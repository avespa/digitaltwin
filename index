<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDT ‚Äî Compliance Digital Twin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c10;
    --surface: #0d1218;
    --surface2: #131a22;
    --border: #1e2a36;
    --accent: #00e5a0;
    --accent2: #0070f3;
    --warn: #f59e0b;
    --danger: #ef4444;
    --text: #e2e8f0;
    --text-muted: #4a6075;
    --text-dim: #8aa0b4;
    --font-display: 'Syne', sans-serif;
    --font-mono: 'DM Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* SCANLINE EFFECT */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,229,160,0.012) 2px, rgba(0,229,160,0.012) 4px);
    pointer-events: none;
    z-index: 9999;
  }

  /* LAYOUT */
  .app { display: flex; min-height: 100vh; }

  /* SIDEBAR */
  .sidebar {
    width: 220px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0; left: 0; bottom: 0;
    z-index: 100;
  }

  .sidebar-logo {
    padding: 28px 20px 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo-mark {
    font-family: var(--font-display);
    font-weight: 800;
    font-size: 18px;
    letter-spacing: -0.5px;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .logo-mark::before {
    content: '';
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 12px var(--accent);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 8px var(--accent); }
    50% { opacity: 0.6; box-shadow: 0 0 20px var(--accent); }
  }

  .logo-sub {
    font-size: 9px;
    color: var(--text-muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-top: 4px;
  }

  .sidebar-nav { padding: 16px 0; flex: 1; }

  .nav-section {
    padding: 8px 20px 4px;
    font-size: 9px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 12px;
    color: var(--text-dim);
    transition: all 0.15s;
    border-left: 2px solid transparent;
    position: relative;
  }

  .nav-item:hover { color: var(--text); background: rgba(0,229,160,0.04); }
  .nav-item.active {
    color: var(--accent);
    border-left-color: var(--accent);
    background: rgba(0,229,160,0.06);
  }

  .nav-icon { font-size: 14px; width: 16px; text-align: center; }

  .nav-badge {
    margin-left: auto;
    background: var(--danger);
    color: white;
    font-size: 9px;
    padding: 1px 5px;
    border-radius: 10px;
    font-weight: 500;
  }

  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    font-size: 10px;
    color: var(--text-muted);
  }

  .status-dot {
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 6px var(--accent);
    margin-right: 6px;
    animation: pulse 2s infinite;
  }

  /* MAIN */
  .main {
    margin-left: 220px;
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* TOPBAR */
  .topbar {
    height: 56px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 28px;
    gap: 16px;
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .topbar-title {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 15px;
    flex: 1;
  }

  .topbar-meta {
    font-size: 11px;
    color: var(--text-muted);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 11px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--accent);
    color: #000;
    font-weight: 500;
  }
  .btn-primary:hover { background: #00ffb0; box-shadow: 0 0 20px rgba(0,229,160,0.3); }

  .btn-ghost {
    background: transparent;
    color: var(--text-dim);
    border-color: var(--border);
  }
  .btn-ghost:hover { color: var(--text); border-color: var(--text-muted); }

  .btn-danger {
    background: transparent;
    color: var(--danger);
    border-color: var(--danger);
  }
  .btn-danger:hover { background: rgba(239,68,68,0.1); }

  /* CONTENT */
  .content { padding: 28px; flex: 1; }

  /* VIEWS */
  .view { display: none; }
  .view.active { display: block; }

  /* CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 20px;
  }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .card-title {
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  /* GRID */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }

  /* STAT CARDS */
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 18px 20px;
    position: relative;
    overflow: hidden;
  }

  .stat-card::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 2px;
    background: var(--accent-color, var(--accent));
  }

  .stat-label {
    font-size: 9px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .stat-value {
    font-family: var(--font-display);
    font-size: 28px;
    font-weight: 800;
    color: var(--accent-color, var(--accent));
    line-height: 1;
  }

  .stat-sub {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 6px;
  }

  /* FORM */
  .form-group { margin-bottom: 16px; }

  .form-label {
    display: block;
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .form-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 10px 12px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 12px;
    transition: border-color 0.15s;
    outline: none;
  }

  .form-input:focus { border-color: var(--accent); }
  .form-input::placeholder { color: var(--text-muted); }

  .form-input[type="password"] { letter-spacing: 2px; }

  select.form-input {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%234a6075'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    cursor: pointer;
  }

  textarea.form-input { resize: vertical; min-height: 80px; line-height: 1.5; }

  .form-hint {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  /* SECTION TITLE */
  .section-title {
    font-family: var(--font-display);
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .section-sub {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 24px;
  }

  /* CONFIG PAGE */
  .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

  .api-key-field {
    position: relative;
  }

  .api-key-field .form-input {
    padding-right: 40px;
  }

  .toggle-visibility {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    padding: 2px;
  }

  .toggle-visibility:hover { color: var(--text); }

  .api-status {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 8px;
  }

  .api-status.ok { background: rgba(0,229,160,0.1); color: var(--accent); }
  .api-status.error { background: rgba(239,68,68,0.1); color: var(--danger); }
  .api-status.pending { background: rgba(245,158,11,0.1); color: var(--warn); }

  /* CLIENTS LIST */
  .client-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    cursor: pointer;
    transition: all 0.15s;
    margin-bottom: 8px;
  }

  .client-card:hover { border-color: var(--accent); background: rgba(0,229,160,0.03); }

  .client-avatar {
    width: 40px; height: 40px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-display);
    font-weight: 800;
    font-size: 14px;
    color: var(--accent);
    flex-shrink: 0;
  }

  .client-info { flex: 1; }

  .client-name {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 13px;
    margin-bottom: 3px;
  }

  .client-meta { font-size: 10px; color: var(--text-muted); }

  .client-risk {
    font-size: 11px;
    font-weight: 500;
    padding: 3px 10px;
    border-radius: 4px;
  }

  .risk-alto { background: rgba(239,68,68,0.15); color: #ef4444; }
  .risk-medio { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .risk-bajo { background: rgba(0,229,160,0.15); color: var(--accent); }

  /* HITS FEED */
  .hit-item {
    border-left: 3px solid var(--border);
    padding: 12px 16px;
    margin-bottom: 8px;
    background: var(--surface);
    border-radius: 0 4px 4px 0;
    transition: all 0.15s;
  }

  .hit-item.critical { border-left-color: var(--danger); }
  .hit-item.warning { border-left-color: var(--warn); }
  .hit-item.info { border-left-color: var(--accent2); }

  .hit-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }

  .hit-tag {
    font-size: 9px;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 500;
  }

  .hit-tag.critical { background: rgba(239,68,68,0.15); color: var(--danger); }
  .hit-tag.warning { background: rgba(245,158,11,0.15); color: var(--warn); }
  .hit-tag.info { background: rgba(0,112,243,0.15); color: var(--accent2); }

  .hit-date { font-size: 10px; color: var(--text-muted); margin-left: auto; }

  .hit-title { font-size: 12px; font-weight: 500; margin-bottom: 4px; }
  .hit-desc { font-size: 11px; color: var(--text-dim); line-height: 1.5; }

  /* RADAR CHART */
  .radar-container {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  svg.radar { overflow: visible; }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 28px;
    width: 560px;
    max-height: 85vh;
    overflow-y: auto;
    position: relative;
  }

  .modal-title {
    font-family: var(--font-display);
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 20px;
    padding-right: 24px;
  }

  .modal-close {
    position: absolute;
    top: 20px; right: 20px;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 18px;
  }

  .modal-close:hover { color: var(--text); }

  /* ALERT */
  .alert {
    padding: 10px 14px;
    border-radius: 4px;
    font-size: 11px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .alert-success { background: rgba(0,229,160,0.1); border: 1px solid rgba(0,229,160,0.2); color: var(--accent); }
  .alert-error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); color: var(--danger); }
  .alert-warn { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.2); color: var(--warn); }

  /* DIVIDER */
  .divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }

  /* LOADING */
  .spinner {
    width: 16px; height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    display: inline-block;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ANALYSIS RESULT */
  .analysis-block {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
    margin-top: 16px;
    font-size: 12px;
    line-height: 1.7;
    white-space: pre-wrap;
  }

  .analysis-block.loading {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-muted);
  }

  /* TAGS */
  .tag {
    display: inline-block;
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 3px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    margin: 2px;
  }

  /* TABLE */
  .table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .table th {
    text-align: left;
    padding: 8px 12px;
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
  }
  .table td { padding: 12px; border-bottom: 1px solid rgba(30,42,54,0.5); }
  .table tr:hover td { background: rgba(0,229,160,0.02); }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  /* PROGRESS BAR */
  .progress { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin-top: 6px; }
  .progress-bar { height: 100%; border-radius: 2px; transition: width 0.5s; }

  /* SEPARATOR */
  .flex { display: flex; }
  .flex-col { flex-direction: column; }
  .items-center { align-items: center; }
  .justify-between { justify-content: space-between; }
  .gap-8 { gap: 8px; }
  .gap-16 { gap: 16px; }
  .mt-8 { margin-top: 8px; }
  .mt-16 { margin-top: 16px; }
  .mt-24 { margin-top: 24px; }
  .mb-8 { margin-bottom: 8px; }
  .mb-16 { margin-bottom: 16px; }
  .text-muted { color: var(--text-muted); font-size: 11px; }
  .text-accent { color: var(--accent); }
  .font-display { font-family: var(--font-display); }

  /* MONITOR MODE */
  .monitor-mode {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 2000;
    display: none;
    flex-direction: column;
    padding: 32px;
  }

  .monitor-mode.active { display: flex; }

  .monitor-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
  }

  .monitor-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 24px;
    flex: 1;
  }

  .monitor-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px;
    display: flex;
    flex-direction: column;
  }

  .monitor-card-title {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 16px;
  }

  .monitor-big-number {
    font-family: var(--font-display);
    font-size: 72px;
    font-weight: 800;
    line-height: 1;
    color: var(--accent);
  }

  .ticker {
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  .ticker-item {
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: none; } }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--text-muted);
  }

  .empty-icon { font-size: 32px; margin-bottom: 12px; }
  .empty-title { font-family: var(--font-display); font-size: 14px; color: var(--text-dim); margin-bottom: 6px; }
  .empty-desc { font-size: 11px; }
</style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-mark">CDT</div>
      <div class="logo-sub">Compliance Digital Twin</div>
    </div>

    <div class="sidebar-nav">
      <div class="nav-section">Principal</div>
      <div class="nav-item active" onclick="showView('dashboard')">
        <span class="nav-icon">‚óà</span> Dashboard
      </div>
      <div class="nav-item" onclick="showView('clientes')">
        <span class="nav-icon">‚óé</span> Clientes
      </div>

      <div class="nav-section" style="margin-top:12px;">Monitor</div>
      <div class="nav-item" onclick="showView('hits')">
        <span class="nav-icon">‚üÅ</span> Hits Detectados
        <span class="nav-badge" id="hits-badge">0</span>
      </div>
      <div class="nav-item" onclick="showView('analisis')">
        <span class="nav-icon">‚óâ</span> An√°lisis IA
      </div>

      <div class="nav-section" style="margin-top:12px;">Sistema</div>
      <div class="nav-item" onclick="showView('config')">
        <span class="nav-icon">‚öô</span> Configuraci√≥n
      </div>
      <div class="nav-item" onclick="toggleMonitor()">
        <span class="nav-icon">‚ñ£</span> Modo Pantalla
      </div>
    </div>

    <div class="sidebar-footer">
      <span class="status-dot"></span>
      <span id="sidebar-status">Sistema activo</span>
    </div>
  </nav>

  <!-- MAIN -->
  <div class="main">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-title" id="topbar-title">Dashboard</div>
      <div class="topbar-meta" id="topbar-date"></div>
      <button class="btn btn-ghost" onclick="runAnalysis()" id="run-btn">
        ‚ü≥ Ejecutar an√°lisis
      </button>
    </div>

    <!-- CONTENT -->
    <div class="content">

      <!-- ===== DASHBOARD ===== -->
      <div class="view active" id="view-dashboard">
        <div class="grid-4 mb-16">
          <div class="stat-card" style="--accent-color: var(--accent)">
            <div class="stat-label">Clientes activos</div>
            <div class="stat-value" id="stat-clientes">0</div>
            <div class="stat-sub">en seguimiento</div>
          </div>
          <div class="stat-card" style="--accent-color: var(--warn)">
            <div class="stat-label">Hits hoy</div>
            <div class="stat-value" id="stat-hits">0</div>
            <div class="stat-sub">eventos relevantes</div>
          </div>
          <div class="stat-card" style="--accent-color: var(--danger)">
            <div class="stat-label">Riesgo cr√≠tico</div>
            <div class="stat-value" id="stat-criticos">0</div>
            <div class="stat-sub">alertas pendientes</div>
          </div>
          <div class="stat-card" style="--accent-color: var(--accent2)">
            <div class="stat-label">Ahorro estimado</div>
            <div class="stat-value" id="stat-ahorro">‚Ç¨0</div>
            <div class="stat-sub">impacto evitado</div>
          </div>
        </div>

        <div class="grid-2" style="gap:20px;">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Radar de Riesgo Global</div>
              <span class="text-muted">Todos los clientes</span>
            </div>
            <div class="radar-container">
              <svg class="radar" width="240" height="240" viewBox="0 0 240 240" id="radar-svg">
              </svg>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">√öltimos Hits</div>
              <span class="text-muted" id="hits-count">0 eventos</span>
            </div>
            <div id="dashboard-hits">
              <div class="empty-state">
                <div class="empty-icon">‚üÅ</div>
                <div class="empty-title">Sin hits detectados</div>
                <div class="empty-desc">Configura las APIs y ejecuta un an√°lisis</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-16">
          <div class="card-header">
            <div class="card-title">Estado por cliente</div>
          </div>
          <table class="table" id="dashboard-table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Sector</th>
                <th>√öltimo an√°lisis</th>
                <th>Hits</th>
                <th>Riesgo</th>
                <th>Ahorro est.</th>
              </tr>
            </thead>
            <tbody id="dashboard-table-body">
              <tr><td colspan="6" style="text-align:center; color: var(--text-muted); padding: 32px;">
                Sin clientes. Ve a <strong>Clientes</strong> para a√±adir el primero.
              </td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ===== CLIENTES ===== -->
      <div class="view" id="view-clientes">
        <div class="flex items-center justify-between mb-16">
          <div>
            <div class="section-title">Clientes</div>
            <div class="section-sub">Gesti√≥n de perfiles empresariales</div>
          </div>
          <button class="btn btn-primary" onclick="openClientModal()">
            + Nuevo cliente
          </button>
        </div>

        <div id="clients-list">
          <div class="empty-state">
            <div class="empty-icon">‚óé</div>
            <div class="empty-title">Sin clientes a√∫n</div>
            <div class="empty-desc">A√±ade tu primer cliente para empezar el seguimiento</div>
          </div>
        </div>
      </div>

      <!-- ===== HITS ===== -->
      <div class="view" id="view-hits">
        <div class="flex items-center justify-between mb-16">
          <div>
            <div class="section-title">Hits Detectados</div>
            <div class="section-sub">Eventos relevantes del mercado en tiempo real</div>
          </div>
          <div class="flex gap-8">
            <select class="form-input" style="width:180px;" id="hits-filter-client" onchange="renderHits()">
              <option value="">Todos los clientes</option>
            </select>
            <select class="form-input" style="width:140px;" id="hits-filter-level" onchange="renderHits()">
              <option value="">Todos los niveles</option>
              <option value="critical">Cr√≠tico</option>
              <option value="warning">Alerta</option>
              <option value="info">Info</option>
            </select>
          </div>
        </div>
        <div id="hits-list">
          <div class="empty-state">
            <div class="empty-icon">‚üÅ</div>
            <div class="empty-title">Sin hits detectados</div>
            <div class="empty-desc">Ejecuta un an√°lisis para detectar eventos relevantes</div>
          </div>
        </div>
      </div>

      <!-- ===== AN√ÅLISIS ===== -->
      <div class="view" id="view-analisis">
        <div class="section-title">An√°lisis IA</div>
        <div class="section-sub">Consulta manual al motor de inteligencia</div>

        <div class="grid-2" style="gap:20px; align-items: start;">
          <div>
            <div class="card">
              <div class="card-header"><div class="card-title">Consulta manual</div></div>

              <div class="form-group">
                <label class="form-label">Cliente / Contexto</label>
                <select class="form-input" id="analysis-client">
                  <option value="">Selecciona un cliente...</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Noticia o evento a analizar</label>
                <textarea class="form-input" id="analysis-news" rows="5"
                  placeholder="Pega aqu√≠ la noticia, sentencia o evento que quieres analizar..."></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">Tipo de an√°lisis</label>
                <select class="form-input" id="analysis-type">
                  <option value="vulnerability">Vulnerabilidad vs. controles</option>
                  <option value="financial">Impacto financiero</option>
                  <option value="recommendation">Recomendaciones de mejora</option>
                  <option value="full">An√°lisis completo</option>
                </select>
              </div>

              <button class="btn btn-primary" style="width:100%;" onclick="runManualAnalysis()" id="manual-analysis-btn">
                Analizar con IA ‚Üí
              </button>
            </div>
          </div>

          <div>
            <div class="card">
              <div class="card-header"><div class="card-title">Resultado</div></div>
              <div id="analysis-result">
                <div class="empty-state" style="padding:32px 0;">
                  <div class="empty-icon">‚óâ</div>
                  <div class="empty-title">Esperando an√°lisis</div>
                  <div class="empty-desc">El resultado aparecer√° aqu√≠</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== CONFIG ===== -->
      <div class="view" id="view-config">
        <div class="section-title">Configuraci√≥n</div>
        <div class="section-sub">APIs, fuentes de datos y par√°metros del sistema</div>

        <div id="config-alert"></div>

        <div class="config-grid">
          <!-- API KEYS -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">ü§ñ APIs de Inteligencia Artificial</div>
            </div>

            <div class="form-group">
              <label class="form-label">
                Mistral AI API Key
                <span class="api-status pending" id="status-mistral">‚óè sin verificar</span>
              </label>
              <div class="api-key-field">
                <input type="password" class="form-input" id="mistral-key"
                  placeholder="sk-..." oninput="markUnsaved()">
                <button class="toggle-visibility" onclick="toggleVis('mistral-key')">üëÅ</button>
              </div>
              <div class="form-hint">
                Cons√≠guela en <a href="https://console.mistral.ai" target="_blank" style="color:var(--accent)">console.mistral.ai</a>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Modelo Mistral</label>
              <select class="form-input" id="mistral-model" oninput="markUnsaved()">
                <option value="mistral-small-latest">mistral-small (r√°pido, gratuito)</option>
                <option value="mistral-medium-latest">mistral-medium (equilibrado)</option>
                <option value="mistral-large-latest">mistral-large (m√°s preciso)</option>
              </select>
            </div>

            <button class="btn btn-ghost" style="width:100%;margin-top:4px;" onclick="testMistral()">
              Verificar conexi√≥n Mistral
            </button>
          </div>

          <!-- PINECONE -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">üóÉ Pinecone (Memoria Vectorial)</div>
            </div>

            <div class="form-group">
              <label class="form-label">
                Pinecone API Key
                <span class="api-status pending" id="status-pinecone">‚óè sin verificar</span>
              </label>
              <div class="api-key-field">
                <input type="password" class="form-input" id="pinecone-key"
                  placeholder="..." oninput="markUnsaved()">
                <button class="toggle-visibility" onclick="toggleVis('pinecone-key')">üëÅ</button>
              </div>
              <div class="form-hint">
                Cons√≠guela en <a href="https://app.pinecone.io" target="_blank" style="color:var(--accent)">app.pinecone.io</a>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Nombre del √≠ndice</label>
              <input type="text" class="form-input" id="pinecone-index"
                placeholder="compliance-index" oninput="markUnsaved()">
            </div>

            <div class="form-group">
              <label class="form-label">Environment / Region</label>
              <input type="text" class="form-input" id="pinecone-env"
                placeholder="us-east-1" oninput="markUnsaved()">
            </div>
          </div>

          <!-- NOTICIAS -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">üì° Fuentes de Noticias</div>
            </div>

            <div class="form-group">
              <label class="form-label">
                NewsAPI Key
                <span class="api-status pending" id="status-newsapi">‚óè sin verificar</span>
              </label>
              <div class="api-key-field">
                <input type="password" class="form-input" id="newsapi-key"
                  placeholder="..." oninput="markUnsaved()">
                <button class="toggle-visibility" onclick="toggleVis('newsapi-key')">üëÅ</button>
              </div>
              <div class="form-hint">
                Tier gratuito: 100 peticiones/d√≠a. <a href="https://newsapi.org" target="_blank" style="color:var(--accent)">newsapi.org</a>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Fuentes adicionales (activas)</label>
              <div>
                <label style="display:flex;align-items:center;gap:8px;font-size:11px;margin-bottom:6px;cursor:pointer;">
                  <input type="checkbox" id="src-boe" checked> BOE (Bolet√≠n Oficial del Estado)
                </label>
                <label style="display:flex;align-items:center;gap:8px;font-size:11px;margin-bottom:6px;cursor:pointer;">
                  <input type="checkbox" id="src-cendoj" checked> CENDOJ (Sentencias judiciales)
                </label>
                <label style="display:flex;align-items:center;gap:8px;font-size:11px;margin-bottom:6px;cursor:pointer;">
                  <input type="checkbox" id="src-cnmv"> CNMV (Comisi√≥n Nacional del Mercado)
                </label>
                <label style="display:flex;align-items:center;gap:8px;font-size:11px;cursor:pointer;">
                  <input type="checkbox" id="src-aepd"> AEPD (Protecci√≥n de Datos)
                </label>
              </div>
            </div>
          </div>

          <!-- FIREBASE -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">üî• Firebase / Firestore</div>
            </div>

            <div class="form-group">
              <label class="form-label">Project ID</label>
              <input type="text" class="form-input" id="firebase-project"
                placeholder="mi-proyecto-compliance" oninput="markUnsaved()">
            </div>

            <div class="form-group">
              <label class="form-label">API Key</label>
              <div class="api-key-field">
                <input type="password" class="form-input" id="firebase-key"
                  placeholder="AIza..." oninput="markUnsaved()">
                <button class="toggle-visibility" onclick="toggleVis('firebase-key')">üëÅ</button>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Auth Domain</label>
              <input type="text" class="form-input" id="firebase-domain"
                placeholder="proyecto.firebaseapp.com" oninput="markUnsaved()">
            </div>
          </div>
        </div>

        <hr class="divider">

        <!-- PAR√ÅMETROS DEL SISTEMA -->
        <div class="card mt-16">
          <div class="card-header">
            <div class="card-title">‚öô Par√°metros del Sistema</div>
          </div>
          <div class="grid-3" style="gap:16px;">
            <div class="form-group">
              <label class="form-label">Frecuencia de an√°lisis</label>
              <select class="form-input" id="analysis-freq" oninput="markUnsaved()">
                <option value="3">Cada 3 horas</option>
                <option value="6">Cada 6 horas</option>
                <option value="12">Cada 12 horas</option>
                <option value="24">Una vez al d√≠a</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Umbral de relevancia (0-100)</label>
              <input type="number" class="form-input" id="relevance-threshold"
                value="65" min="0" max="100" oninput="markUnsaved()">
              <div class="form-hint">M√≠nimo score para considerar un hit</div>
            </div>
            <div class="form-group">
              <label class="form-label">Idioma principal</label>
              <select class="form-input" id="main-language" oninput="markUnsaved()">
                <option value="es">Espa√±ol</option>
                <option value="en">English</option>
                <option value="es,en">Espa√±ol + English</option>
              </select>
            </div>
          </div>
        </div>

        <div class="flex gap-8 mt-16" style="justify-content:flex-end;">
          <button class="btn btn-ghost" onclick="loadConfig()">Cancelar</button>
          <button class="btn btn-primary" onclick="saveConfig()" id="save-btn">
            Guardar configuraci√≥n
          </button>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- MODAL CLIENTE -->
<div class="modal-overlay" id="client-modal">
  <div class="modal">
    <div class="modal-title" id="client-modal-title">Nuevo cliente</div>
    <button class="modal-close" onclick="closeClientModal()">‚úï</button>

    <div class="form-group">
      <label class="form-label">Nombre de la empresa *</label>
      <input type="text" class="form-input" id="client-name" placeholder="Ej: Empresa S.A.">
    </div>

    <div class="grid-2">
      <div class="form-group">
        <label class="form-label">Sector *</label>
        <select class="form-input" id="client-sector">
          <option value="">Selecciona...</option>
          <option value="financiero">Financiero / Banca</option>
          <option value="seguros">Seguros</option>
          <option value="construccion">Construcci√≥n / Inmobiliaria</option>
          <option value="salud">Salud / Farmacia</option>
          <option value="tecnologia">Tecnolog√≠a / Digital</option>
          <option value="energia">Energ√≠a / Utilities</option>
          <option value="alimentacion">Alimentaci√≥n / FMCG</option>
          <option value="transporte">Transporte / Log√≠stica</option>
          <option value="manufactura">Manufactura / Industrial</option>
          <option value="servicios">Servicios Profesionales</option>
          <option value="retail">Retail / Distribuci√≥n</option>
          <option value="otro">Otro</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Tama√±o</label>
        <select class="form-input" id="client-size">
          <option value="pyme">PYME (&lt;250 empleados)</option>
          <option value="mediana">Mediana (250-1000)</option>
          <option value="grande">Grande (&gt;1000)</option>
          <option value="cotizada">Cotizada en bolsa</option>
        </select>
      </div>
    </div>

    <div class="grid-2">
      <div class="form-group">
        <label class="form-label">Pa√≠s principal</label>
        <select class="form-input" id="client-country">
          <option value="ES">Espa√±a</option>
          <option value="ES,PT">Espa√±a + Portugal</option>
          <option value="ES,LATAM">Espa√±a + LATAM</option>
          <option value="EU">Uni√≥n Europea</option>
          <option value="GLOBAL">Global</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Facturaci√≥n anual</label>
        <select class="form-input" id="client-revenue">
          <option value="<5M">Menos de 5M ‚Ç¨</option>
          <option value="5-50M">5M - 50M ‚Ç¨</option>
          <option value="50-250M">50M - 250M ‚Ç¨</option>
          <option value=">250M">M√°s de 250M ‚Ç¨</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Normas aplicables</label>
      <div style="display:flex;flex-wrap:wrap;gap:6px;">
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer;">
          <input type="checkbox" class="client-norm" value="ISO37301" checked> ISO 37301
        </label>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer;">
          <input type="checkbox" class="client-norm" value="UNE19601"> UNE 19601
        </label>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer;">
          <input type="checkbox" class="client-norm" value="ISO37001"> ISO 37001
        </label>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer;">
          <input type="checkbox" class="client-norm" value="RGPD"> RGPD
        </label>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer;">
          <input type="checkbox" class="client-norm" value="PBC"> PBC / AML
        </label>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer;">
          <input type="checkbox" class="client-norm" value="DORA"> DORA
        </label>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Descripci√≥n del modelo de compliance (contexto)</label>
      <textarea class="form-input" id="client-compliance-desc" rows="4"
        placeholder="Describe brevemente el modelo de compliance actual: controles existentes, √°reas de riesgo conocidas, estado de certificaciones..."></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">√Åreas de riesgo prioritarias</label>
      <textarea class="form-input" id="client-risks" rows="2"
        placeholder="Ej: soborno en licitaciones, conflictos de inter√©s, cadena de suministro..."></textarea>
    </div>

    <div class="flex gap-8" style="justify-content:flex-end; margin-top:8px;">
      <button class="btn btn-ghost" onclick="closeClientModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveClient()" id="client-save-btn">
        Guardar cliente
      </button>
    </div>
  </div>
</div>

<!-- MONITOR MODE -->
<div class="monitor-mode" id="monitor-mode">
  <div class="monitor-header">
    <div class="logo-mark" style="font-family: var(--font-display); font-size:22px; font-weight:800; color:var(--accent); display:flex;align-items:center;gap:10px;">
      <span style="width:10px;height:10px;background:var(--accent);border-radius:50%;box-shadow:0 0 16px var(--accent);animation:pulse 2s infinite;display:inline-block;"></span>
      CDT ‚Äî COMPLIANCE DIGITAL TWIN
    </div>
    <div id="monitor-time" style="font-size:13px;color:var(--text-muted);font-family:var(--font-mono);"></div>
    <button class="btn btn-ghost" onclick="toggleMonitor()">‚úï Salir</button>
  </div>

  <div class="monitor-grid">
    <div class="monitor-card">
      <div class="monitor-card-title">‚ö° Nivel de riesgo global</div>
      <div class="monitor-big-number" id="monitor-risk">72</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:8px;">/ 100 ‚Äî MEDIO-ALTO</div>
      <div class="progress mt-16">
        <div class="progress-bar" id="monitor-risk-bar"
          style="width:72%;background:var(--warn);"></div>
      </div>
      <div style="margin-top:24px;">
        <svg width="100%" height="120" viewBox="0 0 300 120" id="monitor-radar-small"></svg>
      </div>
    </div>

    <div class="monitor-card">
      <div class="monitor-card-title">‚üÅ √öltimos hits detectados</div>
      <div class="ticker" id="monitor-hits-ticker">
        <div class="empty-state" style="padding:20px 0;">
          <div class="empty-desc">Sin hits activos</div>
        </div>
      </div>
    </div>

    <div class="monitor-card">
      <div class="monitor-card-title">‚Ç¨ Ahorro acumulado por prevenci√≥n</div>
      <div class="monitor-big-number" style="font-size:52px;" id="monitor-savings">‚Ç¨0</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:8px;">impacto evitado estimado</div>

      <hr class="divider" style="margin:20px 0;">

      <div class="monitor-card-title">‚óé Clientes en seguimiento</div>
      <div id="monitor-client-list" style="flex:1;">
        <div class="empty-state" style="padding:16px 0;"><div class="empty-desc">Sin clientes</div></div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let state = {
  clients: [],
  hits: [],
  config: {
    mistralKey: '',
    mistralModel: 'mistral-small-latest',
    pineconeKey: '',
    pineconeIndex: 'compliance-index',
    pineconeEnv: 'us-east-1',
    newsapiKey: '',
    firebaseProject: '',
    firebaseKey: '',
    firebaseDomain: '',
    srcBoe: true,
    srcCendoj: true,
    srcCnmv: false,
    srcAepd: false,
    analysisFreq: '3',
    relevanceThreshold: 65,
    mainLanguage: 'es'
  }
};

// ============================================================
// PERSISTENCE (localStorage)
// ============================================================
function saveState() {
  localStorage.setItem('cdt_state', JSON.stringify(state));
}

function loadStateFromStorage() {
  const stored = localStorage.getItem('cdt_state');
  if (stored) {
    try {
      const parsed = JSON.parse(stored);
      state = { ...state, ...parsed };
    } catch(e) {}
  }
}

// ============================================================
// NAVIGATION
// ============================================================
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

  document.getElementById('view-' + name).classList.add('active');

  const titles = {
    dashboard: 'Dashboard',
    clientes: 'Clientes',
    hits: 'Hits Detectados',
    analisis: 'An√°lisis IA',
    config: 'Configuraci√≥n'
  };
  document.getElementById('topbar-title').textContent = titles[name] || name;

  // Mark active nav
  document.querySelectorAll('.nav-item').forEach(item => {
    if (item.textContent.trim().toLowerCase().includes(name.toLowerCase().substring(0,4))) {
      item.classList.add('active');
    }
  });

  if (name === 'config') loadConfig();
  if (name === 'hits') renderHits();
  if (name === 'analisis') populateAnalysisClients();
}

// ============================================================
// CONFIG
// ============================================================
function loadConfig() {
  const c = state.config;
  document.getElementById('mistral-key').value = c.mistralKey || '';
  document.getElementById('mistral-model').value = c.mistralModel || 'mistral-small-latest';
  document.getElementById('pinecone-key').value = c.pineconeKey || '';
  document.getElementById('pinecone-index').value = c.pineconeIndex || 'compliance-index';
  document.getElementById('pinecone-env').value = c.pineconeEnv || 'us-east-1';
  document.getElementById('newsapi-key').value = c.newsapiKey || '';
  document.getElementById('firebase-project').value = c.firebaseProject || '';
  document.getElementById('firebase-key').value = c.firebaseKey || '';
  document.getElementById('firebase-domain').value = c.firebaseDomain || '';
  document.getElementById('src-boe').checked = c.srcBoe !== false;
  document.getElementById('src-cendoj').checked = c.srcCendoj !== false;
  document.getElementById('src-cnmv').checked = c.srcCnmv || false;
  document.getElementById('src-aepd').checked = c.srcAepd || false;
  document.getElementById('analysis-freq').value = c.analysisFreq || '3';
  document.getElementById('relevance-threshold').value = c.relevanceThreshold || 65;
  document.getElementById('main-language').value = c.mainLanguage || 'es';
}

function saveConfig() {
  state.config = {
    mistralKey: document.getElementById('mistral-key').value.trim(),
    mistralModel: document.getElementById('mistral-model').value,
    pineconeKey: document.getElementById('pinecone-key').value.trim(),
    pineconeIndex: document.getElementById('pinecone-index').value.trim(),
    pineconeEnv: document.getElementById('pinecone-env').value.trim(),
    newsapiKey: document.getElementById('newsapi-key').value.trim(),
    firebaseProject: document.getElementById('firebase-project').value.trim(),
    firebaseKey: document.getElementById('firebase-key').value.trim(),
    firebaseDomain: document.getElementById('firebase-domain').value.trim(),
    srcBoe: document.getElementById('src-boe').checked,
    srcCendoj: document.getElementById('src-cendoj').checked,
    srcCnmv: document.getElementById('src-cnmv').checked,
    srcAepd: document.getElementById('src-aepd').checked,
    analysisFreq: document.getElementById('analysis-freq').value,
    relevanceThreshold: parseInt(document.getElementById('relevance-threshold').value),
    mainLanguage: document.getElementById('main-language').value
  };

  saveState();
  showAlert('config-alert', '‚úì Configuraci√≥n guardada correctamente', 'success');
  document.getElementById('save-btn').textContent = 'Guardado ‚úì';
  setTimeout(() => { document.getElementById('save-btn').textContent = 'Guardar configuraci√≥n'; }, 2000);
}

function markUnsaved() {
  document.getElementById('save-btn').textContent = 'Guardar configuraci√≥n *';
}

function toggleVis(id) {
  const el = document.getElementById(id);
  el.type = el.type === 'password' ? 'text' : 'password';
}

// ============================================================
// TEST APIs
// ============================================================
async function testMistral() {
  const key = document.getElementById('mistral-key').value.trim();
  if (!key) { showAlert('config-alert', 'Introduce primero la API Key de Mistral', 'error'); return; }

  const statusEl = document.getElementById('status-mistral');
  statusEl.className = 'api-status pending';
  statusEl.textContent = '‚óè probando...';

  try {
    const res = await fetch('https://api.mistral.ai/v1/models', {
      headers: { 'Authorization': 'Bearer ' + key }
    });

    if (res.ok) {
      statusEl.className = 'api-status ok';
      statusEl.textContent = '‚óè conectado';
      showAlert('config-alert', '‚úì Mistral AI conectado correctamente', 'success');
    } else {
      statusEl.className = 'api-status error';
      statusEl.textContent = '‚óè error';
      showAlert('config-alert', '‚úó API Key de Mistral inv√°lida o sin permisos', 'error');
    }
  } catch(e) {
    statusEl.className = 'api-status error';
    statusEl.textContent = '‚óè sin conexi√≥n';
    showAlert('config-alert', '‚úó Error de red. Comprueba tu conexi√≥n.', 'error');
  }
}

// ============================================================
// CLIENTS
// ============================================================
let editingClientId = null;

function openClientModal(clientId = null) {
  editingClientId = clientId;

  if (clientId) {
    const client = state.clients.find(c => c.id === clientId);
    document.getElementById('client-modal-title').textContent = 'Editar cliente';
    document.getElementById('client-name').value = client.name;
    document.getElementById('client-sector').value = client.sector;
    document.getElementById('client-size').value = client.size;
    document.getElementById('client-country').value = client.country;
    document.getElementById('client-revenue').value = client.revenue;
    document.getElementById('client-compliance-desc').value = client.complianceDesc || '';
    document.getElementById('client-risks').value = client.risks || '';
    document.querySelectorAll('.client-norm').forEach(cb => {
      cb.checked = (client.norms || []).includes(cb.value);
    });
  } else {
    document.getElementById('client-modal-title').textContent = 'Nuevo cliente';
    document.getElementById('client-name').value = '';
    document.getElementById('client-sector').value = '';
    document.getElementById('client-size').value = 'pyme';
    document.getElementById('client-country').value = 'ES';
    document.getElementById('client-revenue').value = '5-50M';
    document.getElementById('client-compliance-desc').value = '';
    document.getElementById('client-risks').value = '';
    document.querySelectorAll('.client-norm').forEach(cb => {
      cb.checked = cb.value === 'ISO37301';
    });
  }

  document.getElementById('client-modal').classList.add('open');
}

function closeClientModal() {
  document.getElementById('client-modal').classList.remove('open');
  editingClientId = null;
}

function saveClient() {
  const name = document.getElementById('client-name').value.trim();
  const sector = document.getElementById('client-sector').value;

  if (!name || !sector) {
    alert('Nombre y sector son obligatorios');
    return;
  }

  const norms = [];
  document.querySelectorAll('.client-norm:checked').forEach(cb => norms.push(cb.value));

  const client = {
    id: editingClientId || 'c_' + Date.now(),
    name,
    sector,
    size: document.getElementById('client-size').value,
    country: document.getElementById('client-country').value,
    revenue: document.getElementById('client-revenue').value,
    norms,
    complianceDesc: document.getElementById('client-compliance-desc').value.trim(),
    risks: document.getElementById('client-risks').value.trim(),
    riskLevel: 'medio',
    lastAnalysis: null,
    hits: 0,
    savings: 0,
    createdAt: new Date().toISOString()
  };

  if (editingClientId) {
    const idx = state.clients.findIndex(c => c.id === editingClientId);
    state.clients[idx] = { ...state.clients[idx], ...client };
  } else {
    state.clients.push(client);
  }

  saveState();
  closeClientModal();
  renderClients();
  updateDashboard();
}

function deleteClient(id) {
  if (!confirm('¬øEliminar este cliente?')) return;
  state.clients = state.clients.filter(c => c.id !== id);
  saveState();
  renderClients();
  updateDashboard();
}

function renderClients() {
  const container = document.getElementById('clients-list');

  if (state.clients.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">‚óé</div>
        <div class="empty-title">Sin clientes a√∫n</div>
        <div class="empty-desc">A√±ade tu primer cliente para empezar el seguimiento</div>
      </div>`;
    return;
  }

  container.innerHTML = state.clients.map(c => `
    <div class="client-card" onclick="openClientModal('${c.id}')">
      <div class="client-avatar">${c.name.substring(0,2).toUpperCase()}</div>
      <div class="client-info">
        <div class="client-name">${c.name}</div>
        <div class="client-meta">${sectorLabel(c.sector)} ¬∑ ${c.country} ¬∑ ${c.revenue} ¬∑ ${(c.norms||[]).join(', ')}</div>
      </div>
      <div class="client-risk risk-${c.riskLevel}">${c.riskLevel.toUpperCase()}</div>
      <div style="display:flex;gap:8px;margin-left:8px;" onclick="event.stopPropagation()">
        <button class="btn btn-ghost" onclick="runClientAnalysis('${c.id}')">Analizar</button>
        <button class="btn btn-danger" onclick="deleteClient('${c.id}')">‚úï</button>
      </div>
    </div>
  `).join('');

  // Update filter dropdowns
  updateClientFilters();
}

function sectorLabel(s) {
  const map = {
    financiero: 'Financiero', seguros: 'Seguros', construccion: 'Construcci√≥n',
    salud: 'Salud', tecnologia: 'Tecnolog√≠a', energia: 'Energ√≠a',
    alimentacion: 'Alimentaci√≥n', transporte: 'Transporte', manufactura: 'Manufactura',
    servicios: 'Servicios', retail: 'Retail', otro: 'Otro'
  };
  return map[s] || s;
}

function updateClientFilters() {
  const selects = ['hits-filter-client', 'analysis-client'];
  selects.forEach(id => {
    const el = document.getElementById(id);
    const current = el.value;
    el.innerHTML = `<option value="">Todos los clientes</option>`;
    state.clients.forEach(c => {
      el.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });
    el.value = current;
  });
}

// ============================================================
// HITS
// ============================================================
function renderHits() {
  const container = document.getElementById('hits-list');
  let hits = [...state.hits];

  const clientFilter = document.getElementById('hits-filter-client')?.value;
  const levelFilter = document.getElementById('hits-filter-level')?.value;

  if (clientFilter) hits = hits.filter(h => h.clientId === clientFilter);
  if (levelFilter) hits = hits.filter(h => h.level === levelFilter);

  if (hits.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">‚üÅ</div>
        <div class="empty-title">Sin hits detectados</div>
        <div class="empty-desc">Ejecuta un an√°lisis para detectar eventos relevantes</div>
      </div>`;
    return;
  }

  container.innerHTML = hits.sort((a,b) => new Date(b.date) - new Date(a.date)).map(h => `
    <div class="hit-item ${h.level}">
      <div class="hit-header">
        <span class="hit-tag ${h.level}">${levelLabel(h.level)}</span>
        <span style="font-size:10px;color:var(--text-muted)">${h.clientName || 'Global'}</span>
        <span class="hit-date">${formatDate(h.date)}</span>
      </div>
      <div class="hit-title">${h.title}</div>
      <div class="hit-desc">${h.description}</div>
      ${h.analysis ? `<div class="analysis-block" style="margin-top:8px;font-size:11px;">${h.analysis}</div>` : ''}
    </div>
  `).join('');

  document.getElementById('hits-count').textContent = hits.length + ' eventos';
  document.getElementById('hits-badge').textContent = state.hits.filter(h => h.level === 'critical').length;
}

function levelLabel(l) {
  return { critical: 'CR√çTICO', warning: 'ALERTA', info: 'INFO' }[l] || l;
}

function formatDate(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleDateString('es-ES') + ' ' + d.toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit'});
}

// ============================================================
// AN√ÅLISIS CON MISTRAL
// ============================================================
async function runManualAnalysis() {
  const key = state.config.mistralKey;
  if (!key) {
    showAlert('', 'Configura tu API Key de Mistral primero', 'error');
    showView('config');
    return;
  }

  const clientId = document.getElementById('analysis-client').value;
  const newsText = document.getElementById('analysis-news').value.trim();
  const analysisType = document.getElementById('analysis-type').value;

  if (!newsText) { alert('Introduce una noticia o evento para analizar'); return; }

  const client = state.clients.find(c => c.id === clientId);
  const resultEl = document.getElementById('analysis-result');
  const btn = document.getElementById('manual-analysis-btn');

  resultEl.innerHTML = `<div class="analysis-block loading"><span class="spinner"></span> Analizando con Mistral AI...</div>`;
  btn.disabled = true;

  const systemPrompt = buildSystemPrompt(client, analysisType);

  try {
    const res = await fetch('https://api.mistral.ai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + key
      },
      body: JSON.stringify({
        model: state.config.mistralModel || 'mistral-small-latest',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: 'Analiza el siguiente evento:\n\n' + newsText }
        ],
        temperature: 0.2,
        max_tokens: 1500
      })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.message || 'Error API');
    }

    const data = await res.json();
    const text = data.choices[0].message.content;

    resultEl.innerHTML = `<div class="analysis-block">${escapeHtml(text)}</div>`;

    // Save hit if client selected
    if (client) {
      const hit = {
        id: 'h_' + Date.now(),
        clientId: client.id,
        clientName: client.name,
        title: newsText.substring(0, 100) + (newsText.length > 100 ? '...' : ''),
        description: newsText.substring(0, 200),
        analysis: text,
        level: guessLevel(text),
        date: new Date().toISOString(),
        source: 'manual'
      };

      state.hits.unshift(hit);
      client.lastAnalysis = new Date().toISOString();
      client.hits = (client.hits || 0) + 1;
      saveState();
      updateDashboard();
    }

  } catch(e) {
    resultEl.innerHTML = `<div class="analysis-block" style="color:var(--danger)">Error: ${escapeHtml(e.message)}</div>`;
  }

  btn.disabled = false;
}

function buildSystemPrompt(client, type) {
  const baseContext = client
    ? `Eres un experto en compliance corporativo. Est√°s analizando la empresa "${client.name}" del sector ${sectorLabel(client.sector)}, con operaciones en ${client.country}, facturaci√≥n ${client.revenue} y normativa aplicable: ${(client.norms||[]).join(', ')}.
    
Contexto del modelo de compliance: ${client.complianceDesc || 'No especificado'}
√Åreas de riesgo conocidas: ${client.risks || 'No especificadas'}`
    : `Eres un experto en compliance corporativo basado en ISO 37301, UNE 19601 e ISO 37001. Analiza el evento desde una perspectiva general.`;

  const typeInstructions = {
    vulnerability: `
Responde estructurando as√≠:
1. RELEVANCIA (0-100): Puntuaci√≥n y justificaci√≥n breve
2. RIESGOS IDENTIFICADOS: Lista los riesgos compliance que activa este evento
3. VULNERABILIDAD: ¬øLa empresa tiene controles para este riesgo? ¬øSer√≠an suficientes?
4. EXPOSICI√ìN ESTIMADA: Nivel de riesgo (CR√çTICO/ALTO/MEDIO/BAJO)
5. ACCI√ìN RECOMENDADA: Pasos inmediatos a tomar`,

    financial: `
Responde estructurando as√≠:
1. MULTAS POTENCIALES: Estimaci√≥n seg√∫n normativa espa√±ola vigente
2. DA√ëO REPUTACIONAL: Valoraci√≥n cualitativa del impacto medi√°tico
3. COSTE DE REMEDIACI√ìN: Estimaci√≥n de costes para subsanar la brecha
4. IMPACTO TOTAL ESTIMADO: Rango de p√©rdida econ√≥mica potencial`,

    recommendation: `
Responde estructurando as√≠:
1. GAP IDENTIFICADO: Brecha entre el evento y los controles actuales
2. MEJORAS DE CONTROL: Controles nuevos o refuerzos necesarios
3. PRIORIDAD DE IMPLEMENTACI√ìN: Alta/Media/Baja con justificaci√≥n
4. DOCUMENTACI√ìN NECESARIA: Pol√≠ticas o procedimientos a crear/actualizar`,

    full: `
Haz un an√°lisis completo estructurando as√≠:
1. RELEVANCIA (0-100) con justificaci√≥n
2. RIESGOS ACTIVADOS
3. VULNERABILIDAD vs CONTROLES
4. IMPACTO FINANCIERO ESTIMADO
5. RECOMENDACIONES PRIORITARIAS
6. NIVEL DE ALERTA: CR√çTICO / ALTO / MEDIO / BAJO`
  };

  return baseContext + '\n\n' + (typeInstructions[type] || typeInstructions.full);
}

function guessLevel(text) {
  const upper = text.toUpperCase();
  if (upper.includes('CR√çTICO') || upper.includes('CRITICO') || upper.includes('CR√çTICA')) return 'critical';
  if (upper.includes('ALTO') || upper.includes('HIGH') || upper.includes('ALERTA')) return 'warning';
  return 'info';
}

async function runClientAnalysis(clientId) {
  const client = state.clients.find(c => c.id === clientId);
  if (!client) return;
  showView('analisis');
  document.getElementById('analysis-client').value = clientId;
}

async function runAnalysis() {
  const btn = document.getElementById('run-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Analizando...';

  try {
    await fetchNewsAndAnalyze();
  } catch(e) {}

  btn.disabled = false;
  btn.innerHTML = '‚ü≥ Ejecutar an√°lisis';
}

async function fetchNewsAndAnalyze() {
  const key = state.config.mistralKey;
  if (!key || state.clients.length === 0) return;

  // Fetch BOE RSS (public, no key needed)
  if (state.config.srcBoe) {
    try {
      await fetchBOENews(key);
    } catch(e) {}
  }

  // Fetch NewsAPI if key available
  if (state.config.newsapiKey && state.config.newsapiKey.length > 5) {
    try {
      await fetchNewsAPI(key);
    } catch(e) {}
  }

  renderHits();
  updateDashboard();
}

async function fetchBOENews(mistralKey) {
  // BOE RSS is public
  const boeUrl = 'https://www.boe.es/rss/canal.php?s=boe';
  // Note: Direct fetch may fail due to CORS in browser
  // In production this runs via backend/GitHub Actions
  // For demo, we'll show a simulated result
  simulateNewsHit(mistralKey, 'BOE');
}

async function fetchNewsAPI(mistralKey) {
  const q = state.clients.map(c => sectorLabel(c.sector)).join(' OR ') + ' multa compliance';
  const url = `https://newsapi.org/v2/everything?q=${encodeURIComponent(q)}&language=es&sortBy=publishedAt&pageSize=5&apiKey=${state.config.newsapiKey}`;

  const res = await fetch(url);
  if (!res.ok) return;

  const data = await res.json();
  for (const article of (data.articles || []).slice(0, 3)) {
    await analyzeNewsItem(mistralKey, article.title + '. ' + (article.description || ''), 'NewsAPI');
  }
}

async function simulateNewsHit(mistralKey, source) {
  // Demo hit for when APIs aren't set up yet
  const demoNews = [
    'La CNMC impone una multa de 2,5 millones a una empresa del sector energ√©tico por pr√°cticas anticompetitivas en la contrataci√≥n con proveedores.',
    'El Tribunal Supremo confirma condena por corrupci√≥n en licitaciones p√∫blicas del sector construcci√≥n. Pena de inhabilitaci√≥n de 8 a√±os.',
    'La AEPD sanciona con 300.000‚Ç¨ a empresa tecnol√≥gica por transferencia internacional de datos sin garant√≠as adecuadas bajo el RGPD.'
  ];

  const news = demoNews[Math.floor(Math.random() * demoNews.length)];
  await analyzeNewsItem(mistralKey, news, source);
}

async function analyzeNewsItem(mistralKey, newsText, source) {
  for (const client of state.clients) {
    const systemPrompt = buildSystemPrompt(client, 'full');

    const res = await fetch('https://api.mistral.ai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + mistralKey
      },
      body: JSON.stringify({
        model: state.config.mistralModel || 'mistral-small-latest',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: 'Analiza este evento y determina su relevancia y nivel de alerta:\n\n' + newsText }
        ],
        temperature: 0.1,
        max_tokens: 800
      })
    });

    if (!res.ok) continue;
    const data = await res.json();
    const analysis = data.choices[0].message.content;
    const level = guessLevel(analysis);

    // Only add if relevant
    const hit = {
      id: 'h_' + Date.now() + '_' + client.id,
      clientId: client.id,
      clientName: client.name,
      title: newsText.substring(0, 120),
      description: newsText,
      analysis,
      level,
      date: new Date().toISOString(),
      source
    };

    state.hits.unshift(hit);
    client.lastAnalysis = new Date().toISOString();
    client.hits = (client.hits || 0) + 1;
    client.riskLevel = level === 'critical' ? 'alto' : level === 'warning' ? 'medio' : 'bajo';
  }

  saveState();
}

// ============================================================
// DASHBOARD
// ============================================================
function updateDashboard() {
  document.getElementById('stat-clientes').textContent = state.clients.length;
  document.getElementById('stat-hits').textContent = state.hits.length;

  const criticals = state.hits.filter(h => h.level === 'critical').length;
  document.getElementById('stat-criticos').textContent = criticals;
  document.getElementById('hits-badge').textContent = criticals;

  const savings = state.clients.reduce((sum, c) => sum + (c.savings || 0), 0);
  document.getElementById('stat-ahorro').textContent = '‚Ç¨' + formatNumber(savings);

  // Table
  const tbody = document.getElementById('dashboard-table-body');
  if (state.clients.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:32px;">Sin clientes. Ve a <strong>Clientes</strong> para a√±adir el primero.</td></tr>`;
  } else {
    tbody.innerHTML = state.clients.map(c => `
      <tr>
        <td><strong>${c.name}</strong></td>
        <td>${sectorLabel(c.sector)}</td>
        <td>${c.lastAnalysis ? formatDate(c.lastAnalysis) : '‚Äî'}</td>
        <td>${c.hits || 0}</td>
        <td><span class="client-risk risk-${c.riskLevel || 'medio'}">${(c.riskLevel || 'medio').toUpperCase()}</span></td>
        <td>‚Ç¨${formatNumber(c.savings || 0)}</td>
      </tr>
    `).join('');
  }

  // Dashboard hits preview
  const dashHits = document.getElementById('dashboard-hits');
  const recentHits = state.hits.slice(0, 4);
  if (recentHits.length === 0) {
    dashHits.innerHTML = `<div class="empty-state"><div class="empty-icon">‚üÅ</div><div class="empty-title">Sin hits detectados</div><div class="empty-desc">Configura las APIs y ejecuta un an√°lisis</div></div>`;
  } else {
    dashHits.innerHTML = recentHits.map(h => `
      <div class="hit-item ${h.level}" style="margin-bottom:6px;">
        <div class="hit-header">
          <span class="hit-tag ${h.level}">${levelLabel(h.level)}</span>
          <span class="hit-date">${formatDate(h.date)}</span>
        </div>
        <div class="hit-title">${h.title.substring(0,80)}${h.title.length>80?'...':''}</div>
      </div>
    `).join('');
    document.getElementById('hits-count').textContent = state.hits.length + ' eventos';
  }

  drawRadar();
  updateMonitor();
}

function formatNumber(n) {
  return n.toLocaleString('es-ES');
}

// ============================================================
// RADAR CHART
// ============================================================
function drawRadar() {
  const svg = document.getElementById('radar-svg');
  const cx = 120, cy = 120, r = 90;
  const categories = ['Anticorrupci√≥n', 'PBC/AML', 'RGPD', 'Laboral', 'Medioamb.', 'Terceros'];
  const n = categories.length;

  // Generate scores based on clients
  const scores = categories.map((_, i) => {
    if (state.clients.length === 0) return 0.3 + Math.random() * 0.3;
    const criticals = state.hits.filter(h => h.level === 'critical').length;
    return Math.min(0.9, 0.2 + (criticals * 0.1) + Math.random() * 0.2);
  });

  const getPoint = (angle, radius) => {
    const a = angle - Math.PI / 2;
    return { x: cx + radius * Math.cos(a), y: cy + radius * Math.sin(a) };
  };

  let html = '';

  // Grid
  [0.25, 0.5, 0.75, 1].forEach(scale => {
    const pts = categories.map((_, i) => getPoint(2 * Math.PI * i / n, r * scale));
    html += `<polygon points="${pts.map(p => `${p.x},${p.y}`).join(' ')}" fill="none" stroke="var(--border)" stroke-width="1"/>`;
  });

  // Axes + labels
  categories.forEach((cat, i) => {
    const pt = getPoint(2 * Math.PI * i / n, r);
    html += `<line x1="${cx}" y1="${cy}" x2="${pt.x}" y2="${pt.y}" stroke="var(--border)" stroke-width="1"/>`;
    const lpt = getPoint(2 * Math.PI * i / n, r + 18);
    html += `<text x="${lpt.x}" y="${lpt.y}" fill="var(--text-muted)" font-size="9" text-anchor="middle" dominant-baseline="middle" font-family="DM Mono">${cat}</text>`;
  });

  // Data polygon
  const dataPts = scores.map((s, i) => getPoint(2 * Math.PI * i / n, r * s));
  html += `<polygon points="${dataPts.map(p => `${p.x},${p.y}`).join(' ')}" fill="rgba(239,68,68,0.15)" stroke="var(--danger)" stroke-width="2"/>`;
  dataPts.forEach(p => {
    html += `<circle cx="${p.x}" cy="${p.y}" r="3" fill="var(--danger)"/>`;
  });

  svg.innerHTML = html;
}

// ============================================================
// MONITOR MODE
// ============================================================
function toggleMonitor() {
  const m = document.getElementById('monitor-mode');
  m.classList.toggle('active');
  if (m.classList.contains('active')) {
    updateMonitor();
    startMonitorClock();
  }
}

let monitorInterval;
function startMonitorClock() {
  clearInterval(monitorInterval);
  monitorInterval = setInterval(() => {
    document.getElementById('monitor-time').textContent = new Date().toLocaleString('es-ES');
  }, 1000);
}

function updateMonitor() {
  const criticals = state.hits.filter(h => h.level === 'critical').length;
  const totalRisk = Math.min(100, 30 + criticals * 15 + state.hits.filter(h => h.level === 'warning').length * 5);

  document.getElementById('monitor-risk').textContent = totalRisk;
  document.getElementById('monitor-risk-bar').style.width = totalRisk + '%';
  document.getElementById('monitor-risk-bar').style.background =
    totalRisk > 70 ? 'var(--danger)' : totalRisk > 40 ? 'var(--warn)' : 'var(--accent)';

  const savings = state.clients.reduce((sum, c) => sum + (c.savings || 0), 0);
  document.getElementById('monitor-savings').textContent = '‚Ç¨' + formatNumber(savings);

  // Ticker
  const ticker = document.getElementById('monitor-hits-ticker');
  if (state.hits.length === 0) {
    ticker.innerHTML = `<div class="empty-state" style="padding:20px 0;"><div class="empty-desc">Sin hits activos</div></div>`;
  } else {
    ticker.innerHTML = state.hits.slice(0, 8).map(h => `
      <div class="ticker-item">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <span class="hit-tag ${h.level}" style="font-size:9px;">${levelLabel(h.level)}</span>
          <span style="font-size:10px;color:var(--text-muted);">${h.clientName || ''}</span>
        </div>
        <div style="font-size:12px;">${h.title.substring(0, 90)}${h.title.length > 90 ? '...' : ''}</div>
      </div>
    `).join('');
  }

  // Client list in monitor
  const clientList = document.getElementById('monitor-client-list');
  if (state.clients.length === 0) {
    clientList.innerHTML = `<div class="empty-state" style="padding:16px 0;"><div class="empty-desc">Sin clientes</div></div>`;
  } else {
    clientList.innerHTML = state.clients.map(c => `
      <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
        <div style="width:30px;height:30px;background:var(--surface2);border-radius:4px;display:flex;align-items:center;justify-content:center;font-family:var(--font-display);font-weight:800;font-size:11px;color:var(--accent);">${c.name.substring(0,2).toUpperCase()}</div>
        <div style="flex:1;">
          <div style="font-size:12px;font-weight:500;">${c.name}</div>
          <div style="font-size:10px;color:var(--text-muted);">${sectorLabel(c.sector)}</div>
        </div>
        <span class="client-risk risk-${c.riskLevel || 'medio'}" style="font-size:10px;">${(c.riskLevel||'MEDIO').toUpperCase()}</span>
      </div>
    `).join('');
  }
}

// ============================================================
// POPULATE ANALYSIS CLIENTS
// ============================================================
function populateAnalysisClients() {
  const el = document.getElementById('analysis-client');
  el.innerHTML = `<option value="">Sin cliente espec√≠fico (an√°lisis gen√©rico)</option>`;
  state.clients.forEach(c => {
    el.innerHTML += `<option value="${c.id}">${c.name}</option>`;
  });
}

// ============================================================
// ALERTS
// ============================================================
function showAlert(containerId, message, type) {
  const types = { success: 'alert-success', error: 'alert-error', warn: 'alert-warn' };
  const html = `<div class="alert ${types[type]}">${message}</div>`;

  if (containerId) {
    const el = document.getElementById(containerId);
    if (el) {
      el.innerHTML = html;
      setTimeout(() => { el.innerHTML = ''; }, 4000);
    }
  }
}

// ============================================================
// UTILS
// ============================================================
function escapeHtml(str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/\n/g, '<br>');
}

// ============================================================
// INIT
// ============================================================
function init() {
  loadStateFromStorage();
  renderClients();
  updateDashboard();
  updateClientFilters();

  // Date in topbar
  document.getElementById('topbar-date').textContent = new Date().toLocaleDateString('es-ES', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });

  // Show config prompt if no API key
  if (!state.config.mistralKey) {
    setTimeout(() => {
      document.getElementById('sidebar-status').textContent = 'API key pendiente';
    }, 500);
  }

  drawRadar();
}

init();
</script>
</body>
</html>
