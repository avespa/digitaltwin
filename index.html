<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDT â€” Compliance Digital Twin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
:root{
  --bg:#070b0f;--surface:#0c1117;--surface2:#111820;--surface3:#161f28;
  --border:#1a2530;--border2:#243040;
  --accent:#00e5a0;--accent2:#0066ff;--warn:#f59e0b;--danger:#ef4444;--purple:#8b5cf6;
  --text:#dce8f0;--text-muted:#3d5468;--text-dim:#7a96aa;
  --font-ui:'Syne',sans-serif;--font-mono:'DM Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{background:var(--bg);color:var(--text);font-family:var(--font-mono);overflow:hidden}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,229,160,.006) 3px,rgba(0,229,160,.006) 4px);pointer-events:none;z-index:9999}

/* LAYOUT */
.shell{display:flex;height:100vh;overflow:hidden}

/* SIDEBAR */
.sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.logo{padding:22px 18px 16px;border-bottom:1px solid var(--border)}
.logo-mark{font-family:var(--font-ui);font-weight:800;font-size:18px;color:var(--accent);display:flex;align-items:center;gap:8px}
.logo-dot{width:8px;height:8px;background:var(--accent);border-radius:50%;box-shadow:0 0 12px var(--accent);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 6px var(--accent)}50%{box-shadow:0 0 20px var(--accent),0 0 35px rgba(0,229,160,.25)}}
.logo-sub{font-size:9px;color:var(--text-muted);letter-spacing:2.5px;text-transform:uppercase;margin-top:3px}
.nav{padding:10px 0;flex:1}
.nav-group{padding:12px 16px 4px;font-size:8px;letter-spacing:2.5px;text-transform:uppercase;color:var(--text-muted)}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 16px;cursor:pointer;font-size:11px;color:var(--text-dim);transition:all .15s;border-left:2px solid transparent;user-select:none;position:relative}
.nav-item:hover{color:var(--text);background:rgba(255,255,255,.02)}
.nav-item.active{color:var(--accent);border-left-color:var(--accent);background:rgba(0,229,160,.04)}
.nav-item .icon{width:15px;text-align:center;font-size:12px;flex-shrink:0}
.nav-badge{margin-left:auto;font-size:9px;padding:1px 5px;border-radius:8px;min-width:16px;text-align:center}
.nb-danger{background:rgba(239,68,68,.2);color:var(--danger)}
.nb-warn{background:rgba(245,158,11,.2);color:var(--warn)}
.nb-accent{background:rgba(0,229,160,.15);color:var(--accent)}
.sidebar-foot{padding:12px 16px;border-top:1px solid var(--border);font-size:9.5px;color:var(--text-muted)}
.sync-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--accent);margin-right:5px;animation:pulse 2s infinite}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:52px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 22px;gap:10px;flex-shrink:0}
.topbar-title{font-family:var(--font-ui);font-weight:700;font-size:14px;flex:1}
.topbar-meta{font-size:10px;color:var(--text-muted)}
.page{flex:1;overflow-y:auto;padding:22px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:4px;font-family:var(--font-mono);font-size:11px;cursor:pointer;border:1px solid transparent;transition:all .15s;white-space:nowrap;text-decoration:none}
.btn-primary{background:var(--accent);color:#000;font-weight:500}.btn-primary:hover{background:#00ffb3;box-shadow:0 0 20px rgba(0,229,160,.3)}
.btn-ghost{background:transparent;color:var(--text-dim);border-color:var(--border)}.btn-ghost:hover{color:var(--text);border-color:var(--border2)}
.btn-danger{background:transparent;color:var(--danger);border-color:rgba(239,68,68,.3)}.btn-danger:hover{background:rgba(239,68,68,.08)}
.btn-purple{background:rgba(139,92,246,.15);color:var(--purple);border-color:rgba(139,92,246,.3)}.btn-purple:hover{background:rgba(139,92,246,.25)}
.btn-warn{background:rgba(245,158,11,.1);color:var(--warn);border-color:rgba(245,158,11,.3)}
.btn-sm{padding:4px 9px;font-size:10px}
.btn-xs{padding:2px 7px;font-size:9px}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:18px}
.card-sm{padding:13px}
.card-title{font-family:var(--font-ui);font-size:11.5px;font-weight:700;letter-spacing:.3px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.card-title-left{display:flex;align-items:center;gap:8px}

/* STATS */
.kri-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px}
.kri{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:14px 16px;position:relative;overflow:hidden;cursor:default}
.kri::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--c,var(--accent))}
.kri-label{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px}
.kri-val{font-family:var(--font-ui);font-size:24px;font-weight:800;color:var(--c,var(--accent));line-height:1}
.kri-sub{font-size:9px;color:var(--text-muted);margin-top:4px}

/* GRIDS */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}

/* FORM */
.fg{margin-bottom:13px}
.fl{display:block;font-size:8.5px;letter-spacing:1.8px;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px}
.fi{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:8px 10px;color:var(--text);font-family:var(--font-mono);font-size:11px;transition:border-color .15s;outline:none}
.fi:focus{border-color:var(--accent)}
.fi::placeholder{color:var(--text-muted)}
textarea.fi{resize:vertical;line-height:1.6}
select.fi{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%233d5468'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;cursor:pointer}
.fhint{font-size:9px;color:var(--text-muted);margin-top:3px}
.fsec{font-family:var(--font-ui);font-size:12px;font-weight:700;color:var(--text-dim);margin:20px 0 12px;padding-bottom:6px;border-bottom:1px solid var(--border)}

/* VIEWS */
.view{display:none}.view.active{display:block}

/* PAGE HEADER */
.ph{margin-bottom:20px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
.ph-left .ph-title{font-family:var(--font-ui);font-size:19px;font-weight:800;margin-bottom:3px}
.ph-left .ph-sub{font-size:11px;color:var(--text-muted)}
.ph-actions{display:flex;gap:8px;flex-shrink:0;align-items:flex-start}

/* HITS */
.hit{border-left:3px solid var(--border2);padding:11px 14px;margin-bottom:7px;background:var(--surface);border-radius:0 5px 5px 0;transition:border-color .15s}
.hit.critical{border-left-color:var(--danger)}
.hit.warning{border-left-color:var(--warn)}
.hit.info{border-left-color:var(--accent2)}
.hit-head{display:flex;align-items:center;gap:7px;margin-bottom:4px;flex-wrap:wrap}
.tag{font-size:8.5px;letter-spacing:1px;text-transform:uppercase;padding:2px 6px;border-radius:3px;font-weight:600;flex-shrink:0}
.tag-critical{background:rgba(239,68,68,.15);color:var(--danger)}
.tag-warning{background:rgba(245,158,11,.15);color:var(--warn)}
.tag-info{background:rgba(0,102,255,.15);color:var(--accent2)}
.tag-open{background:rgba(245,158,11,.15);color:var(--warn)}
.tag-progress{background:rgba(139,92,246,.15);color:var(--purple)}
.tag-closed{background:rgba(0,229,160,.1);color:var(--accent)}
.hit-source{font-size:9px;color:var(--text-muted)}
.hit-date{font-size:9px;color:var(--text-muted);margin-left:auto}
.hit-title{font-size:11.5px;font-weight:500;margin-bottom:3px;line-height:1.4}
.hit-summary{font-size:10.5px;color:var(--text-dim);line-height:1.5}
.hit-extra{margin-top:8px;display:none}
.hit-extra.open{display:block}
.hit-twin-box{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:10px;margin-top:8px}
.hit-twin-label{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent);margin-bottom:4px}
.hit-detail-row{margin-bottom:6px}
.hit-detail-label{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:2px}
.hit-detail-val{font-size:10.5px;color:var(--text-dim);line-height:1.5}
.score-bar{height:2px;background:var(--border2);border-radius:2px;margin-top:5px}
.score-fill{height:100%;border-radius:2px;transition:width .5s}

/* RADAR */
.radar-wrap{display:flex;align-items:center;gap:24px}
.radar-legend{flex:1}
.dim-row{display:flex;align-items:center;gap:8px;margin-bottom:9px;cursor:pointer;padding:5px 8px;border-radius:4px;transition:background .15s}
.dim-row:hover{background:rgba(255,255,255,.03)}
.dim-label{flex:1;font-size:11px;color:var(--text-dim)}
.dim-score{font-family:var(--font-ui);font-weight:700;font-size:12px;color:var(--accent);min-width:32px;text-align:right}
.dim-bar{height:3px;background:var(--border2);border-radius:2px;margin-top:2px}
.dim-fill{height:100%;border-radius:2px;background:var(--accent);transition:width .6s}

/* MATURITY ELEMENT */
.mel{background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:12px;margin-bottom:8px}
.mel-head{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.mel-name{flex:1;font-size:11px;font-weight:500}
.mel-score-wrap{display:flex;align-items:center;gap:6px}
.score-btn{width:26px;height:26px;border-radius:4px;border:1px solid var(--border2);background:var(--surface2);color:var(--text-muted);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:var(--font-mono)}
.score-btn:hover{border-color:var(--accent);color:var(--accent)}
.score-btn.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700}
.mel-evidence{width:100%;margin-top:6px}
.mel-actions{display:flex;gap:5px;margin-top:6px}

/* ACTION PLANS */
.ap{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:13px;margin-bottom:8px}
.ap-head{display:flex;align-items:flex-start;gap:8px;margin-bottom:7px}
.ap-title{flex:1;font-size:11.5px;font-weight:500;line-height:1.4}
.ap-meta{font-size:9.5px;color:var(--text-muted);display:flex;gap:10px;flex-wrap:wrap;margin-bottom:7px}
.ap-progress{margin-top:8px}
.ap-steps{margin-top:6px}
.ap-step{display:flex;align-items:flex-start;gap:7px;padding:5px 0;border-bottom:1px solid var(--border);font-size:10.5px;color:var(--text-dim)}
.ap-step:last-child{border-bottom:none}
.ap-step-check{width:14px;height:14px;border:1px solid var(--border2);border-radius:3px;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-top:1px}
.ap-step-check.done{background:var(--accent);border-color:var(--accent);color:#000;font-size:9px}

/* TWIN SUMMARY */
.twin-summary-box{background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:14px;font-size:11px;color:var(--text-dim);line-height:1.8;white-space:pre-wrap;min-height:120px}

/* HISTORY */
.hist-item{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);font-size:10.5px}
.hist-item:last-child{border-bottom:none}
.hist-date{color:var(--text-muted);flex-shrink:0;font-size:9.5px;min-width:100px}
.hist-score{color:var(--accent);font-weight:600;min-width:40px}
.hist-note{flex:1;color:var(--text-dim)}

/* ALERT */
.alert{padding:9px 13px;border-radius:4px;font-size:11px;margin-bottom:13px;display:flex;align-items:flex-start;gap:7px;line-height:1.5}
.alert-ok{background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.2);color:var(--accent)}
.alert-err{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:var(--danger)}
.alert-warn{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);color:var(--warn)}
.alert-info{background:rgba(0,102,255,.08);border:1px solid rgba(0,102,255,.2);color:var(--accent2)}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);z-index:500;align-items:center;justify-content:center}
.overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:24px;width:640px;max-height:90vh;overflow-y:auto;position:relative}
.modal-lg{width:820px}
.modal-title{font-family:var(--font-ui);font-size:15px;font-weight:700;margin-bottom:18px;padding-right:28px}
.modal-x{position:absolute;top:18px;right:18px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:17px;line-height:1}
.modal-x:hover{color:var(--text)}

/* BRIEF */
.brief-page{background:#fff;color:#111;padding:40px;font-family:Georgia,serif;font-size:12px;line-height:1.6;max-width:780px;margin:0 auto}
.brief-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;padding-bottom:16px;border-bottom:2px solid #000}
.brief-logo{font-size:22px;font-weight:900;letter-spacing:-1px}
.brief-date{font-size:10px;color:#666;text-align:right}
.brief-h1{font-size:18px;font-weight:700;margin-bottom:6px}
.brief-h2{font-size:13px;font-weight:700;margin:20px 0 8px;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid #ddd;padding-bottom:4px}
.brief-kri-row{display:flex;gap:16px;margin-bottom:20px}
.brief-kri{flex:1;border:1px solid #ddd;padding:12px;border-radius:4px;text-align:center}
.brief-kri-val{font-size:28px;font-weight:900;margin-bottom:3px}
.brief-kri-label{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:#666}

/* UTILS */
.flex{display:flex}.ic{align-items:center}.jb{justify-content:space-between}.gap6{gap:6px}.gap8{gap:8px}.gap12{gap:12px}
.mt6{margin-top:6px}.mt10{margin-top:10px}.mt14{margin-top:14px}.mt18{margin-top:18px}.mb8{margin-bottom:8px}.mb14{margin-bottom:14px}
.text-muted{color:var(--text-muted)}.text-dim{color:var(--text-dim)}.text-accent{color:var(--accent)}.text-danger{color:var(--danger)}.text-warn{color:var(--warn)}
.mono{font-family:var(--font-mono)}.ui{font-family:var(--font-ui)}
.divider{border:none;border-top:1px solid var(--border);margin:16px 0}
.empty{text-align:center;padding:36px 16px;color:var(--text-muted)}
.empty-icon{font-size:26px;margin-bottom:8px}
.empty-title{font-family:var(--font-ui);font-size:12px;color:var(--text-dim);margin-bottom:4px}
.empty-sub{font-size:10px}
.spin{width:13px;height:13px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:rotate .6s linear infinite;display:inline-block;flex-shrink:0}
@keyframes rotate{to{transform:rotate(360deg)}}
code{background:var(--surface2);padding:1px 5px;border-radius:3px;font-size:10.5px;color:var(--accent)}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
</style>
</head>
<body>
<div class="shell">

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="logo">
    <div class="logo-mark"><span class="logo-dot"></span>CDT</div>
    <div class="logo-sub">Compliance Digital Twin</div>
  </div>
  <div class="nav">
    <div class="nav-group">â—ˆ Mi Digital Twin</div>
    <div class="nav-item active" data-view="dashboard" onclick="go('dashboard')"><span class="icon">â—ˆ</span>Dashboard & KRIs</div>
    <div class="nav-item" data-view="contexto" onclick="go('contexto')"><span class="icon">â¬¡</span>Contexto Organizacional</div>
    <div class="nav-item" data-view="madurez" onclick="go('madurez')"><span class="icon">â—</span>Assessment de Madurez</div>
    <div class="nav-item" data-view="twin-summary" onclick="go('twin-summary')"><span class="icon">âœ¦</span>Resumen Ejecutivo Twin</div>

    <div class="nav-group" style="margin-top:10px">âŸ Monitor Activo</div>
    <div class="nav-item" data-view="hits" onclick="go('hits')"><span class="icon">âš¡</span>Hits Detectados<span class="nav-badge nb-danger" id="badge-hits">0</span></div>
    <div class="nav-item" data-view="planes" onclick="go('planes')"><span class="icon">â—‰</span>Planes de AcciÃ³n<span class="nav-badge nb-warn" id="badge-planes">0</span></div>
    <div class="nav-item" data-view="brief" onclick="go('brief')"><span class="icon">â–¤</span>Brief Ejecutivo</div>
    <div class="nav-item" data-view="fuentes" onclick="go('fuentes')"><span class="icon">ğŸ“¡</span>Fuentes & BÃºsquedas</div>

    <div class="nav-group" style="margin-top:10px">âš™ Sistema</div>
    <div class="nav-item" data-view="analisis" onclick="go('analisis')"><span class="icon">â—‰</span>AnÃ¡lisis Manual IA</div>
    <div class="nav-item" data-view="config" onclick="go('config')"><span class="icon">âš™</span>ConfiguraciÃ³n APIs</div>
  </div>
  <div class="sidebar-foot">
    <span class="sync-dot"></span><span id="foot-status">Iniciando...</span>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="tb-title">Dashboard & KRIs</div>
    <div class="topbar-meta" id="tb-meta"></div>
    <button class="btn btn-ghost" onclick="syncAll()" id="sync-btn">âŸ³ Sync</button>
    <button class="btn btn-primary" onclick="go('analisis')">+ AnÃ¡lisis</button>
  </div>

  <div class="page">

  <!-- DASHBOARD -->
  <div class="view active" id="view-dashboard">
    <div id="twin-disclaimer"></div>
    <div class="kri-grid">
      <div class="kri" style="--c:var(--accent)"><div class="kri-label">Madurez Global</div><div class="kri-val" id="kri-madurez">â€”</div><div class="kri-sub">/5.0 puntos</div></div>
      <div class="kri" style="--c:var(--danger)"><div class="kri-label">Hits CrÃ­ticos</div><div class="kri-val" id="kri-criticos">0</div><div class="kri-sub">sin plan de acciÃ³n</div></div>
      <div class="kri" style="--c:var(--warn)"><div class="kri-label">Planes Abiertos</div><div class="kri-val" id="kri-planes">0</div><div class="kri-sub">requieren atenciÃ³n</div></div>
      <div class="kri" style="--c:var(--accent2)"><div class="kri-label">Ãšltima Sync</div><div class="kri-val" style="font-size:14px;padding-top:4px" id="kri-sync">â€”</div><div class="kri-sub">actualizaciÃ³n hits</div></div>
    </div>

    <div class="g2" style="margin-bottom:16px">
      <div class="card">
        <div class="card-title"><span class="card-title-left">ğŸ“¡ Radar de Madurez</span><button class="btn btn-ghost btn-xs" onclick="go('madurez')">Ver detalle â†’</button></div>
        <div class="radar-wrap">
          <canvas id="radar-dash" width="200" height="200"></canvas>
          <div class="radar-legend" id="radar-legend-dash"></div>
        </div>
        <div id="dash-narrative" style="margin-top:12px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;font-size:10.5px;color:var(--text-dim);line-height:1.6"></div>
      </div>
      <div class="card">
        <div class="card-title"><span class="card-title-left">âš¡ Ãšltimos Hits</span><button class="btn btn-ghost btn-xs" onclick="go('hits')">Ver todos â†’</button></div>
        <div id="dash-hits"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span class="card-title-left">â—‰ Planes de AcciÃ³n Activos</span><button class="btn btn-ghost btn-xs" onclick="go('planes')">Ver todos â†’</button></div>
      <div id="dash-planes"></div>
    </div>
  </div>

  <!-- CONTEXTO ORGANIZACIONAL -->
  <div class="view" id="view-contexto">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Contexto Organizacional</div><div class="ph-sub">ISO 37301 Â§4.1-4.2 â€” Define el modelo base de tu Digital Twin</div></div>
      <div class="ph-actions">
        <button class="btn btn-purple" onclick="openDocAnalysis('contexto')">ğŸ“„ Analizar documento</button>
        <button class="btn btn-ghost" onclick="loadContexto()">Descartar</button>
        <button class="btn btn-primary" onclick="saveContexto()">Guardar â†’</button>
      </div>
    </div>
    <div id="ctx-alert"></div>

    <div class="g2" style="align-items:start">
      <div>
        <div class="fsec">Â§4.1 IdentificaciÃ³n de la OrganizaciÃ³n</div>
        <div class="fg"><label class="fl">Nombre legal de la organizaciÃ³n *</label><input type="text" class="fi" id="ctx-name" placeholder="Empresa S.A."></div>
        <div class="g2">
          <div class="fg"><label class="fl">Sector *</label>
            <select class="fi" id="ctx-sector">
              <option value="">Selecciona...</option>
              <option>Financiero / Banca</option><option>Seguros</option><option>TecnologÃ­a / Digital</option>
              <option>Salud / Farmacia</option><option>EnergÃ­a / Utilities</option><option>ConstrucciÃ³n / Real Estate</option>
              <option>AlimentaciÃ³n / FMCG</option><option>Manufactura / Industrial</option>
              <option>Transporte / LogÃ­stica</option><option>Servicios Profesionales</option>
              <option>Retail</option><option>AdministraciÃ³n PÃºblica</option><option>Otro</option>
            </select>
          </div>
          <div class="fg"><label class="fl">TamaÃ±o</label>
            <select class="fi" id="ctx-size">
              <option>Microempresa (&lt;10 empleados)</option><option>PequeÃ±a (10-49)</option>
              <option>Mediana (50-249)</option><option>Grande (250-999)</option><option>CorporaciÃ³n (1000+)</option>
            </select>
          </div>
        </div>
        <div class="g2">
          <div class="fg"><label class="fl">FacturaciÃ³n anual</label>
            <select class="fi" id="ctx-revenue">
              <option>&lt; 2M â‚¬</option><option>2-10M â‚¬</option><option>10-50M â‚¬</option>
              <option>50-250M â‚¬</option><option>250M-1B â‚¬</option><option>&gt; 1B â‚¬</option>
            </select>
          </div>
          <div class="fg"><label class="fl">Ãmbito geogrÃ¡fico</label>
            <select class="fi" id="ctx-geo">
              <option>Local / Regional</option><option>EspaÃ±a</option><option>EspaÃ±a + Portugal</option>
              <option>EspaÃ±a + LATAM</option><option>UniÃ³n Europea</option><option>Global</option>
            </select>
          </div>
        </div>
        <div class="fg"><label class="fl">DescripciÃ³n del modelo de negocio *</label>
          <textarea class="fi" id="ctx-business" rows="3" placeholder="QuÃ© hace la empresa, cÃ³mo genera valor, cadena de valor principal..."></textarea>
        </div>
        <div class="fg"><label class="fl">Estrategia y objetivos principales</label>
          <textarea class="fi" id="ctx-strategy" rows="2" placeholder="DirecciÃ³n estratÃ©gica, planes de expansiÃ³n, digitalizaciÃ³n..."></textarea>
        </div>

        <div class="fsec">Â§4.1 Contexto Externo</div>
        <div class="fg"><label class="fl">Marco legal y regulatorio aplicable</label>
          <textarea class="fi" id="ctx-legal" rows="3" placeholder="Normativa sectorial, licencias, supervisores regulatorios (CNMV, AEPD, Banco de EspaÃ±a...), legislaciÃ³n penal relevante..."></textarea>
        </div>
        <div class="fg"><label class="fl">Contexto econÃ³mico y de mercado</label>
          <textarea class="fi" id="ctx-economic" rows="2" placeholder="SituaciÃ³n competitiva, presiones de mercado, ciclo econÃ³mico..."></textarea>
        </div>
        <div class="fg"><label class="fl">Contexto social, cultural y medioambiental</label>
          <textarea class="fi" id="ctx-social" rows="2" placeholder="Expectativas sociales, compromisos ESG, impacto ambiental..."></textarea>
        </div>
        <div class="fg"><label class="fl">Tendencias futuras con impacto en compliance</label>
          <textarea class="fi" id="ctx-trends" rows="2" placeholder="Nuevas regulaciones esperadas, cambios tecnolÃ³gicos, geopolÃ­tica..."></textarea>
        </div>
      </div>

      <div>
        <div class="fsec">Â§4.1 Contexto Interno</div>
        <div class="fg"><label class="fl">Estructura organizativa</label>
          <textarea class="fi" id="ctx-structure" rows="2" placeholder="Tipo de estructura, nÃºmero de unidades, presencia internacional, subsidiarias..."></textarea>
        </div>
        <div class="fg"><label class="fl">Cultura de compliance actual</label>
          <textarea class="fi" id="ctx-culture" rows="2" placeholder="Nivel de cultura Ã©tica, historial de incidentes, tono desde la cÃºpula..."></textarea>
        </div>
        <div class="fg"><label class="fl">Recursos tecnolÃ³gicos relevantes</label>
          <textarea class="fi" id="ctx-tech" rows="2" placeholder="Sistemas de informaciÃ³n, herramientas de compliance, nivel de digitalizaciÃ³n..."></textarea>
        </div>
        <div class="fg"><label class="fl">Relaciones con terceros (scope y naturaleza)</label>
          <textarea class="fi" id="ctx-thirds" rows="2" placeholder="Proveedores crÃ­ticos, distribuidores, agentes, intermediarios, joint ventures..."></textarea>
        </div>

        <div class="fsec">Â§4.2 Partes Interesadas</div>
        <div class="fg"><label class="fl">Partes interesadas externas y sus expectativas</label>
          <textarea class="fi" id="ctx-ext-parties" rows="3" placeholder="Reguladores (CNMV, AEPD, Banco de EspaÃ±a...), clientes, inversores, proveedores, sociedad... y quÃ© esperan de nosotros en tÃ©rminos de compliance."></textarea>
        </div>
        <div class="fg"><label class="fl">Partes interesadas internas y sus expectativas</label>
          <textarea class="fi" id="ctx-int-parties" rows="2" placeholder="Consejo de administraciÃ³n, alta direcciÃ³n, empleados, auditorÃ­a interna... y sus expectativas de compliance."></textarea>
        </div>

        <div class="fsec">Normas y Obligaciones Compliance</div>
        <div class="fg"><label class="fl">Normas voluntarias adoptadas</label>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px" id="ctx-norms-checks">
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="ISO 37301"> ISO 37301</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="UNE 19601"> UNE 19601</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="ISO 37001"> ISO 37001</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="RGPD"> RGPD</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="PBC/AML"> PBC/AML</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="DORA"> DORA</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="ESG/CSRD"> ESG/CSRD</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="NIS2"> NIS2</label>
          </div>
        </div>
        <div class="fg"><label class="fl">Riesgos de compliance prioritarios identificados</label>
          <textarea class="fi" id="ctx-risks" rows="3" placeholder="Top riesgos: corrupciÃ³n, blanqueo, protecciÃ³n de datos, responsabilidad penal, conflictos de interÃ©s, conducta de mercado..."></textarea>
        </div>
        <div class="fg"><label class="fl">Historial de incidentes o sanciones relevantes</label>
          <textarea class="fi" id="ctx-incidents" rows="2" placeholder="Expedientes previos, sanciones recibidas, investigaciones, noticias negativas..."></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- ASSESSMENT DE MADUREZ -->
  <div class="view" id="view-madurez">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Assessment de Madurez</div><div class="ph-sub">ISO 37301 â€” 7 dimensiones Â· Escala 1-5</div></div>
      <div class="ph-actions">
        <button class="btn btn-ghost btn-sm" onclick="openHistory()">ğŸ“‹ Historial</button>
        <button class="btn btn-purple" onclick="openDocAnalysis('madurez')">ğŸ“„ Analizar doc</button>
        <button class="btn btn-primary" onclick="saveMaturity()">Guardar versiÃ³n â†’</button>
      </div>
    </div>
    <div id="mat-alert"></div>

    <div class="g2" style="align-items:start;margin-bottom:16px">
      <div class="card">
        <div class="card-title">Radar de Madurez</div>
        <div class="radar-wrap">
          <canvas id="radar-mat" width="200" height="200"></canvas>
          <div class="radar-legend" id="radar-legend-mat"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Puntuaciones por dimensiÃ³n</div>
        <div id="mat-scores-summary"></div>
      </div>
    </div>

    <!-- Filter bar -->
    <div class="card mb14" style="padding:12px 16px">
      <div class="flex ic gap8 flex-wrap">
        <span style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);flex-shrink:0">Filtrar:</span>
        <button class="btn btn-ghost btn-xs mat-filter-btn active" data-filter="all" onclick="setMatFilter('all')">Todos</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="0" onclick="setMatFilter('0')" style="color:var(--text-muted)">Sin evaluar</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="1" onclick="setMatFilter('1')" style="color:var(--danger)">1 â€” No existe</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="2" onclick="setMatFilter('2')" style="color:var(--warn)">2 â€” Inicial</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="3" onclick="setMatFilter('3')" style="color:#eab308">3 â€” Definido</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="4" onclick="setMatFilter('4')" style="color:var(--accent2)">4 â€” Gestionado</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="5" onclick="setMatFilter('5')" style="color:var(--accent)">5 â€” Optimizado</button>
        <div style="flex:1"></div>
        <button class="btn btn-ghost btn-xs" onclick="collapseAllDims(true)">âŠŸ Plegar todos</button>
        <button class="btn btn-ghost btn-xs" onclick="collapseAllDims(false)">âŠ Desplegar todos</button>
      </div>
    </div>

    <div id="mat-dimensions"></div>
  </div>

  <!-- TWIN SUMMARY -->
  <div class="view" id="view-twin-summary">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Resumen Ejecutivo del Twin</div><div class="ph-sub">500 palabras Â· Usado en todos los anÃ¡lisis de hits</div></div>
      <div class="ph-actions">
        <button class="btn btn-purple" id="gen-summary-btn" onclick="generateTwinSummary()">âœ¦ Generar con IA</button>
        <button class="btn btn-primary" onclick="saveTwinSummary()">Guardar â†’</button>
      </div>
    </div>
    <div id="ts-alert"></div>
    <div class="card">
      <div class="card-title">Resumen ejecutivo <span class="text-muted" style="font-weight:400;font-size:10px">Editable â€” se usa como contexto en cada anÃ¡lisis de hit</span></div>
      <textarea class="fi" id="twin-summary-text" rows="18" placeholder="Haz clic en 'Generar con IA' para crear el resumen automÃ¡ticamente a partir del contexto organizacional y el assessment de madurez.\n\nO escribe manualmente el contexto que quieres que Mistral use al analizar cada hit."></textarea>
    </div>
    <div class="card mt14">
      <div class="card-title">InformaciÃ³n del Twin</div>
      <div class="g3">
        <div><div class="fl">Ãšltima actualizaciÃ³n</div><div style="font-size:11px" id="ts-updated">â€”</div></div>
        <div><div class="fl">Contexto organizacional</div><div style="font-size:11px" id="ts-ctx-status">â€”</div></div>
        <div><div class="fl">Assessment madurez</div><div style="font-size:11px" id="ts-mat-status">â€”</div></div>
      </div>
    </div>
  </div>

  <!-- HITS -->
  <div class="view" id="view-hits">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Hits Detectados</div><div class="ph-sub">Analizados contra tu Digital Twin</div></div>
      <div class="ph-actions">
        <select class="fi" style="width:140px" id="hit-filter-level" onchange="renderHits()">
          <option value="">Todos</option><option value="critical">CrÃ­tico</option><option value="warning">Alerta</option><option value="info">Info</option>
        </select>
        <button class="btn btn-ghost" onclick="syncHits()">âŸ³ Sync</button>
      </div>
    </div>
    <div id="hits-list"></div>
  </div>

  <!-- PLANES DE ACCIÃ“N -->
  <div class="view" id="view-planes">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Planes de AcciÃ³n</div><div class="ph-sub">Seguimiento y cierre con mejora documentada</div></div>
      <div class="ph-actions">
        <select class="fi" style="width:140px" id="ap-filter" onchange="renderPlanes()">
          <option value="">Todos</option><option value="open">Abiertos</option><option value="progress">En curso</option><option value="closed">Cerrados</option>
        </select>
      </div>
    </div>
    <div id="planes-list"></div>
  </div>

  <!-- BRIEF EJECUTIVO -->
  <div class="view" id="view-brief">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Brief Ejecutivo</div><div class="ph-sub">Informe para ComitÃ© de Cumplimiento / Consejo</div></div>
      <div class="ph-actions">
        <button class="btn btn-purple" onclick="generateBrief()" id="brief-gen-btn">âœ¦ Generar con IA</button>
        <button class="btn btn-primary" onclick="printBrief()">â¬‡ Exportar PDF</button>
      </div>
    </div>
    <div id="brief-alert"></div>
    <div id="brief-content"></div>
  </div>

  <!-- FUENTES -->
  <div class="view" id="view-fuentes">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Fuentes & BÃºsquedas</div><div class="ph-sub">Configura el monitor activo</div></div>
      <div class="ph-actions"><button class="btn btn-primary" onclick="saveFuentes()">Guardar â†’</button></div>
    </div>
    <div id="fuentes-alert"></div>
    <div class="g2" style="align-items:start">
      <div class="card">
        <div class="card-title">Queries NewsAPI</div>
        <div id="queries-list"></div>
        <textarea class="fi mt10" id="new-query" rows="2" placeholder='Ej: ("fraude fiscal" OR "evasiÃ³n") AND EspaÃ±a'></textarea>
        <button class="btn btn-ghost btn-sm mt6" style="width:100%" onclick="addQuery()">+ AÃ±adir query</button>
      </div>
      <div>
        <div class="card mb14">
          <div class="card-title">Fuentes RSS</div>
          <div id="rss-list"></div>
        </div>
        <div class="card">
          <div class="card-title">Keywords adicionales</div>
          <div id="kw-list" style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px"></div>
          <div class="flex gap6">
            <input type="text" class="fi" id="new-kw" placeholder="Nueva keyword..." onkeydown="if(event.key==='Enter')addKw()">
            <button class="btn btn-ghost btn-sm" onclick="addKw()">+</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ANÃLISIS MANUAL -->
  <div class="view" id="view-analisis">
    <div class="ph"><div class="ph-left"><div class="ph-title">AnÃ¡lisis Manual IA</div><div class="ph-sub">Analiza cualquier noticia contra tu Digital Twin</div></div></div>
    <div class="g2" style="align-items:start">
      <div class="card">
        <div class="card-title">Consulta</div>
        <div class="fg"><label class="fl">Tipo de anÃ¡lisis</label>
          <select class="fi" id="an-type">
            <option value="full">AnÃ¡lisis completo vs. Digital Twin</option>
            <option value="vulnerability">Vulnerabilidad vs. controles</option>
            <option value="financial">Impacto financiero</option>
            <option value="action">Plan de acciÃ³n recomendado</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Texto a analizar</label>
          <textarea class="fi" id="an-text" rows="8" placeholder="Pega aquÃ­ noticia, sentencia, resoluciÃ³n..."></textarea>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="runManual()" id="an-btn">Analizar contra Digital Twin â†’</button>
      </div>
      <div class="card">
        <div class="card-title">Resultado</div>
        <div id="an-result"><div class="empty"><div class="empty-icon">â—‰</div><div class="empty-title">Esperando anÃ¡lisis</div></div></div>
      </div>
    </div>
  </div>

  <!-- CONFIG -->
  <div class="view" id="view-config">
    <div class="ph"><div class="ph-left"><div class="ph-title">ConfiguraciÃ³n APIs</div></div><div class="ph-actions"><button class="btn btn-primary" onclick="saveConfig()">Guardar</button></div></div>
    <div id="config-alert"></div>
    <div class="g2">
      <div class="card">
        <div class="card-title">ğŸ¤– Mistral AI</div>
        <div class="fg"><label class="fl">API Key</label><input type="password" class="fi" id="cfg-mistral-key" placeholder="sk-..."></div>
        <div class="fg"><label class="fl">Modelo</label>
          <select class="fi" id="cfg-mistral-model">
            <option value="mistral-small-latest">mistral-small (rÃ¡pido)</option>
            <option value="mistral-medium-latest">mistral-medium</option>
            <option value="mistral-large-latest">mistral-large (preciso)</option>
          </select>
        </div>
        <button class="btn btn-ghost btn-sm" style="width:100%" onclick="testMistral()">Verificar conexiÃ³n</button>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“° NewsAPI</div>
        <div class="fg"><label class="fl">API Key</label><input type="password" class="fi" id="cfg-newsapi-key"></div>
        <div class="fhint">100 req/dÃ­a en tier gratuito</div>
      </div>
    </div>
    <div class="card mt14">
      <div class="card-title">âš™ ParÃ¡metros</div>
      <div class="g3">
        <div class="fg"><label class="fl">Umbral de relevancia (0-100)</label><input type="number" class="fi" id="cfg-threshold" value="60" min="0" max="100"><div class="fhint">Score mÃ­nimo para publicar hit</div></div>
        <div class="fg"><label class="fl">Repo GitHub</label><input type="text" class="fi" id="cfg-repo" placeholder="avespa/digitaltwin"></div>
        <div class="fg"><label class="fl">DÃ­as hasta aviso Twin obsoleto</label><input type="number" class="fi" id="cfg-twin-days" value="90" min="7"></div>
      </div>
    </div>
  </div>

  </div><!-- /page -->
</div><!-- /main -->
</div><!-- /shell -->

<!-- MODAL ANÃLISIS DOCUMENTO -->
<div class="overlay" id="modal-doc">
  <div class="modal modal-lg">
    <div class="modal-title" id="doc-modal-title">Analizar documento con IA</div>
    <button class="modal-x" onclick="closeModal('modal-doc')">âœ•</button>

    <!-- Paso 1: cargar documentos -->
    <div id="doc-step1">
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:10px">
        Puedes aÃ±adir varios documentos. La IA los analizarÃ¡ todos juntos o por separado.
      </div>

      <!-- Lista de documentos acumulados -->
      <div id="doc-queue-list" style="margin-bottom:10px"></div>

      <!-- AÃ±adir nuevo doc -->
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:12px;margin-bottom:10px">
        <div class="fg">
          <label class="fl">AÃ±adir archivo</label>
          <input type="file" class="fi" id="doc-file" accept=".pdf,.txt,.docx,.doc" multiple>
          <div class="fhint mt6">âœ“ .docx â€” extracciÃ³n perfecta &nbsp;Â·&nbsp; âœ“ .txt â€” texto plano &nbsp;Â·&nbsp; âš  .pdf â€” solo si no estÃ¡ escaneado</div>
        </div>
        <div class="fg"><label class="fl">O pega texto directamente</label><textarea class="fi" id="doc-text" rows="3" placeholder="Pega el texto aquÃ­..."></textarea></div>
        <button class="btn btn-ghost btn-sm" style="width:100%" onclick="addDocToQueue()">+ AÃ±adir a la cola</button>
      </div>

      <div id="doc-alert"></div>

      <div class="flex gap8 mt10" style="justify-content:flex-end">
        <button class="btn btn-ghost" onclick="closeModal('modal-doc')">Cancelar</button>
        <button class="btn btn-ghost" id="doc-analyze-one-btn" onclick="analyzeDocQueue(false)" style="display:none">Analizar Ãºltimo â†’</button>
        <button class="btn btn-primary" id="doc-analyze-all-btn" onclick="analyzeDocQueue(true)" style="display:none">Analizar todos con IA â†’</button>
      </div>
    </div>

    <!-- Resultado -->
    <div id="doc-result" style="margin-top:14px"></div>
  </div>
</div>

<!-- MODAL PLAN DE ACCIÃ“N -->
<div class="overlay" id="modal-ap">
  <div class="modal modal-lg">
    <div class="modal-title" id="ap-modal-title">Plan de AcciÃ³n</div>
    <button class="modal-x" onclick="closeModal('modal-ap')">âœ•</button>
    <div class="g2">
      <div>
        <div class="fg"><label class="fl">TÃ­tulo del plan *</label><input type="text" class="fi" id="ap-title" placeholder="Ej: Reforzar control de terceros..."></div>
        <div class="fg"><label class="fl">Control de madurez afectado</label><input type="text" class="fi" id="ap-control" placeholder="Ej: OPERACIÃ“N - Due diligence de terceros"></div>
        <div class="fg"><label class="fl">DimensiÃ³n ISO 37301</label>
          <select class="fi" id="ap-dim">
            <option value="">Ninguna especÃ­fica</option>
            <option>1. Contexto</option><option>2. Liderazgo</option><option>3. PlanificaciÃ³n</option>
            <option>4. Soporte</option><option>5. OperaciÃ³n</option><option>6. EvaluaciÃ³n</option><option>7. Mejora</option>
          </select>
        </div>
        <div class="g2">
          <div class="fg"><label class="fl">Responsable</label><input type="text" class="fi" id="ap-owner" placeholder="Compliance Officer"></div>
          <div class="fg"><label class="fl">Fecha lÃ­mite</label><input type="date" class="fi" id="ap-deadline"></div>
        </div>
        <div class="fg"><label class="fl">Prioridad</label>
          <select class="fi" id="ap-priority">
            <option value="critical">ğŸ”´ CrÃ­tica</option><option value="high">ğŸŸ  Alta</option>
            <option value="medium">ğŸŸ¡ Media</option><option value="low">ğŸŸ¢ Baja</option>
          </select>
        </div>
        <div class="fg"><label class="fl">DescripciÃ³n y objetivo</label><textarea class="fi" id="ap-desc" rows="3" placeholder="QuÃ© se quiere conseguir y por quÃ©..."></textarea></div>
      </div>
      <div>
        <div class="fl" style="margin-bottom:8px">Pasos / Acciones</div>
        <div id="ap-steps-list"></div>
        <div class="flex gap6 mt6">
          <input type="text" class="fi" id="ap-new-step" placeholder="Nueva acciÃ³n..." onkeydown="if(event.key==='Enter')addApStep()">
          <button class="btn btn-ghost btn-sm" onclick="addApStep()">+</button>
        </div>
        <div class="divider"></div>
        <div class="fg"><label class="fl">Mejora documentada al cierre</label><textarea class="fi" id="ap-improvement" rows="3" placeholder="Al cerrar: quÃ© mejorÃ³, quÃ© controles se actualizaron, quÃ© evidencia se generÃ³..."></textarea></div>
        <div class="fg"><label class="fl">Estado</label>
          <select class="fi" id="ap-status">
            <option value="open">Abierto</option><option value="progress">En curso</option><option value="closed">Cerrado</option>
          </select>
        </div>
        <div id="ap-close-note" style="display:none">
          <div class="alert alert-warn mt6">Al cerrar el plan, se actualizarÃ¡ automÃ¡ticamente el elemento de madurez asociado.</div>
        </div>
      </div>
    </div>
    <div class="flex gap8 mt14" style="justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('modal-ap')">Cancelar</button>
      <button class="btn btn-danger btn-sm" id="ap-delete-btn" style="display:none" onclick="deleteAp()">Eliminar</button>
      <button class="btn btn-primary" onclick="saveAp()">Guardar plan</button>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL MADUREZ -->
<div class="overlay" id="modal-history">
  <div class="modal">
    <div class="modal-title">Historial de Madurez</div>
    <button class="modal-x" onclick="closeModal('modal-history')">âœ•</button>
    <div id="history-list"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FB_CFG = {
  apiKey:            "AIzaSyDFcMb0QmLwCMSAu4LydryNvpAwoCHUQrY",
  authDomain:        "digitaltwin-21a64.firebaseapp.com",
  projectId:         "digitaltwin-21a64",
  storageBucket:     "digitaltwin-21a64.appspot.com",
  messagingSenderId: "placeholder",
  appId:             "placeholder"
};
firebase.initializeApp(FB_CFG);
const db = firebase.firestore();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let S = {
  cfg: { mistralKey:'', mistralModel:'mistral-small-latest', newsapiKey:'', threshold:60, repo:'avespa/digitaltwin', twinDays:90 },
  ctx: {},       // organization context
  maturity: {},  // maturity assessment
  twinSummary: '',
  hits: [],
  actionPlans: [],
  remoteCfg: { newsapi_queries:[], newsapi_sources:'', custom_keywords:[], rss_enabled:{} },
  lastSync: null,
};

// Local cache
function lsGet(k){ try{ return JSON.parse(localStorage.getItem('cdt_'+k)||'null'); }catch(e){ return null; } }
function lsSet(k,v){ try{ localStorage.setItem('cdt_'+k, JSON.stringify(v)); }catch(e){} }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATURITY MODEL â€” ISO 37301
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DIMS = [
  { id:'contexto', label:'Contexto', icon:'â¬¡', color:'#00e5a0',
    elements:[
      { id:'ctx1', label:'ComprensiÃ³n del contexto organizacional (Â§4.1)' },
      { id:'ctx2', label:'IdentificaciÃ³n de partes interesadas (Â§4.2)' },
      { id:'ctx3', label:'Obligaciones de compliance identificadas (Â§4.5)' },
      { id:'ctx4', label:'EvaluaciÃ³n de riesgos de compliance (Â§4.6)' },
    ]
  },
  { id:'liderazgo', label:'Liderazgo', icon:'â˜…', color:'#8b5cf6',
    elements:[
      { id:'lid1', label:'Compromiso del Ã³rgano de gobierno (Â§5.1.1)' },
      { id:'lid2', label:'Cultura de compliance (Â§5.1.2)' },
      { id:'lid3', label:'Gobernanza de compliance (Â§5.1.3)' },
      { id:'lid4', label:'PolÃ­tica de compliance (Â§5.2)' },
      { id:'lid5', label:'FunciÃ³n de compliance: independencia y autoridad (Â§5.3.2)' },
    ]
  },
  { id:'planificacion', label:'PlanificaciÃ³n', icon:'â—', color:'#0066ff',
    elements:[
      { id:'plan1', label:'Acciones para abordar riesgos (Â§6.1)' },
      { id:'plan2', label:'Objetivos de compliance medibles (Â§6.2)' },
      { id:'plan3', label:'PlanificaciÃ³n de cambios (Â§6.3)' },
    ]
  },
  { id:'soporte', label:'Soporte', icon:'â¬Ÿ', color:'#f59e0b',
    elements:[
      { id:'sop1', label:'Recursos asignados al sistema (Â§7.1)' },
      { id:'sop2', label:'Competencia y formaciÃ³n del personal (Â§7.2)' },
      { id:'sop3', label:'ConcienciaciÃ³n en compliance (Â§7.3)' },
      { id:'sop4', label:'ComunicaciÃ³n interna y externa (Â§7.4)' },
      { id:'sop5', label:'InformaciÃ³n documentada (Â§7.5)' },
    ]
  },
  { id:'operacion', label:'OperaciÃ³n', icon:'â—ˆ', color:'#ef4444',
    elements:[
      { id:'op1', label:'Controles operacionales implementados (Â§8.1-8.2)' },
      { id:'op2', label:'Canal de denuncias / Whistleblowing (Â§8.3)' },
      { id:'op3', label:'Procesos de investigaciÃ³n (Â§8.4)' },
      { id:'op4', label:'Due diligence de terceros (Â§8.1)' },
      { id:'op5', label:'CÃ³digo de conducta y procedimientos (Â§8.1)' },
    ]
  },
  { id:'evaluacion', label:'EvaluaciÃ³n', icon:'â—‰', color:'#06b6d4',
    elements:[
      { id:'ev1', label:'MonitorizaciÃ³n y mediciÃ³n de compliance (Â§9.1)' },
      { id:'ev2', label:'KPIs/KRIs de compliance definidos (Â§9.1.3)' },
      { id:'ev3', label:'Reporting de compliance (Â§9.1.4)' },
      { id:'ev4', label:'AuditorÃ­a interna del sistema (Â§9.2)' },
      { id:'ev5', label:'RevisiÃ³n por la direcciÃ³n (Â§9.3)' },
    ]
  },
  { id:'mejora', label:'Mejora', icon:'â†‘', color:'#10b981',
    elements:[
      { id:'mej1', label:'Mejora continua del sistema (Â§10.1)' },
      { id:'mej2', label:'GestiÃ³n de no conformidades (Â§10.2)' },
      { id:'mej3', label:'Acciones correctivas documentadas (Â§10.2)' },
    ]
  },
];

const SCORE_LABELS = {
  1:'No existe / No implementado',
  2:'Inicial / Ad hoc',
  3:'Definido / Documentado',
  4:'Gestionado / Medido',
  5:'Optimizado / Mejora continua'
};

const RSS_LABELS = {
  BOE_disposiciones:'BOE - Disposiciones generales',
  BOE_justicia:'BOE - AdministraciÃ³n de Justicia',
  BOE_anuncios:'BOE - Anuncios oficiales',
  BOE_derecho_penal:'BOE - Derecho Penal',
  BOE_derecho_mercantil:'BOE - Derecho Mercantil',
  BOE_sistema_financiero:'BOE - Sistema Financiero',
  BOE_tribunal_constitucional:'BOE - Tribunal Constitucional',
  BORME_general:'BORME - Registro Mercantil',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TITLES = {
  dashboard:'Dashboard & KRIs', contexto:'Contexto Organizacional', madurez:'Assessment de Madurez',
  'twin-summary':'Resumen Ejecutivo del Twin', hits:'Hits Detectados', planes:'Planes de AcciÃ³n',
  brief:'Brief Ejecutivo', fuentes:'Fuentes & BÃºsquedas', analisis:'AnÃ¡lisis Manual IA', config:'ConfiguraciÃ³n APIs'
};

function go(name){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('view-'+name)?.classList.add('active');
  document.querySelector(`.nav-item[data-view="${name}"]`)?.classList.add('active');
  document.getElementById('tb-title').textContent = TITLES[name]||name;
  if(name==='madurez') renderMaturity();
  if(name==='hits') renderHits();
  if(name==='planes') renderPlanes();
  if(name==='dashboard') renderDashboard();
  if(name==='fuentes') renderFuentes();
  if(name==='twin-summary') renderTwinSummaryPage();
  if(name==='config') loadConfig();
  if(name==='contexto') loadContexto();
  if(name==='brief') renderBriefPlaceholder();
}

function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function openModal(id){ document.getElementById(id).classList.add('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIRESTORE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fsGet(col, doc){ try{ const s=await db.collection(col).doc(doc||'main').get(); return s.exists?s.data():null; }catch(e){ console.warn('fsGet',e); return null; } }
async function fsSet(col, doc, data){ try{ await db.collection(col).doc(doc||'main').set({...data, _updated: new Date().toISOString()}, {merge:true}); return true; }catch(e){ console.error('fsSet',e); return false; } }
async function fsAdd(col, data){ try{ const r=await db.collection(col).add({...data, _created: new Date().toISOString()}); return r.id; }catch(e){ console.error('fsAdd',e); return null; } }
async function fsUpdate(col, id, data){ try{ await db.collection(col).doc(id).update({...data, _updated: new Date().toISOString()}); return true; }catch(e){ console.error('fsUpdate',e); return false; } }
async function fsDelete(col, id){ try{ await db.collection(col).doc(id).delete(); return true; }catch(e){ return false; } }
async function fsList(col, orderBy='_created', dir='desc'){ try{ const s=await db.collection(col).orderBy(orderBy,dir).limit(200).get(); return s.docs.map(d=>({id:d.id,...d.data()})); }catch(e){ console.warn('fsList',e); return []; } }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncAll(){
  setStatus('Sincronizando...');
  document.getElementById('sync-btn').innerHTML='<span class="spin"></span>';
  try{
    const [ctx, mat, ts, plans, cfg] = await Promise.all([
      fsGet('organization','main'),
      fsGet('maturity','current'),
      fsGet('twin_summary','main'),
      fsList('action_plans'),
      fsGet('config','main'),
    ]);
    if(ctx){ S.ctx = ctx; lsSet('ctx', ctx); }
    if(mat){ S.maturity = mat; lsSet('mat', mat); }
    if(ts){ S.twinSummary = ts.text||''; lsSet('ts', ts.text||''); }
    S.actionPlans = plans || [];
    if(cfg){ S.remoteCfg = {...S.remoteCfg,...cfg}; }

    // Hits: try Firestore first, fallback to GitHub raw JSON
    const fsHits = await fsList('hits');
    if(fsHits && fsHits.length > 0){
      S.hits = fsHits;
    } else {
      // Fetcher writes to GitHub â€” read directly from raw
      await syncHitsFromGitHub();
    }

    S.lastSync = new Date().toISOString();
    lsSet('hits', S.hits);
    lsSet('plans', S.actionPlans);
    renderAll();
    setStatus('Sync âœ“ '+fmtTime(S.lastSync));
    document.getElementById('tb-meta').textContent = 'Sync: '+fmtTime(S.lastSync);
  }catch(e){
    setStatus('Error sync');
    console.error('syncAll error:', e);
  }
  document.getElementById('sync-btn').textContent='âŸ³ Sync';
}

async function syncHitsFromGitHub(){
  const repo = S.cfg.repo || 'avespa/digitaltwin';
  const url = `https://raw.githubusercontent.com/${repo}/main/data/hits.json?t=${Date.now()}`;
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    const ghHits = data.hits || [];
    if(ghHits.length > 0){
      // Mirror to Firestore for future use
      S.hits = ghHits;
      // Write each hit to Firestore if not already there (batch by checking ids)
      const fsHits = await fsList('hits');
      const fsIds = new Set(fsHits.map(h=>h.id||h.link));
      const newHits = ghHits.filter(h=>!fsIds.has(h.id||h.link));
      for(const hit of newHits.slice(0,50)){ // max 50 at a time
        await fsAdd('hits', hit);
      }
      console.log(`GitHub hits: ${ghHits.length} total, ${newHits.length} nuevos mirrored a Firestore`);
    }
  }catch(e){
    console.warn('GitHub hits sync failed:', e.message);
    // Use cached local hits
    const cached = lsGet('hits');
    if(cached && cached.length) S.hits = cached;
  }
}

async function syncHits(){
  // Try both sources
  const fsHits = await fsList('hits');
  if(fsHits && fsHits.length>0){
    S.hits = fsHits;
  } else {
    await syncHitsFromGitHub();
  }
  lsSet('hits', S.hits);
  renderHits();
  updateBadges();
}

function restoreLocal(){
  const ctx  = lsGet('ctx');  if(ctx)  S.ctx     = ctx;
  const mat  = lsGet('mat');  if(mat)  S.maturity = mat;
  const ts   = lsGet('ts');   if(ts)   S.twinSummary = ts;
  const hits = lsGet('hits'); if(hits) S.hits = hits;
  const plans= lsGet('plans');if(plans)S.actionPlans = plans;
  const cfg  = lsGet('cfg');  if(cfg)  S.cfg = {...S.cfg,...cfg};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  renderDashboard();
  renderHits();
  renderPlanes();
  updateBadges();
}

function renderDashboard(){
  // Twin disclaimer
  const lastCtxUpdate = S.ctx?._updated;
  const daysSince = lastCtxUpdate ? Math.floor((Date.now()-new Date(lastCtxUpdate))/86400000) : null;
  const disc = document.getElementById('twin-disclaimer');
  if(!S.twinSummary){
    disc.innerHTML=`<div class="alert alert-warn mb14">âš  El Resumen del Digital Twin estÃ¡ vacÃ­o. <button class="btn btn-ghost btn-xs" onclick="go('twin-summary')">Configurar â†’</button></div>`;
  } else if(daysSince !== null && daysSince > (S.cfg.twinDays||90)){
    disc.innerHTML=`<div class="alert alert-warn mb14">âš  El Digital Twin no se actualiza hace <strong>${daysSince} dÃ­as</strong>. Considera revisar el contexto y la madurez. <button class="btn btn-ghost btn-xs" onclick="go('contexto')">Revisar â†’</button></div>`;
  } else {
    disc.innerHTML='';
  }

  // KRIs
  const globalScore = calcGlobalScore();
  document.getElementById('kri-madurez').textContent = globalScore>0 ? globalScore.toFixed(1) : 'â€”';
  const crits = S.hits.filter(h=>h.level==='critical' && !S.actionPlans.find(p=>p.hit_id===h.id && p.status!=='open')).length;
  document.getElementById('kri-criticos').textContent = crits;
  document.getElementById('kri-planes').textContent = S.actionPlans.filter(p=>p.status!=='closed').length;
  document.getElementById('kri-sync').textContent = S.lastSync ? fmtTime(S.lastSync) : 'â€”';

  // Radar
  drawRadar('radar-dash', getDimScores());
  renderRadarLegend('radar-legend-dash', true);

  // Narrative
  const narrative = S.twinSummary ?
    `<em>Twin activo.</em> Madurez global: ${globalScore.toFixed(1)}/5. ${S.hits.filter(h=>h.level==='critical').length} hits crÃ­ticos Â· ${S.actionPlans.filter(p=>p.status!=='closed').length} planes abiertos.` :
    'Configura el Digital Twin para ver el anÃ¡lisis contextualizado.';
  document.getElementById('dash-narrative').innerHTML = narrative;

  // Recent hits
  const dh = document.getElementById('dash-hits');
  const recent = S.hits.slice(0,4);
  dh.innerHTML = recent.length ? recent.map(h=>miniHit(h)).join('') :
    `<div class="empty"><div class="empty-icon">âŸ</div><div class="empty-sub">Sin hits Â· ejecuta el workflow en GitHub</div></div>`;

  // Planes
  const dp = document.getElementById('dash-planes');
  const open = S.actionPlans.filter(p=>p.status!=='closed').slice(0,4);
  dp.innerHTML = open.length ? open.map(p=>miniPlan(p)).join('') :
    `<div class="empty"><div class="empty-sub">Sin planes abiertos</div></div>`;
}

function miniHit(h){
  return `<div class="flex ic gap8 mb8" style="padding:7px;background:var(--bg);border-radius:4px;border-left:2px solid ${levelColor(h.level)}">
    <span class="tag tag-${h.level||'info'}" style="flex-shrink:0">${levelLabel(h.level)}</span>
    <span style="font-size:10.5px;flex:1;line-height:1.3">${esc(h.title?.slice(0,70))}${h.title?.length>70?'...':''}</span>
    <span style="font-size:9px;color:var(--text-muted);flex-shrink:0">${fmtDate(h.fetched_at)}</span>
  </div>`;
}

function miniPlan(p){
  const priority = {critical:'ğŸ”´',high:'ğŸŸ ',medium:'ğŸŸ¡',low:'ğŸŸ¢'}[p.priority]||'âšª';
  return `<div class="flex ic gap8 mb8" style="padding:7px;background:var(--bg);border-radius:4px;cursor:pointer" onclick="openApModal('${p.id}')">
    <span>${priority}</span>
    <span class="tag tag-${p.status||'open'}" style="flex-shrink:0">${p.status||'open'}</span>
    <span style="font-size:10.5px;flex:1">${esc(p.title?.slice(0,65))}${p.title?.length>65?'...':''}</span>
    <span style="font-size:9px;color:var(--text-muted)">${p.deadline||''}</span>
  </div>`;
}

function updateBadges(){
  const crits = S.hits.filter(h=>h.level==='critical').length;
  document.getElementById('badge-hits').textContent = crits;
  const openPlans = S.actionPlans.filter(p=>p.status!=='closed').length;
  document.getElementById('badge-planes').textContent = openPlans;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTEXTO ORGANIZACIONAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadContexto(){
  const c = S.ctx||{};
  const fields = ['name','sector','size','revenue','geo','business','strategy','legal','economic','social','trends','structure','culture','tech','thirds','ext-parties','int-parties','risks','incidents'];
  fields.forEach(f=>{ const el=document.getElementById('ctx-'+f); if(el&&c[f]) el.value=c[f]; });
  document.querySelectorAll('.ctx-norm').forEach(cb=>{ cb.checked=!!(c.norms||[]).includes(cb.value); });
}

async function saveContexto(){
  const ctx = {
    name:       val('ctx-name'),   sector:     val('ctx-sector'),
    size:       val('ctx-size'),   revenue:    val('ctx-revenue'),
    geo:        val('ctx-geo'),    business:   val('ctx-business'),
    strategy:   val('ctx-strategy'),legal:     val('ctx-legal'),
    economic:   val('ctx-economic'),social:    val('ctx-social'),
    trends:     val('ctx-trends'), structure:  val('ctx-structure'),
    culture:    val('ctx-culture'),tech:       val('ctx-tech'),
    thirds:     val('ctx-thirds'),
    'ext-parties': val('ctx-ext-parties'),
    'int-parties': val('ctx-int-parties'),
    risks:      val('ctx-risks'),  incidents:  val('ctx-incidents'),
    norms:      [...document.querySelectorAll('.ctx-norm:checked')].map(c=>c.value),
  };
  if(!ctx.name||!ctx.sector){ showAlert('ctx-alert','Nombre y sector son obligatorios','err'); return; }
  S.ctx = ctx;
  const ok = await fsSet('organization','main', ctx);
  lsSet('ctx', ctx);
  showAlert('ctx-alert', ok?'âœ“ Contexto guardado en Firestore':'Error al guardar','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATURITY ASSESSMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDimScores(){
  const mat = S.maturity||{};
  return DIMS.map(d=>{
    const scores = d.elements.map(e=>parseInt(mat[e.id])||0).filter(s=>s>0);
    return scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
  });
}

function calcGlobalScore(){
  const scores = getDimScores().filter(s=>s>0);
  return scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
}

let matFilter = 'all';

function setMatFilter(f){
  matFilter = f;
  document.querySelectorAll('.mat-filter-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.filter===f);
  });
  applyMatFilter();
}

function applyMatFilter(){
  const mat = S.maturity||{};
  document.querySelectorAll('.mel[data-elem-id]').forEach(el=>{
    const id = el.dataset.elemId;
    const score = parseInt(mat[id])||0;
    let show = true;
    if(matFilter==='0') show = score===0;
    else if(matFilter!=='all') show = score===parseInt(matFilter);
    el.style.display = show ? '' : 'none';
  });

  // Hide whole dim card if all elements hidden
  DIMS.forEach(d=>{
    const body = document.getElementById('dim-body-'+d.id);
    if(!body) return;
    const visible = [...body.querySelectorAll('.mel')].some(el=>el.style.display!=='none');
    const card = body.closest('.card');
    if(card) card.style.display = visible ? '' : 'none';
  });
}

function collapseAllDims(collapse){
  DIMS.forEach(d=>{
    const body = document.getElementById('dim-body-'+d.id);
    if(body) body.style.display = collapse ? 'none' : '';
  });
}

function scoreColor(s){
  return {1:'var(--danger)',2:'var(--warn)',3:'#eab308',4:'var(--accent2)',5:'var(--accent)'}[s]||'var(--text-muted)';
}

function renderMaturity(){
  const mat = S.maturity||{};
  drawRadar('radar-mat', getDimScores());
  renderRadarLegend('radar-legend-mat', false);
  renderMatScoresSummary();

  const container = document.getElementById('mat-dimensions');
  container.innerHTML = DIMS.map(d=>{
    const dimScore = getDimScores()[DIMS.indexOf(d)];
    const dimColor = dimScore>=4?'var(--accent)':dimScore>=3?'#eab308':dimScore>=2?'var(--warn)':dimScore>0?'var(--danger)':d.color;
    return `
    <div class="card mb14">
      <div class="card-title" style="cursor:pointer" onclick="toggleDim('dim-body-${d.id}')">
        <span class="card-title-left">
          <span style="color:${d.color};font-size:14px">${d.icon}</span>
          <span style="font-family:var(--font-ui);font-weight:700">${d.label}</span>
          <span style="font-size:10px;color:var(--text-muted);font-weight:400">Â§ ISO 37301</span>
        </span>
        <div class="flex ic gap8">
          <div style="display:flex;gap:3px">
            ${d.elements.map(e=>{
              const s=parseInt(mat[e.id])||0;
              return `<span style="width:8px;height:8px;border-radius:2px;background:${s>0?scoreColor(s):'var(--border2)'};display:inline-block" title="${e.label}: ${s||'sin evaluar'}"></span>`;
            }).join('')}
          </div>
          <span style="font-family:var(--font-ui);font-weight:800;color:${dimColor};font-size:14px;min-width:36px;text-align:right">${dimScore>0?dimScore.toFixed(1):'â€”'}/5</span>
          <span style="color:var(--text-muted);font-size:11px" id="dim-caret-${d.id}">â–¾</span>
        </div>
      </div>
      <div id="dim-body-${d.id}">
        ${d.elements.map(e=>{
          const s = parseInt(mat[e.id])||0;
          const sc = s>0?scoreColor(s):'var(--border2)';
          return `
          <div class="mel" data-elem-id="${e.id}">
            <div class="mel-head">
              <div style="display:flex;align-items:center;gap:6px;flex:1">
                <span style="width:10px;height:10px;border-radius:2px;background:${sc};flex-shrink:0;display:inline-block"></span>
                <span class="mel-name">${e.label}</span>
                ${s>0?`<span style="font-size:9px;color:${sc};font-weight:600">${SCORE_LABELS[s]}</span>`:'<span style="font-size:9px;color:var(--text-muted)">sin evaluar</span>'}
              </div>
              <div class="mel-score-wrap">
                ${[1,2,3,4,5].map(n=>`<button class="score-btn ${s===n?'active':''}" style="${s===n?`background:${scoreColor(n)};border-color:${scoreColor(n)}`:''}" onclick="setScore('${e.id}',${n},'${d.id}')" title="${SCORE_LABELS[n]}">${n}</button>`).join('')}
              </div>
            </div>
            <textarea class="fi mel-evidence" id="ev-${e.id}" rows="2" placeholder="Evidencias, documentos, notas..." onchange="saveMatQuick('${e.id}','ev')">${mat['ev_'+e.id]||''}</textarea>
            <div class="mel-actions">
              <button class="btn btn-ghost btn-xs" onclick="openDocAnalysis('element','${e.id}','${e.label}')">ğŸ“„ Analizar doc</button>
              <button class="btn btn-ghost btn-xs" onclick="openApFromElement('${d.label}','${e.label}')">+ Plan de acciÃ³n</button>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }).join('');

  applyMatFilter();
}

function toggleDim(id){
  const el = document.getElementById(id);
  if(!el) return;
  const collapsed = el.style.display==='none';
  el.style.display = collapsed ? '' : 'none';
  const dimId = id.replace('dim-body-','');
  const caret = document.getElementById('dim-caret-'+dimId);
  if(caret) caret.textContent = collapsed ? 'â–¾' : 'â–¸';
}

function setScore(elemId, score, dimId){
  if(!S.maturity) S.maturity={};
  S.maturity[elemId] = score;
  const sc = scoreColor(score);

  // Update score buttons and visual elements without full re-render
  const mel = document.querySelector(`.mel[data-elem-id="${elemId}"]`);
  if(mel){
    mel.querySelectorAll('.score-btn').forEach(btn=>{
      const n = parseInt(btn.textContent);
      const active = n===score;
      btn.classList.toggle('active', active);
      btn.style.background = active ? scoreColor(n) : '';
      btn.style.borderColor = active ? scoreColor(n) : '';
      btn.style.color = active ? '#000' : '';
    });
    const dot = mel.querySelector('span[style*="width:10px"]');
    if(dot) dot.style.background = sc;
    const labelSpan = mel.querySelector('.mel-head span[style*="font-size:9px"]');
    if(labelSpan){
      labelSpan.style.color = sc;
      labelSpan.style.fontWeight = '600';
      labelSpan.textContent = SCORE_LABELS[score]||'';
    }
  }

  // Update dim header dots and score
  const d = DIMS.find(x=>x.elements.some(e=>e.id===elemId));
  if(d){
    const dimBody = document.getElementById('dim-body-'+d.id);
    const dimCard = dimBody ? dimBody.closest('.card') : null;
    if(dimCard){
      const dots = dimCard.querySelector('div[style*="display:flex;gap:3px"]');
      if(dots){
        dots.innerHTML = d.elements.map(e=>{
          const s2=parseInt(S.maturity[e.id])||0;
          return `<span style="width:8px;height:8px;border-radius:2px;background:${s2>0?scoreColor(s2):'var(--border2)'};display:inline-block" title="${e.label}: ${s2||'sin evaluar'}"></span>`;
        }).join('');
      }
      const dimScores = getDimScores();
      const di = DIMS.indexOf(d);
      const ds = di>=0 ? dimScores[di] : 0;
      const dc = ds>=4?'var(--accent)':ds>=3?'#eab308':ds>=2?'var(--warn)':ds>0?'var(--danger)':d.color;
      const scoreSpan = dimCard.querySelector('span[style*="font-weight:800"]');
      if(scoreSpan){ scoreSpan.textContent = (ds>0?ds.toFixed(1):'\u2014')+'/5'; scoreSpan.style.color=dc; }
    }
  }

  renderMatScoresSummary();
  drawRadar('radar-mat', getDimScores());
  renderRadarLegend('radar-legend-mat', false);
  drawRadar('radar-dash', getDimScores());
}

function saveMatQuick(elemId, type){
  if(!S.maturity) S.maturity={};
  const ev = document.getElementById('ev-'+elemId);
  if(ev) S.maturity['ev_'+elemId] = ev.value;
}

async function saveMaturity(){
  const mat = S.maturity||{};
  // Collect all textarea evidences
  document.querySelectorAll('[id^="ev-"]').forEach(ta=>{
    const key = 'ev_'+ta.id.replace('ev-','');
    mat[key] = ta.value;
  });
  S.maturity = mat;

  // Save current
  const ok = await fsSet('maturity','current', mat);

  // Save to history
  const globalScore = calcGlobalScore();
  await fsAdd('maturity_history',{
    scores: getDimScores(),
    globalScore,
    snapshot: mat,
    note: `Madurez global: ${globalScore.toFixed(1)}/5`,
  });

  lsSet('mat', mat);
  showAlert('mat-alert', ok?`âœ“ Assessment guardado. Madurez global: ${globalScore.toFixed(1)}/5`:'Error','ok');
  renderDashboard();
}

function renderMatScoresSummary(){
  const scores = getDimScores();
  document.getElementById('mat-scores-summary').innerHTML = DIMS.map((d,i)=>`
    <div class="dim-row" onclick="go('madurez')">
      <span style="color:${d.color};font-size:12px">${d.icon}</span>
      <span class="dim-label">${d.label}</span>
      <span class="dim-score" style="color:${d.color}">${scores[i]>0?scores[i].toFixed(1):'â€”'}</span>
      <div style="width:60px"><div class="dim-bar"><div class="dim-fill" style="width:${scores[i]/5*100}%;background:${d.color}"></div></div></div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RADAR CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawRadar(canvasId, scores){
  const canvas = document.getElementById(canvasId);
  if(!canvas) return;
  const ctx2 = canvas.getContext('2d');
  const W=canvas.width, H=canvas.height, cx=W/2, cy=H/2, r=Math.min(W,H)/2-22;
  const N=DIMS.length;
  ctx2.clearRect(0,0,W,H);

  // Grid
  for(let ring=1;ring<=5;ring++){
    ctx2.beginPath();
    for(let i=0;i<N;i++){
      const angle = (i/N)*Math.PI*2 - Math.PI/2;
      const pr = r*ring/5;
      const x = cx+pr*Math.cos(angle), y = cy+pr*Math.sin(angle);
      i===0?ctx2.moveTo(x,y):ctx2.lineTo(x,y);
    }
    ctx2.closePath();
    ctx2.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx2.lineWidth=1; ctx2.stroke();
  }

  // Axes
  for(let i=0;i<N;i++){
    const angle=(i/N)*Math.PI*2-Math.PI/2;
    ctx2.beginPath();
    ctx2.moveTo(cx,cy);
    ctx2.lineTo(cx+r*Math.cos(angle),cy+r*Math.sin(angle));
    ctx2.strokeStyle='rgba(255,255,255,0.08)';
    ctx2.lineWidth=1; ctx2.stroke();
  }

  // Data
  ctx2.beginPath();
  scores.forEach((s,i)=>{
    const angle=(i/N)*Math.PI*2-Math.PI/2;
    const pr = r*(s||0)/5;
    const x=cx+pr*Math.cos(angle), y=cy+pr*Math.sin(angle);
    i===0?ctx2.moveTo(x,y):ctx2.lineTo(x,y);
  });
  ctx2.closePath();
  ctx2.fillStyle='rgba(0,229,160,0.1)';
  ctx2.strokeStyle='rgba(0,229,160,0.7)';
  ctx2.lineWidth=2; ctx2.fill(); ctx2.stroke();

  // Points
  scores.forEach((s,i)=>{
    const angle=(i/N)*Math.PI*2-Math.PI/2;
    const pr=r*(s||0)/5;
    ctx2.beginPath();
    ctx2.arc(cx+pr*Math.cos(angle),cy+pr*Math.sin(angle),3,0,Math.PI*2);
    ctx2.fillStyle=DIMS[i].color; ctx2.fill();
  });

  // Labels
  ctx2.font='9px DM Mono, monospace';
  ctx2.fillStyle='rgba(220,232,240,0.6)';
  ctx2.textAlign='center'; ctx2.textBaseline='middle';
  DIMS.forEach((d,i)=>{
    const angle=(i/N)*Math.PI*2-Math.PI/2;
    const lr=r+14;
    ctx2.fillText(d.label,cx+lr*Math.cos(angle),cy+lr*Math.sin(angle));
  });
}

function renderRadarLegend(containerId, compact){
  const scores = getDimScores();
  document.getElementById(containerId).innerHTML = DIMS.map((d,i)=>`
    <div class="dim-row" onclick="go('madurez')" style="margin-bottom:${compact?6:9}px">
      <span style="color:${d.color};font-size:${compact?10:12}px">${d.icon}</span>
      <span class="dim-label" style="font-size:${compact?9.5:11}px">${d.label}</span>
      <span class="dim-score" style="color:${d.color};font-size:${compact?11:12}px">${scores[i]>0?scores[i].toFixed(1):'â€”'}</span>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TWIN SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTwinSummaryPage(){
  document.getElementById('twin-summary-text').value = S.twinSummary||'';
  document.getElementById('ts-updated').textContent = S.ctx?._updated ? fmtDate(S.ctx._updated) : 'â€”';
  document.getElementById('ts-ctx-status').textContent = S.ctx?.name ? `âœ“ ${S.ctx.name}` : 'âœ— Sin configurar';
  document.getElementById('ts-mat-status').textContent = calcGlobalScore()>0 ? `âœ“ ${calcGlobalScore().toFixed(1)}/5` : 'âœ— Sin datos';
}

async function generateTwinSummary(){
  const key = S.cfg.mistralKey;
  if(!key){ showAlert('ts-alert','Configura la API key de Mistral primero','err'); return; }
  if(!S.ctx?.name){ showAlert('ts-alert','Completa primero el Contexto Organizacional','err'); return; }

  const btn = document.getElementById('gen-summary-btn');
  btn.innerHTML='<span class="spin"></span> Generando...'; btn.disabled=true;

  const scores = getDimScores();
  const matSummary = DIMS.map((d,i)=>`${d.label}: ${scores[i]>0?scores[i].toFixed(1)+'/5':'Sin datos'}`).join(' | ');
  const ctx = S.ctx;

  const prompt = `Eres el experto en compliance de la empresa "${ctx.name}" (sector: ${ctx.sector}, tamaÃ±o: ${ctx.size}, Ã¡mbito: ${ctx.geo}).

Genera un RESUMEN EJECUTIVO CONCISO (mÃ¡ximo 500 palabras) del Digital Twin de compliance de esta organizaciÃ³n, que se usarÃ¡ como contexto para analizar noticias y eventos regulatorios.

CONTEXTO ORGANIZACIONAL:
- Negocio: ${ctx.business||'No especificado'}
- Marco legal: ${ctx.legal||'No especificado'}
- Riesgos compliance prioritarios: ${ctx.risks||'No especificado'}
- Normas adoptadas: ${(ctx.norms||[]).join(', ')||'No especificado'}
- Terceros: ${ctx.thirds||'No especificado'}
- Cultura compliance: ${ctx.culture||'No especificado'}

ASSESSMENT DE MADUREZ:
${matSummary}

El resumen debe incluir: (1) perfil de la empresa en 2-3 frases, (2) principales riesgos de compliance con sus normas aplicables, (3) fortalezas y gaps del modelo de compliance (segÃºn madurez), (4) Ã¡reas crÃ­ticas que deben monitorizarse.

Escribe en espaÃ±ol. SÃ© concreto y actionable. Este texto se usarÃ¡ en cada anÃ¡lisis de hit para dar contexto especÃ­fico de esta empresa.`;

  try{
    const r = await callMistral(prompt, 800);
    document.getElementById('twin-summary-text').value = r;
    S.twinSummary = r;
    showAlert('ts-alert','âœ“ Resumen generado â€” revÃ­salo y guarda cuando estÃ©s conforme','ok');
  }catch(e){
    showAlert('ts-alert','Error: '+e.message,'err');
  }
  btn.textContent='âœ¦ Generar con IA'; btn.disabled=false;
}

async function saveTwinSummary(){
  const text = document.getElementById('twin-summary-text').value.trim();
  S.twinSummary = text;
  const ok = await fsSet('twin_summary','main',{text});
  lsSet('ts', text);
  showAlert('ts-alert', ok?'âœ“ Resumen guardado en Firestore':'Error al guardar','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HITS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHits(){
  const lv  = document.getElementById('hit-filter-level')?.value||'';
  let hits  = S.hits.filter(h=>!lv||h.level===lv);
  const container = document.getElementById('hits-list');
  container.innerHTML = hits.length ? hits.map(h=>hitCard(h)).join('') :
    `<div class="empty"><div class="empty-icon">âŸ</div><div class="empty-title">Sin hits</div><div class="empty-sub">Ejecuta el workflow en GitHub Actions</div></div>`;
}

function hitCard(h){
  const hasDetail = h.summary||h.twin_analysis||h.recommended_action;
  const hasAp = S.actionPlans.find(p=>p.hit_id===h.id);
  return `
  <div class="hit ${h.level||'info'}">
    <div class="hit-head">
      <span class="tag tag-${h.level||'info'}">${levelLabel(h.level)}</span>
      <span class="hit-source">${esc((h.source||'').split('Â·')[0].trim())}</span>
      <span class="hit-date">${fmtDate(h.fetched_at||h.raw_date)}</span>
    </div>
    <div class="hit-title">${esc(h.title)}</div>
    ${h.summary?`<div class="hit-summary">${esc(h.summary)}</div>`:''}
    <div class="score-bar mt6"><div class="score-fill" style="width:${h.relevance_score||0}%;background:${levelColor(h.level)}"></div></div>
    <div class="flex gap6 mt6">
      ${hasDetail?`<button class="btn btn-ghost btn-xs" onclick="toggleHitDetail('hd-${h.id}')">Ver anÃ¡lisis â†“</button>`:''}
      ${h.link?`<a href="${h.link}" target="_blank" class="btn btn-ghost btn-xs">Fuente â†—</a>`:''}
      ${hasAp?`<span class="btn btn-warn btn-xs">â—‰ Plan abierto</span>`:
        `<button class="btn btn-ghost btn-xs" onclick="openApFromHit('${h.id}','${esc(h.title).replace(/'/g,"\\'")}')">+ Plan de acciÃ³n</button>`}
    </div>
    ${hasDetail?`
    <div class="hit-extra" id="hd-${h.id}">
      ${h.twin_analysis?`<div class="hit-twin-box"><div class="hit-twin-label">â¬¡ AnÃ¡lisis vs. Digital Twin</div><div style="font-size:10.5px;color:var(--text-dim);line-height:1.6">${esc(h.twin_analysis)}</div></div>`:''}
      ${h.risks?.length?`<div class="hit-detail-row mt8"><div class="hit-detail-label">Riesgos</div><div class="hit-detail-val">${h.risks.join(' Â· ')}</div></div>`:''}
      ${h.norms_affected?.length?`<div class="hit-detail-row"><div class="hit-detail-label">Normas afectadas</div><div class="hit-detail-val">${h.norms_affected.join(' Â· ')}</div></div>`:''}
      ${h.vulnerability?`<div class="hit-detail-row"><div class="hit-detail-label">Vulnerabilidad / Control</div><div class="hit-detail-val">${esc(h.vulnerability)}</div></div>`:''}
      ${h.financial_impact?`<div class="hit-detail-row"><div class="hit-detail-label">Impacto financiero</div><div class="hit-detail-val">${esc(h.financial_impact)}</div></div>`:''}
      ${h.recommended_action?`<div class="hit-detail-row"><div class="hit-detail-label">AcciÃ³n recomendada</div><div class="hit-detail-val">${esc(h.recommended_action)}</div></div>`:''}
    </div>`:''}
  </div>`;
}

function toggleHitDetail(id){
  const el=document.getElementById(id);
  if(el)el.classList.toggle('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLANES DE ACCIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentApId = null;
let apSteps = [];

function renderPlanes(){
  const filter = document.getElementById('ap-filter')?.value||'';
  let plans = S.actionPlans.filter(p=>!filter||p.status===filter);
  const container = document.getElementById('planes-list');
  container.innerHTML = plans.length ? plans.map(p=>planCard(p)).join('') :
    `<div class="empty"><div class="empty-icon">â—‰</div><div class="empty-title">Sin planes de acciÃ³n</div><div class="empty-sub">Abre un plan desde un hit crÃ­tico</div></div>`;
}

function planCard(p){
  const pIcon = {critical:'ğŸ”´',high:'ğŸŸ ',medium:'ğŸŸ¡',low:'ğŸŸ¢'}[p.priority]||'âšª';
  const done  = (p.steps||[]).filter(s=>s.done).length;
  const total = (p.steps||[]).length;
  const pct   = total>0?Math.round(done/total*100):0;
  return `
  <div class="ap" onclick="openApModal('${p.id}')">
    <div class="ap-head">
      <span class="tag tag-${p.status||'open'}">${p.status||'open'}</span>
      <div class="ap-title">${pIcon} ${esc(p.title)}</div>
    </div>
    <div class="ap-meta">
      ${p.control?`<span>â— ${esc(p.control)}</span>`:''}
      ${p.owner?`<span>ğŸ‘¤ ${esc(p.owner)}</span>`:''}
      ${p.deadline?`<span>ğŸ“… ${p.deadline}</span>`:''}
      ${p.dim?`<span>Â§ ${esc(p.dim)}</span>`:''}
    </div>
    ${total>0?`<div class="ap-progress">
      <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-muted);margin-bottom:3px"><span>Progreso</span><span>${done}/${total} Â· ${pct}%</span></div>
      <div class="score-bar"><div class="score-fill" style="width:${pct}%;background:var(--accent)"></div></div>
    </div>`:''}
  </div>`;
}

function openApFromHit(hitId, hitTitle){
  currentApId = null; apSteps=[];
  document.getElementById('ap-title').value = 'Plan: '+hitTitle.slice(0,60);
  document.getElementById('ap-control').value='';
  document.getElementById('ap-dim').value='';
  document.getElementById('ap-owner').value='Compliance Officer';
  document.getElementById('ap-deadline').value='';
  document.getElementById('ap-priority').value='high';
  document.getElementById('ap-desc').value='Hit origen: '+hitTitle;
  document.getElementById('ap-improvement').value='';
  document.getElementById('ap-status').value='open';
  document.getElementById('ap-delete-btn').style.display='none';
  document.getElementById('ap-modal-title').textContent='Nuevo Plan de AcciÃ³n';
  window._apHitId = hitId;
  apSteps=[]; renderApSteps();
  openModal('modal-ap');
}

function openApFromElement(dimLabel, elemLabel){
  currentApId=null; apSteps=[];
  document.getElementById('ap-title').value=`Mejora: ${elemLabel.slice(0,50)}`;
  document.getElementById('ap-control').value=elemLabel;
  document.getElementById('ap-dim').value=dimLabel;
  document.getElementById('ap-owner').value='Compliance Officer';
  document.getElementById('ap-deadline').value='';
  document.getElementById('ap-priority').value='medium';
  document.getElementById('ap-desc').value='';
  document.getElementById('ap-improvement').value='';
  document.getElementById('ap-status').value='open';
  document.getElementById('ap-delete-btn').style.display='none';
  document.getElementById('ap-modal-title').textContent='Nuevo Plan de AcciÃ³n';
  window._apHitId=null; renderApSteps();
  openModal('modal-ap');
}

function openApModal(id){
  const p = S.actionPlans.find(a=>a.id===id);
  if(!p) return;
  currentApId=id; apSteps=[...(p.steps||[])];
  document.getElementById('ap-title').value=p.title||'';
  document.getElementById('ap-control').value=p.control||'';
  document.getElementById('ap-dim').value=p.dim||'';
  document.getElementById('ap-owner').value=p.owner||'';
  document.getElementById('ap-deadline').value=p.deadline||'';
  document.getElementById('ap-priority').value=p.priority||'medium';
  document.getElementById('ap-desc').value=p.desc||'';
  document.getElementById('ap-improvement').value=p.improvement||'';
  document.getElementById('ap-status').value=p.status||'open';
  document.getElementById('ap-delete-btn').style.display='';
  document.getElementById('ap-modal-title').textContent='Plan de AcciÃ³n';
  window._apHitId=p.hit_id||null;
  renderApSteps();
  document.getElementById('ap-close-note').style.display=p.status==='closed'?'':'none';
  openModal('modal-ap');
}

function addApStep(){
  const v=document.getElementById('ap-new-step').value.trim();
  if(!v)return;
  apSteps.push({text:v,done:false,id:Date.now()});
  document.getElementById('ap-new-step').value='';
  renderApSteps();
}

function toggleApStep(i){
  apSteps[i].done=!apSteps[i].done;
  renderApSteps();
}

function renderApSteps(){
  document.getElementById('ap-steps-list').innerHTML=apSteps.map((s,i)=>`
    <div class="ap-step">
      <div class="ap-step-check ${s.done?'done':''}" onclick="toggleApStep(${i})">${s.done?'âœ“':''}</div>
      <span style="${s.done?'text-decoration:line-through;opacity:.5':''}">${esc(s.text)}</span>
    </div>`).join('');
  document.getElementById('ap-status').dispatchEvent(new Event('change'));
}

async function saveAp(){
  const title=val('ap-title');
  if(!title){alert('TÃ­tulo obligatorio');return;}
  const data={
    title, control:val('ap-control'), dim:val('ap-dim'),
    owner:val('ap-owner'), deadline:val('ap-deadline'),
    priority:val('ap-priority'), desc:val('ap-desc'),
    improvement:val('ap-improvement'), status:val('ap-status'),
    steps:apSteps, hit_id:window._apHitId||null,
  };

  // If closing plan, update maturity element if control is linked
  if(data.status==='closed' && data.control){
    const matched = findMaturityElement(data.control);
    if(matched && data.improvement){
      // Bump score by 0.5 conceptually â€” just note it
      console.log('Plan cerrado, vinculado a elemento:', matched);
    }
  }

  if(currentApId){
    await fsUpdate('action_plans', currentApId, data);
    const i=S.actionPlans.findIndex(a=>a.id===currentApId);
    if(i>=0) S.actionPlans[i]={...S.actionPlans[i],...data};
  } else {
    const newId = await fsAdd('action_plans', data);
    if(newId) S.actionPlans.push({id:newId,...data});
  }

  lsSet('plans', S.actionPlans);
  closeModal('modal-ap');
  renderPlanes(); renderDashboard(); updateBadges();
}

async function deleteAp(){
  if(!currentApId||!confirm('Â¿Eliminar este plan?'))return;
  await fsDelete('action_plans', currentApId);
  S.actionPlans=S.actionPlans.filter(a=>a.id!==currentApId);
  lsSet('plans',S.actionPlans);
  closeModal('modal-ap'); renderPlanes(); updateBadges();
}

function findMaturityElement(controlText){
  const ct=controlText.toLowerCase();
  for(const d of DIMS){ for(const e of d.elements){ if(e.label.toLowerCase().includes(ct.slice(0,15))) return e.id; } }
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOCUMENTO ANALYSIS â€” queue-based, JSON-structured
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let docAnalysisTarget = 'contexto';
let docAnalysisElementId = null;
let docAnalysisElementLabel = null;
let docQueue = []; // [{name, text}]
let lastDocResult = null; // store result safely (no inline onclick)

function openDocAnalysis(target, elemId=null, elemLabel=null){
  docAnalysisTarget=target;
  docAnalysisElementId=elemId;
  docAnalysisElementLabel=elemLabel;
  docQueue=[];
  lastDocResult=null;

  const title = target==='element' ? `Analizar doc â†’ ${elemLabel}` :
    target==='madurez' ? 'Analizar documentos â€” Assessment de Madurez' :
    'Analizar documentos â€” Contexto Organizacional';
  document.getElementById('doc-modal-title').textContent=title;
  document.getElementById('doc-file').value='';
  document.getElementById('doc-text').value='';
  document.getElementById('doc-result').innerHTML='';
  renderDocQueue();
  openModal('modal-doc');
}

function renderDocQueue(){
  const list = document.getElementById('doc-queue-list');
  const btnOne = document.getElementById('doc-analyze-one-btn');
  const btnAll = document.getElementById('doc-analyze-all-btn');

  if(!docQueue.length){
    list.innerHTML='<div style="font-size:10px;color:var(--text-muted);padding:6px 0">Sin documentos en cola aÃºn.</div>';
    btnOne.style.display='none';
    btnAll.style.display='none';
    return;
  }

  list.innerHTML = docQueue.map((d,i)=>`
    <div class="flex ic gap8" style="padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;margin-bottom:5px">
      <span style="font-size:11px;color:var(--accent)">ğŸ“„</span>
      <span style="font-size:10.5px;flex:1">${esc(d.name)}</span>
      <span style="font-size:9px;color:var(--text-muted)">${(d.text.length/1000).toFixed(1)}k chars</span>
      <button style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:13px" onclick="removeDocFromQueue(${i})">Ã—</button>
    </div>`).join('');

  btnOne.style.display = docQueue.length===1 ? '' : 'none';
  btnAll.style.display = '';
  btnAll.textContent = docQueue.length===1 ? 'Analizar con IA â†’' : `Analizar ${docQueue.length} docs con IA â†’`;
}

function removeDocFromQueue(i){
  docQueue.splice(i,1);
  renderDocQueue();
}

async function addDocToQueue(){
  const files = document.getElementById('doc-file').files;
  const pasted = document.getElementById('doc-text').value.trim();

  if(files.length===0 && !pasted){
    showAlert('doc-alert','Adjunta un archivo o pega texto','err'); return;
  }

  showAlert('doc-alert','Leyendo...','info');

  // Files
  for(const file of files){
    try{
      const text = await readFileAsText(file);
      if(text && text.trim().length>20){
        docQueue.push({name: file.name, text});
      } else {
        showAlert('doc-alert',`No se pudo extraer texto de ${file.name} â€” prueba a pegar el contenido`,'err');
      }
    }catch(e){
      showAlert('doc-alert',`Error leyendo ${file.name}: ${e.message}`,'err');
    }
  }

  // Pasted text
  if(pasted){
    docQueue.push({name:'Texto pegado', text: pasted});
  }

  document.getElementById('doc-file').value='';
  document.getElementById('doc-text').value='';
  document.getElementById('doc-alert').innerHTML='';
  renderDocQueue();
}

async function analyzeDocQueue(allDocs){
  const key=S.cfg.mistralKey;
  if(!key){showAlert('doc-alert','Configura la API key de Mistral en âš™ ConfiguraciÃ³n','err');return;}
  if(!docQueue.length){showAlert('doc-alert','AÃ±ade al menos un documento','err');return;}

  const docsToAnalyze = allDocs ? docQueue : [docQueue[docQueue.length-1]];
  const combinedText = docsToAnalyze.map(d=>`=== ${d.name} ===\n${d.text}`).join('\n\n').slice(0,12000);

  document.getElementById('doc-result').innerHTML=`
    <div class="flex ic gap8" style="color:var(--text-muted);padding:10px 0">
      <span class="spin"></span> Analizando ${docsToAnalyze.length} documento(s) con Mistral AI...
    </div>`;

  let prompt, resultHandler;

  if(docAnalysisTarget==='contexto'){
    // Structured JSON extraction for all context fields
    const existingCtx = JSON.stringify({
      name:val('ctx-name'), sector:val('ctx-sector'), business:val('ctx-business'),
      strategy:val('ctx-strategy'), legal:val('ctx-legal'), economic:val('ctx-economic'),
      social:val('ctx-social'), trends:val('ctx-trends'), structure:val('ctx-structure'),
      culture:val('ctx-culture'), tech:val('ctx-tech'), thirds:val('ctx-thirds'),
      extParties:val('ctx-ext-parties'), intParties:val('ctx-int-parties'),
      risks:val('ctx-risks'), incidents:val('ctx-incidents'),
    });

    prompt = `Eres un experto en compliance corporativo. Analiza EXHAUSTIVAMENTE el/los siguiente(s) documento(s) y extrae TODA la informaciÃ³n relevante para el contexto organizacional ISO 37301.

CONTEXTO ACTUAL (ya rellenado, COMPLEMENTA sin borrar lo existente):
${existingCtx}

DOCUMENTOS A ANALIZAR:
${combinedText}

INSTRUCCIONES CRÃTICAS:
- Lee el documento completo y busca ACTIVAMENTE informaciÃ³n para CADA campo
- Para "incidents": busca CUALQUIER menciÃ³n de sanciones, multas, expedientes, inspecciones, denuncias, investigaciones regulatorias, litigios, condenas, amonestaciones, requerimientos de reguladores, noticias negativas, conflictos legales. Si el documento menciona algo asÃ­, INCLÃšYELO aunque sea implÃ­cito.
- Para "risks": identifica riesgos de compliance mencionados explÃ­cita o implÃ­citamente
- Para "legal": incluye toda normativa, leyes, reguladores mencionados
- Para "thirds": incluye proveedores, clientes, distribuidores, socios
- No dejes campos vacÃ­os si hay informaciÃ³n relevante en el documento

Responde ÃšNICAMENTE con un objeto JSON vÃ¡lido con estos campos exactos (strings en espaÃ±ol):
{
  "name": "nombre legal de la empresa",
  "sector": "sector principal",
  "size": "tamaÃ±o (Microempresa/PequeÃ±a/Mediana/Grande/CorporaciÃ³n)",
  "revenue": "facturaciÃ³n aproximada",
  "geo": "Ã¡mbito geogrÃ¡fico",
  "business": "descripciÃ³n del modelo de negocio",
  "strategy": "estrategia y objetivos principales",
  "legal": "marco legal y regulatorio aplicable",
  "economic": "contexto econÃ³mico y de mercado",
  "social": "contexto social, cultural y medioambiental",
  "trends": "tendencias futuras con impacto en compliance",
  "structure": "estructura organizativa",
  "culture": "cultura de compliance actual",
  "tech": "recursos tecnolÃ³gicos relevantes",
  "thirds": "relaciones con terceros (proveedores, clientes, socios)",
  "ext_parties": "partes interesadas externas y sus expectativas de compliance",
  "int_parties": "partes interesadas internas y sus expectativas de compliance",
  "risks": "riesgos de compliance prioritarios identificados en el documento",
  "incidents": "IMPORTANTE: cualquier sanciÃ³n, multa, expediente, inspecciÃ³n, investigaciÃ³n regulatoria, litigio, requerimiento de autoridades, incidente de compliance, o historial negativo mencionado en el documento",
  "norms": ["array de normas/leyes/regulaciones mencionadas en el documento"]
}

IMPORTANTE: Si el campo ya tiene contenido en el contexto actual, COMPLEMENTA con la nueva informaciÃ³n separada por salto de lÃ­nea. No uses "" para campos que tengan informaciÃ³n en el documento.
Responde SOLO el JSON vÃ¡lido, sin texto adicional, sin bloques markdown.`;

    resultHandler = applyContextoJson;

  } else if(docAnalysisTarget==='madurez'){
    // Structured JSON for all maturity dimensions
    const existingMat = JSON.stringify(S.maturity||{});
    const dimsDesc = DIMS.map(d=>
      `${d.label}:\n${d.elements.map(e=>`  - ${e.id}: ${e.label}`).join('\n')}`
    ).join('\n\n');

    prompt = `Analiza el/los siguiente(s) documento(s) y evalÃºa la madurez del sistema de compliance ISO 37301.

ESCALA: 1=No existe, 2=Inicial/Ad hoc, 3=Definido/Documentado, 4=Gestionado/Medido, 5=Optimizado

DIMENSIONES Y ELEMENTOS A EVALUAR:
${dimsDesc}

EVALUACIÃ“N ACTUAL (complementa, no reemplaces si ya hay datos):
${existingMat}

DOCUMENTOS:
${combinedText}

Responde ÃšNICAMENTE con un JSON vÃ¡lido. Para cada element_id incluye:
- el campo "element_id": score (nÃºmero 1-5, 0 si no hay informaciÃ³n suficiente)
- el campo "ev_element_id": "evidencia encontrada en el documento que justifica la puntuaciÃ³n"

Ejemplo: {"ctx1": 3, "ev_ctx1": "El documento menciona un mapa de procesos aprobado por direcciÃ³n..."}

IMPORTANTE: Si ya hay puntuaciÃ³n para un elemento, solo actualiza si encuentras evidencia mÃ¡s clara. 
Para evidencias, COMPLEMENTA el texto existente con la nueva informaciÃ³n encontrada.
Responde SOLO el JSON, sin texto adicional.`;

    resultHandler = applyMaturityJson;

  } else if(docAnalysisTarget==='element'){
    // Single element analysis
    const existingEv = document.getElementById('ev-'+docAnalysisElementId)?.value||'';
    prompt = `Analiza el/los siguiente(s) documento(s) y evalÃºa el nivel de madurez del elemento de compliance:

ELEMENTO: "${docAnalysisElementLabel}"
ESCALA: 1=No existe, 2=Inicial/Ad hoc, 3=Definido/Documentado, 4=Gestionado/Medido, 5=Optimizado

EVIDENCIA EXISTENTE (complementa):
${existingEv||'Ninguna aÃºn'}

DOCUMENTOS:
${combinedText}

Responde ÃšNICAMENTE con un JSON vÃ¡lido:
{
  "score": <nÃºmero 1-5>,
  "justification": "justificaciÃ³n de la puntuaciÃ³n con evidencias concretas del documento",
  "evidence": "texto de evidencia especÃ­fica encontrada en el documento"
}

Responde SOLO el JSON, sin texto adicional.`;

    resultHandler = applyElementJson;
  }

  try{
    const raw = await callMistral(prompt, 2000);

    // Parse JSON safely
    let parsed;
    try{
      // Strip markdown code blocks if present
      const clean = raw.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
      parsed = JSON.parse(clean);
    }catch(e){
      // Try to extract JSON from response
      const match = raw.match(/\{[\s\S]*\}/);
      if(match) parsed = JSON.parse(match[0]);
      else throw new Error('La IA no devolviÃ³ JSON vÃ¡lido. Respuesta: '+raw.slice(0,200));
    }

    lastDocResult = parsed;
    resultHandler(parsed, true); // preview mode

  }catch(e){
    document.getElementById('doc-result').innerHTML=`<div class="alert alert-err">Error: ${esc(e.message)}</div>`;
  }
}

function applyContextoJson(data, preview=false){
  const fieldMap = {
    name:'ctx-name', sector:'ctx-sector', size:'ctx-size', revenue:'ctx-revenue',
    geo:'ctx-geo', business:'ctx-business', strategy:'ctx-strategy', legal:'ctx-legal',
    economic:'ctx-economic', social:'ctx-social', trends:'ctx-trends',
    structure:'ctx-structure', culture:'ctx-culture', tech:'ctx-tech', thirds:'ctx-thirds',
    ext_parties:'ctx-ext-parties', int_parties:'ctx-int-parties',
    risks:'ctx-risks', incidents:'ctx-incidents',
  };

  // Build preview
  const changes = [];
  for(const [key, fieldId] of Object.entries(fieldMap)){
    if(data[key] && data[key].trim()){
      const el = document.getElementById(fieldId);
      const existing = el?.value?.trim()||'';
      const newVal = existing ? existing+'\n\n[Complemento IA]:\n'+data[key] : data[key];
      changes.push({fieldId, label:fieldId.replace('ctx-',''), newVal, isNew:!existing});
    }
  }

  if(preview){
    document.getElementById('doc-result').innerHTML=`
      <div class="alert alert-ok">âœ“ AnÃ¡lisis completado â€” ${changes.length} campos con informaciÃ³n</div>
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:12px;max-height:260px;overflow-y:auto;margin-bottom:10px">
        ${changes.map(c=>`
          <div style="margin-bottom:8px;padding:6px;border-left:2px solid ${c.isNew?'var(--accent)':'var(--warn)'}">
            <div style="font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:${c.isNew?'var(--accent)':'var(--warn)'};margin-bottom:2px">${c.isNew?'NUEVO':'COMPLEMENTA'} â†’ ${c.label}</div>
            <div style="font-size:10px;color:var(--text-dim);line-height:1.5">${esc(c.newVal.slice(0,150))}${c.newVal.length>150?'...':''}</div>
          </div>`).join('')}
        ${data.norms?.length?`<div style="margin-bottom:8px;padding:6px;border-left:2px solid var(--accent)"><div style="font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent);margin-bottom:2px">NORMAS DETECTADAS</div><div style="font-size:10px;color:var(--text-dim)">${data.norms.join(', ')}</div></div>`:''}
      </div>
      <div class="flex gap8">
        <button class="btn btn-ghost btn-sm" onclick="closeModal('modal-doc')">Cancelar</button>
        <button class="btn btn-primary btn-sm" onclick="applyContextoJson(lastDocResult,false)">Aplicar al formulario â†’</button>
      </div>`;
    return;
  }

  // Actually apply
  for(const {fieldId, newVal} of changes){
    const el = document.getElementById(fieldId);
    if(el) el.value = newVal;
  }

  // Apply norms
  if(data.norms?.length){
    document.querySelectorAll('.ctx-norm').forEach(cb=>{
      if(data.norms.some(n=>n.toLowerCase().includes(cb.value.toLowerCase())||cb.value.toLowerCase().includes(n.toLowerCase()))){
        cb.checked=true;
      }
    });
  }

  closeModal('modal-doc');
  go('contexto');
  showAlert('ctx-alert',`âœ“ ${changes.length} campos actualizados desde el documento â€” revisa y guarda`,'ok');
}

function applyMaturityJson(data, preview=false){
  if(preview){
    const updates = [];
    DIMS.forEach(d=>d.elements.forEach(e=>{
      if(data[e.id] && data[e.id]>0){
        updates.push({id:e.id, label:e.label, score:data[e.id], ev:data['ev_'+e.id]||''});
      }
    }));

    document.getElementById('doc-result').innerHTML=`
      <div class="alert alert-ok">âœ“ AnÃ¡lisis completado â€” ${updates.length} elementos evaluados</div>
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:12px;max-height:280px;overflow-y:auto;margin-bottom:10px">
        ${updates.map(u=>`
          <div style="margin-bottom:7px;padding:6px;border-left:2px solid var(--accent)">
            <div class="flex ic gap8">
              <span style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted)">${esc(u.label.slice(0,40))}</span>
              <span style="font-family:var(--font-ui);font-weight:800;color:var(--accent);margin-left:auto">${u.score}/5</span>
            </div>
            ${u.ev?`<div style="font-size:9.5px;color:var(--text-dim);margin-top:2px;line-height:1.4">${esc(u.ev.slice(0,120))}${u.ev.length>120?'...':''}</div>`:''}
          </div>`).join('')}
      </div>
      <div class="flex gap8">
        <button class="btn btn-ghost btn-sm" onclick="closeModal('modal-doc')">Cancelar</button>
        <button class="btn btn-primary btn-sm" onclick="applyMaturityJson(lastDocResult,false)">Aplicar puntuaciones â†’</button>
      </div>`;
    return;
  }

  // Actually apply
  if(!S.maturity) S.maturity={};
  DIMS.forEach(d=>d.elements.forEach(e=>{
    if(data[e.id] && data[e.id]>0){
      // Only update score if new score > existing or no existing
      const existing = parseInt(S.maturity[e.id])||0;
      if(data[e.id]>existing || !existing) S.maturity[e.id]=data[e.id];
    }
    if(data['ev_'+e.id]){
      const existing = S.maturity['ev_'+e.id]||'';
      S.maturity['ev_'+e.id] = existing ? existing+'\n\n[Doc IA]: '+data['ev_'+e.id] : data['ev_'+e.id];
    }
  }));

  closeModal('modal-doc');
  go('madurez');
  showAlert('mat-alert','âœ“ Puntuaciones actualizadas â€” revisa y guarda la versiÃ³n','ok');
}

function applyElementJson(data, preview=false){
  if(preview){
    document.getElementById('doc-result').innerHTML=`
      <div class="alert alert-ok">âœ“ AnÃ¡lisis completado</div>
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:12px;margin-bottom:10px">
        <div class="flex ic gap8 mb8">
          <span style="font-size:10px;color:var(--text-muted)">PuntuaciÃ³n propuesta</span>
          <span style="font-family:var(--font-ui);font-weight:800;font-size:18px;color:var(--accent)">${data.score}/5</span>
          <span style="font-size:10px;color:var(--text-muted)">${SCORE_LABELS[data.score]||''}</span>
        </div>
        <div style="font-size:10.5px;color:var(--text-dim);line-height:1.6">${esc(data.justification||'')}</div>
        ${data.evidence?`<div style="margin-top:8px;padding:6px;background:var(--surface2);border-radius:3px;font-size:9.5px;color:var(--text-muted);line-height:1.5">Evidencia: ${esc(data.evidence.slice(0,200))}</div>`:''}
      </div>
      <div class="flex gap8">
        <button class="btn btn-ghost btn-sm" onclick="closeModal('modal-doc')">Cancelar</button>
        <button class="btn btn-primary btn-sm" onclick="applyElementJson(lastDocResult,false)">Aplicar â†’</button>
      </div>`;
    return;
  }

  // Apply score
  if(data.score && docAnalysisElementId){
    setScore(docAnalysisElementId, data.score, '');
    const ev = document.getElementById('ev-'+docAnalysisElementId);
    if(ev && data.evidence){
      ev.value = ev.value ? ev.value+'\n\n[Doc IA]: '+data.evidence : data.evidence;
    }
  }

  closeModal('modal-doc');
  showAlert('mat-alert','âœ“ Elemento actualizado â€” guarda la versiÃ³n cuando termines','ok');
}

async function readFileAsText(file){
  const name = file.name.toLowerCase();

  // DOCX â†’ mammoth extrae texto limpio
  if(name.endsWith('.docx') || name.endsWith('.doc')){
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const arrayBuffer = e.target.result;
          const result = await mammoth.extractRawText({ arrayBuffer });
          if(!result.value || result.value.trim().length < 10){
            rej(new Error('El documento parece estar vacÃ­o o no se pudo extraer texto.'));
          } else {
            res(result.value);
          }
        } catch(err) {
          rej(new Error('Error leyendo DOCX: ' + err.message));
        }
      };
      reader.onerror = rej;
      reader.readAsArrayBuffer(file);
    });
  }

  // TXT / CSV / XML â†’ texto plano directo
  if(name.endsWith('.txt') || name.endsWith('.csv') || name.endsWith('.xml')){
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = e => res(e.target.result);
      reader.onerror = rej;
      reader.readAsText(file, 'UTF-8');
    });
  }

  // PDF â†’ intentar leer como texto (solo funciona en PDFs no escaneados)
  if(name.endsWith('.pdf')){
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = e => {
        // Extraer texto legible del PDF binario (heurÃ­stica bÃ¡sica)
        const raw = new Uint8Array(e.target.result);
        let text = '';
        for(let i = 0; i < raw.length - 1; i++){
          const c = raw[i];
          if(c >= 32 && c < 127) text += String.fromCharCode(c);
          else if(c === 10 || c === 13) text += '\n';
        }
        // Limpiar secuencias no legibles
        text = text.replace(/[^\x20-\x7E\n\r\t\u00C0-\u024F]/g, ' ')
                   .replace(/\s{3,}/g, '\n')
                   .replace(/(.)\1{4,}/g, '$1') // quitar repeticiones
                   .trim();
        if(text.length < 50){
          res('[PDF escaneado o protegido â€” por favor pega el texto manualmente en el campo de texto]');
        } else {
          res(text.slice(0, 12000));
        }
      };
      reader.onerror = rej;
      reader.readAsArrayBuffer(file);
    });
  }

  // Fallback genÃ©rico
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = e => res(e.target.result);
    reader.onerror = rej;
    reader.readAsText(file, 'UTF-8');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BRIEF EJECUTIVO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBriefPlaceholder(){
  if(!document.getElementById('brief-content').innerHTML){
    document.getElementById('brief-content').innerHTML=`<div class="empty"><div class="empty-icon">â–¤</div><div class="empty-title">Sin brief generado</div><div class="empty-sub">Haz clic en "Generar con IA" para crear el informe ejecutivo</div></div>`;
  }
}

async function generateBrief(){
  const key=S.cfg.mistralKey;
  if(!key){showAlert('brief-alert','Configura la API key de Mistral','err');return;}
  const btn=document.getElementById('brief-gen-btn');
  btn.innerHTML='<span class="spin"></span> Generando...'; btn.disabled=true;

  const globalScore=calcGlobalScore();
  const scores=getDimScores();
  const topHits=S.hits.filter(h=>h.level==='critical'||h.level==='warning').slice(0,3);
  const openPlans=S.actionPlans.filter(p=>p.status!=='closed');

  const prompt=`Eres el Compliance Officer de "${S.ctx?.name||'la organizaciÃ³n'}". Genera un BRIEF EJECUTIVO en espaÃ±ol para presentar al ComitÃ© de Cumplimiento o Consejo de AdministraciÃ³n.

DATOS DEL TWIN:
- OrganizaciÃ³n: ${S.ctx?.name} Â· ${S.ctx?.sector} Â· ${S.ctx?.size}
- Madurez global: ${globalScore.toFixed(1)}/5
- Por dimensiÃ³n: ${DIMS.map((d,i)=>`${d.label}: ${scores[i].toFixed(1)}`).join(', ')}
- Hits crÃ­ticos/alertas recientes: ${topHits.map(h=>h.title).join(' | ')||'Ninguno'}
- Planes abiertos: ${openPlans.length}

RESUMEN DEL TWIN:
${S.twinSummary?.slice(0,500)||'No disponible'}

El brief debe incluir:
1. Estado actual del modelo de compliance (2-3 frases)
2. Top 3 eventos regulatorios de este perÃ­odo y su impacto
3. Gaps prioritarios del modelo (dimensiones con menor madurez)
4. Planes de acciÃ³n en curso
5. RecomendaciÃ³n clave para el prÃ³ximo perÃ­odo

Formato: claro, ejecutivo, con datos concretos. MÃ¡ximo 400 palabras.`;

  try{
    const result=await callMistral(prompt, 800);
    const now=new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'long',year:'numeric'});
    document.getElementById('brief-content').innerHTML=`
      <div class="brief-page" id="brief-printable">
        <div class="brief-header">
          <div>
            <div class="brief-logo">CDT Â· Compliance Digital Twin</div>
            <div style="font-size:11px;color:#666;margin-top:3px">${S.ctx?.name||'OrganizaciÃ³n'} Â· ${S.ctx?.sector||''}</div>
          </div>
          <div class="brief-date"><div style="font-size:11px;color:#666">Brief Ejecutivo</div><div style="font-weight:700;margin-top:2px">${now}</div></div>
        </div>
        <div class="brief-kri-row">
          <div class="brief-kri"><div class="brief-kri-val" style="color:#16a34a">${globalScore.toFixed(1)}</div><div class="brief-kri-label">Madurez /5.0</div></div>
          <div class="brief-kri"><div class="brief-kri-val" style="color:#dc2626">${S.hits.filter(h=>h.level==='critical').length}</div><div class="brief-kri-label">Hits CrÃ­ticos</div></div>
          <div class="brief-kri"><div class="brief-kri-val" style="color:#d97706">${openPlans.length}</div><div class="brief-kri-label">Planes Abiertos</div></div>
          <div class="brief-kri"><div class="brief-kri-val" style="color:#2563eb">${S.hits.length}</div><div class="brief-kri-label">Hits Monitorizados</div></div>
        </div>
        <div style="white-space:pre-wrap;font-size:12px;line-height:1.7;color:#222">${result}</div>
        <div style="margin-top:24px;padding-top:12px;border-top:1px solid #ddd;font-size:10px;color:#999">Generado automÃ¡ticamente por CDT â€” Compliance Digital Twin Â· ${now}</div>
      </div>`;
  }catch(e){showAlert('brief-alert','Error: '+e.message,'err');}
  btn.textContent='âœ¦ Generar con IA'; btn.disabled=false;
}

function printBrief(){
  const content=document.getElementById('brief-printable');
  if(!content){alert('Genera el brief primero');return;}
  const w=window.open('','_blank');
  w.document.write(`<html><head><title>Brief Ejecutivo CDT</title><style>body{font-family:Georgia,serif;padding:40px;max-width:780px;margin:0 auto}@media print{body{padding:20px}}</style></head><body>${content.outerHTML}</body></html>`);
  w.document.close(); w.print();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORIAL MADUREZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openHistory(){
  const history=await fsList('maturity_history','_created','desc');
  document.getElementById('history-list').innerHTML=history.length?
    history.map(h=>`
      <div class="hist-item">
        <span class="hist-date">${fmtDate(h._created)}</span>
        <span class="hist-score">${h.globalScore?.toFixed(1)||'â€”'}/5</span>
        <span class="hist-note">${h.note||''}</span>
      </div>`).join(''):
    '<div class="empty"><div class="empty-sub">Sin historial aÃºn</div></div>';
  openModal('modal-history');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUENTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFuentes(){
  const rc=S.remoteCfg;
  const ql=document.getElementById('queries-list');
  ql.innerHTML=(rc.newsapi_queries||[]).map((q,i)=>`
    <div class="flex ic gap8 mb6" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:7px 10px">
      <span style="color:var(--accent);font-size:10px;flex-shrink:0">${i+1}</span>
      <span style="font-size:10px;flex:1;color:var(--text-dim)">${esc(q)}</span>
      <button style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px" onclick="removeQuery(${i})">Ã—</button>
    </div>`).join('');

  const rss=document.getElementById('rss-list');
  rss.innerHTML=Object.entries(RSS_LABELS).map(([k,label])=>{
    const on=(rc.rss_enabled||{})[k]!==false;
    return `<div class="flex ic gap8" style="padding:7px 0;border-bottom:1px solid var(--border)">
      <button class="rss-btn ${on?'on':''}" id="rss-${k}" onclick="toggleRss('${k}')" style="width:32px;height:18px;background:${on?'var(--accent)':'var(--border2)'};border:none;border-radius:9px;cursor:pointer;position:relative;transition:background .2s">
        <span style="position:absolute;top:2px;left:${on?'16':'2'}px;width:14px;height:14px;background:#fff;border-radius:50%;transition:left .2s;display:block"></span>
      </button>
      <span style="font-size:11px;color:${on?'var(--text)':'var(--text-dim)'}">${label}</span>
    </div>`;
  }).join('');

  const kw=document.getElementById('kw-list');
  kw.innerHTML=(rc.custom_keywords||[]).map((k,i)=>`
    <span style="display:inline-flex;align-items:center;gap:4px;font-size:10px;padding:3px 8px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim)">${esc(k)}<button style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px" onclick="removeKw(${i})">Ã—</button></span>`).join('');
}

function addQuery(){
  const v=document.getElementById('new-query').value.trim();
  if(!v)return;
  S.remoteCfg.newsapi_queries=[...(S.remoteCfg.newsapi_queries||[]),v];
  document.getElementById('new-query').value='';
  renderFuentes();
}
function removeQuery(i){ S.remoteCfg.newsapi_queries.splice(i,1); renderFuentes(); }
function toggleRss(k){ S.remoteCfg.rss_enabled=S.remoteCfg.rss_enabled||{}; S.remoteCfg.rss_enabled[k]=!S.remoteCfg.rss_enabled[k]; renderFuentes(); }
function addKw(){ const v=document.getElementById('new-kw').value.trim(); if(!v)return; S.remoteCfg.custom_keywords=[...(S.remoteCfg.custom_keywords||[]),v]; document.getElementById('new-kw').value=''; renderFuentes(); }
function removeKw(i){ S.remoteCfg.custom_keywords.splice(i,1); renderFuentes(); }
async function saveFuentes(){
  await fsSet('config','main',S.remoteCfg);
  showAlert('fuentes-alert','âœ“ ConfiguraciÃ³n guardada en Firestore','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANÃLISIS MANUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runManual(){
  const key=S.cfg.mistralKey;
  if(!key){showAlert('','','');go('config');return;}
  const text=document.getElementById('an-text').value.trim();
  if(!text){alert('Introduce texto para analizar');return;}
  const type=document.getElementById('an-type').value;
  const btn=document.getElementById('an-btn');
  document.getElementById('an-result').innerHTML='<div class="flex ic gap8" style="color:var(--text-muted);padding:16px 0"><span class="spin"></span> Analizando contra Digital Twin...</div>';
  btn.disabled=true;

  const twinCtx=S.twinSummary?`CONTEXTO DE LA ORGANIZACIÃ“N (Digital Twin):\n${S.twinSummary}\n\n`:'';
  const typeInstructions={
    full:'Realiza un anÃ¡lisis completo: relevancia para la organizaciÃ³n, riesgos identificados, normas afectadas, control de madurez mÃ¡s expuesto, impacto financiero estimado y acciÃ³n recomendada.',
    vulnerability:'Analiza la vulnerabilidad especÃ­fica: Â¿tiene la organizaciÃ³n controles para este riesgo segÃºn su modelo de compliance? Â¿QuÃ© gap existe?',
    financial:'Estima el impacto financiero: multas potenciales segÃºn normativa espaÃ±ola, daÃ±o reputacional y coste de remediaciÃ³n.',
    action:'Genera un plan de acciÃ³n concreto con pasos especÃ­ficos, responsables y plazos recomendados.',
  };

  const prompt=`${twinCtx}${typeInstructions[type]||typeInstructions.full}\n\nEVENTO A ANALIZAR:\n${text}`;
  try{
    const result=await callMistral(prompt,1200);
    document.getElementById('an-result').innerHTML=`<div style="font-size:11px;line-height:1.8;white-space:pre-wrap;color:var(--text-dim)">${esc(result)}</div>`;
  }catch(e){
    document.getElementById('an-result').innerHTML=`<div class="alert alert-err">Error: ${esc(e.message)}</div>`;
  }
  btn.disabled=false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadConfig(){
  document.getElementById('cfg-mistral-key').value=S.cfg.mistralKey||'';
  document.getElementById('cfg-mistral-model').value=S.cfg.mistralModel||'mistral-small-latest';
  document.getElementById('cfg-newsapi-key').value=S.cfg.newsapiKey||'';
  document.getElementById('cfg-threshold').value=S.cfg.threshold||60;
  document.getElementById('cfg-repo').value=S.cfg.repo||'avespa/digitaltwin';
  document.getElementById('cfg-twin-days').value=S.cfg.twinDays||90;
}

function saveConfig(){
  S.cfg={
    mistralKey: document.getElementById('cfg-mistral-key').value.trim(),
    mistralModel: document.getElementById('cfg-mistral-model').value,
    newsapiKey: document.getElementById('cfg-newsapi-key').value.trim(),
    threshold: parseInt(document.getElementById('cfg-threshold').value),
    repo: document.getElementById('cfg-repo').value.trim(),
    twinDays: parseInt(document.getElementById('cfg-twin-days').value),
  };
  lsSet('cfg',S.cfg);
  showAlert('config-alert','âœ“ ConfiguraciÃ³n guardada localmente','ok');
}

async function testMistral(){
  const key=document.getElementById('cfg-mistral-key').value.trim();
  if(!key){showAlert('config-alert','Introduce la API key primero','err');return;}
  try{
    const r=await fetch('https://api.mistral.ai/v1/models',{headers:{'Authorization':'Bearer '+key}});
    showAlert('config-alert',r.ok?'âœ“ Mistral conectado correctamente':'âœ— API Key invÃ¡lida',r.ok?'ok':'err');
  }catch(e){ showAlert('config-alert','Error de conexiÃ³n','err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MISTRAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callMistral(prompt, maxTokens=800){
  const key=S.cfg.mistralKey;
  if(!key) throw new Error('API key de Mistral no configurada');
  const r=await fetch('https://api.mistral.ai/v1/chat/completions',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
    body:JSON.stringify({
      model:S.cfg.mistralModel||'mistral-small-latest',
      messages:[{role:'user',content:prompt}],
      temperature:0.2, max_tokens:maxTokens,
    })
  });
  if(!r.ok){ const err=await r.json(); throw new Error(err.message||'Error Mistral'); }
  const data=await r.json();
  return data.choices[0].message.content;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function val(id){ const el=document.getElementById(id); return el?el.value.trim():''; }
function esc(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtDate(iso){ if(!iso)return'â€”'; const d=new Date(iso); return d.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit'}); }
function fmtTime(iso){ if(!iso)return'â€”'; const d=new Date(iso); return d.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'})+' '+d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}); }
function levelLabel(l){ return {critical:'CRÃTICO',warning:'ALERTA',info:'INFO'}[l]||l||'?'; }
function levelColor(l){ return {critical:'var(--danger)',warning:'var(--warn)',info:'var(--accent2)'}[l]||'var(--border2)'; }
function setStatus(t){ document.getElementById('foot-status').textContent=t; }
function showAlert(containerId, msg, type){
  const cls={ok:'alert-ok',err:'alert-err',warn:'alert-warn',info:'alert-info'}[type]||'alert-info';
  const html=`<div class="alert ${cls}">${msg}</div>`;
  if(containerId){ const el=document.getElementById(containerId); if(el){ el.innerHTML=html; setTimeout(()=>el.innerHTML='',5000); } }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
restoreLocal();
renderAll();
drawRadar('radar-dash', getDimScores());
renderRadarLegend('radar-legend-dash', true);
syncAll();
setInterval(syncAll, 15*60*1000); // auto-sync cada 15 min
</script>
</body>
</html>
