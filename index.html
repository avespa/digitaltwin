<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDT ‚Äî Compliance Digital Twin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#070b0f;--surface:#0c1117;--surface2:#111820;--surface3:#161f28;
  --border:#1a2530;--border2:#243040;
  --accent:#00e5a0;--accent2:#0066ff;--warn:#f59e0b;--danger:#ef4444;--purple:#8b5cf6;
  --text:#dce8f0;--text-muted:#3d5468;--text-dim:#7a96aa;
  --font-ui:'Syne',sans-serif;--font-mono:'DM Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{background:var(--bg);color:var(--text);font-family:var(--font-mono);overflow:hidden}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,229,160,.006) 3px,rgba(0,229,160,.006) 4px);pointer-events:none;z-index:9999}

/* LAYOUT */
.shell{display:flex;height:100vh;overflow:hidden}

/* SIDEBAR */
.sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.logo{padding:22px 18px 16px;border-bottom:1px solid var(--border)}
.logo-mark{font-family:var(--font-ui);font-weight:800;font-size:18px;color:var(--accent);display:flex;align-items:center;gap:8px}
.logo-dot{width:8px;height:8px;background:var(--accent);border-radius:50%;box-shadow:0 0 12px var(--accent);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 6px var(--accent)}50%{box-shadow:0 0 20px var(--accent),0 0 35px rgba(0,229,160,.25)}}
.logo-sub{font-size:9px;color:var(--text-muted);letter-spacing:2.5px;text-transform:uppercase;margin-top:3px}
.nav{padding:10px 0;flex:1}
.nav-group{padding:12px 16px 4px;font-size:8px;letter-spacing:2.5px;text-transform:uppercase;color:var(--text-muted)}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 16px;cursor:pointer;font-size:11px;color:var(--text-dim);transition:all .15s;border-left:2px solid transparent;user-select:none;position:relative}
.nav-item:hover{color:var(--text);background:rgba(255,255,255,.02)}
.nav-item.active{color:var(--accent);border-left-color:var(--accent);background:rgba(0,229,160,.04)}
.nav-item .icon{width:15px;text-align:center;font-size:12px;flex-shrink:0}
.nav-badge{margin-left:auto;font-size:9px;padding:1px 5px;border-radius:8px;min-width:16px;text-align:center}
.nb-danger{background:rgba(239,68,68,.2);color:var(--danger)}
.nb-warn{background:rgba(245,158,11,.2);color:var(--warn)}
.nb-accent{background:rgba(0,229,160,.15);color:var(--accent)}
.sidebar-foot{padding:12px 16px;border-top:1px solid var(--border);font-size:9.5px;color:var(--text-muted)}
.sync-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--accent);margin-right:5px;animation:pulse 2s infinite}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:52px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 22px;gap:10px;flex-shrink:0}
.topbar-title{font-family:var(--font-ui);font-weight:700;font-size:14px;flex:1}
.topbar-meta{font-size:10px;color:var(--text-muted)}
.page{flex:1;overflow-y:auto;padding:22px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:4px;font-family:var(--font-mono);font-size:11px;cursor:pointer;border:1px solid transparent;transition:all .15s;white-space:nowrap;text-decoration:none}
.btn-primary{background:var(--accent);color:#000;font-weight:500}.btn-primary:hover{background:#00ffb3;box-shadow:0 0 20px rgba(0,229,160,.3)}
.btn-ghost{background:transparent;color:var(--text-dim);border-color:var(--border)}.btn-ghost:hover{color:var(--text);border-color:var(--border2)}
.btn-danger{background:transparent;color:var(--danger);border-color:rgba(239,68,68,.3)}.btn-danger:hover{background:rgba(239,68,68,.08)}
.btn-purple{background:rgba(139,92,246,.15);color:var(--purple);border-color:rgba(139,92,246,.3)}.btn-purple:hover{background:rgba(139,92,246,.25)}
.btn-warn{background:rgba(245,158,11,.1);color:var(--warn);border-color:rgba(245,158,11,.3)}
.btn-sm{padding:4px 9px;font-size:10px}
.btn-xs{padding:2px 7px;font-size:9px}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:18px}
.card-sm{padding:13px}
.card-title{font-family:var(--font-ui);font-size:11.5px;font-weight:700;letter-spacing:.3px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.card-title-left{display:flex;align-items:center;gap:8px}

/* STATS */
.kri-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px}
.kri{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:14px 16px;position:relative;overflow:hidden;cursor:default}
.kri::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--c,var(--accent))}
.kri-label{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px}
.kri-val{font-family:var(--font-ui);font-size:24px;font-weight:800;color:var(--c,var(--accent));line-height:1}
.kri-sub{font-size:9px;color:var(--text-muted);margin-top:4px}

/* GRIDS */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}

/* FORM */
.fg{margin-bottom:13px}
.fl{display:block;font-size:8.5px;letter-spacing:1.8px;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px}
.fi{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:8px 10px;color:var(--text);font-family:var(--font-mono);font-size:11px;transition:border-color .15s;outline:none}
.fi:focus{border-color:var(--accent)}
.fi::placeholder{color:var(--text-muted)}
textarea.fi{resize:vertical;line-height:1.6}
select.fi{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%233d5468'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;cursor:pointer}
.fhint{font-size:9px;color:var(--text-muted);margin-top:3px}
.fsec{font-family:var(--font-ui);font-size:12px;font-weight:700;color:var(--text-dim);margin:20px 0 12px;padding-bottom:6px;border-bottom:1px solid var(--border)}

/* VIEWS */
.view{display:none}.view.active{display:block}

/* PAGE HEADER */
.ph{margin-bottom:20px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
.ph-left .ph-title{font-family:var(--font-ui);font-size:19px;font-weight:800;margin-bottom:3px}
.ph-left .ph-sub{font-size:11px;color:var(--text-muted)}
.ph-actions{display:flex;gap:8px;flex-shrink:0;align-items:flex-start}

/* HITS */
.hit{border-left:3px solid var(--border2);padding:11px 14px;margin-bottom:7px;background:var(--surface);border-radius:0 5px 5px 0;transition:border-color .15s}
.hit.critical{border-left-color:var(--danger)}
.hit.warning{border-left-color:var(--warn)}
.hit.info{border-left-color:var(--accent2)}
.hit-head{display:flex;align-items:center;gap:7px;margin-bottom:4px;flex-wrap:wrap}
.tag{font-size:8.5px;letter-spacing:1px;text-transform:uppercase;padding:2px 6px;border-radius:3px;font-weight:600;flex-shrink:0}
.tag-critical,.tag-alto{background:rgba(239,68,68,.15);color:var(--danger)}
.tag-warning,.tag-medio{background:rgba(245,158,11,.15);color:var(--warn)}
.tag-info,.tag-bajo{background:rgba(0,102,255,.15);color:var(--accent2)}
.tag-irrelevant{background:rgba(74,96,112,.12);color:var(--text-muted)}
.tag-open{background:rgba(245,158,11,.15);color:var(--warn)}
.tag-progress{background:rgba(139,92,246,.15);color:var(--purple)}
.tag-closed{background:rgba(0,229,160,.1);color:var(--accent)}
.hit-source{font-size:9px;color:var(--text-muted)}
.hit-date{font-size:9px;color:var(--text-muted);margin-left:auto}
.hit-title{font-size:11.5px;font-weight:500;margin-bottom:3px;line-height:1.4}
.hit-summary{font-size:10.5px;color:var(--text-dim);line-height:1.5}
.hit-extra{margin-top:8px;display:none}
.hit-extra.open{display:block}
.hit-twin-box{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:10px;margin-top:8px}
.hit-twin-label{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent);margin-bottom:4px}
.hit-detail-row{margin-bottom:6px}
.hit-detail-label{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:2px}
.hit-detail-val{font-size:10.5px;color:var(--text-dim);line-height:1.5}
./* score-bar removed */
/* score-fill removed */

/* RADAR */
.radar-wrap{display:flex;align-items:center;gap:24px}
.radar-legend{flex:1}
.dim-row{display:flex;align-items:center;gap:8px;margin-bottom:9px;cursor:pointer;padding:5px 8px;border-radius:4px;transition:background .15s}
.dim-row:hover{background:rgba(255,255,255,.03)}
.dim-label{flex:1;font-size:11px;color:var(--text-dim)}
.dim-score{font-family:var(--font-ui);font-weight:700;font-size:12px;color:var(--accent);min-width:32px;text-align:right}
.dim-bar{height:3px;background:var(--border2);border-radius:2px;margin-top:2px}
.dim-fill{height:100%;border-radius:2px;background:var(--accent);transition:width .6s}

/* MATURITY ELEMENT */
.mel{background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:12px;margin-bottom:8px}
.mel-head{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.mel-name{flex:1;font-size:11px;font-weight:500}
.mel-score-wrap{display:flex;align-items:center;gap:6px}
.score-btn{width:26px;height:26px;border-radius:4px;border:1px solid var(--border2);background:var(--surface2);color:var(--text-muted);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:var(--font-mono)}
.score-btn:hover{border-color:var(--accent);color:var(--accent)}
.score-btn.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700}
.mel-evidence{width:100%;margin-top:6px}
.mel-actions{display:flex;gap:5px;margin-top:6px}

/* ACTION PLANS */
.ap{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:13px;margin-bottom:8px}
.ap-head{display:flex;align-items:flex-start;gap:8px;margin-bottom:7px}
.ap-title{flex:1;font-size:11.5px;font-weight:500;line-height:1.4}
.ap-meta{font-size:9.5px;color:var(--text-muted);display:flex;gap:10px;flex-wrap:wrap;margin-bottom:7px}
.ap-progress{margin-top:8px}
.ap-steps{margin-top:6px}
.ap-step{display:flex;align-items:flex-start;gap:7px;padding:5px 0;border-bottom:1px solid var(--border);font-size:10.5px;color:var(--text-dim)}
.ap-step:last-child{border-bottom:none}
.ap-step-check{width:14px;height:14px;border:1px solid var(--border2);border-radius:3px;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-top:1px}
.ap-step-check.done{background:var(--accent);border-color:var(--accent);color:#000;font-size:9px}

/* TWIN SUMMARY */
.twin-summary-box{background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:14px;font-size:11px;color:var(--text-dim);line-height:1.8;white-space:pre-wrap;min-height:120px}

/* HISTORY */
.hist-item{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);font-size:10.5px}
.hist-item:last-child{border-bottom:none}
.hist-date{color:var(--text-muted);flex-shrink:0;font-size:9.5px;min-width:100px}
.hist-score{color:var(--accent);font-weight:600;min-width:40px}
.hist-note{flex:1;color:var(--text-dim)}

/* ALERT */
.alert{padding:9px 13px;border-radius:4px;font-size:11px;margin-bottom:13px;display:flex;align-items:flex-start;gap:7px;line-height:1.5}
.alert-ok{background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.2);color:var(--accent)}
.alert-err{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:var(--danger)}
.alert-warn{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);color:var(--warn)}
.alert-info{background:rgba(0,102,255,.08);border:1px solid rgba(0,102,255,.2);color:var(--accent2)}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);z-index:500;align-items:center;justify-content:center}
.overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:24px;width:640px;max-height:90vh;overflow-y:auto;position:relative}
.modal-lg{width:820px}
.modal-title{font-family:var(--font-ui);font-size:15px;font-weight:700;margin-bottom:18px;padding-right:28px}
.modal-x{position:absolute;top:18px;right:18px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:17px;line-height:1}
.modal-x:hover{color:var(--text)}

/* BRIEF */
.brief-page{background:#fff;color:#111;padding:40px;font-family:Georgia,serif;font-size:12px;line-height:1.6;max-width:780px;margin:0 auto}
.brief-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;padding-bottom:16px;border-bottom:2px solid #000}
.brief-logo{font-size:22px;font-weight:900;letter-spacing:-1px}
.brief-date{font-size:10px;color:#666;text-align:right}
.brief-h1{font-size:18px;font-weight:700;margin-bottom:6px}
.brief-h2{font-size:13px;font-weight:700;margin:20px 0 8px;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid #ddd;padding-bottom:4px}
.brief-kri-row{display:flex;gap:16px;margin-bottom:20px}
.brief-kri{flex:1;border:1px solid #ddd;padding:12px;border-radius:4px;text-align:center}
.brief-kri-val{font-size:28px;font-weight:900;margin-bottom:3px}
.brief-kri-label{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:#666}

/* UTILS */
.flex{display:flex}.ic{align-items:center}.jb{justify-content:space-between}.gap6{gap:6px}.gap8{gap:8px}.gap12{gap:12px}
.mt6{margin-top:6px}.mt10{margin-top:10px}.mt14{margin-top:14px}.mt18{margin-top:18px}.mb8{margin-bottom:8px}.mb14{margin-bottom:14px}
.text-muted{color:var(--text-muted)}.text-dim{color:var(--text-dim)}.text-accent{color:var(--accent)}.text-danger{color:var(--danger)}.text-warn{color:var(--warn)}
.mono{font-family:var(--font-mono)}.ui{font-family:var(--font-ui)}
.divider{border:none;border-top:1px solid var(--border);margin:16px 0}
.empty{text-align:center;padding:36px 16px;color:var(--text-muted)}
.empty-icon{font-size:26px;margin-bottom:8px}
.empty-title{font-family:var(--font-ui);font-size:12px;color:var(--text-dim);margin-bottom:4px}
.empty-sub{font-size:10px}
.spin{width:13px;height:13px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:rotate .6s linear infinite;display:inline-block;flex-shrink:0}
@keyframes rotate{to{transform:rotate(360deg)}}
code{background:var(--surface2);padding:1px 5px;border-radius:3px;font-size:10.5px;color:var(--accent)}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* TABS */
.tab-bar{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:16px}
.tab{padding:9px 18px;font-size:11px;cursor:pointer;color:var(--text-dim);border-bottom:2px solid transparent;transition:all .15s;font-family:var(--font-mono)}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-pane{display:none}.tab-pane.active{display:block}

/* CONTROLS TABLE */
.ctrl-table{width:100%;border-collapse:collapse;font-size:10.5px}
.ctrl-table th{background:var(--surface2);padding:7px 10px;text-align:left;font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);border-bottom:1px solid var(--border);white-space:nowrap;position:sticky;top:0}
.ctrl-table td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text-dim);vertical-align:middle;line-height:1.4}
.ctrl-table tr:hover td{background:rgba(255,255,255,.02);color:var(--text)}
.ctrl-row-selected td{background:rgba(0,229,160,.04)!important;border-left:2px solid var(--accent)}
.ctrl-table tr.dup-warn td{background:rgba(245,158,11,.04);border-left:2px solid var(--warn)}
.ctrl-wrap{overflow-x:auto;max-height:calc(100vh - 340px);border:1px solid var(--border);border-radius:6px}
.freq-tag{font-size:8px;padding:2px 6px;border-radius:10px;background:rgba(0,102,255,.12);color:var(--accent2);letter-spacing:.5px}
.nat-prev{color:var(--accent);font-size:9px;font-weight:600}
.nat-det{color:var(--purple);font-size:9px;font-weight:600}
.exec-yes{color:var(--accent);font-size:9px;font-weight:600}
.exec-no{color:var(--warn);font-size:9px}

/* FUNNEL */
.funnel-bar{display:flex;align-items:stretch;gap:0;margin-bottom:16px;border:1px solid var(--border);border-radius:6px;overflow:hidden}
.funnel-step{flex:1;padding:12px 16px;text-align:center;cursor:pointer;border-right:1px solid var(--border);transition:background .15s}
.funnel-step:last-child{border-right:none}
.funnel-step:hover{background:rgba(255,255,255,.02)}
.funnel-step.active{background:rgba(0,229,160,.04);border-bottom:2px solid var(--accent)}
.funnel-count{font-family:var(--font-ui);font-size:24px;font-weight:800;line-height:1}
.funnel-label{font-size:13px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);margin-top:3px}
.funnel-arrow{display:flex;align-items:center;padding:0 6px;color:var(--text-muted);font-size:16px;flex-shrink:0}

/* SENTENCIAS */
.sent-card{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:13px;margin-bottom:8px;border-left:3px solid var(--purple)}
.sent-tag{background:rgba(139,92,246,.15);color:var(--purple);font-size:8.5px;padding:2px 7px;border-radius:3px;font-weight:600;letter-spacing:.5px}

/* EXEC HISTORY */
.exec-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--border);font-size:10px}
.exec-row:last-child{border-bottom:none}
.exec-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}


/* DUAL RISK DISPLAY */
.risk-dual{display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.risk-pill{display:flex;align-items:center;gap:4px}
.risk-pill-label{font-size:7px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted)}
.risk-pill-val{font-size:8.5px}
.rag-badge{font-size:7.5px;background:rgba(0,229,160,.1);color:var(--accent);padding:1px 6px;border-radius:3px;letter-spacing:.5px;margin-left:6px}


/* ‚îÄ‚îÄ Deepdive drawer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;opacity:0;pointer-events:none;transition:opacity .25s}
.drawer-overlay.open{opacity:1;pointer-events:all}
.drawer{position:fixed;top:0;right:0;height:100vh;width:min(680px,90vw);background:var(--surface);border-left:1px solid var(--border2);z-index:501;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;overflow:hidden}
.drawer.open{transform:translateX(0)}
.drawer-head{padding:18px 20px;border-bottom:1px solid var(--border2);display:flex;align-items:flex-start;gap:12px;flex-shrink:0}
.drawer-close{background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer;padding:0;line-height:1;margin-left:auto;flex-shrink:0}
.drawer-close:hover{color:var(--text)}
.drawer-body{flex:1;overflow-y:auto;padding:20px}
.drawer-foot{padding:14px 20px;border-top:1px solid var(--border2);display:flex;gap:8px;align-items:center;flex-shrink:0;background:var(--surface)}
.dd-section{margin-bottom:20px}
.dd-section-title{font-size:8px;letter-spacing:2px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase}
.dd-block{background:var(--surface2);border-radius:5px;padding:12px 14px;font-size:10.5px;color:var(--text-dim);line-height:1.7;margin-bottom:8px}
.dd-block.danger{border-left:3px solid var(--danger)}
.dd-block.warn{border-left:3px solid var(--warn)}
.dd-block.ok{border-left:3px solid var(--accent)}
.dd-pill-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.dd-pill{font-size:9px;padding:3px 9px;border-radius:12px;background:rgba(0,229,160,.08);color:var(--accent);border:1px solid rgba(0,229,160,.2)}
.dd-pill.ctrl{background:rgba(139,92,246,.08);color:var(--purple);border-color:rgba(139,92,246,.2)}
.dd-pill.gap{background:rgba(245,158,11,.08);color:var(--warn);border-color:rgba(245,158,11,.2)}
.dd-disclaimer{font-size:9px;color:var(--text-muted);background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.15);border-radius:4px;padding:8px 10px;margin-bottom:14px;line-height:1.5}
.dd-meta{font-size:8.5px;color:var(--text-muted);margin-top:4px}
.dd-precedent{background:var(--surface2);border-radius:4px;padding:8px 10px;margin-bottom:6px;font-size:10px;color:var(--text-dim);line-height:1.6;border-left:2px solid var(--border2)}
</style>
</head>
<body>
<div class="shell">

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="logo">
    <div class="logo-mark"><span class="logo-dot"></span>CDT</div>
    <div class="logo-sub">Compliance Digital Twin</div>
  </div>
  <div class="nav">
    <div class="nav-group">‚óà Mi Digital Twin</div>
    <div class="nav-item active" data-view="dashboard" onclick="go('dashboard')"><span class="icon">‚óà</span>Dashboard & KRIs</div>
    <div class="nav-item" data-view="contexto" onclick="go('contexto')"><span class="icon">‚¨°</span>Contexto Organizacional</div>
    <div class="nav-item" data-view="madurez" onclick="go('madurez')"><span class="icon">‚óé</span>Assessment de Madurez</div>
    <div class="nav-item" data-view="controles" onclick="go('controles')"><span class="icon">‚¨ü</span>Controles de Compliance</div>
    <div class="nav-item" data-view="twin-summary" onclick="go('twin-summary')"><span class="icon">‚ú¶</span>Resumen Ejecutivo Twin</div>

    <div class="nav-group" style="margin-top:10px">‚üÅ Monitor Activo</div>
    <div class="nav-item" data-view="hits" onclick="go('hits')"><span class="icon">‚ö°</span>Monitorizaci√≥n de Hits<span class="nav-badge nb-danger" id="badge-hits">0</span></div>
    <div class="nav-item" data-view="sentencias" onclick="go('sentencias')"><span class="icon">‚öñ</span>Sentencias<span class="nav-badge nb-accent" id="badge-sent">0</span></div>
    <div class="nav-item" data-view="fuentes" onclick="go('fuentes')"><span class="icon">üì°</span>Fuentes & B√∫squedas</div>

    <div class="nav-group" style="margin-top:10px">‚öô Sistema</div>
    <div class="nav-item" data-view="analisis" onclick="go('analisis')"><span class="icon">‚óâ</span>An√°lisis Manual IA</div>
    <div class="nav-item" data-view="config" onclick="go('config')"><span class="icon">‚öô</span>Configuraci√≥n APIs</div>
  </div>
  <div class="sidebar-foot">
    <span class="sync-dot"></span><span id="foot-status">Iniciando...</span>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="tb-title">Dashboard & KRIs</div>
    <div class="topbar-meta" id="tb-meta"></div>
    <button class="btn btn-ghost" onclick="syncAll()" id="sync-btn" title="Sincroniza datos con Firestore y GitHub. Actualiza hits, controles y configuraci√≥n.">‚ü≥ Sync</button>
    <button class="btn btn-primary" onclick="go('analisis')">+ An√°lisis</button>
  </div>

  <div class="page">

  <!-- DASHBOARD -->
  <div class="view active" id="view-dashboard">
    <div id="twin-disclaimer"></div>
    <div class="kri-grid">
      <div class="kri" style="--c:var(--accent)"><div class="kri-label">Madurez Global</div><div class="kri-val" id="kri-madurez">‚Äî</div><div class="kri-sub">/5.0 puntos</div></div>
      <div class="kri" style="--c:var(--danger)"><div class="kri-label">Hits Cr√≠ticos</div><div class="kri-val" id="kri-criticos">0</div><div class="kri-sub">sin plan de acci√≥n</div></div>
      <div class="kri" style="--c:var(--warn)"><div class="kri-label">Planes Abiertos</div><div class="kri-val" id="kri-planes">0</div><div class="kri-sub">requieren atenci√≥n</div></div>
      <div class="kri" style="--c:var(--accent2)"><div class="kri-label">√öltima Sync</div><div class="kri-val" style="font-size:14px;padding-top:4px" id="kri-sync">‚Äî</div><div class="kri-sub">actualizaci√≥n hits</div></div>
    </div>

    <div class="g2" style="margin-bottom:16px">
      <div class="card">
        <div class="card-title"><span class="card-title-left">üì° Radar de Madurez</span><button class="btn btn-ghost btn-xs" onclick="go('madurez')">Ver detalle ‚Üí</button></div>
        <div class="radar-wrap">
          <canvas id="radar-dash" width="200" height="200"></canvas>
          <div class="radar-legend" id="radar-legend-dash"></div>
        </div>
        <div id="dash-narrative" style="margin-top:12px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;font-size:10.5px;color:var(--text-dim);line-height:1.6"></div>
      </div>
      <div class="card">
        <div class="card-title"><span class="card-title-left">‚ö° √öltimos Hits</span><button class="btn btn-ghost btn-xs" onclick="go('hits')">Ver todos ‚Üí</button></div>
        <div id="dash-hits"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span class="card-title-left">‚óâ Planes de Acci√≥n Activos</span><button class="btn btn-ghost btn-xs" onclick="go('planes')">Ver todos ‚Üí</button></div>
      <div id="dash-planes"></div>
    </div>
  </div>

  <!-- CONTEXTO ORGANIZACIONAL -->
  <div class="view" id="view-contexto">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Contexto Organizacional</div><div class="ph-sub">ISO 37301 ¬ß4.1-4.2 ‚Äî Define el modelo base de tu Digital Twin</div></div>
      <div class="ph-actions">
        <button class="btn btn-purple" onclick="openDocAnalysis('contexto')">üìÑ Analizar documento</button>
        <button class="btn btn-ghost" onclick="loadContexto()">Descartar</button>
        <button class="btn btn-primary" onclick="saveContexto()">Guardar ‚Üí</button>
      </div>
    </div>
    <div id="ctx-alert"></div>

    <div class="g2" style="align-items:start">
      <div>
        <div class="fsec">¬ß4.1 Identificaci√≥n de la Organizaci√≥n</div>
        <div class="fg"><label class="fl">Nombre legal de la organizaci√≥n *</label><input type="text" class="fi" id="ctx-name" placeholder="Empresa S.A."></div>
        <div class="g2">
          <div class="fg"><label class="fl">Sector *</label>
            <select class="fi" id="ctx-sector">
              <option value="">Selecciona...</option>
              <option>Financiero / Banca</option><option>Seguros</option><option>Tecnolog√≠a / Digital</option>
              <option>Salud / Farmacia</option><option>Energ√≠a / Utilities</option><option>Construcci√≥n / Real Estate</option>
              <option>Alimentaci√≥n / FMCG</option><option>Manufactura / Industrial</option>
              <option>Transporte / Log√≠stica</option><option>Servicios Profesionales</option>
              <option>Retail</option><option>Administraci√≥n P√∫blica</option><option>Otro</option>
            </select>
          </div>
          <div class="fg"><label class="fl">Tama√±o</label>
            <select class="fi" id="ctx-size">
              <option>Microempresa (&lt;10 empleados)</option><option>Peque√±a (10-49)</option>
              <option>Mediana (50-249)</option><option>Grande (250-999)</option><option>Corporaci√≥n (1000+)</option>
            </select>
          </div>
        </div>
        <div class="g2">
          <div class="fg"><label class="fl">Facturaci√≥n anual</label>
            <select class="fi" id="ctx-revenue">
              <option>&lt; 2M ‚Ç¨</option><option>2-10M ‚Ç¨</option><option>10-50M ‚Ç¨</option>
              <option>50-250M ‚Ç¨</option><option>250M-1B ‚Ç¨</option><option>&gt; 1B ‚Ç¨</option>
            </select>
          </div>
          <div class="fg"><label class="fl">√Åmbito geogr√°fico</label>
            <select class="fi" id="ctx-geo">
              <option>Local / Regional</option><option>Espa√±a</option><option>Espa√±a + Portugal</option>
              <option>Espa√±a + LATAM</option><option>Uni√≥n Europea</option><option>Global</option>
            </select>
          </div>
        </div>
        <div class="fg"><label class="fl">Descripci√≥n del modelo de negocio *</label>
          <textarea class="fi" id="ctx-business" rows="3" placeholder="Qu√© hace la empresa, c√≥mo genera valor, cadena de valor principal..."></textarea>
        </div>
        <div class="fg"><label class="fl">Estrategia y objetivos principales</label>
          <textarea class="fi" id="ctx-strategy" rows="2" placeholder="Direcci√≥n estrat√©gica, planes de expansi√≥n, digitalizaci√≥n..."></textarea>
        </div>

        <div class="fsec">¬ß4.1 Contexto Externo</div>
        <div class="fg"><label class="fl">Marco legal y regulatorio aplicable</label>
          <textarea class="fi" id="ctx-legal" rows="3" placeholder="Normativa sectorial, licencias, supervisores regulatorios (CNMV, AEPD, Banco de Espa√±a...), legislaci√≥n penal relevante..."></textarea>
        </div>
        <div class="fg"><label class="fl">Contexto econ√≥mico y de mercado</label>
          <textarea class="fi" id="ctx-economic" rows="2" placeholder="Situaci√≥n competitiva, presiones de mercado, ciclo econ√≥mico..."></textarea>
        </div>
        <div class="fg"><label class="fl">Contexto social, cultural y medioambiental</label>
          <textarea class="fi" id="ctx-social" rows="2" placeholder="Expectativas sociales, compromisos ESG, impacto ambiental..."></textarea>
        </div>
        <div class="fg"><label class="fl">Tendencias futuras con impacto en compliance</label>
          <textarea class="fi" id="ctx-trends" rows="2" placeholder="Nuevas regulaciones esperadas, cambios tecnol√≥gicos, geopol√≠tica..."></textarea>
        </div>
      </div>

      <div>
        <div class="fsec">¬ß4.1 Contexto Interno</div>
        <div class="fg"><label class="fl">Estructura organizativa</label>
          <textarea class="fi" id="ctx-structure" rows="2" placeholder="Tipo de estructura, n√∫mero de unidades, presencia internacional, subsidiarias..."></textarea>
        </div>
        <div class="fg"><label class="fl">Cultura de compliance actual</label>
          <textarea class="fi" id="ctx-culture" rows="2" placeholder="Nivel de cultura √©tica, historial de incidentes, tono desde la c√∫pula..."></textarea>
        </div>
        <div class="fg"><label class="fl">Recursos tecnol√≥gicos relevantes</label>
          <textarea class="fi" id="ctx-tech" rows="2" placeholder="Sistemas de informaci√≥n, herramientas de compliance, nivel de digitalizaci√≥n..."></textarea>
        </div>
        <div class="fg"><label class="fl">Relaciones con terceros (scope y naturaleza)</label>
          <textarea class="fi" id="ctx-thirds" rows="2" placeholder="Proveedores cr√≠ticos, distribuidores, agentes, intermediarios, joint ventures..."></textarea>
        </div>

        <div class="fsec">¬ß4.2 Partes Interesadas</div>
        <div class="fg"><label class="fl">Partes interesadas externas y sus expectativas</label>
          <textarea class="fi" id="ctx-ext-parties" rows="3" placeholder="Reguladores (CNMV, AEPD, Banco de Espa√±a...), clientes, inversores, proveedores, sociedad... y qu√© esperan de nosotros en t√©rminos de compliance."></textarea>
        </div>
        <div class="fg"><label class="fl">Partes interesadas internas y sus expectativas</label>
          <textarea class="fi" id="ctx-int-parties" rows="2" placeholder="Consejo de administraci√≥n, alta direcci√≥n, empleados, auditor√≠a interna... y sus expectativas de compliance."></textarea>
        </div>

        <div class="fsec">Normas y Obligaciones Compliance</div>
        <div class="fg"><label class="fl">Normas voluntarias adoptadas</label>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px" id="ctx-norms-checks">
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="ISO 37301"> ISO 37301</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="UNE 19601"> UNE 19601</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="ISO 37001"> ISO 37001</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="RGPD"> RGPD</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="PBC/AML"> PBC/AML</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="DORA"> DORA</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="ESG/CSRD"> ESG/CSRD</label>
            <label class="flex ic gap6" style="font-size:11px;cursor:pointer"><input type="checkbox" class="ctx-norm" value="NIS2"> NIS2</label>
          </div>
        </div>
        <div class="fg"><label class="fl">Riesgos de compliance prioritarios identificados</label>
          <textarea class="fi" id="ctx-risks" rows="3" placeholder="Top riesgos: corrupci√≥n, blanqueo, protecci√≥n de datos, responsabilidad penal, conflictos de inter√©s, conducta de mercado..."></textarea>
        </div>
        <div class="fg"><label class="fl">Historial de incidentes o sanciones relevantes</label>
          <textarea class="fi" id="ctx-incidents" rows="2" placeholder="Expedientes previos, sanciones recibidas, investigaciones, noticias negativas..."></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- ASSESSMENT DE MADUREZ -->
  <div class="view" id="view-madurez">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Assessment de Madurez</div><div class="ph-sub">ISO 37301 ‚Äî 7 dimensiones ¬∑ Escala 1-5</div></div>
      <div class="ph-actions">
        <button class="btn btn-ghost btn-sm" onclick="openHistory()">üìã Historial</button>
        <button class="btn btn-purple" onclick="openDocAnalysis('madurez')">üìÑ Analizar doc</button>
        <button class="btn btn-primary" onclick="saveMaturity()">Guardar versi√≥n ‚Üí</button>
      </div>
    </div>
    <div id="mat-alert"></div>

    <div class="g2" style="align-items:start;margin-bottom:16px">
      <div class="card">
        <div class="card-title">Radar de Madurez</div>
        <div class="radar-wrap">
          <canvas id="radar-mat" width="200" height="200"></canvas>
          <div class="radar-legend" id="radar-legend-mat"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Puntuaciones por dimensi√≥n</div>
        <div id="mat-scores-summary"></div>
      </div>
    </div>

    <!-- Filter bar -->
    <div class="card mb14" style="padding:12px 16px">
      <div class="flex ic gap8 flex-wrap">
        <span style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);flex-shrink:0">Filtrar:</span>
        <button class="btn btn-ghost btn-xs mat-filter-btn active" data-filter="all" onclick="setMatFilter('all')">Todos</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="0" onclick="setMatFilter('0')" style="color:var(--text-muted)">Sin evaluar</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="1" onclick="setMatFilter('1')" style="color:var(--danger)">1 ‚Äî No existe</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="2" onclick="setMatFilter('2')" style="color:var(--warn)">2 ‚Äî Inicial</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="3" onclick="setMatFilter('3')" style="color:#eab308">3 ‚Äî Definido</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="4" onclick="setMatFilter('4')" style="color:var(--accent2)">4 ‚Äî Gestionado</button>
        <button class="btn btn-ghost btn-xs mat-filter-btn" data-filter="5" onclick="setMatFilter('5')" style="color:var(--accent)">5 ‚Äî Optimizado</button>
        <div style="flex:1"></div>
        <button class="btn btn-ghost btn-xs" onclick="collapseAllDims(true)">‚äü Plegar todos</button>
        <button class="btn btn-ghost btn-xs" onclick="collapseAllDims(false)">‚äû Desplegar todos</button>
      </div>
    </div>

    <div id="mat-dimensions"></div>
  </div>

  <!-- TWIN SUMMARY -->
  <div class="view" id="view-twin-summary">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Resumen Ejecutivo del Twin</div><div class="ph-sub">500 palabras ¬∑ Usado en todos los an√°lisis de hits</div></div>
      <div class="ph-actions">
        <button class="btn btn-purple" id="gen-summary-btn" onclick="generateTwinSummary()">‚ú¶ Generar con IA</button>
        <button class="btn btn-primary" onclick="saveTwinSummary()">Guardar ‚Üí</button>
      </div>
    </div>
    <div id="ts-alert"></div>
    <div class="card">
      <div class="card-title">Resumen ejecutivo <span class="text-muted" style="font-weight:400;font-size:10px">Editable ‚Äî se usa como contexto en cada an√°lisis de hit</span></div>
      <textarea class="fi" id="twin-summary-text" rows="18" placeholder="Haz clic en 'Generar con IA' para crear el resumen autom√°ticamente a partir del contexto organizacional y el assessment de madurez.\n\nO escribe manualmente el contexto que quieres que Mistral use al analizar cada hit."></textarea>
    </div>
    <div class="card mt14">
      <div class="card-title">Informaci√≥n del Twin</div>
      <div class="g3">
        <div><div class="fl">√öltima actualizaci√≥n</div><div style="font-size:11px" id="ts-updated">‚Äî</div></div>
        <div><div class="fl">Contexto organizacional</div><div style="font-size:11px" id="ts-ctx-status">‚Äî</div></div>
        <div><div class="fl">Assessment madurez</div><div style="font-size:11px" id="ts-mat-status">‚Äî</div></div>
      </div>
    </div>
  </div>

  <!-- HITS -->
  <div class="view" id="view-hits">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Monitorizaci√≥n de Hits</div><div class="ph-sub" id="hits-sync-info">Funnel de relevancia ¬∑ Filtrado por keywords ‚Üí Impacto en tu empresa</div></div>
      <div class="ph-actions">
        <button class="btn btn-ghost btn-sm" id="batch-reanalyze-btn" onclick="batchReAnalyze()" title="Re-analiza todos los hits pendientes contra tu Digital Twin">‚ü≥ Re-evaluar todos</button>
        <button class="btn btn-ghost btn-sm" onclick="syncHits()">Sync</button>
      </div>
    </div>
    <div id="hits-alert" style="margin-bottom:10px"></div>

    <!-- Funnel: Analizados ‚Üí Impactos ‚Üí Planes de Acci√≥n -->
    <div class="funnel-bar mb14">
      <div class="funnel-step active" id="funnel-all" onclick="setHitFunnel('all')">
        <div class="funnel-count text-accent" id="funnel-count-all">0</div>
        <div class="funnel-label">Analizados</div>
        <div style="font-size:9px;color:var(--text-muted);margin-top:2px">total recibidos</div>
      </div>
      <div class="funnel-arrow">‚Üí</div>
      <div class="funnel-step" id="funnel-company" onclick="setHitFunnel('impacts')">
        <div style="display:flex;align-items:baseline;gap:6px;justify-content:center">
          <div class="funnel-count" id="funnel-count-company" style="color:var(--warn)">0</div>
          <div style="font-size:11px;color:var(--text-muted)">¬∑</div>
          <div id="funnel-count-residual-alto" style="font-family:var(--font-ui);font-size:18px;font-weight:800;color:var(--danger)">0</div>
        </div>
        <div class="funnel-label">Impactos</div>
        <div style="font-size:9px;color:var(--text-muted);margin-top:2px">
          <span style="color:var(--warn)">inh.</span> medio/alto ¬∑ <span style="color:var(--danger)">res.</span> alto
        </div>
      </div>
      <div class="funnel-arrow">‚Üí</div>
      <div class="funnel-step" id="funnel-plans" onclick="setHitFunnel('plans')">
        <div class="funnel-count" id="funnel-count-plans" style="color:var(--accent)">0</div>
        <div class="funnel-label">Planes de Acci√≥n</div>
        <div style="font-size:9px;color:var(--text-muted);margin-top:2px">en seguimiento</div>
      </div>
    </div>

    <!-- Dual filters: inherente + residual + source + search -->
    <div class="flex ic gap8 mb14 flex-wrap">
      <select class="fi" style="width:145px" id="hit-filter-inh" onchange="renderHits()">
        <option value="">Inherente</option>
        <option value="alto">Alto</option>
        <option value="medio">Medio</option>
        <option value="bajo">Bajo</option>
        <option value="irrelevant">No aplica</option>
      </select>
      <select class="fi" style="width:145px" id="hit-filter-res" onchange="renderHits()">
        <option value="">Residual</option>
        <option value="alto">Alto</option>
        <option value="medio">Medio</option>
        <option value="bajo">Bajo</option>
        <option value="irrelevant">No aplica</option>
      </select>
      <select class="fi" style="width:140px" id="hit-filter-source" onchange="renderHits()">
        <option value="">Fuente</option><option value="BOE">BOE</option><option value="BORME">BORME</option><option value="NewsAPI">NewsAPI</option><option value="Sentencia">Sentencia</option>
      </select>
      <input type="text" class="fi" id="hit-search" placeholder="Buscar en hits..." style="max-width:200px" oninput="renderHits()">
      <span id="hit-count" style="font-size:10px;color:var(--text-muted);margin-left:auto"></span>
    </div>

    <div id="hits-list"></div>
    <!-- Plans panel (inside hits view) -->
    <div id="hits-plans-panel" style="display:none">
      <div class="ph" style="margin-top:20px">
        <div class="ph-left"><div class="ph-title" style="font-size:16px">Planes de Acci√≥n</div><div class="ph-sub">Seguimiento activo de impactos con plan abierto</div></div>
        <select class="fi" style="width:140px" id="ap-filter" onchange="renderPlanes()">
          <option value="">Todos</option><option value="open">Abiertos</option><option value="progress">En curso</option><option value="closed">Cerrados</option>
        </select>
      </div>
      <div id="planes-list"></div>
    </div>
  </div>

  <!-- BRIEF EJECUTIVO -->

  <!-- FUENTES -->
  <div class="view" id="view-fuentes">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Fuentes & B√∫squedas</div><div class="ph-sub">Configura el monitor activo</div></div>
      <div class="ph-actions"><button class="btn btn-primary" onclick="saveFuentes()">Guardar ‚Üí</button></div>
    </div>
    <div id="fuentes-alert"></div>
    <div class="g2" style="align-items:start">
      <div class="card">
        <div class="card-title">Queries NewsAPI</div>
        <div id="queries-list"></div>
        <textarea class="fi mt10" id="new-query" rows="2" placeholder='Ej: ("fraude fiscal" OR "evasi√≥n") AND Espa√±a'></textarea>
        <button class="btn btn-ghost btn-sm mt6" style="width:100%" onclick="addQuery()">+ A√±adir query</button>
      </div>
      <div>
        <div class="card mb14">
          <div class="card-title">Fuentes RSS</div>
          <div id="rss-list"></div>
        </div>
        <div class="card">
          <div class="card-title">Keywords adicionales</div>
          <div id="kw-list" style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px"></div>
          <div class="flex gap6">
            <input type="text" class="fi" id="new-kw" placeholder="Nueva keyword..." onkeydown="if(event.key==='Enter')addKw()">
            <button class="btn btn-ghost btn-sm" onclick="addKw()">+</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AN√ÅLISIS MANUAL -->
  <div class="view" id="view-analisis">
    <div class="ph"><div class="ph-left"><div class="ph-title">An√°lisis Manual IA</div><div class="ph-sub">Analiza cualquier noticia contra tu Digital Twin</div></div></div>
    <div class="g2" style="align-items:start">
      <div class="card">
        <div class="card-title">Consulta</div>
        <div class="fg"><label class="fl">Tipo de an√°lisis</label>
          <select class="fi" id="an-type">
            <option value="full">An√°lisis completo vs. Digital Twin</option>
            <option value="vulnerability">Vulnerabilidad vs. controles</option>
            <option value="financial">Impacto financiero</option>
            <option value="action">Plan de acci√≥n recomendado</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Texto a analizar</label>
          <textarea class="fi" id="an-text" rows="8" placeholder="Pega aqu√≠ noticia, sentencia, resoluci√≥n..."></textarea>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="runManual()" id="an-btn">Analizar contra Digital Twin ‚Üí</button>
      </div>
      <div class="card">
        <div class="card-title">Resultado</div>
        <div id="an-result"><div class="empty"><div class="empty-icon">‚óâ</div><div class="empty-title">Esperando an√°lisis</div></div></div>
      </div>
    </div>
  </div>

  <!-- CONFIG -->
  <div class="view" id="view-config">
    <div class="ph"><div class="ph-left"><div class="ph-title">Configuraci√≥n APIs</div></div><div class="ph-actions"><button class="btn btn-primary" onclick="saveConfig()">Guardar</button></div></div>
    <div id="config-alert"></div>
    <div class="g2">
      <div class="card">
        <div class="card-title">ü§ñ Mistral AI</div>
        <div class="fg"><label class="fl">API Key</label><input type="password" class="fi" id="cfg-mistral-key" placeholder="sk-..."></div>
        <div class="fg"><label class="fl">Modelo</label>
          <select class="fi" id="cfg-mistral-model">
            <option value="mistral-small-latest">mistral-small (r√°pido)</option>
            <option value="mistral-medium-latest">mistral-medium</option>
            <option value="mistral-large-latest">mistral-large (preciso)</option>
          </select>
        </div>
        <button class="btn btn-ghost btn-sm" style="width:100%" onclick="testMistral()">Verificar conexi√≥n</button>
      </div>
      <div class="card">
        <div class="card-title">üì∞ NewsAPI</div>
        <div class="fg"><label class="fl">API Key</label><input type="password" class="fi" id="cfg-newsapi-key"></div>
        <div class="fhint">100 req/d√≠a en tier gratuito</div>
      </div>
    </div>
    <div class="g2 mt14">
      <div class="card">
        <div class="card-title">üå≤ Pinecone</div>
        <div class="fg"><label class="fl">API Key</label><input type="password" class="fi" id="cfg-pinecone-key" placeholder="pc-..."></div>
        <div class="fg"><label class="fl">√çndice</label><input type="text" class="fi" id="cfg-pinecone-index" placeholder="digitaltwin"></div>
        <div class="fg"><label class="fl">Host / Endpoint</label><input type="text" class="fi" id="cfg-pinecone-host" placeholder="https://digitaltwin-xm7jklu.svc.aped-4627-b74a.pinecone.io"><div class="fhint">Visible en la consola de Pinecone al crear el √≠ndice</div></div>
        <button class="btn btn-ghost btn-sm" style="width:100%" onclick="testPinecone()">Verificar conexi√≥n</button>
        <button class="btn btn-purple btn-sm mt10" style="width:100%" id="btn-sync-pinecone" onclick="syncTwinToPinecone()">‚¨Ü Sincronizar Twin ‚Üí Pinecone</button>
        <div class="fhint mt6">Vectoriza contexto, controles y elementos de madurez para an√°lisis RAG</div>
      </div>
      <div class="card">
        <div class="card-title">üî• Firebase / Firestore</div>
        <div class="fg"><label class="fl">Project ID</label><input type="text" class="fi" id="cfg-fb-project" placeholder="digitaltwin-21a64" value="digitaltwin-21a64"></div>
        <div class="fg"><label class="fl">API Key</label><input type="password" class="fi" id="cfg-fb-key"><div class="fhint">Guardada solo en localStorage ‚Äî nunca en GitHub</div></div>
        <div class="alert alert-info" style="margin-top:8px">La Firebase key es p√∫blica por dise√±o. La seguridad est√° en las Reglas de Firestore.</div>
      </div>
    </div>
    <div class="card mt14">
      <div class="card-title">‚öô Par√°metros del funnel</div>
      <div class="g4">
        <div class="fg"><label class="fl">Umbral keywords (%)</label><input type="number" class="fi" id="cfg-threshold" value="60" min="0" max="100"><div class="fhint">Score m√≠nimo para pasar al funnel</div></div>
        <div class="fg"><label class="fl">Umbral impacto empresa (%)</label><input type="number" class="fi" id="cfg-impact-threshold" value="50" min="0" max="100"><div class="fhint">Score para marcar como "Tu empresa"</div></div>
        <div class="fg"><label class="fl">Repo GitHub</label><input type="text" class="fi" id="cfg-repo" placeholder="avespa/digitaltwin"></div>
        <div class="fg"><label class="fl">D√≠as aviso Twin obsoleto</label><input type="number" class="fi" id="cfg-twin-days" value="90" min="7"></div>
      </div>
    </div>
  </div>


  <!-- CONTROLES DE COMPLIANCE -->
  <div class="view" id="view-controles">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Controles de Compliance</div><div class="ph-sub">Registro completo ¬∑ Import/Export Excel</div></div>
      <div class="ph-actions">
        <button class="btn btn-ghost btn-sm" onclick="downloadCtrlTemplate()">‚¨á Plantilla Excel</button>
        <label class="btn btn-ghost btn-sm" style="cursor:pointer">‚¨Ü Importar Excel<input type="file" id="ctrl-import-file" accept=".xlsx,.xls" style="display:none" onchange="importControls(this)"></label>
        <button class="btn btn-purple btn-sm" onclick="openCtrlModal(null)">+ Nuevo control</button>
        <button class="btn btn-ghost btn-sm" onclick="exportControls()">‚¨á Exportar</button>
        <button class="btn btn-primary" onclick="saveControls()">Guardar ‚Üí</button>
      </div>
    </div>
    <div id="ctrl-alert"></div>

    <!-- Stats bar -->
    <div class="g4 mb14">
      <div class="kri" style="--c:var(--accent)"><div class="kri-label">Total Controles</div><div class="kri-val" id="ctrl-total">0</div></div>
      <div class="kri" style="--c:var(--accent2)"><div class="kri-label">Preventivos</div><div class="kri-val" id="ctrl-prev">0</div></div>
      <div class="kri" style="--c:var(--purple)"><div class="kri-label">Detectivos</div><div class="kri-val" id="ctrl-det">0</div></div>
      <div class="kri" style="--c:var(--warn)"><div class="kri-label">No ejecutados</div><div class="kri-val" id="ctrl-noexec">0</div></div>
    </div>

    <!-- Filter bar -->
    <div class="card mb10" style="padding:10px 14px">
      <div class="flex ic gap8 flex-wrap">
        <input type="text" class="fi" id="ctrl-search" placeholder="Buscar por t√≠tulo, riesgo, responsable..." style="max-width:280px" oninput="renderControls()">
        <select class="fi" id="ctrl-filter-nat" style="width:140px" onchange="renderControls()">
          <option value="">Naturaleza</option><option>Preventivo</option><option>Detectivo</option>
        </select>
        <select class="fi" id="ctrl-filter-exec" style="width:130px" onchange="renderControls()">
          <option value="">Ejecutado</option><option value="S√≠">S√≠</option><option value="No">No</option>
        </select>
        <select class="fi" id="ctrl-filter-freq" style="width:140px" onchange="renderControls()">
          <option value="">Frecuencia</option>
          <option>diario</option><option>semanal</option><option>mensual</option>
          <option>trimestral</option><option>semestral</option><option>anual</option><option>ad-hoc</option>
        </select>
        <span id="ctrl-count" style="font-size:10px;color:var(--text-muted);margin-left:auto"></span>
      </div>
    </div>

    <!-- Bulk action bar (shows when rows selected) -->
    <div id="ctrl-bulk-bar" style="display:none;background:rgba(0,229,160,.06);border:1px solid rgba(0,229,160,.2);border-radius:5px;padding:8px 14px;margin-bottom:10px;display:none" class="flex ic gap12">
      <span id="ctrl-bulk-count" style="font-size:10.5px;color:var(--accent)"></span>
      <div style="flex:1"></div>
      <span style="font-size:10px;color:var(--text-muted)">Marcar como:</span>
      <button class="btn btn-ghost btn-xs" onclick="bulkMarkExecuted('S√≠')">‚úì Ejecutado</button>
      <button class="btn btn-ghost btn-xs" onclick="bulkMarkExecuted('No')">‚úó No ejecutado</button>
      <button class="btn btn-ghost btn-xs" onclick="bulkSetStatus('Activo')">Activo</button>
      <button class="btn btn-ghost btn-xs" onclick="bulkSetStatus('Inactivo')">Inactivo</button>
      <button class="btn btn-danger btn-xs" onclick="bulkDelete()">Eliminar</button>
    </div>

    <div class="ctrl-wrap">
      <table class="ctrl-table">
        <thead>
          <tr>
            <th style="width:32px"><input type="checkbox" id="ctrl-check-all" onchange="ctrlToggleAll(this.checked)" title="Seleccionar todos"></th>
            <th>ID</th><th>T√≠tulo</th><th>Responsable</th><th>Riesgo</th>
            <th>Frecuencia</th><th>Naturaleza</th><th>Tipo</th>
            <th>Elemento ISO</th><th>Ejecutado</th><th>√öltima Ejec.</th><th>Estado</th><th></th>
          </tr>
        </thead>
        <tbody id="ctrl-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- SENTENCIAS -->
  <div class="view" id="view-sentencias">
    <div class="ph">
      <div class="ph-left"><div class="ph-title">Sentencias & Jurisprudencia</div><div class="ph-sub">An√°lisis manual de sentencias relevantes ‚Üí publicaci√≥n al feed</div></div>
      <div class="ph-actions">
        <button class="btn btn-primary" onclick="openSentModal(null)">+ Nueva sentencia</button>
      </div>
    </div>
    <div id="sent-alert"></div>
    <div id="sent-list"><div class="empty"><div class="empty-icon">‚öñ</div><div class="empty-title">Sin sentencias publicadas</div><div class="empty-sub">A√±ade sentencias del CENDOJ para an√°lisis IA</div></div></div>
  </div>

  </div><!-- /page -->
</div><!-- /main -->
</div><!-- /shell -->

<!-- MODAL AN√ÅLISIS DOCUMENTO -->
<div class="overlay" id="modal-doc">
  <div class="modal modal-lg">
    <div class="modal-title" id="doc-modal-title">Analizar documento con IA</div>
    <button class="modal-x" onclick="closeModal('modal-doc')">‚úï</button>

    <!-- Paso 1: cargar documentos -->
    <div id="doc-step1">
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:10px">
        Puedes a√±adir varios documentos. La IA los analizar√° todos juntos o por separado.
      </div>

      <!-- Lista de documentos acumulados -->
      <div id="doc-queue-list" style="margin-bottom:10px"></div>

      <!-- A√±adir nuevo doc -->
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:12px;margin-bottom:10px">
        <div class="fg">
          <label class="fl">A√±adir archivo</label>
          <input type="file" class="fi" id="doc-file" accept=".pdf,.txt,.docx,.doc" multiple>
          <div class="fhint mt6">‚úì .docx ‚Äî extracci√≥n perfecta &nbsp;¬∑&nbsp; ‚úì .txt ‚Äî texto plano &nbsp;¬∑&nbsp; ‚ö† .pdf ‚Äî solo si no est√° escaneado</div>
        </div>
        <div class="fg"><label class="fl">O pega texto directamente</label><textarea class="fi" id="doc-text" rows="3" placeholder="Pega el texto aqu√≠..."></textarea></div>
        <button class="btn btn-ghost btn-sm" style="width:100%" onclick="addDocToQueue()">+ A√±adir a la cola</button>
      </div>

      <div id="doc-alert"></div>

      <div class="flex gap8 mt10" style="justify-content:flex-end">
        <button class="btn btn-ghost" onclick="closeModal('modal-doc')">Cancelar</button>
        <button class="btn btn-ghost" id="doc-analyze-one-btn" onclick="analyzeDocQueue(false)" style="display:none">Analizar √∫ltimo ‚Üí</button>
        <button class="btn btn-primary" id="doc-analyze-all-btn" onclick="analyzeDocQueue(true)" style="display:none">Analizar todos con IA ‚Üí</button>
      </div>
    </div>

    <!-- Resultado -->
    <div id="doc-result" style="margin-top:14px"></div>
  </div>
</div>

<!-- MODAL PLAN DE ACCI√ìN -->
<div class="overlay" id="modal-ap">
  <div class="modal modal-lg">
    <div class="modal-title" id="ap-modal-title">Plan de Acci√≥n</div>
    <button class="modal-x" onclick="closeModal('modal-ap')">‚úï</button>
    <div class="g2">
      <div>
        <div class="fg"><label class="fl">T√≠tulo del plan *</label><input type="text" class="fi" id="ap-title" placeholder="Ej: Reforzar control de terceros..."></div>
        <div class="fg"><label class="fl">Control de madurez afectado</label><input type="text" class="fi" id="ap-control" placeholder="Ej: OPERACI√ìN - Due diligence de terceros"></div>
        <div class="fg"><label class="fl">Dimensi√≥n ISO 37301</label>
          <select class="fi" id="ap-dim">
            <option value="">Ninguna espec√≠fica</option>
            <option>1. Contexto</option><option>2. Liderazgo</option><option>3. Planificaci√≥n</option>
            <option>4. Soporte</option><option>5. Operaci√≥n</option><option>6. Evaluaci√≥n</option><option>7. Mejora</option>
          </select>
        </div>
        <div class="g2">
          <div class="fg"><label class="fl">Responsable</label><input type="text" class="fi" id="ap-owner" placeholder="Compliance Officer"></div>
          <div class="fg"><label class="fl">Fecha l√≠mite</label><input type="date" class="fi" id="ap-deadline"></div>
        </div>
        <div class="fg"><label class="fl">Prioridad</label>
          <select class="fi" id="ap-priority">
            <option value="critical">üî¥ Cr√≠tica</option><option value="high">üü† Alta</option>
            <option value="medium">üü° Media</option><option value="low">üü¢ Baja</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Descripci√≥n y objetivo</label><textarea class="fi" id="ap-desc" rows="3" placeholder="Qu√© se quiere conseguir y por qu√©..."></textarea></div>
      </div>
      <div>
        <div class="fl" style="margin-bottom:8px">Pasos / Acciones</div>
        <div id="ap-steps-list"></div>
        <div class="flex gap6 mt6">
          <input type="text" class="fi" id="ap-new-step" placeholder="Nueva acci√≥n..." onkeydown="if(event.key==='Enter')addApStep()">
          <button class="btn btn-ghost btn-sm" onclick="addApStep()">+</button>
        </div>
        <div class="divider"></div>
        <div class="fg"><label class="fl">Mejora documentada al cierre</label><textarea class="fi" id="ap-improvement" rows="3" placeholder="Al cerrar: qu√© mejor√≥, qu√© controles se actualizaron, qu√© evidencia se gener√≥..."></textarea></div>
        <div class="fg"><label class="fl">Estado</label>
          <select class="fi" id="ap-status">
            <option value="open">Abierto</option><option value="progress">En curso</option><option value="closed">Cerrado</option>
          </select>
        </div>
        <div id="ap-close-note" style="display:none">
          <div class="alert alert-warn mt6">Al cerrar el plan, se actualizar√° autom√°ticamente el elemento de madurez asociado.</div>
        </div>
      </div>
    </div>
    <div class="flex gap8 mt14" style="justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('modal-ap')">Cancelar</button>
      <button class="btn btn-danger btn-sm" id="ap-delete-btn" style="display:none" onclick="deleteAp()">Eliminar</button>
      <button class="btn btn-primary" onclick="saveAp()">Guardar plan</button>
    </div>
  </div>
</div>

<!-- MODAL HISTORIAL MADUREZ -->
<div class="overlay" id="modal-history">
  <div class="modal">
    <div class="modal-title">Historial de Madurez</div>
    <button class="modal-x" onclick="closeModal('modal-history')">‚úï</button>
    <div id="history-list"></div>
  </div>
</div>

<script>
let hitFunnel = 'all'; // declared at top to avoid TDZ in renderHits
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FB_CFG = {
  apiKey:            "AIzaSyDFcMb0QmLwCMSAu4LydryNvpAwoCHUQrY",
  authDomain:        "digitaltwin-21a64.firebaseapp.com",
  projectId:         "digitaltwin-21a64",
  storageBucket:     "digitaltwin-21a64.appspot.com",
  messagingSenderId: "placeholder",
  appId:             "placeholder"
};
firebase.initializeApp(FB_CFG);
const db = firebase.firestore();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S = {
  cfg: { mistralKey:'', mistralModel:'mistral-small-latest', newsapiKey:'', threshold:60, impactThreshold:50, repo:'avespa/digitaltwin', twinDays:90, pineconeKey:'', pineconeHost:'https://digitaltwin-xm7jklu.svc.aped-4627-b74a.pinecone.io', pineconeIndex:'digitaltwin' },
  ctx: {},       // organization context
  maturity: {},  // maturity assessment
  twinSummary: '',
  hits: [],
  actionPlans: [],
  controls: [],
  sentences: [],
  remoteCfg: { newsapi_queries:[], newsapi_sources:'', custom_keywords:[], rss_enabled:{} },
  lastSync: null,
  docBibliography: [], // [{id, name, date, elements:[], summary}]
};

// Local cache
function lsGet(k){ try{ return JSON.parse(localStorage.getItem('cdt_'+k)||'null'); }catch(e){ return null; } }
function lsSet(k,v){ try{ localStorage.setItem('cdt_'+k, JSON.stringify(v)); }catch(e){} }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MATURITY MODEL ‚Äî ISO 37301
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DIMS = [
  { id:'contexto', label:'Contexto', icon:'‚¨°', color:'#00e5a0',
    elements:[
      { id:'ctx1', label:'Comprensi√≥n del contexto organizacional (¬ß4.1)',
        criteria:'¬ß4.1 exige que la organizaci√≥n determine los factores externos (legales, regulatorios, mercado, competencia) e internos (estructura, cultura, capacidades) que son relevantes para su prop√≥sito y que afectan a su capacidad para lograr los resultados del sistema de compliance. Evidencia esperada: an√°lisis PESTEL, DAFO, memorias, actas de direcci√≥n que identifiquen el entorno regulatorio y de negocio.' },
      { id:'ctx2', label:'Identificaci√≥n de partes interesadas (¬ß4.2)',
        criteria:'¬ß4.2 exige identificar las partes interesadas relevantes (empleados, accionistas, clientes, reguladores, proveedores, comunidad) y determinar sus necesidades y expectativas de compliance pertinentes. Evidencia esperada: registro de partes interesadas, mapa de stakeholders, an√°lisis de sus expectativas en materia de cumplimiento normativo.' },
      { id:'ctx3', label:'Obligaciones de compliance identificadas (¬ß4.5)',
        criteria:'¬ß4.5 exige que la organizaci√≥n identifique, tenga acceso y comprenda sus obligaciones de compliance (leyes, reglamentos, permisos, c√≥digos voluntarios, directrices). Debe mantener actualizado un registro o inventario de obligaciones aplicables. Evidencia esperada: registro de requisitos legales y normativos, matriz de obligaciones, suscripci√≥n a actualizaciones regulatorias.' },
      { id:'ctx4', label:'Evaluaci√≥n de riesgos de compliance (¬ß4.6)',
        criteria:'¬ß4.6 exige un proceso formal para identificar, analizar y evaluar los riesgos de compliance (probabilidad e impacto de incumplimiento) y las oportunidades de mejora. El proceso debe ser documentado y revisado peri√≥dicamente. Evidencia esperada: mapa de riesgos de compliance, metodolog√≠a de evaluaci√≥n, matriz probabilidad-impacto, registro de riesgos actualizado.' },
    ]
  },
  { id:'liderazgo', label:'Liderazgo', icon:'‚òÖ', color:'#8b5cf6',
    elements:[
      { id:'lid1', label:'Compromiso del √≥rgano de gobierno (¬ß5.1.1)',
        criteria:'¬ß5.1.1 exige que el √≥rgano de gobierno demuestre liderazgo y compromiso con el sistema de compliance: aprobando la pol√≠tica, asignando responsabilidades, garantizando recursos, promoviendo la cultura de cumplimiento y revisando el sistema peri√≥dicamente. Evidencia esperada: actas de consejo que reflejen supervisi√≥n de compliance, delegaci√≥n de funciones, aprobaci√≥n de pol√≠tica, revisiones formales del sistema.' },
      { id:'lid2', label:'Cultura de compliance (¬ß5.1.2)',
        criteria:'¬ß5.1.2 exige que la alta direcci√≥n fomente activamente una cultura en la que el cumplimiento normativo sea un valor integrado, no solo un requisito formal. Deben establecerse mecanismos para medir y mejorar la cultura. Evidencia esperada: encuestas de cultura, programas de tone-at-the-top, comunicaciones de liderazgo sobre compliance, indicadores de clima de integridad.' },
      { id:'lid3', label:'Gobernanza de compliance (¬ß5.1.3)',
        criteria:'¬ß5.1.3 exige definir roles, responsabilidades y autoridades claras para la gesti√≥n del compliance en todos los niveles. Debe existir una estructura de gobernanza con l√≠neas de reporte definidas (comit√© de compliance, compliance officer, etc.). Evidencia esperada: organigrama de compliance, fichas de roles y responsabilidades, comit√©s formalizados, reporting a √≥rgano de gobierno.' },
      { id:'lid4', label:'Pol√≠tica de compliance (¬ß5.2)',
        criteria:'¬ß5.2 exige una pol√≠tica de compliance documentada, aprobada por el √≥rgano de gobierno, que exprese el compromiso con el cumplimiento de obligaciones, establezca el marco del sistema y proporcione la base para los objetivos. Debe estar disponible para las partes interesadas. Evidencia esperada: pol√≠tica aprobada, firmada, con fecha, difundida internamente y publicada/disponible para terceros.' },
      { id:'lid5', label:'Funci√≥n de compliance: independencia y autoridad (¬ß5.3.2)',
        criteria:'¬ß5.3.2 exige que la funci√≥n de compliance tenga suficiente independencia, autoridad y acceso a informaci√≥n para desempe√±ar su rol eficazmente, con l√≠nea directa al √≥rgano de gobierno. El compliance officer debe poder actuar sin interferencias. Evidencia esperada: estatuto de la funci√≥n de compliance, acceso directo a √≥rgano de gobierno documentado, ausencia de conflictos de inter√©s en reporting.' },
    ]
  },
  { id:'planificacion', label:'Planificaci√≥n', icon:'‚óé', color:'#0066ff',
    elements:[
      { id:'plan1', label:'Acciones para abordar riesgos (¬ß6.1)',
        criteria:'¬ß6.1 exige que la organizaci√≥n planifique acciones para abordar los riesgos e incumplimientos potenciales identificados en la evaluaci√≥n de riesgos (¬ß4.6), y que estas acciones se integren en los procesos del sistema. Evidencia esperada: plan de tratamiento de riesgos, acciones preventivas documentadas vinculadas a riesgos espec√≠ficos, responsables y plazos asignados.' },
      { id:'plan2', label:'Objetivos de compliance medibles (¬ß6.2)',
        criteria:'¬ß6.2 exige establecer objetivos de compliance medibles, coherentes con la pol√≠tica, que tengan en cuenta los riesgos, con indicadores de seguimiento, responsables, plazos y recursos asignados. Evidencia esperada: cuadro de objetivos de compliance con KPIs, seguimiento peri√≥dico documentado, vinculaci√≥n con pol√≠tica y riesgos.' },
      { id:'plan3', label:'Planificaci√≥n de cambios (¬ß6.3)',
        criteria:'¬ß6.3 exige que cuando la organizaci√≥n determine la necesidad de cambios en el sistema de compliance, estos se lleven a cabo de manera planificada, considerando el prop√≥sito, consecuencias, disponibilidad de recursos e integridad del sistema. Evidencia esperada: procedimiento de gesti√≥n del cambio, registro de cambios normativos y organizativos, evaluaci√≥n de impacto en el sistema de compliance.' },
    ]
  },
  { id:'soporte', label:'Soporte', icon:'‚¨ü', color:'#f59e0b',
    elements:[
      { id:'sop1', label:'Recursos asignados al sistema (¬ß7.1)',
        criteria:'¬ß7.1 exige que la organizaci√≥n determine y proporcione los recursos necesarios (humanos, financieros, tecnol√≥gicos, de infraestructura) para establecer, implementar, mantener y mejorar continuamente el sistema de compliance. Evidencia esperada: presupuesto de compliance aprobado, dotaci√≥n de personal, herramientas tecnol√≥gicas, plan de recursos.' },
      { id:'sop2', label:'Competencia y formaci√≥n del personal (¬ß7.2)',
        criteria:'¬ß7.2 exige determinar la competencia necesaria de las personas que realizan trabajo bajo el control de la organizaci√≥n que afecta al compliance, asegurar que sean competentes mediante formaci√≥n/experiencia y mantener evidencias documentadas. Evidencia esperada: mapa de competencias de compliance, plan de formaci√≥n, registros de formaciones realizadas, evaluaciones de competencia.' },
      { id:'sop3', label:'Concienciaci√≥n en compliance (¬ß7.3)',
        criteria:'¬ß7.3 exige que las personas que trabajan bajo el control de la organizaci√≥n sean conscientes de la pol√≠tica de compliance, su contribuci√≥n al sistema, las consecuencias del incumplimiento y los canales de reporte disponibles. Evidencia esperada: programas de awareness, comunicaciones peri√≥dicas, m√©tricas de concienciaci√≥n, confirmaciones de lectura de pol√≠ticas.' },
      { id:'sop4', label:'Comunicaci√≥n interna y externa (¬ß7.4)',
        criteria:'¬ß7.4 exige determinar qu√© comunicar sobre compliance (a qui√©n, cu√°ndo, c√≥mo), tanto internamente como con partes externas. La comunicaci√≥n debe ser coherente y veraz. Evidencia esperada: plan de comunicaci√≥n de compliance, registros de comunicaciones internas/externas, informes de compliance publicados o reportados a reguladores.' },
      { id:'sop5', label:'Informaci√≥n documentada (¬ß7.5)',
        criteria:'¬ß7.5 exige que el sistema de compliance incluya la informaci√≥n documentada requerida por la norma y la determinada por la organizaci√≥n como necesaria, controlando su creaci√≥n, actualizaci√≥n, distribuci√≥n y protecci√≥n. Evidencia esperada: inventario documental, control de versiones, procedimientos de gesti√≥n documental, accesibilidad de documentos a personas pertinentes.' },
    ]
  },
  { id:'operacion', label:'Operaci√≥n', icon:'‚óà', color:'#ef4444',
    elements:[
      { id:'op1', label:'Controles operacionales implementados (¬ß8.1-8.2)',
        criteria:'¬ß8.1-8.2 exigen planificar, implementar, controlar y revisar los procesos necesarios para cumplir con los requisitos del sistema y ejecutar las acciones identificadas en planificaci√≥n. Deben existir controles documentados para gestionar los riesgos de compliance en los procesos cr√≠ticos. Evidencia esperada: matriz de controles, procedimientos operativos, evidencias de ejecuci√≥n de controles, registros de supervisi√≥n.' },
      { id:'op2', label:'Canal de denuncias / Whistleblowing (¬ß8.3)',
        criteria:'¬ß8.3 exige establecer, implementar y mantener procesos accesibles y fiables para que las personas puedan informar de posibles incumplimientos de compliance (whistleblowing), garantizando: accesibilidad a empleados e interesados externos, confidencialidad y anonimato, protecci√≥n contra represalias, seguimiento de las denuncias recibidas y retroalimentaci√≥n al denunciante. Evidencia esperada: procedimiento de canal de denuncias documentado, canales disponibles (web, tel√©fono, email), pol√≠tica de no represalias, protocolo de investigaci√≥n de denuncias, m√©tricas de uso del canal.' },
      { id:'op3', label:'Procesos de investigaci√≥n (¬ß8.4)',
        criteria:'¬ß8.4 exige que la organizaci√≥n establezca, implemente y mantenga un proceso para investigar los posibles incumplimientos de compliance identificados, tanto por el canal de denuncias como por otras v√≠as. El proceso debe ser objetivo, documentado y derivar en acciones. Evidencia esperada: procedimiento de investigaci√≥n interna, criterios de apertura/cierre, registro de investigaciones, roles de investigador, plazos definidos, medidas correctoras.' },
      { id:'op4', label:'Due diligence de terceros (¬ß8.1)',
        criteria:'¬ß8.1 exige que la organizaci√≥n implemente controles de compliance para terceros (proveedores, socios, agentes, distribuidores) proporcionados al riesgo que representan, incluyendo evaluaci√≥n previa y seguimiento continuo. Evidencia esperada: procedimiento de due diligence de terceros, cuestionarios de evaluaci√≥n, clasificaci√≥n de terceros por riesgo, registros de evaluaciones realizadas, cl√°usulas de compliance en contratos.' },
      { id:'op5', label:'C√≥digo de conducta y procedimientos (¬ß8.1)',
        criteria:'¬ß8.1 exige que la organizaci√≥n disponga de un c√≥digo de conducta u otros procedimientos equivalentes que establezcan las expectativas de comportamiento en materia de compliance para todos los miembros de la organizaci√≥n. Evidencia esperada: c√≥digo de conducta aprobado y difundido, confirmaciones de adhesi√≥n, pol√≠ticas espec√≠ficas (conflictos de inter√©s, regalos, etc.), procedimientos operativos de compliance.' },
    ]
  },
  { id:'evaluacion', label:'Evaluaci√≥n', icon:'‚óâ', color:'#06b6d4',
    elements:[
      { id:'ev1', label:'Monitorizaci√≥n y medici√≥n de compliance (¬ß9.1)',
        criteria:'¬ß9.1 exige que la organizaci√≥n eval√∫e el rendimiento del sistema de compliance y la eficacia de los controles, determinando qu√© monitorizar/medir, los m√©todos de an√°lisis/evaluaci√≥n, cu√°ndo y qui√©n. Evidencia esperada: programa de monitorizaci√≥n continua, herramientas de seguimiento, informes peri√≥dicos de rendimiento, revisi√≥n de eficacia de controles.' },
      { id:'ev2', label:'KPIs/KRIs de compliance definidos (¬ß9.1.3)',
        criteria:'¬ß9.1.3 exige que la organizaci√≥n defina indicadores clave de rendimiento (KPIs) y/o indicadores de riesgo (KRIs) de compliance que permitan medir objetivamente el desempe√±o del sistema. Evidencia esperada: cuadro de mando de compliance con indicadores definidos, umbrales, frecuencia de medici√≥n, responsables y series hist√≥ricas.' },
      { id:'ev3', label:'Reporting de compliance (¬ß9.1.4)',
        criteria:'¬ß9.1.4 exige que la organizaci√≥n genere informes de compliance para las partes interesadas pertinentes (√≥rgano de gobierno, alta direcci√≥n, reguladores) con la frecuencia adecuada. Evidencia esperada: informes peri√≥dicos de compliance al √≥rgano de gobierno, memorias de compliance, informes a reguladores, actas de presentaci√≥n ante comit√©s.' },
      { id:'ev4', label:'Auditor√≠a interna del sistema (¬ß9.2)',
        criteria:'¬ß9.2 exige que la organizaci√≥n lleve a cabo auditor√≠as internas del sistema de compliance a intervalos planificados para determinar si el sistema es conforme con los requisitos y se implementa y mantiene eficazmente. Evidencia esperada: programa anual de auditor√≠a interna de compliance, informes de auditor√≠a, hallazgos documentados, planes de acci√≥n correctiva derivados.' },
      { id:'ev5', label:'Revisi√≥n por la direcci√≥n (¬ß9.3)',
        criteria:'¬ß9.3 exige que la alta direcci√≥n revise el sistema de compliance a intervalos planificados para asegurar su idoneidad, adecuaci√≥n y eficacia. La revisi√≥n debe incluir resultados de auditor√≠as, incumplimientos, objetivos, riesgos y oportunidades de mejora. Evidencia esperada: actas de revisi√≥n por la direcci√≥n, agenda con todos los puntos requeridos por ¬ß9.3, decisiones y compromisos documentados.' },
    ]
  },
  { id:'mejora', label:'Mejora', icon:'‚Üë', color:'#10b981',
    elements:[
      { id:'mej1', label:'Mejora continua del sistema (¬ß10.1)',
        criteria:'¬ß10.1 exige que la organizaci√≥n mejore continuamente la idoneidad, adecuaci√≥n y eficacia del sistema de compliance. Deben existir mecanismos para identificar oportunidades de mejora y actuar sobre ellas de forma sistem√°tica. Evidencia esperada: ciclo PDCA documentado, registro de oportunidades de mejora, mejoras implementadas con evidencias, evoluci√≥n positiva de KPIs.' },
      { id:'mej2', label:'Gesti√≥n de no conformidades (¬ß10.2)',
        criteria:'¬ß10.2 exige que cuando ocurra un incumplimiento o no conformidad, la organizaci√≥n reaccione, eval√∫e si existen causas ra√≠z, implemente acciones correctivas y revise su eficacia. El proceso debe estar documentado. Evidencia esperada: procedimiento de gesti√≥n de no conformidades, registro de incumplimientos detectados, an√°lisis de causa ra√≠z, acciones correctivas y seguimiento de cierre.' },
      { id:'mej3', label:'Acciones correctivas documentadas (¬ß10.2)',
        criteria:'¬ß10.2 exige que las acciones correctivas sean apropiadas a los efectos de los incumplimientos, que se documenten y que se verifique su eficacia. La organizaci√≥n debe retener informaci√≥n documentada de la naturaleza de los incumplimientos y las acciones tomadas. Evidencia esperada: ficha o registro de acci√≥n correctiva con descripci√≥n, causa, acciones, responsable, plazo y evidencia de cierre efectivo.' },
    ]
  },
];

const SCORE_LABELS = {
  1:'No existe / No implementado',
  2:'Inicial / Ad hoc',
  3:'Definido / Documentado',
  4:'Gestionado / Medido',
  5:'Optimizado / Mejora continua'
};

const RSS_LABELS = {
  BOE_disposiciones:'BOE - Disposiciones generales',
  BOE_justicia:'BOE - Administraci√≥n de Justicia',
  BOE_anuncios:'BOE - Anuncios oficiales',
  BOE_derecho_penal:'BOE - Derecho Penal',
  BOE_derecho_mercantil:'BOE - Derecho Mercantil',
  BOE_sistema_financiero:'BOE - Sistema Financiero',
  BOE_tribunal_constitucional:'BOE - Tribunal Constitucional',
  BORME_general:'BORME - Registro Mercantil',
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TITLES = {
  dashboard:'Dashboard & KRIs', contexto:'Contexto Organizacional', madurez:'Assessment de Madurez',
  controles:'Controles de Compliance', sentencias:'Sentencias & Jurisprudencia',
  'twin-summary':'Resumen Ejecutivo del Twin', hits:'Monitor de Hits', planes:'Planes de Acci√≥n',
  brief:'Brief Ejecutivo', fuentes:'Fuentes & B√∫squedas', analisis:'An√°lisis Manual IA', config:'Configuraci√≥n APIs'
};

function go(name){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('view-'+name)?.classList.add('active');
  document.querySelector(`.nav-item[data-view="${name}"]`)?.classList.add('active');
  document.getElementById('tb-title').textContent = TITLES[name]||name;
  if(name==='madurez') renderMaturity();
  if(name==='hits') renderHits();
  if(name==='planes') renderPlanes();
  if(name==='dashboard') renderDashboard();
  if(name==='fuentes') renderFuentes();
  if(name==='twin-summary') renderTwinSummaryPage();
  if(name==='config') loadConfig();
  if(name==='contexto') loadContexto();
  if(name==='brief') renderBriefPlaceholder();
  if(name==='controles'){ renderControls(); renderCtrlStats(); }
  if(name==='sentencias') renderSentencias();
}

function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function openModal(id){ document.getElementById(id).classList.add('open'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIRESTORE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fsGet(col, doc){ try{ const s=await db.collection(col).doc(doc||'main').get(); return s.exists?s.data():null; }catch(e){ console.warn('fsGet',e); return null; } }
async function fsSet(col, doc, data){ try{ await db.collection(col).doc(doc||'main').set({...data, _updated: new Date().toISOString()}, {merge:true}); return true; }catch(e){ console.error('fsSet',e); return false; } }
async function fsAdd(col, data){ try{ const r=await db.collection(col).add({...data, _created: new Date().toISOString()}); return r.id; }catch(e){ console.error('fsAdd',e); return null; } }
async function fsUpdate(col, id, data){ try{ await db.collection(col).doc(id).update({...data, _updated: new Date().toISOString()}); return true; }catch(e){ console.error('fsUpdate',e); return false; } }
async function fsDelete(col, id){ try{ await db.collection(col).doc(id).delete(); return true; }catch(e){ return false; } }
async function fsList(col, orderBy='_created', dir='desc'){ try{ const s=await db.collection(col).orderBy(orderBy,dir).limit(200).get(); return s.docs.map(d=>{ const data=d.data(); return {_fsId:d.id, ...data, id: data.id||d.id}; }); }catch(e){ console.warn('fsList',e); return []; } }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYNC ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function syncAll(){
  setStatus('Sincronizando...');
  document.getElementById('sync-btn').innerHTML='<span class="spin"></span>';
  try{
    const [ctx, mat, ts, plans, cfg, ctrls] = await Promise.all([
      fsGet('organization','main'),
      fsGet('maturity','current'),
      fsGet('twin_summary','main'),
      fsList('action_plans'),
      fsGet('config','main'),
      fsList('controls'),
    ]);
    if(ctx){ S.ctx = ctx; lsSet('ctx', ctx); }
    if(mat){ S.maturity = mat; lsSet('mat', mat); }
    if(ts){ S.twinSummary = ts.text||''; lsSet('ts', ts.text||''); }
    S.actionPlans = plans || [];
    if(ctrls && ctrls.length) S.controls = ctrls;
    if(cfg){
      S.remoteCfg = {...S.remoteCfg,...cfg};
      // Restore API keys from Firestore if not already in localStorage
      if(cfg.mistralKey && !S.cfg.mistralKey) S.cfg.mistralKey = cfg.mistralKey;
      if(cfg.mistralModel && !S.cfg.mistralModel) S.cfg.mistralModel = cfg.mistralModel;
      if(cfg.newsapiKey && !S.cfg.newsapiKey) S.cfg.newsapiKey = cfg.newsapiKey;
      if(cfg.repo && !S.cfg.repo) S.cfg.repo = cfg.repo;
      // Merge full config if localStorage has nothing
      if(!lsGet('cfg')) { S.cfg = {...S.cfg,...cfg}; lsSet('cfg',S.cfg); }
    }

    // Hits: try Firestore first, fallback to GitHub raw JSON
    const fsHits = await fsList('hits');
    if(fsHits && fsHits.length > 0){
      S.hits = fsHits;
    } else {
      // Fetcher writes to GitHub ‚Äî read directly from raw
      await syncHitsFromGitHub();
    }

    S.lastSync = new Date().toISOString();
    lsSet('hits', S.hits);
    lsSet('plans', S.actionPlans);
    renderAll();
    setStatus('Sync ‚úì '+fmtTime(S.lastSync));

    // Actualizar info de √∫ltima actualizaci√≥n en cabecera de hits
    const syncInfoEl = document.getElementById('hits-sync-info');
    if(syncInfoEl){
      const latestHit = S.hits.reduce((max,h)=>{
        const d = h.raw_date||h.published_at||h.fetched_at||'';
        return d > max ? d : max;
      }, '');
      const latestSent = (S.sentences||[]).reduce((max,s)=>{
        const d = s.date||s.raw_date||'';
        return d > max ? d : max;
      }, '');
      const parts = [];
      if(latestHit) parts.push('√öltima noticia: ' + fmtDate(latestHit));
      if(latestSent) parts.push('√öltima sentencia: ' + fmtDate(latestSent));
      parts.push('Sync: ' + fmtTime(S.lastSync));
      syncInfoEl.textContent = parts.join(' ¬∑ ');
    }
    document.getElementById('tb-meta').textContent = 'Sync: '+fmtTime(S.lastSync);

    // Auto-analyze hits without RAG evaluation (silent background queue)
    autoAnalyzePending();

  }catch(e){
    setStatus('Error sync');
    console.error('syncAll error:', e);
  }
  document.getElementById('sync-btn').textContent='‚ü≥ Sync';
}

// ‚îÄ‚îÄ Auto-analyze pending hits in background ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Only processes hits that have NEVER been analyzed (_analyzed flag not set)
// Once analyzed + saved to Firestore, a hit is never re-evaluated automatically
async function autoAnalyzePending(){
  if(!S.cfg.mistralKey){ return; }
  if(!S.ctx || !S.ctx.name){ return; }

  // ONLY hits that have never been analyzed (no _analyzed flag AND no inherent_level)
  const pending = S.hits.filter(h =>
    !h._analyzed &&
    !h.inherent_level &&
    !h.false_positive
  );
  if(pending.length === 0) return;

  console.log('[AutoAnalyze] ' + pending.length + ' hits nuevos sin evaluar');
  setStatus('Evaluando ' + pending.length + ' hits nuevos...');

  let done = 0;
  for(const hit of pending.slice(0, 20)){
    try{
      await reAnalyzeHit(hit.id, true);
      done++;
      if(done % 5 === 0) setStatus('Evaluando... ' + done + '/' + Math.min(pending.length, 20));
      await new Promise(r => setTimeout(r, 800));
    }catch(e){
      console.warn('[AutoAnalyze] Error en hit', hit.id, e.message);
    }
  }

  setStatus('Sync ‚úì ' + fmtTime(S.lastSync));
  console.log('[AutoAnalyze] Completado: ' + done + ' hits evaluados');
}

async function syncHitsFromGitHub(){
  const repo = S.cfg.repo || 'avespa/digitaltwin';
  const url = `https://raw.githubusercontent.com/${repo}/main/data/hits.json?t=${Date.now()}`;
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    const ghHits = data.hits || [];
    if(ghHits.length > 0){
      // Load Firestore hits to build an analyzed-data map
      const fsHits = await fsList('hits');
      // Map by hit id (not Firestore doc id)
      const fsMap = {};
      fsHits.forEach(h => { fsMap[h.id||h.link] = h; });
      const fsIdSet = new Set(Object.keys(fsMap));

      // Merge: use GitHub as source of truth for raw fields,
      // but PRESERVE all analyzed/evaluated fields from Firestore
      S.hits = ghHits.map(ghHit => {
        const key = ghHit.id || ghHit.link;
        const fsHit = fsMap[key];
        if(fsHit && fsHit._analyzed){
          // Already analyzed ‚Äî keep all enriched data, update raw fields
          return { ...ghHit, ...fsHit, id: ghHit.id||fsHit.id };
        }
        return fsHit ? { ...fsHit, ...ghHit, id: ghHit.id||fsHit.id } : ghHit;
      });

      // Write truly new hits to Firestore (not yet there at all)
      const newHits = ghHits.filter(h=>!fsIdSet.has(h.id||h.link));
      for(const hit of newHits.slice(0,50)){
        const docId = await fsAdd('hits', hit);
        // Update state with _fsId so future fsUpdate works
        const idx = S.hits.findIndex(h=>(h.id||h.link)===(hit.id||hit.link));
        if(idx>=0 && docId) S.hits[idx]._fsId = docId;
      }
      console.log('GitHub hits: ' + ghHits.length + ' total, ' + newHits.length + ' nuevos en Firestore');
    }
  }catch(e){
    console.warn('GitHub hits sync failed:', e.message);
    const cached = lsGet('hits');
    if(cached && cached.length) S.hits = cached;
  }
}

async function syncHits(){
  // Always load Firestore first (has analyzed data), then merge GitHub
  const fsHits = await fsList('hits');
  if(fsHits && fsHits.length > 0){
    // Build map of Firestore hits
    const fsMap = {};
    fsHits.forEach(h => { fsMap[h.id||h.link] = h; });
    // Try to get newer hits from GitHub and merge
    try{
      const repo = S.cfg.repo || 'avespa/digitaltwin';
      const url = `https://raw.githubusercontent.com/\${repo}/main/data/hits.json?t=\${Date.now()}`;
      const r = await fetch(url);
      if(r.ok){
        const data = await r.json();
        const ghHits = data.hits || [];
        // Merge: Firestore data wins for analyzed hits, GitHub provides new ones
        const merged = ghHits.map(ghHit => {
          const key = ghHit.id || ghHit.link;
          const fsHit = fsMap[key];
          if(fsHit && fsHit._analyzed){
            return { ...ghHit, ...fsHit, id: ghHit.id||fsHit.id };
          }
          return fsHit ? { ...fsHit, ...ghHit, id: ghHit.id||fsHit.id } : ghHit;
        });
        // Add Firestore-only hits (sentencias, etc.) not in GitHub
        fsHits.forEach(fh => {
          const key = fh.id||fh.link;
          if(!ghHits.find(gh=>(gh.id||gh.link)===key)){
            merged.push(fh);
          }
        });
        S.hits = merged;
        // Write new GitHub hits to Firestore
        const fsIds = new Set(Object.keys(fsMap));
        const newHits = ghHits.filter(h=>!fsIds.has(h.id||h.link));
        for(const hit of newHits.slice(0,50)){
          const docId = await fsAdd('hits', hit);
          const idx = S.hits.findIndex(h=>(h.id||h.link)===(hit.id||hit.link));
          if(idx>=0 && docId) S.hits[idx]._fsId = docId;
        }
        if(newHits.length) console.log(newHits.length + ' hits nuevos a√±adidos desde GitHub');
      } else {
        S.hits = fsHits;
      }
    }catch(e){
      S.hits = fsHits; // Fallback to Firestore only
    }
  } else {
    await syncHitsFromGitHub();
  }
  lsSet('hits', S.hits);
  renderHits();
  updateBadges();
}

function restoreLocal(){
  const ctx  = lsGet('ctx');  if(ctx)  S.ctx     = ctx;
  const mat  = lsGet('mat');  if(mat)  S.maturity = mat;
  const ts   = lsGet('ts');   if(ts)   S.twinSummary = ts;
  const hits = lsGet('hits'); if(hits) S.hits = hits;
  const plans= lsGet('plans');if(plans)S.actionPlans = plans;
  const cfg  = lsGet('cfg');  if(cfg)  S.cfg = {...S.cfg,...cfg};
  const ctrls= lsGet('controls'); if(ctrls) S.controls = ctrls;
  const sents= lsGet('sentences'); if(sents) S.sentences = sents;
  const bib = lsGet('docBibliography'); if(bib) S.docBibliography = bib;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){
  renderDashboard();
  renderHits();
  renderPlanes();
  updateBadges();
}

function renderDashboard(){
  // Twin disclaimer
  const lastCtxUpdate = S.ctx?._updated;
  const daysSince = lastCtxUpdate ? Math.floor((Date.now()-new Date(lastCtxUpdate))/86400000) : null;
  const disc = document.getElementById('twin-disclaimer');
  if(!S.twinSummary){
    disc.innerHTML=`<div class="alert alert-warn mb14">‚ö† El Resumen del Digital Twin est√° vac√≠o. <button class="btn btn-ghost btn-xs" onclick="go('twin-summary')">Configurar ‚Üí</button></div>`;
  } else if(daysSince !== null && daysSince > (S.cfg.twinDays||90)){
    disc.innerHTML=`<div class="alert alert-warn mb14">‚ö† El Digital Twin no se actualiza hace <strong>${daysSince} d√≠as</strong>. Considera revisar el contexto y la madurez. <button class="btn btn-ghost btn-xs" onclick="go('contexto')">Revisar ‚Üí</button></div>`;
  } else {
    disc.innerHTML='';
  }

  // KRIs
  const globalScore = calcGlobalScore();
  document.getElementById('kri-madurez').textContent = globalScore>0 ? globalScore.toFixed(1) : '‚Äî';
  const crits = S.hits.filter(h=>h.level==='critical' && !S.actionPlans.find(p=>p.hit_id===h.id && p.status!=='open')).length;
  document.getElementById('kri-criticos').textContent = crits;
  document.getElementById('kri-planes').textContent = S.actionPlans.filter(p=>p.status!=='closed').length;
  document.getElementById('kri-sync').textContent = S.lastSync ? fmtTime(S.lastSync) : '‚Äî';

  // Radar
  drawRadar('radar-dash', getDimScores());
  renderRadarLegend('radar-legend-dash', true);

  // Narrative
  const narrative = S.twinSummary ?
    `<em>Twin activo.</em> Madurez global: ${globalScore.toFixed(1)}/5. ${S.hits.filter(h=>h.level==='critical').length} hits cr√≠ticos ¬∑ ${S.actionPlans.filter(p=>p.status!=='closed').length} planes abiertos.` :
    'Configura el Digital Twin para ver el an√°lisis contextualizado.';
  document.getElementById('dash-narrative').innerHTML = narrative;

  // Recent hits
  const dh = document.getElementById('dash-hits');
  const recent = S.hits.slice(0,4);
  dh.innerHTML = recent.length ? recent.map(h=>miniHit(h)).join('') :
    `<div class="empty"><div class="empty-icon">‚üÅ</div><div class="empty-sub">Sin hits ¬∑ ejecuta el workflow en GitHub</div></div>`;

  // Planes
  const dp = document.getElementById('dash-planes');
  const open = S.actionPlans.filter(p=>p.status!=='closed').slice(0,4);
  dp.innerHTML = open.length ? open.map(p=>miniPlan(p)).join('') :
    `<div class="empty"><div class="empty-sub">Sin planes abiertos</div></div>`;
}

function miniHit(h){
  return `<div class="flex ic gap8 mb8" style="padding:7px;background:var(--bg);border-radius:4px;border-left:2px solid ${levelColor(h.level)}">
    <span class="tag tag-${h.level||'info'}" style="flex-shrink:0">${levelLabel(h.level)}</span>
    <span style="font-size:10.5px;flex:1;line-height:1.3">${esc(h.title?.slice(0,70))}${h.title?.length>70?'...':''}</span>
    <span style="font-size:9px;color:var(--text-muted);flex-shrink:0">${fmtDate(h.raw_date||h.published_at||h.fetched_at||h._created)}</span>
  </div>`;
}

function miniPlan(p){
  const priority = {critical:'üî¥',high:'üü†',medium:'üü°',low:'üü¢'}[p.priority]||'‚ö™';
  return `<div class="flex ic gap8 mb8" style="padding:7px;background:var(--bg);border-radius:4px;cursor:pointer" onclick="openApModal('${p.id}')">
    <span>${priority}</span>
    <span class="tag tag-${p.status||'open'}" style="flex-shrink:0">${p.status||'open'}</span>
    <span style="font-size:10.5px;flex:1">${esc(p.title?.slice(0,65))}${p.title?.length>65?'...':''}</span>
    <span style="font-size:9px;color:var(--text-muted)">${p.deadline||''}</span>
  </div>`;
}

function updateBadges(){
  // Badge = residual ALTO count (requiring immediate action)
  const highRisk = S.hits.filter(h=>{
    const r=h.inherent_level||''; return r==='alto'||r==='critical';
  }).length;
  const badgeHits=document.getElementById('badge-hits');
  if(badgeHits) badgeHits.textContent=highRisk;
  const sents = (S.sentences||[]).length;
  const badgeSent=document.getElementById('badge-sent'); if(badgeSent) badgeSent.textContent=sents;
  updateFunnelCounts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTEXTO ORGANIZACIONAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadContexto(){
  const c = S.ctx||{};
  const fields = ['name','sector','size','revenue','geo','business','strategy','legal','economic','social','trends','structure','culture','tech','thirds','ext-parties','int-parties','risks','incidents'];
  fields.forEach(f=>{ const el=document.getElementById('ctx-'+f); if(el&&c[f]) el.value=c[f]; });
  document.querySelectorAll('.ctx-norm').forEach(cb=>{ cb.checked=!!(c.norms||[]).includes(cb.value); });
}

async function saveContexto(){
  const ctx = {
    name:       val('ctx-name'),   sector:     val('ctx-sector'),
    size:       val('ctx-size'),   revenue:    val('ctx-revenue'),
    geo:        val('ctx-geo'),    business:   val('ctx-business'),
    strategy:   val('ctx-strategy'),legal:     val('ctx-legal'),
    economic:   val('ctx-economic'),social:    val('ctx-social'),
    trends:     val('ctx-trends'), structure:  val('ctx-structure'),
    culture:    val('ctx-culture'),tech:       val('ctx-tech'),
    thirds:     val('ctx-thirds'),
    'ext-parties': val('ctx-ext-parties'),
    'int-parties': val('ctx-int-parties'),
    risks:      val('ctx-risks'),  incidents:  val('ctx-incidents'),
    norms:      [...document.querySelectorAll('.ctx-norm:checked')].map(c=>c.value),
  };
  if(!ctx.name||!ctx.sector){ showAlert('ctx-alert','Nombre y sector son obligatorios','err'); return; }
  S.ctx = ctx;
  const ok = await fsSet('organization','main', ctx);
  lsSet('ctx', ctx);
  showAlert('ctx-alert', ok?'‚úì Contexto guardado en Firestore':'Error al guardar','ok');
  // Auto-vectorize in Pinecone
  if(pcKey()){
    const ctxText = [
      ctx.name?'Empresa: '+ctx.name:'', ctx.sector?'Sector: '+ctx.sector:'',
      ctx.business?'Actividad: '+ctx.business:'', ctx.risks?'Riesgos: '+ctx.risks:'',
      ctx.certifications?'Normativa: '+ctx.certifications:''
    ].filter(Boolean).join('\n');
    vectorizeAndStore(ctxText, {id:'org-context', type:'org', name:ctx.name||'', sector:ctx.sector||''})
      .then(ok=>{ if(ok) console.log('‚úì Contexto vectorizado'); });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MATURITY ASSESSMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getDimScores(){
  const mat = S.maturity||{};
  return DIMS.map(d=>{
    const scores = d.elements.map(e=>parseInt(mat[e.id])||0).filter(s=>s>0);
    return scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
  });
}

function calcGlobalScore(){
  const scores = getDimScores().filter(s=>s>0);
  return scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
}

let matFilter = 'all';

function setMatFilter(f){
  matFilter = f;
  document.querySelectorAll('.mat-filter-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.filter===f);
  });
  applyMatFilter();
}

function applyMatFilter(){
  const mat = S.maturity||{};
  document.querySelectorAll('.mel[data-elem-id]').forEach(el=>{
    const id = el.dataset.elemId;
    const score = parseInt(mat[id])||0;
    let show = true;
    if(matFilter==='0') show = score===0;
    else if(matFilter!=='all') show = score===parseInt(matFilter);
    el.style.display = show ? '' : 'none';
  });

  // Hide whole dim card if all elements hidden
  DIMS.forEach(d=>{
    const body = document.getElementById('dim-body-'+d.id);
    if(!body) return;
    const visible = [...body.querySelectorAll('.mel')].some(el=>el.style.display!=='none');
    const card = body.closest('.card');
    if(card) card.style.display = visible ? '' : 'none';
  });
}

function collapseAllDims(collapse){
  DIMS.forEach(d=>{
    const body = document.getElementById('dim-body-'+d.id);
    if(body) body.style.display = collapse ? 'none' : '';
  });
}

function scoreColor(s){
  return {1:'var(--danger)',2:'var(--warn)',3:'#eab308',4:'var(--accent2)',5:'var(--accent)'}[s]||'var(--text-muted)';
}

function renderMaturity(){
  const mat = S.maturity||{};
  drawRadar('radar-mat', getDimScores());
  renderRadarLegend('radar-legend-mat', false);
  renderMatScoresSummary();

  const container = document.getElementById('mat-dimensions');
  container.innerHTML = DIMS.map(d=>{
    const dimScore = getDimScores()[DIMS.indexOf(d)];
    const dimColor = dimScore>=4?'var(--accent)':dimScore>=3?'#eab308':dimScore>=2?'var(--warn)':dimScore>0?'var(--danger)':d.color;
    return `
    <div class="card mb14">
      <div class="card-title" style="cursor:pointer" onclick="toggleDim('dim-body-${d.id}')">
        <span class="card-title-left">
          <span style="color:${d.color};font-size:14px">${d.icon}</span>
          <span style="font-family:var(--font-ui);font-weight:700">${d.label}</span>
          <span style="font-size:10px;color:var(--text-muted);font-weight:400">¬ß ISO 37301</span>
        </span>
        <div class="flex ic gap8">
          <div style="display:flex;gap:3px">
            ${d.elements.map(e=>{
              const s=parseInt(mat[e.id])||0;
              return `<span style="width:8px;height:8px;border-radius:2px;background:${s>0?scoreColor(s):'var(--border2)'};display:inline-block" title="${e.label}: ${s||'sin evaluar'}"></span>`;
            }).join('')}
          </div>
          <span style="font-family:var(--font-ui);font-weight:800;color:${dimColor};font-size:14px;min-width:36px;text-align:right">${dimScore>0?dimScore.toFixed(1):'‚Äî'}/5</span>
          <span style="color:var(--text-muted);font-size:11px" id="dim-caret-${d.id}">‚ñæ</span>
        </div>
      </div>
      <div id="dim-body-${d.id}">
        ${d.elements.map(e=>{
          const s = parseInt(mat[e.id])||0;
          const sc = s>0?scoreColor(s):'var(--border2)';
          return `
          <div class="mel" data-elem-id="${e.id}">
            <div class="mel-head">
              <div style="display:flex;align-items:center;gap:6px;flex:1">
                <span style="width:10px;height:10px;border-radius:2px;background:${sc};flex-shrink:0;display:inline-block"></span>
                <span class="mel-name">${e.label}</span>
                ${s>0?`<span style="font-size:9px;color:${sc};font-weight:600">${SCORE_LABELS[s]}</span>`:'<span style="font-size:9px;color:var(--text-muted)">sin evaluar</span>'}
              </div>
              <div class="mel-score-wrap">
                ${[1,2,3,4,5].map(n=>`<button class="score-btn ${s===n?'active':''}" style="${s===n?`background:${scoreColor(n)};border-color:${scoreColor(n)}`:''}" onclick="setScore('${e.id}',${n},'${d.id}')" title="${SCORE_LABELS[n]}">${n}</button>`).join('')}
              </div>
            </div>
            ${e.criteria?`<details style="margin:4px 0 2px"><summary style="font-size:8.5px;color:var(--text-muted);cursor:pointer;letter-spacing:.5px;user-select:none">‚ñ∏ Criterios ISO 37301</summary><div style="font-size:9px;color:var(--text-dim);line-height:1.6;padding:6px 0 4px;border-left:2px solid var(--border2);padding-left:8px;margin-top:4px">${esc(e.criteria)}</div></details>`:''}
            <textarea class="fi mel-evidence" id="ev-${e.id}" rows="2" placeholder="Evidencias, documentos, notas..." onchange="saveMatQuick('${e.id}','ev')">${mat['ev_'+e.id]||''}</textarea>
            ${mat['gap_'+e.id]?`<div style="font-size:8.5px;color:var(--warn);background:rgba(245,158,11,.07);border-left:2px solid var(--warn);padding:4px 8px;border-radius:0 3px 3px 0;margin-top:3px">‚ö† Gap: ${esc(mat['gap_'+e.id])}</div>`:''}
            ${(S.docBibliography||[]).filter(b=>b.elements.includes(e.id)).length>0?`<div style="font-size:8px;color:var(--text-muted);margin-top:4px">üìÑ ${(S.docBibliography||[]).filter(b=>b.elements.includes(e.id)).map(b=>`<span title="${b.date}" style="color:var(--accent)">${esc(b.name.slice(0,35))} (${b.date})</span>`).join(', ')}</div>`:''}
            <div class="mel-actions">
              <button class="btn btn-ghost btn-xs" onclick="openDocAnalysis('element','${e.id}','${e.label}')">üìÑ Analizar doc</button>
              <button class="btn btn-ghost btn-xs" onclick="openApFromElement('${d.label}','${e.label}')">+ Plan de acci√≥n</button>
            </div>
          </div>`
        }).join('')}
      </div>
    </div>`;
  }).join('');

  applyMatFilter();
}

function toggleDim(id){
  const el = document.getElementById(id);
  if(!el) return;
  const collapsed = el.style.display==='none';
  el.style.display = collapsed ? '' : 'none';
  const dimId = id.replace('dim-body-','');
  const caret = document.getElementById('dim-caret-'+dimId);
  if(caret) caret.textContent = collapsed ? '‚ñæ' : '‚ñ∏';
}

function setScore(elemId, score, dimId){
  if(!S.maturity) S.maturity={};
  S.maturity[elemId] = score;
  const sc = scoreColor(score);

  // Update score buttons and visual elements without full re-render
  const mel = document.querySelector(`.mel[data-elem-id="${elemId}"]`);
  if(mel){
    mel.querySelectorAll('.score-btn').forEach(btn=>{
      const n = parseInt(btn.textContent);
      const active = n===score;
      btn.classList.toggle('active', active);
      btn.style.background = active ? scoreColor(n) : '';
      btn.style.borderColor = active ? scoreColor(n) : '';
      btn.style.color = active ? '#000' : '';
    });
    const dot = mel.querySelector('span[style*="width:10px"]');
    if(dot) dot.style.background = sc;
    const labelSpan = mel.querySelector('.mel-head span[style*="font-size:9px"]');
    if(labelSpan){
      labelSpan.style.color = sc;
      labelSpan.style.fontWeight = '600';
      labelSpan.textContent = SCORE_LABELS[score]||'';
    }
  }

  // Update dim header dots and score
  const d = DIMS.find(x=>x.elements.some(e=>e.id===elemId));
  if(d){
    const dimBody = document.getElementById('dim-body-'+d.id);
    const dimCard = dimBody ? dimBody.closest('.card') : null;
    if(dimCard){
      const dots = dimCard.querySelector('div[style*="display:flex;gap:3px"]');
      if(dots){
        dots.innerHTML = d.elements.map(e=>{
          const s2=parseInt(S.maturity[e.id])||0;
          return `<span style="width:8px;height:8px;border-radius:2px;background:${s2>0?scoreColor(s2):'var(--border2)'};display:inline-block" title="${e.label}: ${s2||'sin evaluar'}"></span>`;
        }).join('');
      }
      const dimScores = getDimScores();
      const di = DIMS.indexOf(d);
      const ds = di>=0 ? dimScores[di] : 0;
      const dc = ds>=4?'var(--accent)':ds>=3?'#eab308':ds>=2?'var(--warn)':ds>0?'var(--danger)':d.color;
      const scoreSpan = dimCard.querySelector('span[style*="font-weight:800"]');
      if(scoreSpan){ scoreSpan.textContent = (ds>0?ds.toFixed(1):'\u2014')+'/5'; scoreSpan.style.color=dc; }
    }
  }

  renderMatScoresSummary();
  drawRadar('radar-mat', getDimScores());
  renderRadarLegend('radar-legend-mat', false);
  drawRadar('radar-dash', getDimScores());
  // Auto-vectorize updated element
  if(pcKey()){
    const _elem = DIMS.flatMap(d=>d.elements).find(e=>e.id===elemId);
    const _dim  = DIMS.find(d=>d.elements.some(e=>e.id===elemId));
    if(_elem){
      const _mat = S.maturity[elemId]||{};
      const _txt = ['Dimensi√≥n: '+(_dim?.label||''), 'Elemento: '+_elem.label, 'Puntuaci√≥n: '+score+'/5 ‚Äî '+(SCORE_LABELS[score]||''), _mat.justification?'Justificaci√≥n: '+_mat.justification:''].filter(Boolean).join('\n');
      vectorizeAndStore(_txt, {id:'elem-'+elemId, type:'element', elem_id:elemId, dim_id:_dim?.id||'', dim_label:_dim?.label||'', elem_label:_elem.label, score, score_label:SCORE_LABELS[score]||''});
    }
  }
}

function saveMatQuick(elemId, type){
  if(!S.maturity) S.maturity={};
  const ev = document.getElementById('ev-'+elemId);
  if(ev) S.maturity['ev_'+elemId] = ev.value;
}

async function saveMaturity(){
  const mat = S.maturity||{};
  // Collect all textarea evidences
  document.querySelectorAll('[id^="ev-"]').forEach(ta=>{
    const key = 'ev_'+ta.id.replace('ev-','');
    mat[key] = ta.value;
  });
  S.maturity = mat;

  // Save current
  const ok = await fsSet('maturity','current', mat);

  // Save to history
  const globalScore = calcGlobalScore();
  await fsAdd('maturity_history',{
    scores: getDimScores(),
    globalScore,
    snapshot: mat,
    note: `Madurez global: ${globalScore.toFixed(1)}/5`,
  });

  lsSet('mat', mat);
  showAlert('mat-alert', ok?`‚úì Assessment guardado. Madurez global: ${globalScore.toFixed(1)}/5`:'Error','ok');
  renderDashboard();
}

function renderMatScoresSummary(){
  const scores = getDimScores();
  document.getElementById('mat-scores-summary').innerHTML = DIMS.map((d,i)=>`
    <div class="dim-row" onclick="go('madurez')">
      <span style="color:${d.color};font-size:12px">${d.icon}</span>
      <span class="dim-label">${d.label}</span>
      <span class="dim-score" style="color:${d.color}">${scores[i]>0?scores[i].toFixed(1):'‚Äî'}</span>
      <div style="width:60px"><div class="dim-bar"><div class="dim-fill" style="width:${scores[i]/5*100}%;background:${d.color}"></div></div></div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RADAR CANVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawRadar(canvasId, scores){
  const canvas = document.getElementById(canvasId);
  if(!canvas) return;
  const ctx2 = canvas.getContext('2d');
  const W=canvas.width, H=canvas.height, cx=W/2, cy=H/2, r=Math.min(W,H)/2-22;
  const N=DIMS.length;
  ctx2.clearRect(0,0,W,H);

  // Grid
  for(let ring=1;ring<=5;ring++){
    ctx2.beginPath();
    for(let i=0;i<N;i++){
      const angle = (i/N)*Math.PI*2 - Math.PI/2;
      const pr = r*ring/5;
      const x = cx+pr*Math.cos(angle), y = cy+pr*Math.sin(angle);
      i===0?ctx2.moveTo(x,y):ctx2.lineTo(x,y);
    }
    ctx2.closePath();
    ctx2.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx2.lineWidth=1; ctx2.stroke();
  }

  // Axes
  for(let i=0;i<N;i++){
    const angle=(i/N)*Math.PI*2-Math.PI/2;
    ctx2.beginPath();
    ctx2.moveTo(cx,cy);
    ctx2.lineTo(cx+r*Math.cos(angle),cy+r*Math.sin(angle));
    ctx2.strokeStyle='rgba(255,255,255,0.08)';
    ctx2.lineWidth=1; ctx2.stroke();
  }

  // Data
  ctx2.beginPath();
  scores.forEach((s,i)=>{
    const angle=(i/N)*Math.PI*2-Math.PI/2;
    const pr = r*(s||0)/5;
    const x=cx+pr*Math.cos(angle), y=cy+pr*Math.sin(angle);
    i===0?ctx2.moveTo(x,y):ctx2.lineTo(x,y);
  });
  ctx2.closePath();
  ctx2.fillStyle='rgba(0,229,160,0.1)';
  ctx2.strokeStyle='rgba(0,229,160,0.7)';
  ctx2.lineWidth=2; ctx2.fill(); ctx2.stroke();

  // Points
  scores.forEach((s,i)=>{
    const angle=(i/N)*Math.PI*2-Math.PI/2;
    const pr=r*(s||0)/5;
    ctx2.beginPath();
    ctx2.arc(cx+pr*Math.cos(angle),cy+pr*Math.sin(angle),3,0,Math.PI*2);
    ctx2.fillStyle=DIMS[i].color; ctx2.fill();
  });

  // Labels
  ctx2.font='9px DM Mono, monospace';
  ctx2.fillStyle='rgba(220,232,240,0.6)';
  ctx2.textAlign='center'; ctx2.textBaseline='middle';
  DIMS.forEach((d,i)=>{
    const angle=(i/N)*Math.PI*2-Math.PI/2;
    const lr=r+14;
    ctx2.fillText(d.label,cx+lr*Math.cos(angle),cy+lr*Math.sin(angle));
  });
}

function renderRadarLegend(containerId, compact){
  const scores = getDimScores();
  document.getElementById(containerId).innerHTML = DIMS.map((d,i)=>`
    <div class="dim-row" onclick="go('madurez')" style="margin-bottom:${compact?6:9}px">
      <span style="color:${d.color};font-size:${compact?10:12}px">${d.icon}</span>
      <span class="dim-label" style="font-size:${compact?9.5:11}px">${d.label}</span>
      <span class="dim-score" style="color:${d.color};font-size:${compact?11:12}px">${scores[i]>0?scores[i].toFixed(1):'‚Äî'}</span>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TWIN SUMMARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTwinSummaryPage(){
  document.getElementById('twin-summary-text').value = S.twinSummary||'';
  document.getElementById('ts-updated').textContent = S.ctx?._updated ? fmtDate(S.ctx._updated) : '‚Äî';
  document.getElementById('ts-ctx-status').textContent = S.ctx?.name ? `‚úì ${S.ctx.name}` : '‚úó Sin configurar';
  document.getElementById('ts-mat-status').textContent = calcGlobalScore()>0 ? `‚úì ${calcGlobalScore().toFixed(1)}/5` : '‚úó Sin datos';
}

async function generateTwinSummary(){
  const key = S.cfg.mistralKey;
  if(!key){ showAlert('ts-alert','Configura la API key de Mistral primero','err'); return; }
  if(!S.ctx?.name){ showAlert('ts-alert','Completa primero el Contexto Organizacional','err'); return; }

  const btn = document.getElementById('gen-summary-btn');
  btn.innerHTML='<span class="spin"></span> Generando...'; btn.disabled=true;

  const scores = getDimScores();
  const matSummary = DIMS.map((d,i)=>`${d.label}: ${scores[i]>0?scores[i].toFixed(1)+'/5':'Sin datos'}`).join(' | ');
  const ctx = S.ctx;

  const prompt = `Eres el experto en compliance de la empresa "${ctx.name}" (sector: ${ctx.sector}, tama√±o: ${ctx.size}, √°mbito: ${ctx.geo}).

Genera un RESUMEN EJECUTIVO CONCISO (m√°ximo 500 palabras) del Digital Twin de compliance de esta organizaci√≥n, que se usar√° como contexto para analizar noticias y eventos regulatorios.

CONTEXTO ORGANIZACIONAL:
- Negocio: ${ctx.business||'No especificado'}
- Marco legal: ${ctx.legal||'No especificado'}
- Riesgos compliance prioritarios: ${ctx.risks||'No especificado'}
- Normas adoptadas: ${(ctx.norms||[]).join(', ')||'No especificado'}
- Terceros: ${ctx.thirds||'No especificado'}
- Cultura compliance: ${ctx.culture||'No especificado'}

ASSESSMENT DE MADUREZ:
${matSummary}

El resumen debe incluir: (1) perfil de la empresa en 2-3 frases, (2) principales riesgos de compliance con sus normas aplicables, (3) fortalezas y gaps del modelo de compliance (seg√∫n madurez), (4) √°reas cr√≠ticas que deben monitorizarse.

Escribe en espa√±ol. S√© concreto y actionable. Este texto se usar√° en cada an√°lisis de hit para dar contexto espec√≠fico de esta empresa.`;

  try{
    const r = await callMistral(prompt, 800);
    document.getElementById('twin-summary-text').value = r;
    S.twinSummary = r;
    showAlert('ts-alert','‚úì Resumen generado ‚Äî rev√≠salo y guarda cuando est√©s conforme','ok');
  }catch(e){
    showAlert('ts-alert','Error: '+e.message,'err');
  }
  btn.textContent='‚ú¶ Generar con IA'; btn.disabled=false;
}

async function saveTwinSummary(){
  const text = document.getElementById('twin-summary-text').value.trim();
  S.twinSummary = text;
  const ok = await fsSet('twin_summary','main',{text});
  lsSet('ts', text);
  showAlert('ts-alert', ok?'‚úì Resumen guardado en Firestore':'Error al guardar','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HITS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Helper: is this hit an impact? inherente medio or alto
function isImpact(h){
  const lvl = h.inherent_level||'';
  return lvl==='alto'||lvl==='medio'||lvl==='critical'||lvl==='warning';
}

function renderHits(){
  const inh    = document.getElementById('hit-filter-inh')?.value||'';
  const res    = document.getElementById('hit-filter-res')?.value||'';
  const src    = document.getElementById('hit-filter-source')?.value||'';
  const search = (document.getElementById('hit-search')?.value||'').toLowerCase();

  let hits = S.hits;

  // Funnel filter
  if(hitFunnel==='impacts'){
    hits = hits.filter(h => isImpact(h));
  } else if(hitFunnel==='plans'){
    // Show plans panel, hide hits list
    document.getElementById('hits-list').style.display='none';
    document.getElementById('hits-plans-panel').style.display='';
    renderPlanes();
    updateFunnelCounts();
    return;
  }

  document.getElementById('hits-list').style.display='';
  document.getElementById('hits-plans-panel').style.display='none';

  // Dual level filters
  if(inh) hits=hits.filter(h=>{
    const l=h.inherent_level||h.level||'';
    const norm={critical:'alto',warning:'medio',info:'bajo'}[l]||l;
    return norm===inh;
  });
  if(res) hits=hits.filter(h=>{
    const l=h.residual_level||h.level||'';
    const norm={critical:'alto',warning:'medio',info:'bajo'}[l]||l;
    return norm===res;
  });
  if(src) hits=hits.filter(h=>(h.source||'').includes(src)||(h.is_sentencia&&src==='Sentencia'));
  if(search) hits=hits.filter(h=>((h.title||'')+(h.summary||'')+(h.twin_analysis||'')).toLowerCase().includes(search));

  updateFunnelCounts();
  const el=document.getElementById('hit-count');
  if(el) el.textContent=`${hits.length} hits`;
  const container = document.getElementById('hits-list');
  if(!container) return;

  // In impacts funnel: hits needing action shown first
  if(hitFunnel==='impacts'){
    hits.sort((a,b)=>{
      const aAction = a._action_taken ? 1 : 0;
      const bAction = b._action_taken ? 1 : 0;
      return aAction - bAction;
    });
  }

  container.innerHTML = hits.length ? hits.map(h=>hitCard(h)).join('') :
    `<div class="empty"><div class="empty-icon">‚üÅ</div><div class="empty-title">Sin hits${hitFunnel==='impacts'?' con impacto':''}</div><div class="empty-sub">${hitFunnel==='impacts'?'Los hits con riesgo inherente medio o alto aparecer√°n aqu√≠':'Ejecuta el workflow en GitHub Actions o a√±ade sentencias'}</div></div>`;
}

function hitCard(h){
  const hasDetail = h.summary||h.twin_analysis||h.recommended_action;
  const hasAp = S.actionPlans.find(p=>p.hit_id===h.id);
  return `
  <div class="hit ${({alto:'critical',medio:'warning',bajo:'info',critical:'critical',warning:'warning',info:'info',irrelevant:'irrelevant'})[h.inherent_level||h.level||'info']||'info'}">
    <div class="hit-head">
      ${h.inherent_level ? `
        <div class="risk-dual">
          <div class="risk-pill risk-inh">
            <span class="risk-pill-label">INHERENTE</span>
            <span class="risk-pill-val tag tag-${h.inherent_level}">${levelLabel(h.inherent_level)}</span>
          </div>
          <span style="color:var(--text-muted);font-size:10px;margin:0 2px">‚Üí</span>
          <div class="risk-pill risk-res">
            <span class="risk-pill-label">RESIDUAL</span>
            <span class="risk-pill-val tag tag-${h.residual_level||h.level||'info'}">${levelLabel(h.residual_level||h.level)}</span>
          </div>
          ${h.rag_fragments_used>0||h.inherent_level?`<span class="rag-badge" title="${h.rag_fragments_used>0?'An√°lisis con '+h.rag_fragments_used+' fragmentos del Digital Twin':'An√°lisis Twin'}">‚¨° Twin${h.rag_fragments_used>0?' ¬∑'+h.rag_fragments_used:''}</span>`:''}
        </div>
      ` : `<span class="tag tag-${h.level||'info'}">${levelLabel(h.level)}</span>`}
      ${h.is_sentencia?'<span class="sent-tag">SENTENCIA</span>':''}<span class="hit-source">${esc((h.source||'').split('¬∑')[0].trim())}</span>
      <span class="hit-date">${fmtDate(h.raw_date||h.published_at||h.fetched_at||h._created)}</span>
    </div>
    <div class="hit-title">${esc(h.title)}</div>
    ${h.summary?`<div class="hit-summary">${esc(h.summary)}</div>`:''}
    ${h.relevance_score?`<div style="font-size:8px;color:var(--text-muted);margin-top:4px">Relevancia: ${h.relevance_score}/100</div>`:''}
    <div class="flex gap6 mt6" style="flex-wrap:wrap">
      ${hasDetail?`<button class="btn btn-ghost btn-xs" onclick="toggleHitDetail('hd-${h.id}')">Ver an√°lisis ‚Üì</button>`:''}
      ${h.inherent_level?`<button class="btn btn-ghost btn-xs" style="color:var(--purple);border-color:rgba(139,92,246,.3)" onclick="openDeepDive('${h.id}')">‚ú¶ An√°lisis Profundo</button>`:'' }
      ${h.link?`<a href="${h.link}" target="_blank" class="btn btn-ghost btn-xs">Fuente ‚Üó</a>`:''}
      <button class="btn btn-ghost btn-xs" onclick="reAnalyzeHit('${h.id}')" title="Re-analizar manualmente contra el Twin" id="reanalyze-${h.id}">‚ü≥ Re-evaluar</button>
      ${h._discarded?
        `<span class="btn btn-xs" style="background:rgba(122,150,170,.1);color:var(--text-dim);cursor:default" title="${esc(h._discard_reason||'')}">‚úó Descartado</span>`:
        hasAp?
          `<span class="btn btn-warn btn-xs" onclick="setHitFunnel('plans')" style="cursor:pointer">‚óâ Ver plan ‚Üí</span>`:
          isImpact(h)?`
          <button class="btn btn-ghost btn-xs" onclick="discardHit('${h.id}')">‚úó Descartar</button>
          <button class="btn btn-primary btn-xs" onclick="openApFromHit('${h.id}','${esc(h.title).replace(/'/g,"\\'")}')">+ Abrir Plan</button>`:
          `<button class="btn btn-ghost btn-xs" onclick="openApFromHit('${h.id}','${esc(h.title).replace(/'/g,"\\'")}')">+ Plan de acci√≥n</button>`
      }
    </div>
    ${hasDetail?`
    <div class="hit-extra" id="hd-${h.id}">
      ${h.false_positive?`<div style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:4px;padding:8px 12px;margin-bottom:10px;font-size:10px;color:var(--warn)">
        <span style="font-size:8px;letter-spacing:1.5px;font-weight:700">‚ö† FALSO POSITIVO DETECTADO</span>
        <div style="color:var(--text-dim);margin-top:3px;line-height:1.6">${esc(h.false_positive_reason||h.reanalysis_rationale||'No aplica a esta organizaci√≥n')}</div>
      </div>`:''}
      ${h.reanalysis_rationale&&!h.false_positive?`<div style="background:rgba(0,229,160,.05);border:1px solid rgba(0,229,160,.15);border-radius:4px;padding:8px 12px;margin-bottom:10px;font-size:10px">
        <span style="font-size:8px;letter-spacing:1.5px;font-weight:700;color:var(--accent)">‚úì RE-EVALUADO CONTRA EL TWIN</span>
        <div style="color:var(--text-dim);margin-top:3px;line-height:1.6">${esc(h.reanalysis_rationale)}</div>
      </div>`:''}
      ${h.twin_analysis?`<div class="hit-twin-box"><div class="hit-twin-label">‚¨° An√°lisis vs. Digital Twin</div><div style="font-size:10.5px;color:var(--text-dim);line-height:1.6">${esc(h.twin_analysis)}</div></div>`:''}
      ${h.inherent_rationale||h.residual_rationale?`
      <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="background:rgba(0,0,0,.2);border-radius:4px;padding:8px 10px;border-left:2px solid ${levelColor(h.inherent_level||'info')}">
          <div style="font-size:7.5px;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:4px">RIESGO INHERENTE</div>
          <div style="font-size:10px;color:var(--text-dim);line-height:1.6">${esc(h.inherent_rationale||'Sin evaluar')}</div>
        </div>
        <div style="background:rgba(0,0,0,.2);border-radius:4px;padding:8px 10px;border-left:2px solid ${levelColor(h.residual_level||'info')}">
          <div style="font-size:7.5px;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:4px">RIESGO RESIDUAL (cobertura del Twin)</div>
          <div style="font-size:10px;color:var(--text-dim);line-height:1.6">${esc(h.residual_rationale||'Sin evaluar')}</div>
        </div>
      </div>`:''} 
      ${h.controls_activated?.length?`
      <div style="margin-top:8px">
        <div style="font-size:7.5px;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:4px">CONTROLES ACTIVADOS</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px">${h.controls_activated.map(id=>`<span style="background:rgba(0,229,160,.08);color:var(--accent);font-size:8.5px;padding:2px 7px;border-radius:3px">${esc(id)}</span>`).join('')}</div>
      </div>`:''}
      ${h.gaps_identified?`
      <div style="margin-top:8px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:4px;padding:8px 10px">
        <div style="font-size:7.5px;letter-spacing:1.5px;color:var(--warn);margin-bottom:3px">GAP IDENTIFICADO</div>
        <div style="font-size:10px;color:var(--text-dim);line-height:1.5">${esc(h.gaps_identified)}</div>
      </div>`:''} 
      ${h.risks?.length?`<div class="hit-detail-row mt8"><div class="hit-detail-label">Riesgos</div><div class="hit-detail-val">${h.risks.join(' ¬∑ ')}</div></div>`:''}
      ${h.norms_affected?.length?`<div class="hit-detail-row"><div class="hit-detail-label">Normas afectadas</div><div class="hit-detail-val">${h.norms_affected.join(' ¬∑ ')}</div></div>`:''}
      ${h.vulnerability?`<div class="hit-detail-row"><div class="hit-detail-label">Vulnerabilidad / Control</div><div class="hit-detail-val">${esc(h.vulnerability)}</div></div>`:''}
      ${h.financial_impact?`<div class="hit-detail-row"><div class="hit-detail-label">Impacto financiero</div><div class="hit-detail-val">${esc(h.financial_impact)}</div></div>`:''}
      ${h.recommended_action?`<div class="hit-detail-row"><div class="hit-detail-label">Acci√≥n recomendada</div><div class="hit-detail-val">${esc(h.recommended_action)}</div></div>`:''}
      ${h.ctrl_proposal?`<div class="hit-detail-row"><div class="hit-detail-label" style="color:var(--purple)">‚óé Propuesta de control</div><div class="hit-detail-val" style="color:var(--text-dim)">${esc(h.ctrl_proposal)}</div></div>`:''}
      ${h.is_sentencia?`<div class="hit-detail-row"><div class="hit-detail-label" style="color:var(--purple)">ECLI / Referencia</div><div class="hit-detail-val">${esc(h.ecli||'')}</div></div>`:''}
    </div>`:''}
  </div>`;
}

function toggleHitDetail(id){
  const el=document.getElementById(id);
  if(el)el.classList.toggle('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLANES DE ACCI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentApId = null;
let apSteps = [];

function renderPlanes(){
  const filter = document.getElementById('ap-filter')?.value||'';
  let plans = S.actionPlans.filter(p=>!filter||p.status===filter);
  const container = document.getElementById('planes-list');
  container.innerHTML = plans.length ? plans.map(p=>planCard(p)).join('') :
    `<div class="empty"><div class="empty-icon">‚óâ</div><div class="empty-title">Sin planes de acci√≥n</div><div class="empty-sub">Abre un plan desde un hit cr√≠tico</div></div>`;
}

function planCard(p){
  const pIcon = {critical:'üî¥',high:'üü†',medium:'üü°',low:'üü¢'}[p.priority]||'‚ö™';
  const done  = (p.steps||[]).filter(s=>s.done).length;
  const total = (p.steps||[]).length;
  const pct   = total>0?Math.round(done/total*100):0;
  return `
  <div class="ap" onclick="openApModal('${p.id}')">
    <div class="ap-head">
      <span class="tag tag-${p.status||'open'}">${p.status||'open'}</span>
      <div class="ap-title">${pIcon} ${esc(p.title)}</div>
    </div>
    <div class="ap-meta">
      ${p.control?`<span>‚óé ${esc(p.control)}</span>`:''}
      ${p.owner?`<span>üë§ ${esc(p.owner)}</span>`:''}
      ${p.deadline?`<span>üìÖ ${p.deadline}</span>`:''}
      ${p.dim?`<span>¬ß ${esc(p.dim)}</span>`:''}
    </div>
    ${total>0?`<div class="ap-progress">
      <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-muted);margin-bottom:3px"><span>Progreso</span><span>${done}/${total} ¬∑ ${pct}%</span></div>
      <div class="score-bar"><div class="score-fill" style="width:${pct}%;background:var(--accent)"></div></div>
    </div>`:''}
  </div>`;
}

function openApFromHit(hitId, hitTitle){
  currentApId = null; apSteps=[];
  document.getElementById('ap-title').value = 'Plan: '+hitTitle.slice(0,60);
  document.getElementById('ap-control').value='';
  document.getElementById('ap-dim').value='';
  document.getElementById('ap-owner').value='Compliance Officer';
  document.getElementById('ap-deadline').value='';
  document.getElementById('ap-priority').value='high';
  document.getElementById('ap-desc').value='Hit origen: '+hitTitle;
  document.getElementById('ap-improvement').value='';
  document.getElementById('ap-status').value='open';
  document.getElementById('ap-delete-btn').style.display='none';
  document.getElementById('ap-modal-title').textContent='Nuevo Plan de Acci√≥n';
  window._apHitId = hitId;
  apSteps=[]; renderApSteps();
  openModal('modal-ap');
}

function openApFromElement(dimLabel, elemLabel){
  currentApId=null; apSteps=[];
  document.getElementById('ap-title').value=`Mejora: ${elemLabel.slice(0,50)}`;
  document.getElementById('ap-control').value=elemLabel;
  document.getElementById('ap-dim').value=dimLabel;
  document.getElementById('ap-owner').value='Compliance Officer';
  document.getElementById('ap-deadline').value='';
  document.getElementById('ap-priority').value='medium';
  document.getElementById('ap-desc').value='';
  document.getElementById('ap-improvement').value='';
  document.getElementById('ap-status').value='open';
  document.getElementById('ap-delete-btn').style.display='none';
  document.getElementById('ap-modal-title').textContent='Nuevo Plan de Acci√≥n';
  window._apHitId=null; renderApSteps();
  openModal('modal-ap');
}

function openApModal(id){
  const p = S.actionPlans.find(a=>a.id===id);
  if(!p) return;
  currentApId=id; apSteps=[...(p.steps||[])];
  document.getElementById('ap-title').value=p.title||'';
  document.getElementById('ap-control').value=p.control||'';
  document.getElementById('ap-dim').value=p.dim||'';
  document.getElementById('ap-owner').value=p.owner||'';
  document.getElementById('ap-deadline').value=p.deadline||'';
  document.getElementById('ap-priority').value=p.priority||'medium';
  document.getElementById('ap-desc').value=p.desc||'';
  document.getElementById('ap-improvement').value=p.improvement||'';
  document.getElementById('ap-status').value=p.status||'open';
  document.getElementById('ap-delete-btn').style.display='';
  document.getElementById('ap-modal-title').textContent='Plan de Acci√≥n';
  window._apHitId=p.hit_id||null;
  renderApSteps();
  document.getElementById('ap-close-note').style.display=p.status==='closed'?'':'none';
  openModal('modal-ap');
}

function addApStep(){
  const v=document.getElementById('ap-new-step').value.trim();
  if(!v)return;
  apSteps.push({text:v,done:false,id:Date.now()});
  document.getElementById('ap-new-step').value='';
  renderApSteps();
}

function toggleApStep(i){
  apSteps[i].done=!apSteps[i].done;
  renderApSteps();
}

function renderApSteps(){
  document.getElementById('ap-steps-list').innerHTML=apSteps.map((s,i)=>`
    <div class="ap-step">
      <div class="ap-step-check ${s.done?'done':''}" onclick="toggleApStep(${i})">${s.done?'‚úì':''}</div>
      <span style="${s.done?'text-decoration:line-through;opacity:.5':''}">${esc(s.text)}</span>
    </div>`).join('');
  document.getElementById('ap-status').dispatchEvent(new Event('change'));
}

async function saveAp(){
  const title=val('ap-title');
  if(!title){alert('T√≠tulo obligatorio');return;}
  const data={
    title, control:val('ap-control'), dim:val('ap-dim'),
    owner:val('ap-owner'), deadline:val('ap-deadline'),
    priority:val('ap-priority'), desc:val('ap-desc'),
    improvement:val('ap-improvement'), status:val('ap-status'),
    steps:apSteps, hit_id:window._apHitId||null,
  };

  // If closing plan, update maturity element if control is linked
  if(data.status==='closed' && data.control){
    const matched = findMaturityElement(data.control);
    if(matched && data.improvement){
      // Bump score by 0.5 conceptually ‚Äî just note it
      console.log('Plan cerrado, vinculado a elemento:', matched);
    }
  }

  if(currentApId){
    await fsUpdate('action_plans', currentApId, data);
    const i=S.actionPlans.findIndex(a=>a.id===currentApId);
    if(i>=0) S.actionPlans[i]={...S.actionPlans[i],...data};
  } else {
    const newId = await fsAdd('action_plans', data);
    if(newId) S.actionPlans.push({id:newId,...data});
  }

  lsSet('plans', S.actionPlans);
  closeModal('modal-ap');
  renderPlanes(); renderDashboard(); updateBadges();
}

async function deleteAp(){
  if(!currentApId||!confirm('¬øEliminar este plan?'))return;
  await fsDelete('action_plans', currentApId);
  S.actionPlans=S.actionPlans.filter(a=>a.id!==currentApId);
  lsSet('plans',S.actionPlans);
  closeModal('modal-ap'); renderPlanes(); updateBadges();
}

function findMaturityElement(controlText){
  const ct=controlText.toLowerCase();
  for(const d of DIMS){ for(const e of d.elements){ if(e.label.toLowerCase().includes(ct.slice(0,15))) return e.id; } }
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOCUMENTO ANALYSIS ‚Äî queue-based, JSON-structured
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let docAnalysisTarget = 'contexto';
let docAnalysisElementId = null;
let docAnalysisElementLabel = null;
let docQueue = []; // [{name, text}]
let lastDocResult = null; // store result safely (no inline onclick)

function openDocAnalysis(target, elemId=null, elemLabel=null){
  docAnalysisTarget=target;
  docAnalysisElementId=elemId;
  docAnalysisElementLabel=elemLabel;
  docQueue=[];
  lastDocResult=null;

  const title = target==='element' ? `Analizar doc ‚Üí ${elemLabel}` :
    target==='madurez' ? 'Analizar documentos ‚Äî Assessment de Madurez' :
    'Analizar documentos ‚Äî Contexto Organizacional';
  document.getElementById('doc-modal-title').textContent=title;
  document.getElementById('doc-file').value='';
  document.getElementById('doc-text').value='';
  document.getElementById('doc-result').innerHTML='';
  renderDocQueue();
  openModal('modal-doc');
}

function renderDocQueue(){
  const list = document.getElementById('doc-queue-list');
  const btnOne = document.getElementById('doc-analyze-one-btn');
  const btnAll = document.getElementById('doc-analyze-all-btn');

  if(!docQueue.length){
    list.innerHTML='<div style="font-size:10px;color:var(--text-muted);padding:6px 0">Sin documentos en cola a√∫n.</div>';
    btnOne.style.display='none';
    btnAll.style.display='none';
    return;
  }

  list.innerHTML = docQueue.map((d,i)=>`
    <div class="flex ic gap8" style="padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;margin-bottom:5px">
      <span style="font-size:11px;color:var(--accent)">üìÑ</span>
      <span style="font-size:10.5px;flex:1">${esc(d.name)}</span>
      <span style="font-size:9px;color:var(--text-muted)">${(d.text.length/1000).toFixed(1)}k chars</span>
      <button style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:13px" onclick="removeDocFromQueue(${i})">√ó</button>
    </div>`).join('');

  btnOne.style.display = docQueue.length===1 ? '' : 'none';
  btnAll.style.display = '';
  btnAll.textContent = docQueue.length===1 ? 'Analizar con IA ‚Üí' : `Analizar ${docQueue.length} docs con IA ‚Üí`;
}

function removeDocFromQueue(i){
  docQueue.splice(i,1);
  renderDocQueue();
}

async function addDocToQueue(){
  const files = document.getElementById('doc-file').files;
  const pasted = document.getElementById('doc-text').value.trim();

  if(files.length===0 && !pasted){
    showAlert('doc-alert','Adjunta un archivo o pega texto','err'); return;
  }

  showAlert('doc-alert','Leyendo...','info');

  // Files
  for(const file of files){
    try{
      const text = await readFileAsText(file);
      if(text && text.trim().length>20){
        docQueue.push({name: file.name, text});
      } else {
        showAlert('doc-alert',`No se pudo extraer texto de ${file.name} ‚Äî prueba a pegar el contenido`,'err');
      }
    }catch(e){
      showAlert('doc-alert',`Error leyendo ${file.name}: ${e.message}`,'err');
    }
  }

  // Pasted text
  if(pasted){
    docQueue.push({name:'Texto pegado', text: pasted});
  }

  document.getElementById('doc-file').value='';
  document.getElementById('doc-text').value='';
  document.getElementById('doc-alert').innerHTML='';
  renderDocQueue();
}

async function analyzeDocQueue(allDocs){
  const key=S.cfg.mistralKey;
  if(!key){showAlert('doc-alert','Configura la API key de Mistral en ‚öô Configuraci√≥n','err');return;}
  if(!docQueue.length){showAlert('doc-alert','A√±ade al menos un documento','err');return;}

  const docsToAnalyze = allDocs ? docQueue : [docQueue[docQueue.length-1]];
  const combinedText = docsToAnalyze.map(d=>`=== ${d.name} ===\n${d.text}`).join('\n\n').slice(0,12000);

  document.getElementById('doc-result').innerHTML=`
    <div class="flex ic gap8" style="color:var(--text-muted);padding:10px 0">
      <span class="spin"></span> Analizando ${docsToAnalyze.length} documento(s) con Mistral AI...
    </div>`;

  let prompt, resultHandler;

  if(docAnalysisTarget==='contexto'){
    // Structured JSON extraction for all context fields
    const existingCtx = JSON.stringify({
      name:val('ctx-name'), sector:val('ctx-sector'), business:val('ctx-business'),
      strategy:val('ctx-strategy'), legal:val('ctx-legal'), economic:val('ctx-economic'),
      social:val('ctx-social'), trends:val('ctx-trends'), structure:val('ctx-structure'),
      culture:val('ctx-culture'), tech:val('ctx-tech'), thirds:val('ctx-thirds'),
      extParties:val('ctx-ext-parties'), intParties:val('ctx-int-parties'),
      risks:val('ctx-risks'), incidents:val('ctx-incidents'),
    });

    prompt = `Eres un experto en compliance corporativo. Analiza EXHAUSTIVAMENTE el/los siguiente(s) documento(s) y extrae TODA la informaci√≥n relevante para el contexto organizacional ISO 37301.

CONTEXTO ACTUAL (ya rellenado, COMPLEMENTA sin borrar lo existente):
${existingCtx}

DOCUMENTOS A ANALIZAR:
${combinedText}

INSTRUCCIONES CR√çTICAS:
- Lee el documento completo y busca ACTIVAMENTE informaci√≥n para CADA campo
- Para "incidents": busca CUALQUIER menci√≥n de sanciones, multas, expedientes, inspecciones, denuncias, investigaciones regulatorias, litigios, condenas, amonestaciones, requerimientos de reguladores, noticias negativas, conflictos legales. Si el documento menciona algo as√≠, INCL√öYELO aunque sea impl√≠cito.
- Para "risks": identifica riesgos de compliance mencionados expl√≠cita o impl√≠citamente
- Para "legal": incluye toda normativa, leyes, reguladores mencionados
- Para "thirds": incluye proveedores, clientes, distribuidores, socios
- No dejes campos vac√≠os si hay informaci√≥n relevante en el documento

Responde √öNICAMENTE con un objeto JSON v√°lido con estos campos exactos (strings en espa√±ol):
{
  "name": "nombre legal de la empresa",
  "sector": "sector principal",
  "size": "tama√±o (Microempresa/Peque√±a/Mediana/Grande/Corporaci√≥n)",
  "revenue": "facturaci√≥n aproximada",
  "geo": "√°mbito geogr√°fico",
  "business": "descripci√≥n del modelo de negocio",
  "strategy": "estrategia y objetivos principales",
  "legal": "marco legal y regulatorio aplicable",
  "economic": "contexto econ√≥mico y de mercado",
  "social": "contexto social, cultural y medioambiental",
  "trends": "tendencias futuras con impacto en compliance",
  "structure": "estructura organizativa",
  "culture": "cultura de compliance actual",
  "tech": "recursos tecnol√≥gicos relevantes",
  "thirds": "relaciones con terceros (proveedores, clientes, socios)",
  "ext_parties": "partes interesadas externas y sus expectativas de compliance",
  "int_parties": "partes interesadas internas y sus expectativas de compliance",
  "risks": "riesgos de compliance prioritarios identificados en el documento",
  "incidents": "IMPORTANTE: cualquier sanci√≥n, multa, expediente, inspecci√≥n, investigaci√≥n regulatoria, litigio, requerimiento de autoridades, incidente de compliance, o historial negativo mencionado en el documento",
  "norms": ["array de normas/leyes/regulaciones mencionadas en el documento"]
}

IMPORTANTE: Si el campo ya tiene contenido en el contexto actual, COMPLEMENTA con la nueva informaci√≥n separada por salto de l√≠nea. No uses "" para campos que tengan informaci√≥n en el documento.
Responde SOLO el JSON v√°lido, sin texto adicional, sin bloques markdown.`;

    resultHandler = applyContextoJson;

  } else if(docAnalysisTarget==='madurez'){
    // Sequential per-element analysis ‚Äî calls IA once per element
    closeModal('modal-doc');
    await analyzeMaturitySequential(combinedText, docsToAnalyze);
    return;

  } else if(docAnalysisTarget==='element'){
    // Single element analysis with full ISO criteria
    const elemDef = DIMS.flatMap(d=>d.elements).find(e=>e.id===docAnalysisElementId);
    const existingEv = document.getElementById('ev-'+docAnalysisElementId)?.value||'';
    const criteria = elemDef?.criteria || '';

    prompt = `Eres un auditor experto en compliance ISO 37301. Eval√∫a el nivel de madurez del siguiente elemento.

ELEMENTO A EVALUAR: "${docAnalysisElementLabel}"
CLAUSULA ISO 37301: ${elemDef?.label||docAnalysisElementLabel}

CRITERIOS NORMATIVOS (lo que exige la ISO 37301 para este elemento):
${criteria}

ESCALA DE MADUREZ:
1 = No existe / No hay evidencia en el documento
2 = Inicial / Mencionado pero sin documentar ni formalizar
3 = Definido / Documentado formalmente (procedimiento, pol√≠tica o proceso escrito)
4 = Gestionado / Implementado con seguimiento, m√©tricas o evidencias de funcionamiento
5 = Optimizado / Revisado, mejorado continuamente, con indicadores y ciclo de mejora

INSTRUCCIONES DE EVALUACI√ìN:
- Eval√∫a SOLO contra los criterios normativos indicados arriba
- Busca evidencias concretas en el documento (citas, referencias, procesos descritos)
- Si el documento ES el procedimiento del elemento, punt√∫a seg√∫n su completitud y profundidad
- Si el documento no aporta informaci√≥n sobre este elemento, devuelve score: 0
- S√© riguroso: mencionar algo no equivale a tenerlo implementado (score 3 requiere documentaci√≥n formal)

EVIDENCIA PREVIA (complementa sin repetir):
${existingEv||'Sin evidencia previa'}

DOCUMENTO A ANALIZAR:
${combinedText}

Responde √öNICAMENTE con JSON v√°lido:
{
  "score": <n√∫mero 0-5>,
  "justification": "Justificaci√≥n t√©cnica referenciando los criterios normativos y las evidencias encontradas",
  "evidence": "Cita o descripci√≥n literal de la evidencia encontrada en el documento",
  "gaps": "Qu√© falta para alcanzar el siguiente nivel de madurez seg√∫n la ISO 37301"
}

Responde SOLO el JSON, sin texto adicional.`;

    resultHandler = applyElementJson;
  }

  try{
    const raw = await callMistral(prompt, 4000);

    // Parse JSON safely
    let parsed;
    try{
      const clean = raw.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
      parsed = JSON.parse(clean);
    }catch(e){
      const match = raw.match(/\{[\s\S]*\}/);
      if(match) parsed = JSON.parse(match[0]);
      else throw new Error('La IA no devolvi√≥ JSON v√°lido. Respuesta: '+raw.slice(0,200));
    }

    lastDocResult = parsed;
    resultHandler(parsed, true); // preview mode

  }catch(e){
    document.getElementById('doc-result').innerHTML=`<div class="alert alert-err">Error: ${esc(e.message)}</div>`;
  }
}

// ‚îÄ‚îÄ Sequential maturity analysis: one IA call per element ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function analyzeMaturitySequential(combinedText, docsToAnalyze){
  const allElements = DIMS.flatMap(d => d.elements);
  const totalElements = allElements.length;
  let processed = 0;
  const results = {}; // {elemId: {score, evidence, gaps}}

  // Register documents in bibliography
  const docDate = new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric'});
  const docEntry = {
    id: 'doc-'+Date.now(),
    name: docsToAnalyze.map(d=>d.name).join(' + '),
    date: docDate,
    dateISO: new Date().toISOString(),
    elements: [],
    summary: ''
  };

  // Show progress UI in maturity page
  const progressId = 'mat-seq-progress';
  let progressEl = document.getElementById(progressId);
  if(!progressEl){
    const matAlert = document.getElementById('mat-alert');
    if(matAlert){
      matAlert.innerHTML = `
        <div id="${progressId}" style="background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:12px;margin-bottom:10px">
          <div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">Analizando elemento a elemento con ISO 37301...</div>
          <div style="background:var(--bg);border-radius:3px;height:6px;overflow:hidden">
            <div id="mat-seq-bar" style="height:100%;background:var(--accent);width:0%;transition:width .3s"></div>
          </div>
          <div id="mat-seq-label" style="font-size:9px;color:var(--text-dim);margin-top:6px">Iniciando...</div>
        </div>`;
      progressEl = document.getElementById(progressId);
    }
  }

  function updateProgress(label){
    const pct = Math.round((processed/totalElements)*100);
    const bar = document.getElementById('mat-seq-bar');
    const lbl = document.getElementById('mat-seq-label');
    if(bar) bar.style.width = pct+'%';
    if(lbl) lbl.textContent = `${processed}/${totalElements} ‚Äî ${label}`;
  }

  for(const elem of allElements){
    updateProgress(elem.label.slice(0,50));

    const existingEv = S.maturity?.['ev_'+elem.id] || '';
    const prompt = `Eres un auditor experto en compliance ISO 37301. Eval√∫a el nivel de madurez del siguiente elemento bas√°ndote ESTRICTAMENTE en los criterios normativos.

ELEMENTO: "${elem.label}"

CRITERIOS NORMATIVOS ISO 37301:
${elem.criteria}

ESCALA DE MADUREZ:
1 = No existe / Sin evidencia en el documento
2 = Inicial / Mencionado informalmente, sin documentar
3 = Definido / Documentado formalmente (procedimiento, pol√≠tica escrita)
4 = Gestionado / Implementado con seguimiento, m√©tricas o controles verificables
5 = Optimizado / Con ciclo de mejora continua, indicadores y revisi√≥n peri√≥dica

INSTRUCCIONES:
- Eval√∫a SOLO contra los criterios normativos de arriba
- Score 0 si el documento no aporta ninguna informaci√≥n sobre este elemento
- Score 3 requiere evidencia de documentaci√≥n formal (no solo menci√≥n)
- Score 4 requiere evidencia de implementaci√≥n y seguimiento activo
- Cita evidencias literales del documento cuando existan

DOCUMENTO:
${combinedText.slice(0,8000)}

Responde SOLO con JSON:
{"score":<0-5>,"evidence":"evidencia literal del documento o vac√≠o si no hay","gaps":"qu√© falta para el siguiente nivel seg√∫n ISO 37301"}`;

    try{
      const raw = await callMistral(prompt, 600);
      const clean = raw.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
      let parsed;
      try{ parsed = JSON.parse(clean); }
      catch(e){
        const m = raw.match(/\{[\s\S]*?\}/);
        parsed = m ? JSON.parse(m[0]) : {score:0,evidence:'',gaps:''};
      }

      const score = parseInt(parsed.score)||0;
      results[elem.id] = {score, evidence:parsed.evidence||'', gaps:parsed.gaps||''};

      // Apply immediately to state
      if(!S.maturity) S.maturity={};
      if(score > 0) S.maturity[elem.id] = score;
      if(parsed.evidence){
        const existing = S.maturity['ev_'+elem.id]||'';
        S.maturity['ev_'+elem.id] = parsed.evidence.length > (existing.length*0.8)
          ? parsed.evidence
          : existing ? existing+'\n\n[Doc IA '+docDate+']: '+parsed.evidence : parsed.evidence;
      }
      if(parsed.gaps) S.maturity['gap_'+elem.id] = parsed.gaps;

      if(score > 0) docEntry.elements.push(elem.id);

    }catch(e){
      console.warn('Element analysis error:', elem.id, e.message);
    }

    processed++;
    // Small delay to avoid rate limiting
    await new Promise(r=>setTimeout(r,300));
  }

  // Save bibliography entry
  docEntry.summary = `Analizado ${docEntry.elements.length}/${totalElements} elementos con evidencia`;
  if(!S.docBibliography) S.docBibliography=[];
  S.docBibliography.push(docEntry);
  lsSet('docBibliography', S.docBibliography);
  await fsSet('maturity','current',S.maturity).catch(()=>{});

  // Remove progress UI
  const prog = document.getElementById('mat-seq-progress');
  if(prog) prog.remove();

  // Refresh maturity view
  renderMaturity();
  showAlert('mat-alert', `‚úì An√°lisis completado: ${docEntry.elements.length} elementos con evidencia. Fuente: "${docEntry.name}" (${docDate})`, 'ok');
}

function applyContextoJson(data, preview=false){
  const fieldMap = {
    name:'ctx-name', sector:'ctx-sector', size:'ctx-size', revenue:'ctx-revenue',
    geo:'ctx-geo', business:'ctx-business', strategy:'ctx-strategy', legal:'ctx-legal',
    economic:'ctx-economic', social:'ctx-social', trends:'ctx-trends',
    structure:'ctx-structure', culture:'ctx-culture', tech:'ctx-tech', thirds:'ctx-thirds',
    ext_parties:'ctx-ext-parties', int_parties:'ctx-int-parties',
    risks:'ctx-risks', incidents:'ctx-incidents',
  };

  // Build preview
  const changes = [];
  for(const [key, fieldId] of Object.entries(fieldMap)){
    if(data[key] && data[key].trim()){
      const el = document.getElementById(fieldId);
      const existing = el?.value?.trim()||'';
      const newVal = existing ? existing+'\n\n[Complemento IA]:\n'+data[key] : data[key];
      changes.push({fieldId, label:fieldId.replace('ctx-',''), newVal, isNew:!existing});
    }
  }

  if(preview){
    document.getElementById('doc-result').innerHTML=`
      <div class="alert alert-ok">‚úì An√°lisis completado ‚Äî ${changes.length} campos con informaci√≥n</div>
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:12px;max-height:260px;overflow-y:auto;margin-bottom:10px">
        ${changes.map(c=>`
          <div style="margin-bottom:8px;padding:6px;border-left:2px solid ${c.isNew?'var(--accent)':'var(--warn)'}">
            <div style="font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:${c.isNew?'var(--accent)':'var(--warn)'};margin-bottom:2px">${c.isNew?'NUEVO':'COMPLEMENTA'} ‚Üí ${c.label}</div>
            <div style="font-size:10px;color:var(--text-dim);line-height:1.5">${esc(c.newVal.slice(0,150))}${c.newVal.length>150?'...':''}</div>
          </div>`).join('')}
        ${data.norms?.length?`<div style="margin-bottom:8px;padding:6px;border-left:2px solid var(--accent)"><div style="font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent);margin-bottom:2px">NORMAS DETECTADAS</div><div style="font-size:10px;color:var(--text-dim)">${data.norms.join(', ')}</div></div>`:''}
      </div>
      <div class="flex gap8">
        <button class="btn btn-ghost btn-sm" onclick="closeModal('modal-doc')">Cancelar</button>
        <button class="btn btn-primary btn-sm" onclick="applyContextoJson(lastDocResult,false)">Aplicar al formulario ‚Üí</button>
      </div>`;
    return;
  }

  // Actually apply
  for(const {fieldId, newVal} of changes){
    const el = document.getElementById(fieldId);
    if(el) el.value = newVal;
  }

  // Apply norms
  if(data.norms?.length){
    document.querySelectorAll('.ctx-norm').forEach(cb=>{
      if(data.norms.some(n=>n.toLowerCase().includes(cb.value.toLowerCase())||cb.value.toLowerCase().includes(n.toLowerCase()))){
        cb.checked=true;
      }
    });
  }

  closeModal('modal-doc');
  go('contexto');
  showAlert('ctx-alert',`‚úì ${changes.length} campos actualizados desde el documento ‚Äî revisa y guarda`,'ok');
}

function applyMaturityJson(data, preview=false){
  if(preview){
    const updates = [];
    DIMS.forEach(d=>d.elements.forEach(e=>{
      if(data[e.id] && data[e.id]>0){
        updates.push({id:e.id, label:e.label, score:data[e.id], ev:data['ev_'+e.id]||''});
      }
    }));

    document.getElementById('doc-result').innerHTML=`
      <div class="alert alert-ok">‚úì An√°lisis completado ‚Äî ${updates.length} elementos evaluados</div>
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:12px;max-height:280px;overflow-y:auto;margin-bottom:10px">
        ${updates.map(u=>`
          <div style="margin-bottom:7px;padding:6px;border-left:2px solid var(--accent)">
            <div class="flex ic gap8">
              <span style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted)">${esc(u.label.slice(0,40))}</span>
              <span style="font-family:var(--font-ui);font-weight:800;color:var(--accent);margin-left:auto">${u.score}/5</span>
            </div>
            ${u.ev?`<div style="font-size:9.5px;color:var(--text-dim);margin-top:2px;line-height:1.4">${esc(u.ev.slice(0,120))}${u.ev.length>120?'...':''}</div>`:''}
          </div>`).join('')}
      </div>
      <div class="flex gap8">
        <button class="btn btn-ghost btn-sm" onclick="closeModal('modal-doc')">Cancelar</button>
        <button class="btn btn-primary btn-sm" onclick="applyMaturityJson(lastDocResult,false)">Aplicar puntuaciones ‚Üí</button>
      </div>`;
    return;
  }

  // Actually apply ‚Äî document is source of truth, always update when AI finds evidence
  if(!S.maturity) S.maturity={};
  DIMS.forEach(d=>d.elements.forEach(e=>{
    const newScore = parseInt(data[e.id])||0;
    if(newScore > 0){
      S.maturity[e.id] = newScore;
    }
    if(data['ev_'+e.id]){
      const existing = S.maturity['ev_'+e.id]||'';
      const newEv = data['ev_'+e.id];
      // Replace if new evidence is more informative (longer), else append
      S.maturity['ev_'+e.id] = newEv.length > (existing.length * 0.8)
        ? newEv
        : existing ? existing+'\n\n[Doc IA]: '+newEv : newEv;
    }
  }));

  closeModal('modal-doc');
  go('madurez');
  showAlert('mat-alert','‚úì Puntuaciones actualizadas ‚Äî revisa y guarda la versi√≥n','ok');
}

function applyElementJson(data, preview=false){
  if(preview){
    document.getElementById('doc-result').innerHTML=`
      <div class="alert alert-ok">‚úì An√°lisis completado</div>
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:12px;margin-bottom:10px">
        <div class="flex ic gap8 mb8">
          <span style="font-size:10px;color:var(--text-muted)">Puntuaci√≥n propuesta</span>
          <span style="font-family:var(--font-ui);font-weight:800;font-size:18px;color:var(--accent)">${data.score}/5</span>
          <span style="font-size:10px;color:var(--text-muted)">${SCORE_LABELS[data.score]||''}</span>
        </div>
        <div style="font-size:10.5px;color:var(--text-dim);line-height:1.6">${esc(data.justification||'')}</div>
        ${data.evidence?`<div style="margin-top:8px;padding:6px;background:var(--surface2);border-radius:3px;font-size:9.5px;color:var(--text-muted);line-height:1.5">Evidencia: ${esc(data.evidence.slice(0,200))}</div>`:''}
      </div>
      <div class="flex gap8">
        <button class="btn btn-ghost btn-sm" onclick="closeModal('modal-doc')">Cancelar</button>
        <button class="btn btn-primary btn-sm" onclick="applyElementJson(lastDocResult,false)">Aplicar ‚Üí</button>
      </div>`;
    return;
  }

  // Apply score
  if(data.score && docAnalysisElementId){
    setScore(docAnalysisElementId, data.score, '');
    const ev = document.getElementById('ev-'+docAnalysisElementId);
    if(ev && data.evidence){
      ev.value = ev.value ? ev.value+'\n\n[Doc IA]: '+data.evidence : data.evidence;
    }
  }

  closeModal('modal-doc');
  showAlert('mat-alert','‚úì Elemento actualizado ‚Äî guarda la versi√≥n cuando termines','ok');
}

async function readFileAsText(file){
  const name = file.name.toLowerCase();

  // DOCX ‚Üí mammoth extrae texto limpio
  if(name.endsWith('.docx') || name.endsWith('.doc')){
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const arrayBuffer = e.target.result;
          const result = await mammoth.extractRawText({ arrayBuffer });
          if(!result.value || result.value.trim().length < 10){
            rej(new Error('El documento parece estar vac√≠o o no se pudo extraer texto.'));
          } else {
            res(result.value);
          }
        } catch(err) {
          rej(new Error('Error leyendo DOCX: ' + err.message));
        }
      };
      reader.onerror = rej;
      reader.readAsArrayBuffer(file);
    });
  }

  // TXT / CSV / XML ‚Üí texto plano directo
  if(name.endsWith('.txt') || name.endsWith('.csv') || name.endsWith('.xml')){
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = e => res(e.target.result);
      reader.onerror = rej;
      reader.readAsText(file, 'UTF-8');
    });
  }

  // PDF ‚Üí intentar leer como texto (solo funciona en PDFs no escaneados)
  if(name.endsWith('.pdf')){
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = e => {
        // Extraer texto legible del PDF binario (heur√≠stica b√°sica)
        const raw = new Uint8Array(e.target.result);
        let text = '';
        for(let i = 0; i < raw.length - 1; i++){
          const c = raw[i];
          if(c >= 32 && c < 127) text += String.fromCharCode(c);
          else if(c === 10 || c === 13) text += '\n';
        }
        // Limpiar secuencias no legibles
        text = text.replace(/[^\x20-\x7E\n\r\t\u00C0-\u024F]/g, ' ')
                   .replace(/\s{3,}/g, '\n')
                   .replace(/(.)\1{4,}/g, '$1') // quitar repeticiones
                   .trim();
        if(text.length < 50){
          res('[PDF escaneado o protegido ‚Äî por favor pega el texto manualmente en el campo de texto]');
        } else {
          res(text.slice(0, 12000));
        }
      };
      reader.onerror = rej;
      reader.readAsArrayBuffer(file);
    });
  }

  // Fallback gen√©rico
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = e => res(e.target.result);
    reader.onerror = rej;
    reader.readAsText(file, 'UTF-8');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BRIEF EJECUTIVO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBriefPlaceholder(){
  if(!document.getElementById('brief-content').innerHTML){
    document.getElementById('brief-content').innerHTML=`<div class="empty"><div class="empty-icon">‚ñ§</div><div class="empty-title">Sin brief generado</div><div class="empty-sub">Haz clic en "Generar con IA" para crear el informe ejecutivo</div></div>`;
  }
}

</script>


<!-- MODAL CONTROL -->
<div class="overlay" id="modal-ctrl">
  <div class="modal modal-lg">
    <div class="modal-title" id="ctrl-modal-title">Control de Compliance</div>
    <button class="modal-x" onclick="closeModal('modal-ctrl')">‚úï</button>
    <div class="g2">
      <div>
        <div class="fg"><label class="fl">ID *</label><input type="text" class="fi" id="ctrl-id" placeholder="C-001"></div>
        <div class="fg"><label class="fl">T√≠tulo *</label><input type="text" class="fi" id="ctrl-title" placeholder="Revisi√≥n contratos proveedores..."></div>
        <div class="fg"><label class="fl">Descripci√≥n</label><textarea class="fi" id="ctrl-desc" rows="3" placeholder="Descripci√≥n detallada del control..."></textarea></div>
        <div class="g2">
          <div class="fg"><label class="fl">Responsable *</label><input type="text" class="fi" id="ctrl-owner" placeholder="CCO / Dpto. Legal"></div>
          <div class="fg"><label class="fl">Estado</label>
            <select class="fi" id="ctrl-status"><option>Activo</option><option>Inactivo</option><option>En revisi√≥n</option></select>
          </div>
        </div>
        <div class="fg"><label class="fl">Riesgo asociado *</label><input type="text" class="fi" id="ctrl-risk" placeholder="Riesgo de terceros / Due diligence..."></div>
        <div class="fg"><label class="fl">Evidencia requerida</label><textarea class="fi" id="ctrl-evidence" rows="2" placeholder="Qu√© documentos o registros prueban la ejecuci√≥n..."></textarea></div>
        <div class="fg"><label class="fl">Comentarios</label><textarea class="fi" id="ctrl-comments" rows="2" placeholder="Notas adicionales..."></textarea></div>
      </div>
      <div>
        <div class="g2">
          <div class="fg"><label class="fl">Frecuencia *</label>
            <select class="fi" id="ctrl-freq">
              <option>diario</option><option>semanal</option><option>mensual</option>
              <option>trimestral</option><option>semestral</option><option>anual</option><option>ad-hoc</option>
            </select>
          </div>
          <div class="fg"><label class="fl">Naturaleza *</label>
            <select class="fi" id="ctrl-nature"><option>Preventivo</option><option>Detectivo</option></select>
          </div>
        </div>
        <div class="fg"><label class="fl">Tipo *</label>
          <select class="fi" id="ctrl-type"><option>Manual</option><option>Autom√°tico</option></select>
        </div>
        <div class="fg"><label class="fl">Elementos ISO 37301 vinculados</label>
          <div id="ctrl-iso-checks" style="display:flex;flex-direction:column;gap:4px;max-height:180px;overflow-y:auto;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:8px"></div>
          <div class="fhint">Selecci√≥n m√∫ltiple ‚Äî vinculado autom√°ticamente por IA al guardar</div>
        </div>
        <div class="divider"></div>
        <div class="fg">
          <label class="fl">Ejecutado</label>
          <div class="flex ic gap12">
            <label class="flex ic gap6" style="cursor:pointer;font-size:11px"><input type="radio" name="ctrl-exec" value="S√≠" id="ctrl-exec-yes"> S√≠</label>
            <label class="flex ic gap6" style="cursor:pointer;font-size:11px"><input type="radio" name="ctrl-exec" value="No" id="ctrl-exec-no" checked> No</label>
          </div>
        </div>
        <div class="fg"><label class="fl">Fecha √∫ltima ejecuci√≥n</label><input type="date" class="fi" id="ctrl-exec-date"></div>
        <div class="divider"></div>
        <div id="ctrl-exec-history-wrap">
          <div class="fl mb8">Historial de ejecuciones</div>
          <div id="ctrl-exec-history"></div>
          <div class="flex gap6 mt6">
            <input type="date" class="fi" id="new-exec-date" style="flex:1">
            <input type="text" class="fi" id="new-exec-by" placeholder="Ejecutado por" style="flex:1">
            <select class="fi" id="new-exec-result" style="width:100px"><option>OK</option><option>Con observaciones</option><option>Fallido</option></select>
            <button class="btn btn-ghost btn-xs" onclick="addExecRecord()">+</button>
          </div>
        </div>
      </div>
    </div>
    <div class="flex gap8 mt14" style="justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('modal-ctrl')">Cancelar</button>
      <button class="btn btn-danger btn-xs" id="ctrl-delete-btn" style="display:none" onclick="deleteControl()">Eliminar</button>
      <button class="btn btn-purple btn-sm" onclick="suggestIsoLinks()">‚ú¶ Sugerir v√≠nculos ISO</button>
      <button class="btn btn-primary" onclick="saveControl()">Guardar control</button>
    </div>
    <div id="ctrl-modal-alert" style="margin-top:8px"></div>
  </div>
</div>

<!-- MODAL SENTENCIA -->
<div class="overlay" id="modal-sent">
  <div class="modal modal-lg">
    <div class="modal-title" id="sent-modal-title">Nueva Sentencia / Jurisprudencia</div>
    <button class="modal-x" onclick="closeModal('modal-sent')">‚úï</button>
    <div class="g2">
      <div>
        <div class="fg"><label class="fl">Referencia ECLI / N√∫mero</label><input type="text" class="fi" id="sent-ref" placeholder="ECLI:ES:TS:2024:1234"></div>
        <div class="fg"><label class="fl">Tribunal</label><input type="text" class="fi" id="sent-court" placeholder="Tribunal Supremo ‚Äî Sala de lo Penal"></div>
        <div class="g2">
          <div class="fg"><label class="fl">Fecha</label><input type="date" class="fi" id="sent-date"></div>
          <div class="fg"><label class="fl">Sala / Materia</label>
            <select class="fi" id="sent-sala">
              <option>Civil</option><option>Penal</option><option>Contencioso-Administrativo</option>
              <option>Social</option><option>Mercantil</option><option>Otro</option>
            </select>
          </div>
        </div>
        <div class="fg"><label class="fl">Partes (demandante vs. demandado)</label><input type="text" class="fi" id="sent-parties" placeholder="Ministerio Fiscal vs. Empresa X"></div>
        <div class="fg"><label class="fl">Texto / Resumen de la sentencia *</label>
          <textarea class="fi" id="sent-text" rows="10" placeholder="Pega aqu√≠ el texto de la sentencia o su resumen. La IA lo analizar√° para extraer implicaciones de compliance..."></textarea>
        </div>
      </div>
      <div>
        <div class="fg"><label class="fl">An√°lisis IA</label></div>
        <div id="sent-analysis-box" style="background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:12px;min-height:200px;font-size:10.5px;color:var(--text-muted);line-height:1.7">
          Haz clic en "Analizar con IA" para obtener el an√°lisis de compliance.
        </div>
        <button class="btn btn-purple btn-sm mt10" style="width:100%" onclick="analyzeSentencia()" id="sent-analyze-btn">‚ú¶ Analizar con IA</button>
        <div id="sent-analysis-fields" style="display:none;margin-top:12px">
          <div class="fg"><label class="fl">Nivel de impacto (IA)</label>
            <select class="fi" id="sent-impact"><option value="critical">Alto ‚Äî Cr√≠tico</option><option value="warning">Medio ‚Äî Alerta</option><option value="info">Bajo ‚Äî Informativo</option></select>
          </div>
          <div class="fg"><label class="fl">Resumen ejecutivo (editable)</label>
            <textarea class="fi" id="sent-summary" rows="3"></textarea>
          </div>
          <div class="fg"><label class="fl">Implicaciones para empresas espa√±olas</label>
            <textarea class="fi" id="sent-implications" rows="3"></textarea>
          </div>
          <div class="fg"><label class="fl">Propuesta de control sugerida</label>
            <textarea class="fi" id="sent-ctrl-proposal" rows="2" placeholder="Control propuesto para mitigar el riesgo identificado..."></textarea>
          </div>
        </div>
      </div>
    </div>
    <div id="sent-alert"></div>
    <div class="flex gap8 mt14" style="justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('modal-sent')">Cancelar</button>
      <button class="btn btn-primary" id="sent-publish-btn" onclick="publishSentencia()" style="display:none">Publicar al feed ‚Üí</button>
    </div>
  </div>
</div>

<!-- MODAL IMPORT CONTROLES -->
<div class="overlay" id="modal-import">
  <div class="modal" style="max-width:900px;width:95vw">
    <div class="modal-title">Importar Controles ‚Äî Revisi√≥n previa</div>
    <button class="modal-x" onclick="closeModal('modal-import')">‚úï</button>
    
    <div id="import-step1">
      <!-- Column mapping -->
      <div class="card mb10" style="padding:10px 14px" id="import-col-map-wrap">
        <div class="fl mb8">Mapeo de columnas detectado <span style="color:var(--text-muted);font-size:9px">‚Äî ajusta si es necesario</span></div>
        <div id="import-col-map" class="g2" style="font-size:10px"></div>
      </div>

      <!-- Stats -->
      <div class="flex ic gap14 mb10" style="font-size:10.5px">
        <span id="import-stat-total" style="color:var(--text-dim)"></span>
        <span id="import-stat-new" style="color:var(--accent)"></span>
        <span id="import-stat-dup" style="color:var(--warn)"></span>
        <span id="import-stat-error" style="color:var(--danger)"></span>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn btn-ghost btn-xs" onclick="importSelectAll(true)">‚úì Seleccionar todos los nuevos</button>
          <button class="btn btn-ghost btn-xs" onclick="importSelectAll(false)">‚úó Deseleccionar todos</button>
        </div>
      </div>

      <!-- Preview table -->
      <div style="overflow-x:auto;max-height:420px;border:1px solid var(--border);border-radius:5px">
        <table class="ctrl-table" id="import-preview-table">
          <thead>
            <tr>
              <th style="width:32px"><input type="checkbox" id="import-check-all" onchange="importToggleAll(this.checked)"></th>
              <th>Estado</th><th>ID</th><th>T√≠tulo</th><th>Responsable</th>
              <th>Naturaleza</th><th>Frecuencia</th><th>Riesgo</th><th>Duplicado de</th>
            </tr>
          </thead>
          <tbody id="import-preview-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="import-alert" style="margin-top:10px"></div>
    <div class="flex gap8 mt14" style="justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('modal-import')">Cancelar</button>
      <button class="btn btn-primary" onclick="confirmImport()" id="import-confirm-btn">Importar seleccionados ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Deepdive Drawer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="drawer-overlay" id="dd-overlay" onclick="closeDrawer()"></div>
<div class="drawer" id="dd-drawer">
  <div class="drawer-head">
    <div style="flex:1">
      <div id="dd-hit-title" style="font-size:13px;font-weight:700;color:var(--text);line-height:1.4;margin-bottom:6px"></div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span id="dd-inh-pill" class="tag"></span>
        <span style="color:var(--text-muted);font-size:10px">‚Üí</span>
        <span id="dd-res-pill" class="tag"></span>
        <span id="dd-date-meta" class="dd-meta"></span>
      </div>
    </div>
    <button class="drawer-close" onclick="closeDrawer()">‚úï</button>
  </div>
  <div class="drawer-body" id="dd-body">
    <div class="empty" style="padding:40px 0">
      <div class="empty-icon">‚ú¶</div>
      <div class="empty-title">Cargando an√°lisis...</div>
    </div>
  </div>
  <div class="drawer-foot">
    <button class="btn btn-ghost btn-sm" id="dd-export-btn" onclick="exportDeepDiveWord()" style="display:none">‚¨á Exportar Word</button>
    <span id="dd-analyzed-at" style="font-size:9px;color:var(--text-muted);margin-left:auto"></span>
  </div>
</div>
</body></html>`);
  w.document.close(); w.print();
}

<script>

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIAL MADUREZ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openHistory(){
  const history=await fsList('maturity_history','_created','desc');
  document.getElementById('history-list').innerHTML=history.length?
    history.map(h=>`
      <div class="hist-item">
        <span class="hist-date">${fmtDate(h._created)}</span>
        <span class="hist-score">${h.globalScore?.toFixed(1)||'‚Äî'}/5</span>
        <span class="hist-note">${h.note||''}</span>
      </div>`).join(''):
    '<div class="empty"><div class="empty-sub">Sin historial a√∫n</div></div>';
  openModal('modal-history');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FUENTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFuentes(){
  const rc=S.remoteCfg;
  const ql=document.getElementById('queries-list');
  ql.innerHTML=(rc.newsapi_queries||[]).map((q,i)=>`
    <div class="flex ic gap8 mb6" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:7px 10px">
      <span style="color:var(--accent);font-size:10px;flex-shrink:0">${i+1}</span>
      <span style="font-size:10px;flex:1;color:var(--text-dim)">${esc(q)}</span>
      <button style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px" onclick="removeQuery(${i})">√ó</button>
    </div>`).join('');

  const rss=document.getElementById('rss-list');
  rss.innerHTML=Object.entries(RSS_LABELS).map(([k,label])=>{
    const on=(rc.rss_enabled||{})[k]!==false;
    return `<div class="flex ic gap8" style="padding:7px 0;border-bottom:1px solid var(--border)">
      <button class="rss-btn ${on?'on':''}" id="rss-${k}" onclick="toggleRss('${k}')" style="width:32px;height:18px;background:${on?'var(--accent)':'var(--border2)'};border:none;border-radius:9px;cursor:pointer;position:relative;transition:background .2s">
        <span style="position:absolute;top:2px;left:${on?'16':'2'}px;width:14px;height:14px;background:#fff;border-radius:50%;transition:left .2s;display:block"></span>
      </button>
      <span style="font-size:11px;color:${on?'var(--text)':'var(--text-dim)'}">${label}</span>
    </div>`;
  }).join('');

  const kw=document.getElementById('kw-list');
  kw.innerHTML=(rc.custom_keywords||[]).map((k,i)=>`
    <span style="display:inline-flex;align-items:center;gap:4px;font-size:10px;padding:3px 8px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim)">${esc(k)}<button style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px" onclick="removeKw(${i})">√ó</button></span>`).join('');
}

function addQuery(){
  const v=document.getElementById('new-query').value.trim();
  if(!v)return;
  S.remoteCfg.newsapi_queries=[...(S.remoteCfg.newsapi_queries||[]),v];
  document.getElementById('new-query').value='';
  renderFuentes();
}
function removeQuery(i){ S.remoteCfg.newsapi_queries.splice(i,1); renderFuentes(); }
function toggleRss(k){ S.remoteCfg.rss_enabled=S.remoteCfg.rss_enabled||{}; S.remoteCfg.rss_enabled[k]=!S.remoteCfg.rss_enabled[k]; renderFuentes(); }
function addKw(){ const v=document.getElementById('new-kw').value.trim(); if(!v)return; S.remoteCfg.custom_keywords=[...(S.remoteCfg.custom_keywords||[]),v]; document.getElementById('new-kw').value=''; renderFuentes(); }
function removeKw(i){ S.remoteCfg.custom_keywords.splice(i,1); renderFuentes(); }
async function saveFuentes(){
  await fsSet('config','main',S.remoteCfg);
  showAlert('fuentes-alert','‚úì Configuraci√≥n guardada en Firestore','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AN√ÅLISIS MANUAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runManual(){
  const key=S.cfg.mistralKey;
  if(!key){showAlert('','','');go('config');return;}
  const text=document.getElementById('an-text').value.trim();
  if(!text){alert('Introduce texto para analizar');return;}
  const type=document.getElementById('an-type').value;
  const btn=document.getElementById('an-btn');
  document.getElementById('an-result').innerHTML='<div class="flex ic gap8" style="color:var(--text-muted);padding:16px 0"><span class="spin"></span> Analizando contra Digital Twin...</div>';
  btn.disabled=true;

  const twinCtx=S.twinSummary?`CONTEXTO DE LA ORGANIZACI√ìN (Digital Twin):\n${S.twinSummary}\n\n`:'';
  const typeInstructions={
    full:'Realiza un an√°lisis completo: relevancia para la organizaci√≥n, riesgos identificados, normas afectadas, control de madurez m√°s expuesto, impacto financiero estimado y acci√≥n recomendada.',
    vulnerability:'Analiza la vulnerabilidad espec√≠fica: ¬øtiene la organizaci√≥n controles para este riesgo seg√∫n su modelo de compliance? ¬øQu√© gap existe?',
    financial:'Estima el impacto financiero: multas potenciales seg√∫n normativa espa√±ola, da√±o reputacional y coste de remediaci√≥n.',
    action:'Genera un plan de acci√≥n concreto con pasos espec√≠ficos, responsables y plazos recomendados.',
  };

  const prompt=`${twinCtx}${typeInstructions[type]||typeInstructions.full}\n\nEVENTO A ANALIZAR:\n${text}`;
  try{
    const result=await callMistral(prompt,1200);
    document.getElementById('an-result').innerHTML=`<div style="font-size:11px;line-height:1.8;white-space:pre-wrap;color:var(--text-dim)">${esc(result)}</div>`;
  }catch(e){
    document.getElementById('an-result').innerHTML=`<div class="alert alert-err">Error: ${esc(e.message)}</div>`;
  }
  btn.disabled=false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadConfig(){
  document.getElementById('cfg-mistral-key').value=S.cfg.mistralKey||'';
  document.getElementById('cfg-mistral-model').value=S.cfg.mistralModel||'mistral-small-latest';
  document.getElementById('cfg-newsapi-key').value=S.cfg.newsapiKey||'';
  document.getElementById('cfg-threshold').value=S.cfg.threshold||60;
  document.getElementById('cfg-repo').value=S.cfg.repo||'avespa/digitaltwin';
  document.getElementById('cfg-twin-days').value=S.cfg.twinDays||90;
  // Pinecone key is server-side (Vercel env var PINECONE_API_KEY)
  if(document.getElementById('cfg-pinecone-host')) document.getElementById('cfg-pinecone-host').value=S.cfg.pineconeHost||'https://digitaltwin-xm7jklu.svc.aped-4627-b74a.pinecone.io';
  if(document.getElementById('cfg-pinecone-index')) document.getElementById('cfg-pinecone-index').value=S.cfg.pineconeIndex||'digitaltwin';
  if(document.getElementById('cfg-impact-threshold')) document.getElementById('cfg-impact-threshold').value=S.cfg.impactThreshold||50;
}

async function saveConfig(){
  S.cfg={
    mistralKey: document.getElementById('cfg-mistral-key').value.trim(),
    mistralModel: document.getElementById('cfg-mistral-model').value,
    newsapiKey: document.getElementById('cfg-newsapi-key').value.trim(),
    threshold: parseInt(document.getElementById('cfg-threshold').value)||60,
    impactThreshold: parseInt(document.getElementById('cfg-impact-threshold')?.value)||50,
    repo: document.getElementById('cfg-repo').value.trim(),
    twinDays: parseInt(document.getElementById('cfg-twin-days').value)||90,
    pineconeKey: 'server-side',
    pineconeHost: document.getElementById('cfg-pinecone-host')?.value?.trim()||'https://digitaltwin-xm7jklu.svc.aped-4627-b74a.pinecone.io',
    pineconeIndex: document.getElementById('cfg-pinecone-index')?.value?.trim()||'digitaltwin',
  };
  lsSet('cfg', S.cfg);
  // Also persist to Firestore so keys survive across devices/sessions
  await fsSet('config', 'main', S.cfg).catch(()=>{});
  showAlert('config-alert','‚úì Configuraci√≥n guardada y sincronizada entre dispositivos','ok');
}

async function testMistral(){
  const key=document.getElementById('cfg-mistral-key').value.trim();
  if(!key){showAlert('config-alert','Introduce la API key primero','err');return;}
  try{
    const r=await fetch('https://api.mistral.ai/v1/models',{headers:{'Authorization':'Bearer '+key}});
    showAlert('config-alert',r.ok?'‚úì Mistral conectado correctamente':'‚úó API Key inv√°lida',r.ok?'ok':'err');
  }catch(e){ showAlert('config-alert','Error de conexi√≥n','err'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MISTRAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function callMistral(prompt, maxTokens=800){
  const key=S.cfg.mistralKey;
  if(!key) throw new Error('API key de Mistral no configurada');
  const r=await fetch('https://api.mistral.ai/v1/chat/completions',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
    body:JSON.stringify({
      model:S.cfg.mistralModel||'mistral-small-latest',
      messages:[{role:'user',content:prompt}],
      temperature:0.2, max_tokens:maxTokens,
    })
  });
  if(!r.ok){ const err=await r.json(); throw new Error(err.message||'Error Mistral'); }
  const data=await r.json();
  return data.choices[0].message.content;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function val(id){ const el=document.getElementById(id); return el?el.value.trim():''; }
function esc(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtDate(iso){ if(!iso)return'‚Äî'; const d=new Date(iso); return d.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'2-digit'}); }
function fmtTime(iso){ if(!iso)return'‚Äî'; const d=new Date(iso); return d.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'})+' '+d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}); }
function levelLabel(l){ return {critical:'ALTO',warning:'MEDIO',info:'BAJO',irrelevant:'NO APLICA',alto:'ALTO',medio:'MEDIO',bajo:'BAJO'}[l]||l||'?'; }
function levelColor(l){ return {critical:'var(--danger)',warning:'var(--warn)',info:'var(--accent2)',irrelevant:'var(--text-muted)',alto:'var(--danger)',medio:'var(--warn)',bajo:'var(--accent2)'}[l]||'var(--text-dim)'; }
function setStatus(t){ document.getElementById('foot-status').textContent=t; }
function showAlert(containerId, msg, type){
  const cls={ok:'alert-ok',err:'alert-err',warn:'alert-warn',info:'alert-info'}[type]||'alert-info';
  const html=`<div class="alert ${cls}">${msg}</div>`;
  if(containerId){ const el=document.getElementById(containerId); if(el){ el.innerHTML=html; setTimeout(()=>el.innerHTML='',5000); } }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
restoreLocal();
renderAll();
drawRadar('radar-dash', getDimScores());
renderRadarLegend('radar-legend-dash', true);
syncAll();
setInterval(syncAll, 15*60*1000); // auto-sync cada 15 min

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTROLES DE COMPLIANCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentCtrlId = null;
let ctrlExecHistory = [];

// Levenshtein distance for fuzzy duplicate detection
function levenshtein(a, b){
  const m=a.length,n=b.length,dp=Array.from({length:m+1},(_,i)=>Array.from({length:n+1},(_,j)=>i?j?0:i:j));
  for(let i=1;i<=m;i++)for(let j=1;j<=n;j++)dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]:1+Math.min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1]);
  return dp[m][n];
}
function normalizeTitle(s){ var acc={"√°":"a","√†":"a","√§":"a","√©":"e","√®":"e","√´":"e","√≠":"i","√¨":"i","√Ø":"i","√≥":"o","√≤":"o","√∂":"o","√∫":"u","√π":"u","√º":"u","√±":"n"}; var r=(s||"").toLowerCase().split("").map(function(c){return acc[c]||c;}).join("").replace(/[^a-z0-9 ]/g,""); var stop=["el","la","los","las","de","del","en","y","a","con","por","para","un","una"]; stop.forEach(function(w){r=r.replace(new RegExp(" "+w+" ","g")," ");}); return r.replace(/\s+/g," ").trim(); }
function similarityPct(a,b){ const na=normalizeTitle(a),nb=normalizeTitle(b),maxL=Math.max(na.length,nb.length,1); return Math.round((1-levenshtein(na,nb)/maxL)*100); }

function openCtrlModal(id){
  currentCtrlId = id;
  ctrlExecHistory = [];
  const c = id ? S.controls.find(x=>x.id===id) : null;
  document.getElementById('ctrl-modal-title').textContent = c ? 'Editar Control' : 'Nuevo Control';
  document.getElementById('ctrl-delete-btn').style.display = c ? '' : 'none';

  // Auto-generate ID
  if(!c){
    const maxN = S.controls.reduce((m,x)=>{ const n=parseInt((x.id||'').replace(/\D/g,'')||0); return n>m?n:m; },0);
    document.getElementById('ctrl-id').value = 'C-'+String(maxN+1).padStart(3,'0');
  } else {
    document.getElementById('ctrl-id').value = c.id||'';
  }

  const fields = ['title','desc','owner','risk','evidence','comments','freq','nature','type','status','exec-date'];
  fields.forEach(f=>{ const el=document.getElementById('ctrl-'+f); if(el) el.value=c?.[f.replace('-','_')]||c?.[f]||''; });
  document.getElementById('ctrl-freq').value = c?.freq||'mensual';
  document.getElementById('ctrl-nature').value = c?.nature||'Preventivo';
  document.getElementById('ctrl-type').value = c?.type||'Manual';
  document.getElementById('ctrl-status').value = c?.status||'Activo';

  // Executed radio
  const execVal = c?.executed||'No';
  document.getElementById('ctrl-exec-yes').checked = execVal==='S√≠';
  document.getElementById('ctrl-exec-no').checked  = execVal!=='S√≠';
  document.getElementById('ctrl-exec-date').value = c?.exec_date||'';

  // ISO checkboxes
  const isoBox = document.getElementById('ctrl-iso-checks');
  const linked = c?.iso_elements||[];
  isoBox.innerHTML = DIMS.map(d=>d.elements.map(e=>`
    <label class="flex ic gap6" style="font-size:10px;cursor:pointer;padding:2px 0">
      <input type="checkbox" class="ctrl-iso-cb" value="${e.id}" ${linked.includes(e.id)?'checked':''}> 
      <span style="color:var(--text-muted)">[${d.label.slice(0,3)}]</span> ${e.label.slice(0,55)}
    </label>`).join('')).join('');

  // Exec history
  ctrlExecHistory = c?.exec_history||[];
  renderExecHistory();

  openModal('modal-ctrl');
}

function renderExecHistory(){
  const el = document.getElementById('ctrl-exec-history');
  el.innerHTML = ctrlExecHistory.length ? ctrlExecHistory.map((e,i)=>`
    <div class="exec-row">
      <span class="exec-dot" style="background:${e.result==='OK'?'var(--accent)':e.result==='Fallido'?'var(--danger)':'var(--warn)'}"></span>
      <span style="color:var(--text-dim)">${e.date||''}</span>
      <span style="flex:1;color:var(--text-muted)">${esc(e.by||'')}</span>
      <span class="tag" style="background:rgba(0,0,0,.2);color:var(--text-dim)">${e.result||'OK'}</span>
      <button style="background:none;border:none;color:var(--text-muted);cursor:pointer" onclick="removeExecRecord(${i})">√ó</button>
    </div>`).join('') :
    '<div style="font-size:10px;color:var(--text-muted);padding:6px 0">Sin ejecuciones registradas</div>';
}

function addExecRecord(){
  const date=document.getElementById('new-exec-date').value;
  const by=document.getElementById('new-exec-by').value.trim();
  const result=document.getElementById('new-exec-result').value;
  if(!date){alert('Indica la fecha de ejecuci√≥n');return;}
  ctrlExecHistory.unshift({date,by,result,_created:new Date().toISOString()});
  document.getElementById('new-exec-date').value='';
  document.getElementById('new-exec-by').value='';
  renderExecHistory();
}
function removeExecRecord(i){ ctrlExecHistory.splice(i,1); renderExecHistory(); }

async function suggestIsoLinks(){
  const key=S.cfg.mistralKey;
  if(!key){showAlert('ctrl-modal-alert','Configura la API key de Mistral','err');return;}
  const title=document.getElementById('ctrl-title').value;
  const desc=document.getElementById('ctrl-desc').value;
  const risk=document.getElementById('ctrl-risk').value;
  if(!title){showAlert('ctrl-modal-alert','Introduce el t√≠tulo primero','err');return;}

  showAlert('ctrl-modal-alert','Analizando v√≠nculos ISO...','info');
  const dimsDesc = DIMS.map(d=>d.elements.map(e=>`${e.id}: ${e.label}`).join('\n')).join('\n');
  const prompt = `Dado este control de compliance:
T√≠tulo: ${title}
Descripci√≥n: ${desc}
Riesgo: ${risk}

¬øA qu√© elementos del framework ISO 37301 corresponde? Responde SOLO con un JSON array de IDs:
${dimsDesc}

Ejemplo de respuesta: ["op1","op4","ev1"]
Responde SOLO el array JSON, sin texto adicional.`;

  try{
    const raw = await callMistral(prompt, 200);
    const clean = raw.replace(/```json|```/g,'').trim();
    const ids = JSON.parse(clean.match(/\[.*\]/s)?.[0]||'[]');
    document.querySelectorAll('.ctrl-iso-cb').forEach(cb=>{
      if(ids.includes(cb.value)) cb.checked=true;
    });
    showAlert('ctrl-modal-alert',`‚úì ${ids.length} v√≠nculos sugeridos ‚Äî revisa y confirma`,'ok');
  }catch(e){ showAlert('ctrl-modal-alert','Error: '+e.message,'err'); }
}

async function saveControl(){
  const id=val('ctrl-id'), title=val('ctrl-title');
  if(!id||!title){showAlert('ctrl-modal-alert','ID y t√≠tulo son obligatorios','err');return;}

  // Duplicate check
  const existing = S.controls.filter(c=>c.id!==currentCtrlId);
  const dupById = existing.find(c=>c.id===id);
  if(dupById){showAlert('ctrl-modal-alert','Ya existe un control con ese ID','err');return;}
  const dupTitle = existing.find(c=>similarityPct(c.title,title)>=80);
  if(dupTitle && !currentCtrlId){
    if(!confirm(`Posible duplicado detectado (${similarityPct(dupTitle.title,title)}% similar): "${dupTitle.title}"\n\n¬øContinuar guardando de todas formas?`)) return;
  }

  const iso_elements = [...document.querySelectorAll('.ctrl-iso-cb:checked')].map(cb=>cb.value);
  const ctrl = {
    id, title,
    desc: val('ctrl-desc'), owner: val('ctrl-owner'), risk: val('ctrl-risk'),
    evidence: val('ctrl-evidence'), comments: val('ctrl-comments'),
    freq: val('ctrl-freq'), nature: val('ctrl-nature'), type: val('ctrl-type'),
    status: val('ctrl-status'),
    executed: document.getElementById('ctrl-exec-yes').checked?'S√≠':'No',
    exec_date: val('ctrl-exec-date'),
    iso_elements,
    exec_history: ctrlExecHistory,
    _updated: new Date().toISOString(),
  };

  if(currentCtrlId){
    const i=S.controls.findIndex(c=>c.id===currentCtrlId);
    if(i>=0) S.controls[i]={...S.controls[i],...ctrl};
    await fsUpdate('controls',currentCtrlId,ctrl);
  } else {
    const docId = await fsAdd('controls',ctrl);
    if(docId) S.controls.push({...ctrl,_fsId:docId});
    // Auto-vectorize
    if(pcKey()){
      const ctrlText = ['Control: '+ctrl.title, ctrl.desc?'Descripci√≥n: '+ctrl.desc:'', ctrl.risk?'Riesgo: '+ctrl.risk:'', ctrl.nature?'Naturaleza: '+ctrl.nature:'', ctrl.freq?'Frecuencia: '+ctrl.freq:''].filter(Boolean).join('\n');
      vectorizeAndStore(ctrlText, {id:'ctrl-'+ctrl.id, type:'control', ctrl_id:ctrl.id, title:ctrl.title, nature:ctrl.nature||'', freq:ctrl.freq||'', executed:ctrl.executed||'No', status:ctrl.status||'Activo', iso_elements:(ctrl.iso_elements||[]).join(',')});
    }
  }
  lsSet('controls',S.controls);
  closeModal('modal-ctrl');
  renderControls();
  renderCtrlStats();
}

async function deleteControl(){
  if(!currentCtrlId||!confirm('¬øEliminar este control?'))return;
  const i=S.controls.findIndex(c=>c.id===currentCtrlId);
  if(i>=0){
    if(S.controls[i]._fsId) await fsDelete('controls',S.controls[i]._fsId);
    S.controls.splice(i,1);
  }
  lsSet('controls',S.controls);
  closeModal('modal-ctrl');
  renderControls();
  renderCtrlStats();
}

async function saveControls(){
  // Batch save all controls to Firestore
  showAlert('ctrl-alert','Guardando en Firestore...','info');
  let ok=true;
  for(const c of S.controls){
    if(!c._fsId){ const id=await fsAdd('controls',c); if(id) c._fsId=id; }
    else await fsUpdate('controls',c._fsId,c);
  }
  lsSet('controls',S.controls);
  showAlert('ctrl-alert',ok?`‚úì ${S.controls.length} controles guardados`:'Error parcial','ok');
}

let ctrlSelectedIds = new Set();
let ctrlFilteredList = [];

function renderControls(){
  const search=(document.getElementById('ctrl-search')?.value||'').toLowerCase();
  const nat=document.getElementById('ctrl-filter-nat')?.value||'';
  const exec=document.getElementById('ctrl-filter-exec')?.value||'';
  const freq=document.getElementById('ctrl-filter-freq')?.value||'';

  ctrlFilteredList=S.controls.filter(c=>{
    if(nat && c.nature!==nat) return false;
    if(exec && c.executed!==exec) return false;
    if(freq && c.freq!==freq) return false;
    if(search && !((c.title||'').toLowerCase().includes(search)||(c.risk||'').toLowerCase().includes(search)||(c.owner||'').toLowerCase().includes(search))) return false;
    return true;
  });

  document.getElementById('ctrl-count').textContent = `${ctrlFilteredList.length} de ${S.controls.length} controles`;
  const tbody=document.getElementById('ctrl-tbody');
  if(!tbody) return;

  tbody.innerHTML = ctrlFilteredList.length ? ctrlFilteredList.map(c=>`
    <tr class="ctrl-row ${ctrlSelectedIds.has(c.id)?'ctrl-row-selected':''}" data-ctrl-id="${c.id}">
      <td onclick="event.stopPropagation()">
        <input type="checkbox" class="ctrl-row-cb" data-id="${c.id}" ${ctrlSelectedIds.has(c.id)?'checked':''} onchange="ctrlToggleRow('${c.id}',this.checked)">
      </td>
      <td onclick="openCtrlModal('${c.id}')" style="cursor:pointer"><code>${esc(c.id)}</code></td>
      <td onclick="openCtrlModal('${c.id}')" style="cursor:pointer;font-weight:500;max-width:200px">${esc(c.title)}</td>
      <td onclick="openCtrlModal('${c.id}')" style="cursor:pointer">${esc(c.owner)}</td>
      <td onclick="openCtrlModal('${c.id}')" style="cursor:pointer;max-width:160px;color:var(--text-muted)">${esc((c.risk||'').slice(0,50))}${(c.risk||'').length>50?'...':''}</td>
      <td><span class="freq-tag">${esc(c.freq)}</span></td>
      <td><span class="${c.nature==='Preventivo'?'nat-prev':'nat-det'}">${esc(c.nature)}</span></td>
      <td style="color:var(--text-muted)">${esc(c.type)}</td>
      <td style="font-size:9px;color:var(--text-muted);max-width:140px">${(c.iso_elements||[]).length>0?c.iso_elements.slice(0,3).join(', ')+(c.iso_elements.length>3?'...':''):'‚Äî'}</td>
      <td><span class="${c.executed==='S√≠'?'exec-yes':'exec-no'}">${esc(c.executed||'No')}</span></td>
      <td style="font-size:9px;color:var(--text-muted)">${c.exec_date||'‚Äî'}</td>
      <td><span class="tag ${c.status==='Activo'?'tag-closed':c.status==='Inactivo'?'tag-critical':'tag-warning'}">${esc(c.status||'Activo')}</span></td>
      <td><button class="btn btn-ghost btn-xs" onclick="event.stopPropagation();openCtrlModal('${c.id}')">‚úè</button></td>
    </tr>`).join('') :
    `<tr><td colspan="13"><div class="empty"><div class="empty-sub">Sin controles${search?' que coincidan con "'+esc(search)+'"':''}</div></div></td></tr>`;

  updateCtrlBulkBar();
}

function ctrlToggleRow(id, checked){
  if(checked) ctrlSelectedIds.add(id);
  else ctrlSelectedIds.delete(id);
  const row=document.querySelector(`.ctrl-row[data-ctrl-id="${id}"]`);
  if(row) row.classList.toggle('ctrl-row-selected', checked);
  updateCtrlBulkBar();
  // Update "select all" checkbox state
  const allCb=document.getElementById('ctrl-check-all');
  if(allCb) allCb.checked = ctrlFilteredList.length>0 && ctrlFilteredList.every(c=>ctrlSelectedIds.has(c.id));
}

function ctrlToggleAll(checked){
  ctrlFilteredList.forEach(c=>{ if(checked) ctrlSelectedIds.add(c.id); else ctrlSelectedIds.delete(c.id); });
  document.querySelectorAll('.ctrl-row-cb').forEach(cb=>cb.checked=checked);
  document.querySelectorAll('.ctrl-row').forEach(r=>r.classList.toggle('ctrl-row-selected',checked));
  updateCtrlBulkBar();
}

function updateCtrlBulkBar(){
  const n=ctrlSelectedIds.size;
  const bar=document.getElementById('ctrl-bulk-bar');
  if(!bar) return;
  bar.style.display=n>0?'flex':'none';
  const cnt=document.getElementById('ctrl-bulk-count');
  if(cnt) cnt.textContent=`${n} control${n!==1?'es':''} seleccionado${n!==1?'s':''}`;
}

async function bulkMarkExecuted(val){
  const date = val==='S√≠' ? new Date().toISOString().slice(0,10) : '';
  let changed=0;
  for(const id of ctrlSelectedIds){
    const c=S.controls.find(x=>x.id===id);
    if(c){ c.executed=val; if(date) c.exec_date=date; changed++;
      if(c._fsId) await fsUpdate('controls',c._fsId,{executed:val,exec_date:date||c.exec_date||''}); }
  }
  lsSet('controls',S.controls);
  ctrlSelectedIds.clear();
  renderControls(); renderCtrlStats();
  showAlert('ctrl-alert',`‚úì ${changed} controles marcados como "${val}"`,'ok');
}

async function bulkSetStatus(val){
  let changed=0;
  for(const id of ctrlSelectedIds){
    const c=S.controls.find(x=>x.id===id);
    if(c){ c.status=val; changed++;
      if(c._fsId) await fsUpdate('controls',c._fsId,{status:val}); }
  }
  lsSet('controls',S.controls);
  ctrlSelectedIds.clear();
  renderControls(); renderCtrlStats();
  showAlert('ctrl-alert',`‚úì ${changed} controles actualizados a "${val}"`,'ok');
}

async function bulkDelete(){
  if(!ctrlSelectedIds.size) return;
  if(!confirm(`¬øEliminar ${ctrlSelectedIds.size} controles seleccionados? Esta acci√≥n no se puede deshacer.`)) return;

  // Optimistic UI: eliminar del estado y renderizar INMEDIATAMENTE
  const idsToDelete = [...ctrlSelectedIds];
  const toDelete = S.controls.filter(c => idsToDelete.includes(c.id));
  S.controls = S.controls.filter(c => !idsToDelete.includes(c.id));
  lsSet('controls', S.controls);
  ctrlSelectedIds.clear();
  renderControls(); renderCtrlStats();
  showAlert('ctrl-alert', `‚úì ${toDelete.length} controles eliminados`, 'ok');

  // Borrar en Firestore en background (no bloquea la UI)
  const delPromises = toDelete.filter(c => c._fsId).map(c => fsDelete('controls', c._fsId).catch(()=>{}));
  await Promise.all(delPromises);
}

function renderCtrlStats(){
  const total=S.controls.length;
  document.getElementById('ctrl-total').textContent=total;
  document.getElementById('ctrl-prev').textContent=S.controls.filter(c=>c.nature==='Preventivo').length;
  document.getElementById('ctrl-det').textContent=S.controls.filter(c=>c.nature==='Detectivo').length;
  document.getElementById('ctrl-noexec').textContent=S.controls.filter(c=>c.executed!=='S√≠').length;
}

// ‚îÄ‚îÄ Excel Import/Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let importPreviewRows = []; // {row, parsed, isDup, dupOf, selected, errors}

function downloadCtrlTemplate(){
  const a=document.createElement('a');
  a.href='controles_template.xlsx';
  a.download='CDT_Controles_Template.xlsx';
  a.click();
}

async function importControls(input){
  const file=input.files[0];
  if(!file){return;}
  if(typeof XLSX==='undefined'){showAlert('ctrl-alert','SheetJS no disponible ‚Äî recarga la p√°gina','err');return;}
  
  try{
    const data=await file.arrayBuffer();
    const wb=XLSX.read(data,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    
    // Normalize helper: quita tildes para comparar sin acentos
    const norm = s => String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();

    // Find header row (look for row with "titulo" or "title" ‚Äî sin tilde)
    let headerRow=-1;
    for(let i=0;i<Math.min(rows.length,6);i++){
      const r=rows[i].map(c=>norm(c));
      if(r.some(c=>c.includes('titulo')||c.includes('title'))){
        headerRow=i; break;
      }
    }
    if(headerRow<0){showAlert('ctrl-alert','No se encontr√≥ la fila de cabeceras. Usa la plantilla descargable.','err');input.value='';return;}
    
    const headers=rows[headerRow].map(h=>norm(h).replace(/[*]/g,''));
    
    // Smart column detection
    const findCol=(terms)=>{ for(const t of terms){ const i=headers.findIndex(h=>h.includes(t)); if(i>=0) return i; } return -1; };
    const colMap={
      id:        findCol(['id']),
      title:     findCol(['t√≠tulo','titulo','title','nombre']),
      desc:      findCol(['descripci√≥n','descripcion','description','desc']),
      owner:     findCol(['responsable','owner','responsability']),
      risk:      findCol(['riesgo','risk']),
      freq:      findCol(['frecuencia','frequency','freq']),
      nature:    findCol(['naturaleza','nature','tipo control']),
      type:      findCol(['tipo','type']),
      iso:       findCol(['iso','elemento']),
      evidence:  findCol(['evidencia','evidence']),
      comments:  findCol(['comentarios','comments','notas','notes']),
      executed:  findCol(['ejecutado','executed','realizado']),
      exec_date: findCol(['fecha','date']),
      status:    findCol(['estado','status']),
    };
    
    // Show column mapping UI
    renderColMap(colMap, headers);
    
    // Parse all data rows
    importPreviewRows=[];
    const dataRows=rows.slice(headerRow+1).filter(r=>r.some(c=>String(c).trim()!==''));
    
    for(const r of dataRows){
      const get=(col)=>col>=0?String(r[col]||'').trim():'';
      
      // ID: use col if present, else generate later
      const rawId=get(colMap.id);
      const title=get(colMap.title);
      if(!title && !rawId) continue; // skip empty rows
      
      const parsed={
        id:       rawId||'', // blank if no ID col
        title,
        desc:     get(colMap.desc),
        owner:    get(colMap.owner),
        risk:     get(colMap.risk),
        freq:     get(colMap.freq)||'mensual',
        nature:   get(colMap.nature)||'Preventivo',
        type:     get(colMap.type)||'Manual',
        iso_elements: get(colMap.iso).split(',').map(s=>s.trim()).filter(Boolean),
        evidence: get(colMap.evidence),
        comments: get(colMap.comments),
        executed: get(colMap.executed)||'No',
        exec_date:get(colMap.exec_date),
        status:   get(colMap.status)||'Activo',
        exec_history:[],
      };
      
      // Duplicate detection
      let isDup=false, dupOf=null;
      const existingById = rawId ? S.controls.find(c=>c.id===rawId) : null;
      if(existingById){ isDup=true; dupOf=existingById; }
      else if(title){
        const existingByTitle=S.controls.find(c=>similarityPct(c.title,title)>=80);
        if(existingByTitle){ isDup=true; dupOf=existingByTitle; }
      }
      
      importPreviewRows.push({parsed, isDup, dupOf, selected: !isDup, errors:[]});
    }
    
    renderImportPreview();
    openModal('modal-import');
    
  }catch(e){
    showAlert('ctrl-alert','Error leyendo Excel: '+e.message,'err');
    console.error(e);
  }
  input.value='';
}

function renderColMap(colMap, headers){
  const wrap=document.getElementById('import-col-map');
  if(!wrap) return;
  const FIELD_LABELS={id:'ID',title:'T√≠tulo',desc:'Descripci√≥n',owner:'Responsable',risk:'Riesgo',freq:'Frecuencia',nature:'Naturaleza',type:'Tipo',iso:'ISO 37301',evidence:'Evidencia',comments:'Comentarios',executed:'Ejecutado',exec_date:'Fecha ejec.',status:'Estado'};
  wrap.innerHTML=Object.entries(colMap).map(([field,colIdx])=>`
    <div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border)">
      <span style="min-width:90px;color:var(--text-muted);font-size:9.5px">${FIELD_LABELS[field]||field}</span>
      <select class="fi import-col-sel" data-field="${field}" style="font-size:9px;padding:2px 6px;height:24px">
        <option value="-1">${colIdx<0?'‚Äî no detectado ‚Äî':'(ninguno)'}</option>
        ${headers.map((h,i)=>`<option value="${i}" ${i===colIdx?'selected':''}>${h||'Col '+(i+1)}</option>`).join('')}
      </select>
      ${colIdx>=0?`<span style="font-size:8.5px;color:var(--accent)">‚úì Col ${colIdx+1}</span>`:'<span style="font-size:8.5px;color:var(--warn)">‚ö† no mapeada</span>'}
    </div>`).join('');
}

function renderImportPreview(){
  const tbody=document.getElementById('import-preview-tbody');
  if(!tbody) return;
  
  const newRows=importPreviewRows.filter(r=>!r.isDup);
  const dupRows=importPreviewRows.filter(r=>r.isDup);
  
  document.getElementById('import-stat-total').textContent=`${importPreviewRows.length} filas detectadas`;
  document.getElementById('import-stat-new').textContent=`${newRows.length} nuevos`;
  document.getElementById('import-stat-dup').textContent=`${dupRows.length} duplicados`;
  document.getElementById('import-stat-error').textContent='';
  
  tbody.innerHTML=importPreviewRows.map((row,i)=>{
    const p=row.parsed;
    const isDup=row.isDup;
    const rowStyle=isDup?'background:rgba(245,158,11,.06);border-left:3px solid var(--warn)':'';
    return `<tr style="${rowStyle}">
      <td><input type="checkbox" class="import-row-cb" data-idx="${i}" ${row.selected?'checked':''} onchange="importPreviewRows[${i}].selected=this.checked;updateImportStats()"></td>
      <td>${isDup
        ?'<span style="font-size:8.5px;background:rgba(245,158,11,.15);color:var(--warn);padding:2px 6px;border-radius:3px">‚ö† DUPLICADO</span>'
        :'<span style="font-size:8.5px;background:rgba(0,229,160,.1);color:var(--accent);padding:2px 6px;border-radius:3px">‚úì NUEVO</span>'
      }</td>
      <td><code style="font-size:9px">${esc(p.id||'(auto)')}</code></td>
      <td style="font-weight:500;max-width:180px">${esc(p.title)}</td>
      <td style="color:var(--text-muted)">${esc(p.owner)}</td>
      <td><span class="${p.nature==='Preventivo'?'nat-prev':'nat-det'}">${esc(p.nature)}</span></td>
      <td><span class="freq-tag">${esc(p.freq)}</span></td>
      <td style="color:var(--text-muted);font-size:9px;max-width:120px">${esc((p.risk||'').slice(0,50))}</td>
      <td style="color:var(--warn);font-size:9px">${isDup?`"${esc((row.dupOf?.title||'').slice(0,35))}"`:''}</td>
    </tr>`;
  }).join('');
  
  updateImportStats();
}

function updateImportStats(){
  const selected=importPreviewRows.filter(r=>r.selected).length;
  const btn=document.getElementById('import-confirm-btn');
  if(btn) btn.textContent=`Importar ${selected} seleccionados ‚Üí`;
}

function importSelectAll(select){
  importPreviewRows.forEach((r,i)=>{ if(!r.isDup||select) r.selected=select; });
  document.querySelectorAll('.import-row-cb').forEach((cb,i)=>{ cb.checked=importPreviewRows[i]?.selected||false; });
  updateImportStats();
}
function importToggleAll(checked){ importSelectAll(checked); }

async function confirmImport(){
  const toImport=importPreviewRows.filter(r=>r.selected);
  if(!toImport.length){showAlert('import-alert','Selecciona al menos un control','err');return;}
  
  let added=0;
  const maxExistingN=S.controls.reduce((m,x)=>{ const n=parseInt((x.id||'').replace(/\D/g,'')||0); return n>m?n:m; },0);
  let nextN=maxExistingN+1;
  
  for(const row of toImport){
    const ctrl={...row.parsed};
    if(!ctrl.id) ctrl.id='C-'+String(nextN++).padStart(3,'0');
    ctrl._updated=new Date().toISOString();
    const docId=await fsAdd('controls',ctrl);
    if(docId){ ctrl._fsId=docId; S.controls.push(ctrl); added++; }
  }
  
  lsSet('controls',S.controls);
  closeModal('modal-import');
  renderControls();
  renderCtrlStats();
  showAlert('ctrl-alert',`‚úì ${added} controles importados correctamente`,'ok');
}

function exportControls(){
  if(typeof XLSX==='undefined'){showAlert('ctrl-alert','SheetJS no disponible','err');return;}
  const headers=['ID','T√≠tulo','Descripci√≥n','Responsable','Riesgo Asociado','Frecuencia','Naturaleza','Tipo','Elemento ISO 37301','Evidencia','Comentarios','Ejecutado','Fecha √öltima Ejecuci√≥n','Estado'];
  const rows=S.controls.map(c=>[
    c.id,c.title,c.desc,c.owner,c.risk,c.freq,c.nature,c.type,
    (c.iso_elements||[]).join(', '),c.evidence,c.comments,
    c.executed,c.exec_date,c.status||'Activo'
  ]);
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet([headers,...rows]);
  ws['!cols']=headers.map((_,i)=>({wch:[8,32,40,18,28,14,14,14,26,30,30,12,22,12][i]||15}));
  XLSX.utils.book_append_sheet(wb,ws,'Controles');
  const hHeaders=['ID Control','T√≠tulo','Fecha','Ejecutado por','Resultado'];
  const hRows=S.controls.flatMap(c=>(c.exec_history||[]).map(h=>[c.id,c.title,h.date,h.by,h.result]));
  const ws2=XLSX.utils.aoa_to_sheet([hHeaders,...hRows]);
  XLSX.utils.book_append_sheet(wb,ws2,'Historial');
  XLSX.writeFile(wb,'CDT_Controles_'+new Date().toISOString().slice(0,10)+'.xlsx');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SENTENCIAS / JURISPRUDENCIA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentSentId = null;
let lastSentAnalysis = null;

function openSentModal(id){
  currentSentId=id;
  lastSentAnalysis=null;
  const s=id?S.sentences.find(x=>x.id===id):null;
  document.getElementById('sent-modal-title').textContent=s?'Ver Sentencia':'Nueva Sentencia';
  document.getElementById('sent-ref').value=s?.ref||'';
  document.getElementById('sent-court').value=s?.court||'';
  document.getElementById('sent-date').value=s?.date||'';
  document.getElementById('sent-sala').value=s?.sala||'Civil';
  document.getElementById('sent-parties').value=s?.parties||'';
  document.getElementById('sent-text').value=s?.text||'';
  document.getElementById('sent-summary').value=s?.summary||'';
  document.getElementById('sent-implications').value=s?.implications||'';
  document.getElementById('sent-ctrl-proposal').value=s?.ctrl_proposal||'';
  document.getElementById('sent-impact').value=s?.level||'warning';
  document.getElementById('sent-analysis-box').innerHTML=s?.ai_analysis||'Haz clic en "Analizar con IA" para obtener el an√°lisis de compliance.';
  document.getElementById('sent-analysis-fields').style.display=s?'block':'none';
  document.getElementById('sent-publish-btn').style.display=s?'none':'none';
  openModal('modal-sent');
}

async function analyzeSentencia(){
  const key=S.cfg.mistralKey;
  if(!key){showAlert('sent-alert','Configura la API key de Mistral','err');return;}
  const text=document.getElementById('sent-text').value.trim();
  if(!text){showAlert('sent-alert','Introduce el texto de la sentencia','err');return;}

  const btn=document.getElementById('sent-analyze-btn');
  btn.innerHTML='<span class="spin"></span> Analizando...'; btn.disabled=true;
  document.getElementById('sent-analysis-box').innerHTML='<div class="flex ic gap8" style="color:var(--text-muted)"><span class="spin"></span> Analizando con Mistral...</div>';

  const prompt=`Eres un experto en compliance y derecho corporativo espa√±ol. Analiza la siguiente sentencia/resoluci√≥n y extrae informaci√≥n relevante para el sistema de compliance de una empresa espa√±ola.

CONTEXTO DE LA EMPRESA (Digital Twin):
${S.twinSummary||'No disponible'}

SENTENCIA A ANALIZAR:
${text.slice(0,10000)}

Responde √öNICAMENTE con un JSON v√°lido:
{
  "summary": "Resumen ejecutivo de 3-4 frases de qu√© trata la sentencia",
  "implications": "Implicaciones generales para empresas espa√±olas: qu√© deben hacer o evitar",
  "sectors_affected": ["sectores afectados"],
  "norms_referenced": ["normas, leyes, art√≠culos referenciados"],
  "company_relevance": "Por qu√© esta sentencia es o no relevante para esta empresa espec√≠fica, bas√°ndote en el Digital Twin",
  "company_impact": true,
  "impact_level": "critical|warning|info",
  "controls_needed": "Qu√© controles deber√≠an existir para mitigar el riesgo que evidencia esta sentencia",
  "ctrl_proposal": "Propuesta concreta de un control de compliance para a√±adir al registro",
  "coverage_assessment": "¬øEsta empresa tiene cobertura suficiente para este riesgo seg√∫n el twin?"
}

Responde SOLO el JSON, sin texto adicional.`;

  try{
    const raw=await callMistral(prompt,2000);
    const clean=raw.replace(/```json|```/g,'').trim();
    const data=JSON.parse(clean.match(/\{[\s\S]*\}/)?.[0]||'{}');
    lastSentAnalysis=data;

    const html=`<div class="hit-detail-row"><div class="hit-detail-label">Resumen</div><div class="hit-detail-val">${esc(data.summary||'')}</div></div>
<div class="hit-detail-row mt8"><div class="hit-detail-label">Implicaciones generales</div><div class="hit-detail-val">${esc(data.implications||'')}</div></div>
<div class="hit-detail-row mt8"><div class="hit-detail-label">Relevancia para tu empresa</div><div class="hit-detail-val">${esc(data.company_relevance||'')}</div></div>
<div class="hit-detail-row mt8"><div class="hit-detail-label">Controles necesarios</div><div class="hit-detail-val">${esc(data.controls_needed||'')}</div></div>
<div class="hit-detail-row mt8"><div class="hit-detail-label">Cobertura actual</div><div class="hit-detail-val">${esc(data.coverage_assessment||'')}</div></div>
${(data.norms_referenced||[]).length?`<div class="hit-detail-row mt8"><div class="hit-detail-label">Normas referenciadas</div><div class="hit-detail-val">${data.norms_referenced.join(' ¬∑ ')}</div></div>`:''}`;

    document.getElementById('sent-analysis-box').innerHTML=html;
    document.getElementById('sent-summary').value=data.summary||'';
    document.getElementById('sent-implications').value=data.implications||'';
    document.getElementById('sent-ctrl-proposal').value=data.ctrl_proposal||'';
    document.getElementById('sent-impact').value=data.impact_level||'warning';
    document.getElementById('sent-analysis-fields').style.display='block';
    document.getElementById('sent-publish-btn').style.display='';
  }catch(e){
    document.getElementById('sent-analysis-box').innerHTML=`<div class="alert alert-err">Error: ${esc(e.message)}</div>`;
  }
  btn.textContent='‚ú¶ Analizar con IA'; btn.disabled=false;
}

async function publishSentencia(){
  if(!lastSentAnalysis){showAlert('sent-alert','Analiza la sentencia primero','err');return;}
  const ref=val('sent-ref')||'SIN-REF-'+Date.now();
  const hit={
    id:'sent-'+Date.now(),
    title:`[SENTENCIA] ${val('sent-ref')||val('sent-court')||'Sentencia CENDOJ'}`,
    summary:document.getElementById('sent-summary').value,
    source:'Sentencia ¬∑ '+val('sent-court'),
    level:document.getElementById('sent-impact').value,
    relevance_score:document.getElementById('sent-impact').value==='critical'?90:document.getElementById('sent-impact').value==='warning'?70:50,
    company_impact:true,
    twin_analysis:lastSentAnalysis.company_relevance||'',
    recommended_action:lastSentAnalysis.controls_needed||'',
    vulnerability:lastSentAnalysis.coverage_assessment||'',
    ctrl_proposal:document.getElementById('sent-ctrl-proposal').value,
    norms_affected:lastSentAnalysis.norms_referenced||[],
    risks:lastSentAnalysis.sectors_affected||[],
    link:'',
    fetched_at:new Date().toISOString(),
    raw_date:val('sent-date'),
    is_sentencia:true,
    ecli:ref,
    full_analysis:lastSentAnalysis,
    raw_text:document.getElementById('sent-text').value.slice(0,2000),
  };

  // Save to Firestore
  const fsId=await fsAdd('hits',hit);
  if(fsId) hit._fsId=fsId;
  S.hits.unshift(hit);

  // Save to sentences list
  const sent={id:'sent-'+Date.now(),ref,court:val('sent-court'),date:val('sent-date'),sala:val('sent-sala'),parties:val('sent-parties'),text:document.getElementById('sent-text').value,summary:document.getElementById('sent-summary').value,implications:document.getElementById('sent-implications').value,ctrl_proposal:document.getElementById('sent-ctrl-proposal').value,level:document.getElementById('sent-impact').value,ai_analysis:document.getElementById('sent-analysis-box').innerHTML,hit_id:hit.id};
  if(!S.sentences) S.sentences=[];
  S.sentences.unshift(sent);
  lsSet('sentences',S.sentences);
  lsSet('hits',S.hits);

  closeModal('modal-sent');
  renderSentencias();
  renderHits();
  updateBadges();
  showAlert('sent-alert','‚úì Sentencia publicada al feed de hits','ok');
  setTimeout(()=>go('hits'),1000);
}

function renderSentencias(){
  if(!S.sentences) S.sentences=[];
  const el=document.getElementById('sent-list');
  if(!el) return;
  el.innerHTML=S.sentences.length?S.sentences.map(s=>`
    <div class="sent-card" onclick="openSentModal('${s.id}')" style="cursor:pointer">
      <div class="flex ic gap8 mb6">
        <span class="sent-tag">SENTENCIA</span>
        <span class="tag tag-${s.level||'warning'}">${levelLabel(s.level)}</span>
        <span style="font-size:9px;color:var(--text-muted);margin-left:auto">${s.date||''}</span>
      </div>
      <div style="font-size:11.5px;font-weight:500;margin-bottom:3px">${esc(s.ref||s.court||'Sin referencia')}</div>
      <div style="font-size:10.5px;color:var(--text-dim)">${esc(s.court||'')} ${s.sala?'¬∑ '+s.sala:''}</div>
      ${s.summary?`<div style="font-size:10px;color:var(--text-muted);margin-top:5px;line-height:1.5">${esc(s.summary.slice(0,150))}...</div>`:''}
    </div>`).join('') :
    '<div class="empty"><div class="empty-icon">‚öñ</div><div class="empty-title">Sin sentencias</div><div class="empty-sub">A√±ade sentencias del CENDOJ para an√°lisis IA</div></div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FUNNEL DE HITS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function setHitFunnel(level){
  hitFunnel=level;
  document.querySelectorAll('.funnel-step').forEach(s=>s.classList.remove('active'));
  // Map funnel level to DOM element id
  const domId = {all:'funnel-all', impacts:'funnel-company', plans:'funnel-plans'}[level]||('funnel-'+level);
  document.getElementById(domId)?.classList.add('active');
  renderHits();
}

function updateFunnelCounts(){
  const all = S.hits.length;
  const impacts = S.hits.filter(h=>isImpact(h)).length;
  const residualAlto = S.hits.filter(h=>{
    const r=h.residual_level||'';
    return r==='alto'||r==='critical';
  }).length;
  const plans = S.actionPlans.filter(p=>p.status!=='closed').length;
  document.getElementById('funnel-count-all').textContent=all;
  document.getElementById('funnel-count-company').textContent=impacts;
  const fra = document.getElementById('funnel-count-residual-alto');
  if(fra) fra.textContent=residualAlto;
  const fp = document.getElementById('funnel-count-plans');
  if(fp) fp.textContent=plans;
  // Badge in nav = residual ALTO count
  const badge = document.getElementById('badge-hits');
  if(badge) badge.textContent=residualAlto;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PINECONE ‚Äî Native Inference API (llama-text-embed-v2)
// Host: https://digitaltwin-xm7jklu.svc.aped-4627-b74a.pinecone.io
// No Mistral embeddings needed ‚Äî Pinecone generates them natively
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Pinecone via Vercel proxy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// API key lives in Vercel env var PINECONE_API_KEY ‚Äî never sent from browser
// Proxy handles: embed text ‚Üí upsert vector | embed query ‚Üí search
const PC_PROXY = '/api/pinecone';

function pcKey(){ return true; } // key is server-side

async function pcCall(path, method='GET', body=null){
  try{
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if(body) opts.body = JSON.stringify(body);
    const r = await fetch(PC_PROXY + '?path=' + encodeURIComponent(path), opts);
    return r;
  }catch(e){ console.warn('pcCall exception:', e); return null; }
}

// ‚îÄ‚îÄ Core: embed text + upsert vector (single proxy call) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pcUpsert(id, text, metadata){
  try{
    const r = await pcCall('/upsert-text', 'POST', { id, text, metadata });
    if(!r || !r.ok){
      const errText = await r?.text();
      console.warn('pcUpsert error:', r?.status, errText);
      return false;
    }
    return true;
  }catch(e){ console.warn('pcUpsert exception:', e); return false; }
}

// ‚îÄ‚îÄ Core: embed query + search vectors (single proxy call) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pcQuery(queryText, topK=8){
  try{
    const r = await pcCall('/search-text', 'POST', { text: String(queryText).slice(0,2000), topK });
    if(!r || !r.ok){ console.warn('pcQuery error:', r?.status); return []; }
    const d = await r.json();
    // Returns Pinecone query response: { matches: [{id, score, metadata}] }
    return (d.matches || []).map(m => ({
      score: m.score || 0,
      metadata: m.metadata || {}
    }));
  }catch(e){ console.warn('pcQuery exception:', e); return []; }
}

// ‚îÄ‚îÄ vectorizeAndStore: unified entry point ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toAsciiId(str){
  // Pinecone requires ASCII-only vector IDs
  if(!str) return 'vec-'+Date.now();
  let s = str;
  // Manual accent removal for Spanish chars
  s = s.replace(/[\xC0-\xC5\xE0-\xE5]/g,'a'); // √† √° √¢ √£ √§ √•
  s = s.replace(/[\xC8-\xCB\xE8-\xEB]/g,'e'); // √® √© √™ √´
  s = s.replace(/[\xCC-\xCF\xEC-\xEF]/g,'i'); // √¨ √≠ √Æ √Ø
  s = s.replace(/[\xD2-\xD6\xF2-\xF6]/g,'o'); // √≤ √≥ √¥ √µ √∂
  s = s.replace(/[\xD9-\xDC\xF9-\xFC]/g,'u'); // √π √∫ √ª √º
  s = s.replace(/[\xD1\xF1]/g,'n');            // √ë √±
  s = s.replace(/[\xC7\xE7]/g,'c');            // √á √ß
  // Replace anything non-ASCII with underscore
  s = s.replace(/[^\x20-\x7E]/g,'_');
  // Replace spaces and unsafe chars
  s = s.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-.]/g,'_');
  return s.slice(0,400) || 'vec-x';
}
async function vectorizeAndStore(text, metadata){
  const rawId = metadata.id || 'vec-'+Date.now();
  const id = toAsciiId(rawId);
  const { id: _removed, ...meta } = metadata;
  return pcUpsert(id, text, meta);
}

// ‚îÄ‚îÄ pcEmbedQuery alias (not needed with proxy ‚Äî kept for compatibility) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pcEmbedQuery(text){ return text; }

// ‚îÄ‚îÄ TEST connection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function testPinecone(){
  showAlert('config-alert', 'Verificando conexi√≥n...', 'info');
  try{
    const r = await pcCall('/describe_index_stats', 'GET');
    if(r && r.ok){
      const d = await r.json();
      const count = d.totalVectorCount || d.namespaces?.['']?.vectorCount || 0;
      showAlert('config-alert', `‚úì Pinecone conectado ‚Äî ${count} vectores en el √≠ndice`, 'ok');
    } else {
      showAlert('config-alert', '‚úó Error ' + (r?.status||'') + ': verifica PINECONE_API_KEY en Vercel', 'err');
    }
  }catch(e){ showAlert('config-alert', 'Error: ' + e.message, 'err'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TWIN SYNC ‚Üí PINECONE
// Vectorizes all Twin data: org context, controls, maturity elements, summary
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function syncTwinToPinecone(){
  if(!pcKey()){ showAlert('config-alert', 'Configura la API key de Pinecone primero', 'err'); return; }

  const btn = document.getElementById('btn-sync-pinecone');
  if(btn){ btn.disabled = true; btn.innerHTML = '<span class="spin"></span> Sincronizando...'; }
  showAlert('config-alert', 'Vectorizando Twin...', 'info');

  let done = 0, errors = 0;
  const log = [];
  let progressMsg = '';
  const updateProgress = (msg) => { progressMsg = msg; showAlert('config-alert', msg, 'info'); };

  // 1. Organization context
  const ctx = S.ctx || {};
  if(ctx.name || ctx.business){
    const text = [
      ctx.name       ? 'Empresa: ' + ctx.name : '',
      ctx.sector     ? 'Sector: ' + ctx.sector : '',
      ctx.business   ? 'Actividad: ' + ctx.business : '',
      ctx.legal      ? 'Forma jur√≠dica: ' + ctx.legal : '',
      ctx.size       ? 'Tama√±o: ' + ctx.size : '',
      ctx.geography  ? 'Geograf√≠a: ' + ctx.geography : '',
      ctx.certifications ? 'Normativa aplicable: ' + ctx.certifications : '',
      ctx.structure  ? 'Estructura: ' + ctx.structure : '',
      ctx.risks      ? 'Riesgos declarados: ' + ctx.risks : '',
      ctx.incidents  ? 'Incidencias hist√≥ricas: ' + ctx.incidents : '',
    ].filter(Boolean).join('\n');
    const ok = await vectorizeAndStore(text, { id: 'org-context', type: 'org', name: ctx.name || '', sector: ctx.sector || '' });
    if(!ok){ console.error('Failed to sync: org-context'); }
    ok ? done++ : errors++;
    log.push({ label: 'Contexto organizacional', ok });
  }

  // 2. Twin summary
  if(S.twinSummary){
    const ok = await vectorizeAndStore(S.twinSummary, { id: 'org-summary', type: 'summary' });
    ok ? done++ : errors++;
    log.push({ label: 'Resumen ejecutivo Twin', ok });
  }

  // 3. Controls
  updateProgress(`Vectorizando controles (${S.controls.length})...`);
  for(const ctrl of S.controls){
    const text = [
      'Control: ' + ctrl.title,
      ctrl.desc    ? 'Descripci√≥n: ' + ctrl.desc : '',
      ctrl.risk    ? 'Riesgo: ' + ctrl.risk : '',
      ctrl.nature  ? 'Naturaleza: ' + ctrl.nature : '',
      ctrl.freq    ? 'Frecuencia: ' + ctrl.freq : '',
      ctrl.evidence? 'Evidencia: ' + ctrl.evidence : '',
      (ctrl.iso_elements||[]).length ? 'Elementos ISO: ' + ctrl.iso_elements.join(', ') : '',
    ].filter(Boolean).join('\n');
    const ok = await vectorizeAndStore(text, {
      id: 'ctrl-' + ctrl.id,
      type: 'control',
      ctrl_id: ctrl.id,
      title: ctrl.title,
      nature: ctrl.nature || '',
      freq: ctrl.freq || '',
      executed: ctrl.executed || 'No',
      status: ctrl.status || 'Activo',
      iso_elements: (ctrl.iso_elements || []).join(','),
    });
    ok ? done++ : errors++;
    await new Promise(r => setTimeout(r, 120)); // rate limit
  }
  log.push({ label: `Controles (${S.controls.length})`, ok: errors === 0 });

  // 4. Maturity elements
  updateProgress(`Vectorizando elementos de madurez...`);
  for(const dim of DIMS){
    for(const elem of dim.elements){
      const mat = S.maturity?.[elem.id] || {};
      const score = mat.score || 0;
      const justification = mat.justification || '';
      const evidence = mat.evidence || '';
      const text = [
        'Dimensi√≥n: ' + dim.label,
        'Elemento: ' + elem.label,
        'Puntuaci√≥n: ' + score + '/5 ‚Äî ' + (SCORE_LABELS[score] || 'Sin evaluar'),
        justification ? 'Justificaci√≥n: ' + justification : '',
        evidence      ? 'Evidencia: ' + evidence : '',
      ].filter(Boolean).join('\n');
      const ok = await vectorizeAndStore(text, {
        id: 'elem-' + elem.id,
        type: 'element',
        elem_id: elem.id,
        dim_id: dim.id,
        dim_label: dim.label,
        elem_label: elem.label,
        score: score,
        score_label: SCORE_LABELS[score] || 'Sin evaluar',
      });
      ok ? done++ : errors++;
      await new Promise(r => setTimeout(r, 80));
    }
  }
  log.push({ label: 'Elementos madurez ('+DIMS.reduce((s,d)=>s+d.elements.length,0)+')', ok: errors===0 });

  const msg = `‚úì ${done} vectores sincronizados${errors > 0 ? ' ¬∑ ' + errors + ' errores' : ''}`;
  showAlert('config-alert', msg, errors > 0 ? 'warn' : 'ok');
  if(btn){ btn.innerHTML = '‚úì Twin sincronizado'; setTimeout(()=>{ btn.innerHTML = '‚¨Ü Sincronizar Twin ‚Üí Pinecone'; btn.disabled = false; }, 3000); }

  console.log('Pinecone sync log:', log);
  return { done, errors, log };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RAG HIT ANALYSIS ‚Äî Inherent + Residual Risk
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


// ‚îÄ‚îÄ Discard a hit with reason ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function discardHit(hitId){
  const reason = prompt('¬øPor qu√© no es relevante este hit para tu empresa?\n(Se guardar√° como justificaci√≥n del descarte)');
  if(reason === null) return; // cancelled
  const idx = S.hits.findIndex(h=>h.id===hitId);
  if(idx<0) return;
  S.hits[idx]._discarded = true;
  S.hits[idx]._discard_reason = reason || 'Descartado manualmente';
  S.hits[idx]._action_taken = 'discarded';
  lsSet('hits', S.hits);
  if(S.hits[idx]._fsId){
    await fsUpdate('hits', S.hits[idx]._fsId, {
      _discarded: true,
      _discard_reason: S.hits[idx]._discard_reason,
      _action_taken: 'discarded',
    }).catch(()=>{});
  }
  renderHits();
}
async function reAnalyzeHit(hitId, silent=false){
  if(!S.cfg.mistralKey){ showAlert('hits-alert','Configura la API key de Mistral','err'); return; }
  if(!S.ctx?.name && !S.twinSummary){ showAlert('hits-alert','Primero completa el Contexto Organizacional del Twin','err'); return; }

  const hit = S.hits.find(h=>h.id===hitId);
  if(!hit) return;

  const btn = document.getElementById('reanalyze-'+hitId);
  if(btn){ btn.innerHTML='<span class="spin"></span>'; btn.disabled=true; }

  // ‚îÄ‚îÄ STEP 1: Retrieve relevant Twin fragments via RAG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let ragContext = '';
  let retrievedFragments = [];

  if(pcKey()){
    try{
      // Embed the hit text as a query
      const hitText = [hit.title, hit.summary, hit.twin_analysis].filter(Boolean).join(' ');
      // Integrated index: pcQuery takes text directly, no pre-embedding needed
      const matches = await pcQuery(hitText, 8);
      if(true){

        retrievedFragments = matches.filter(m => m.score > 0.3).map(m => {
          const meta = m.metadata || {};
          let fragment = '';
          if(meta.type === 'control'){
            fragment = `CONTROL [${meta.ctrl_id}] "${meta.title}" ‚Äî ${meta.nature}, ${meta.freq}, ejecutado: ${meta.executed}, ISO: ${meta.iso_elements||''}`;
          } else if(meta.type === 'element'){
            fragment = `ELEMENTO MADUREZ [${meta.elem_id}] "${meta.elem_label}" ‚Äî Score: ${meta.score}/5 (${meta.score_label}) ‚Äî Dimensi√≥n: ${meta.dim_label}`;
          } else if(meta.type === 'org'){
            fragment = `CONTEXTO: sector ${meta.sector}, empresa: ${meta.name}`;
          } else if(meta.type === 'summary'){
            fragment = 'RESUMEN TWIN: (incluido abajo)';
          }
          return { fragment, score: m.score, type: meta.type, meta };
        }).filter(f => f.fragment);

        if(retrievedFragments.length > 0){
          ragContext = '\n\n‚ïê‚ïê‚ïê FRAGMENTOS M√ÅS RELEVANTES DEL TWIN (recuperados por RAG) ‚ïê‚ïê‚ïê\n' +
            retrievedFragments.map((f,i) => `[${i+1}] (relevancia: ${Math.round(f.score*100)}%) ${f.fragment}`).join('\n');
        }
      }
    }catch(e){ console.warn('RAG retrieval failed, proceeding without:', e); }
  }

  // ‚îÄ‚îÄ STEP 2: Build context ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const ctx = S.ctx || {};
  const orgCtx = [
    ctx.name     ? 'Empresa: ' + ctx.name : '',
    ctx.sector   ? 'Sector: ' + ctx.sector : '',
    ctx.business ? 'Actividad: ' + ctx.business : '',
    ctx.geography? 'Geograf√≠a: ' + ctx.geography : '',
    ctx.certifications ? 'Normativa vigente: ' + ctx.certifications : '',
  ].filter(Boolean).join('\n');

  const twinSummaryCtx = S.twinSummary ? '\n\nRESUMEN DEL TWIN:\n' + S.twinSummary.slice(0,600) : '';

  // ‚îÄ‚îÄ STEP 3: Single Mistral call with RAG context ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const prompt = `Eres experto en compliance corporativo espa√±ol. Eval√∫a este evento usando la metodolog√≠a de RIESGO INHERENTE y RIESGO RESIDUAL.

‚ïê‚ïê‚ïê ORGANIZACI√ìN ‚ïê‚ïê‚ïê
${orgCtx}${twinSummaryCtx}${ragContext}

‚ïê‚ïê‚ïê EVENTO A EVALUAR ‚ïê‚ïê‚ïê
T√≠tulo: ${hit.title}
Fuente: ${hit.source||''}
Fecha: ${hit.raw_date||''}
Resumen: ${hit.summary||''}
${hit.norms_affected?.length ? 'Normativas mencionadas: ' + hit.norms_affected.join(', ') : ''}

‚ïê‚ïê‚ïê INSTRUCCIONES ‚ïê‚ïê‚ïê
RIESGO INHERENTE: eval√∫a si este tipo de riesgo existe para esta empresa por su sector/actividad/normativa aplicable, IGNORANDO sus controles actuales.
RIESGO RESIDUAL: eval√∫a el riesgo REAL considerando los controles y nivel de madurez del Twin mostrado arriba.

S√© muy espec√≠fico: si la empresa es agr√≠cola y el evento es sobre regulaci√≥n audiovisual, el inherente es BAJO porque esa normativa no aplica a su sector.

Devuelve SOLO este JSON:
{
  "inherent_score": 0-100,
  "inherent_level": "alto|medio|bajo|irrelevant",
  "inherent_rationale": "1-2 frases: por qu√© este riesgo existe o no para esta empresa espec√≠fica por su sector/actividad",
  "residual_score": 0-100,
  "residual_level": "alto|medio|bajo|irrelevant",
  "residual_rationale": "1-2 frases: qu√© cobertura tiene el Twin y qu√© gap queda",
  "company_impact": true|false,
  "controls_activated": ["IDs de controles del Twin que cubrir√≠an este riesgo, si los hay"],
  "weakest_element": "ID del elemento de madurez m√°s expuesto a este riesgo, si aplica",
  "coverage_quality": "alta|media|baja|sin_cobertura",
  "gaps_identified": "Qu√© control o pol√≠tica concreta falta o es insuficiente, si aplica",
  "ctrl_proposal": "Propuesta breve de 1 control nuevo si hay gap significativo, vac√≠o si no aplica",
  "false_positive_reason": "Si inherent=irrelevant, explica en 1 frase por qu√© no aplica a esta empresa"
}`;

  try{
    const raw = await callMistral(prompt, 1200);
    const clean = raw.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
    const analysis = JSON.parse(clean.match(/\{[\s\S]*\}/)?.[0]||'{}');

    // Enforce residual ‚â§ inherent (methodological constraint)
    const levelOrder = {irrelevant:0, bajo:1, info:1, medio:2, warning:2, alto:3, critical:3};
    const inhOrder = levelOrder[analysis.inherent_level] || 0;
    const resOrderRaw = levelOrder[analysis.residual_level] || 0;
    if(resOrderRaw > inhOrder){
      // Residual cannot exceed inherent ‚Äî cap it
      const capMap = {0:'irrelevant',1:'bajo',2:'medio',3:'alto'};
      analysis.residual_level = capMap[inhOrder] || analysis.inherent_level;
      analysis.residual_score = Math.min(analysis.residual_score||0, analysis.inherent_score||0);
      console.warn('[Risk] Residual capped to inherent level for hit', hitId);
    }
    // Map residual level to display level
    const finalLevel = analysis.residual_level || 'bajo';
    const company_impact = analysis.inherent_level !== 'irrelevant' && analysis.inherent_score > 15;

    // Update hit in state
    const idx = S.hits.findIndex(h=>h.id===hitId);
    if(idx>=0){
      S.hits[idx] = {
        ...S.hits[idx],
        // Both risk levels
        inherent_score:    analysis.inherent_score ?? 50,
        inherent_level:    analysis.inherent_level || 'warning',
        inherent_rationale:analysis.inherent_rationale || '',
        residual_score:    analysis.residual_score ?? 30,
        residual_level:    analysis.residual_level || 'info',
        residual_rationale:analysis.residual_rationale || '',
        // Display level = residual
        level:             finalLevel,
        relevance_score:   analysis.residual_score ?? S.hits[idx].relevance_score,
        company_impact,
        // Coverage details
        controls_activated: analysis.controls_activated || [],
        weakest_element:   analysis.weakest_element || '',
        coverage_quality:  analysis.coverage_quality || '',
        gaps_identified:   analysis.gaps_identified || '',
        ctrl_proposal:     analysis.ctrl_proposal || '',
        false_positive_reason: analysis.false_positive_reason || '',
        false_positive:    !company_impact,
        twin_analysis:     analysis.residual_rationale || S.hits[idx].twin_analysis || '',
        recommended_action:analysis.gaps_identified || '',
        rag_fragments_used:retrievedFragments.length,
        _reanalyzed:       new Date().toISOString(),
        _analyzed:         true,
      };
      lsSet('hits', S.hits);
      if(S.hits[idx]._fsId){
        fsUpdate('hits', S.hits[idx]._fsId, {
          inherent_score:     analysis.inherent_score,
          inherent_level:     analysis.inherent_level,
          inherent_rationale: analysis.inherent_rationale||'',
          residual_score:     analysis.residual_score,
          residual_level:     analysis.residual_level,
          residual_rationale: analysis.residual_rationale||'',
          level:              finalLevel,
          company_impact,
          controls_activated: analysis.controls_activated||[],
          weakest_element:    analysis.weakest_element||'',
          coverage_quality:   analysis.coverage_quality||'',
          gaps_identified:    analysis.gaps_identified||'',
          ctrl_proposal:      analysis.ctrl_proposal||'',
          false_positive_reason: analysis.false_positive_reason||'',
          false_positive:     !company_impact,
          rag_fragments_used: retrievedFragments.length,
          _reanalyzed:        new Date().toISOString(),
          _analyzed:          true,
        }).catch(()=>{});
      }
    }

    updateFunnelCounts();
    updateBadges();
    renderHits();
    if(!silent) showRiskToast(hitId, analysis, company_impact, retrievedFragments.length);

  }catch(e){
    if(btn){ btn.innerHTML='‚ü≥ Re-evaluar'; btn.disabled=false; }
    console.error('reAnalyzeHit error:', e);
    showAlert('hits-alert','Error: '+e.message,'err');
  }
}

function showRiskToast(hitId, analysis, company_impact, ragCount){
  const el = document.getElementById('hits-inline-alert') || (() => {
    const d=document.createElement('div'); d.id='hits-inline-alert';
    d.style.cssText='position:fixed;bottom:20px;right:20px;max-width:400px;z-index:9999';
    document.body.appendChild(d); return d;
  })();
  const inh = analysis.inherent_level || 'info';
  const res = analysis.residual_level || 'info';
  const levelColors = {critical:'var(--danger)',warning:'var(--warn)',info:'var(--accent2)',irrelevant:'var(--text-muted)'};
  const ic = levelColors[inh]||'var(--text-muted)';
  const rc = levelColors[res]||'var(--text-muted)';
  el.innerHTML = `<div style="background:var(--surface);border:1px solid var(--border2);border-radius:6px;padding:13px 15px;box-shadow:0 6px 24px rgba(0,0,0,.5)">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      <div style="text-align:center">
        <div style="font-size:7.5px;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:2px">INHERENTE</div>
        <span style="font-size:9px;font-weight:700;color:${ic};background:rgba(0,0,0,.2);padding:2px 8px;border-radius:3px">${levelLabel(inh)}</span>
      </div>
      <div style="color:var(--text-muted);font-size:14px">‚Üí</div>
      <div style="text-align:center">
        <div style="font-size:7.5px;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:2px">RESIDUAL</div>
        <span style="font-size:9px;font-weight:700;color:${rc};background:rgba(0,0,0,.2);padding:2px 8px;border-radius:3px">${levelLabel(res)}</span>
      </div>
      ${ragCount>0?`<div style="margin-left:auto;font-size:8.5px;color:var(--accent)">‚¨° ${ragCount} fragmentos RAG</div>`:''}
    </div>
    <div style="font-size:9.5px;color:var(--text-dim);line-height:1.6">${esc(analysis.inherent_rationale||'')}</div>
    ${!company_impact?`<div style="margin-top:6px;font-size:9px;color:var(--text-muted);font-style:italic">${esc(analysis.false_positive_reason||'')}</div>`:''}
  </div>`;
  setTimeout(()=>{ el.innerHTML=''; }, 10000);
}

// ‚îÄ‚îÄ Batch re-analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function batchReAnalyze(){
  if(!S.cfg.mistralKey){ go('config'); return; }
  const toProcess = S.hits.filter(h=>!h._reanalyzed && !h.is_sentencia).slice(0,15);
  if(!toProcess.length){ showAlert('hits-alert','Todos los hits ya han sido evaluados','info'); return; }

  const btn = document.getElementById('batch-reanalyze-btn');
  if(btn){ btn.disabled=true; }

  for(let i=0; i<toProcess.length; i++){
    const h = toProcess[i];
    if(btn) btn.innerHTML=`<span class="spin"></span> ${i+1}/${toProcess.length}`;
    await reAnalyzeHit(h.id);
    await new Promise(r=>setTimeout(r,1200)); // rate limit
  }

  if(btn){ btn.innerHTML='‚úì Completado'; setTimeout(()=>{ btn.innerHTML='‚ü≥ Re-evaluar todos'; btn.disabled=false; },3000); }
}

// ‚îÄ‚îÄ Build twin context string (used elsewhere) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTwinContext(){
  const ctx = S.ctx || {};
  return [
    ctx.name       ? 'Empresa: '+ctx.name : '',
    ctx.sector     ? 'Sector: '+ctx.sector : '',
    ctx.business   ? 'Actividad: '+ctx.business : '',
    ctx.geography  ? 'Geograf√≠a: '+ctx.geography : '',
    ctx.certifications ? 'Normativa: '+ctx.certifications : '',
    S.twinSummary  ? '\nResumen Twin:\n'+S.twinSummary.slice(0,500) : '',
  ].filter(Boolean).join('\n');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEEPDIVE DRAWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ddCurrentHitId = null;

function openDrawer(){
  document.getElementById('dd-overlay').classList.add('open');
  document.getElementById('dd-drawer').classList.add('open');
}
function closeDrawer(){
  document.getElementById('dd-overlay').classList.remove('open');
  document.getElementById('dd-drawer').classList.remove('open');
  ddCurrentHitId = null;
}

function renderDeepDiveContent(hit, dd){
  const body = document.getElementById('dd-body');
  const inhColor = levelColor(dd.inherent_level||'');
  const resColor = levelColor(dd.residual_level||'');

  // Build controls rows
  const ctrlsHtml = (dd.controls_coverage||[]).map(c=>
    `<div style="display:flex;gap:8px;align-items:start;margin-bottom:8px">
      <span style="flex-shrink:0;font-size:9px;padding:2px 7px;border-radius:3px;background:rgba(139,92,246,.1);color:var(--purple)">${esc(c.id||'')}</span>
      <div>
        <div style="font-size:10px;color:var(--text);margin-bottom:2px">${esc(c.title||'')}</div>
        <div style="font-size:9.5px;color:var(--text-dim)">${esc(c.coverage_comment||'')}</div>
      </div>
    </div>`
  ).join('');

  const precedentsHtml = (dd.precedents||[]).length
    ? (dd.precedents).map(p=>
        `<div class="dd-precedent"><strong style="color:var(--text)">${esc(p.case||'')}</strong> ‚Äî ${esc(p.outcome||'')}${p.source?`<div style="font-size:8.5px;color:var(--text-muted);margin-top:2px">${esc(p.source)}</div>`:''}</div>`
      ).join('')
    : `<div style="font-size:10px;color:var(--text-muted);font-style:italic">No se encontraron precedentes concretos en NewsAPI para esta tipolog√≠a.</div>`;

  const gapsHtml = (dd.gaps||[]).map(g=>
    `<div style="display:flex;gap:8px;align-items:start;margin-bottom:8px">
      <span style="flex-shrink:0;width:6px;height:6px;border-radius:50%;background:var(--warn);margin-top:5px;display:inline-block"></span>
      <div style="font-size:10px;color:var(--text-dim)">${esc(g)}</div>
    </div>`
  ).join('');

  body.innerHTML = `
    <div class="dd-disclaimer">
      ‚ö† Este an√°lisis ha sido generado con Inteligencia Artificial. Los datos, precedentes e implicaciones legales requieren supervisi√≥n y validaci√≥n humana antes de tomar decisiones.
    </div>

    <div class="dd-section">
      <div class="dd-section-title">Exposici√≥n inherente</div>
      <div class="dd-block danger">${esc(dd.inherent_analysis||'')}</div>
      ${dd.worst_case?`<div class="dd-block" style="border-left:3px solid var(--border2)">
        <div style="font-size:8px;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:4px">ESCENARIO ADVERSO</div>
        ${esc(dd.worst_case)}
      </div>`:''}
    </div>

    <div class="dd-section">
      <div class="dd-section-title">Precedentes relevantes</div>
      ${precedentsHtml}
    </div>

    <div class="dd-section">
      <div class="dd-section-title">Cobertura del Digital Twin</div>
      ${ctrlsHtml||`<div style="font-size:10px;color:var(--text-muted)">No se identificaron controles espec√≠ficos en el Twin para este riesgo.</div>`}
      ${dd.maturity_comment?`<div class="dd-block ok" style="margin-top:8px">${esc(dd.maturity_comment)}</div>`:''}
    </div>

    ${(dd.gaps||[]).length?`
    <div class="dd-section">
      <div class="dd-section-title">Gaps identificados</div>
      ${gapsHtml}
    </div>`:''}

    ${dd.recommended_action?`
    <div class="dd-section">
      <div class="dd-section-title">Acci√≥n recomendada</div>
      <div class="dd-block warn">${esc(dd.recommended_action)}</div>
    </div>`:''}
  `;
  document.getElementById('dd-export-btn').style.display='';
}

async function openDeepDive(hitId){
  const hit = S.hits.find(h=>h.id===hitId);
  if(!hit) return;
  ddCurrentHitId = hitId;

  // Set header ‚Äî guard against drawer not yet in DOM
  const titleEl  = document.getElementById('dd-hit-title');
  const inhPill  = document.getElementById('dd-inh-pill');
  const resPill  = document.getElementById('dd-res-pill');
  const dateMeta = document.getElementById('dd-date-meta');
  if(!titleEl || !inhPill || !resPill){ console.error('Drawer elements not found'); return; }
  titleEl.textContent = hit.title||'';
  inhPill.textContent = 'INHERENTE ' + levelLabel(hit.inherent_level||'');
  inhPill.className = 'tag tag-'+(hit.inherent_level||'info');
  resPill.textContent = 'RESIDUAL ' + levelLabel(hit.residual_level||'');
  resPill.className = 'tag tag-'+(hit.residual_level||'info');
  if(dateMeta) dateMeta.textContent = fmtDate(hit.raw_date||hit.fetched_at||'');
  document.getElementById('dd-export-btn').style.display='none';

  openDrawer();

  // Check if deepdive already saved in Firestore
  const fsId = hit._fsId;
  if(hit._deepdive && hit._deepdive_at){
    document.getElementById('dd-analyzed-at').textContent = 'An√°lisis realizado: ' + fmtDate(hit._deepdive_at);
    renderDeepDiveContent(hit, hit._deepdive);
    return;
  }

  // Show confirmation before calling IA
  const body = document.getElementById('dd-body');
  body.innerHTML = `
    <div style="padding:30px 0;text-align:center">
      <div style="font-size:28px;margin-bottom:12px">‚ú¶</div>
      <div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:8px">An√°lisis Profundo con IA</div>
      <div style="font-size:11px;color:var(--text-dim);line-height:1.7;max-width:400px;margin:0 auto 20px">
        Se va a realizar un an√°lisis extendido usando Mistral AI + NewsAPI (~3.000 tokens).<br>
        El resultado se guardar√° en Firestore para no repetirlo.<br><br>
        <span style="color:var(--warn);font-size:10px">‚ö† Requiere supervisi√≥n humana. No sustituye asesoramiento legal.</span>
      </div>
      <button class="btn btn-primary" onclick="runDeepDive('${hitId}')">Ejecutar an√°lisis ‚Üí</button>
      <button class="btn btn-ghost" onclick="closeDrawer()" style="margin-left:8px">Cancelar</button>
    </div>`;
  document.getElementById('dd-analyzed-at').textContent='';
}

async function runDeepDive(hitId){
  const hit = S.hits.find(h=>h.id===hitId);
  if(!hit) return;

  const body = document.getElementById('dd-body');
  body.innerHTML = `<div class="flex ic gap8" style="color:var(--text-muted);padding:40px 0;justify-content:center"><span class="spin"></span> Analizando en profundidad...</div>`;

  // Build RAG context
  let ragContext = '';
  let ragFragments = [];
  if(pcKey()){
    try{
      const hitText = [hit.title, hit.summary].filter(Boolean).join(' ');
      const matches = await pcQuery(hitText, 12);
      ragFragments = matches.filter(m=>m.score>0.25).map(m=>{
        const meta = m.metadata||{};
        if(meta.type==='control') return `CONTROL [${meta.ctrl_id}] "${meta.title}" ‚Äî ${meta.nature}, ${meta.freq}, ejecutado: ${meta.executed}`;
        if(meta.type==='element') return `MADUREZ [${meta.elem_id}] "${meta.elem_label}" ‚Äî Score: ${meta.score}/5`;
        if(meta.type==='org') return `CONTEXTO: ${meta.name}, sector ${meta.sector}`;
        return '';
      }).filter(Boolean);
      if(ragFragments.length) ragContext = '\n\nCONTEXTO DEL TWIN:\n' + ragFragments.join('\n');
    }catch(e){ console.warn('RAG error in deepdive:', e); }
  }

  // Build prompt
  const ctx = S.ctx||{};
  const orgCtx = [
    ctx.name ? 'Empresa: '+ctx.name : '',
    ctx.sector ? 'Sector: '+ctx.sector : '',
    ctx.business ? 'Actividad: '+ctx.business : '',
    ctx.legal ? 'Marco legal: '+ctx.legal : '',
  ].filter(Boolean).join('\n');

  const prompt = `Eres un experto en compliance corporativo espa√±ol. Realiza un an√°lisis profundo y ejecutivo del siguiente evento de riesgo para la organizaci√≥n.

ORGANIZACI√ìN:
${orgCtx}
${ragContext}

EVENTO:
T√≠tulo: ${hit.title}
Fuente: ${hit.source||''}  
Resumen: ${(hit.summary||'').slice(0,600)}
Riesgo inherente previo: ${levelLabel(hit.inherent_level||'')}
Riesgo residual previo: ${levelLabel(hit.residual_level||'')}

INSTRUCCIONES:
Proporciona un an√°lisis ejecutivo completo con:
1. An√°lisis detallado de la exposici√≥n inherente (por qu√© aplica o no a esta empresa, normativa espec√≠fica espa√±ola/europea)
2. Escenario adverso concreto (consecuencias regulatorias reales: multas m√°ximas, sanciones, publicidad negativa)
3. Hasta 3 precedentes REALES y concretos de casos similares en Espa√±a/Europa (si los conoces con certeza; si no, no inventes)
4. Evaluaci√≥n de cada control/elemento del Twin que cubrir√≠a este riesgo
5. Gaps concretos (qu√© falta exactamente)
6. Acci√≥n recomendada espec√≠fica y accionable

Devuelve SOLO este JSON:
{
  "inherent_analysis": "p√°rrafo detallado sobre la exposici√≥n inherente",
  "worst_case": "descripci√≥n del escenario adverso con cifras concretas si las hay",
  "precedents": [
    {"case": "Nombre del caso real", "outcome": "Resultado/sanci√≥n concreta", "source": "Regulador/fuente"}
  ],
  "controls_coverage": [
    {"id": "ID control o elemento Twin", "title": "nombre", "coverage_comment": "qu√© cubre y qu√© no de este riesgo"}
  ],
  "maturity_comment": "evaluaci√≥n del nivel de madurez del Twin para este riesgo",
  "gaps": ["gap 1 concreto", "gap 2 concreto"],
  "recommended_action": "acci√≥n espec√≠fica y accionable"
}
Responde SOLO el JSON. Precedentes: solo incluye si son reales y verificables; omite el array si no est√°s seguro.`;

  try{
    const raw = await callMistral(prompt, 3000);
    const clean = raw.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
    const dd = JSON.parse(clean.match(/\{[\s\S]*\}/)?.[0]||'{}');

    // Save to hit in state + Firestore
    const idx = S.hits.findIndex(h=>h.id===hitId);
    if(idx>=0){
      S.hits[idx]._deepdive = dd;
      S.hits[idx]._deepdive_at = new Date().toISOString();
      S.hits[idx]._deepdive_frags = ragFragments.length;
      lsSet('hits', S.hits);
      if(S.hits[idx]._fsId){
        fsUpdate('hits', S.hits[idx]._fsId, {
          _deepdive: dd,
          _deepdive_at: S.hits[idx]._deepdive_at,
          _deepdive_frags: ragFragments.length,
        }).catch(()=>{});
      }
    }

    document.getElementById('dd-analyzed-at').textContent = 'An√°lisis realizado: ' + fmtDate(new Date().toISOString());
    renderDeepDiveContent(hit, dd);

  }catch(e){
    body.innerHTML = `<div class="alert alert-err">Error en an√°lisis: ${esc(e.message)}</div>`;
  }
}

// ‚îÄ‚îÄ Export deepdive to Word ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function exportDeepDiveWord(){
  const hit = S.hits.find(h=>h.id===ddCurrentHitId);
  if(!hit||!hit._deepdive) return;
  const dd = hit._deepdive;

  // Read docx skill then generate
  const btn = document.getElementById('dd-export-btn');
  btn.textContent='Generando...'; btn.disabled=true;

  try{
    // Build markdown content for the Word doc
    const md = buildDeepDiveMarkdown(hit, dd);
    // Use mammoth-style approach: create blob and download as HTML-based doc
    const htmlContent = buildDeepDiveHtml(hit, dd);
    const blob = new Blob([htmlContent], {type:'application/vnd.ms-word;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `AnalisisProfundo_${(hit.title||'hit').slice(0,40).replace(/[^a-zA-Z0-9]/g,'_')}_${new Date().toISOString().slice(0,10)}.doc`;
    a.click();
    URL.revokeObjectURL(url);
  }catch(e){
    alert('Error exportando: '+e.message);
  }
  btn.textContent='‚¨á Exportar Word'; btn.disabled=false;
}

function buildDeepDiveHtml(hit, dd){
  const date = new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric'});
  const ctx = S.ctx||{};
  const precedentsRows = (dd.precedents||[]).map(p=>
    `<tr><td style="padding:6px 10px;border:1px solid #ddd">${p.case||''}</td><td style="padding:6px 10px;border:1px solid #ddd">${p.outcome||''}</td><td style="padding:6px 10px;border:1px solid #ddd">${p.source||''}</td></tr>`
  ).join('');
  const ctrlRows = (dd.controls_coverage||[]).map(c=>
    `<tr><td style="padding:6px 10px;border:1px solid #ddd">${c.id||''}</td><td style="padding:6px 10px;border:1px solid #ddd">${c.title||''}</td><td style="padding:6px 10px;border:1px solid #ddd">${c.coverage_comment||''}</td></tr>`
  ).join('');
  const gapsList = (dd.gaps||[]).map(g=>`<li>${g}</li>`).join('');

  return `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="utf-8"><title>An√°lisis Profundo de Riesgo</title>
<style>
  body{font-family:Calibri,Arial,sans-serif;font-size:11pt;color:#1a1a1a;margin:2cm}
  h1{font-size:16pt;color:#1a1a1a;border-bottom:2px solid #00e5a0;padding-bottom:8px}
  h2{font-size:12pt;color:#333;margin-top:20px;border-left:4px solid #00e5a0;padding-left:8px}
  h3{font-size:11pt;color:#555;margin-top:14px}
  table{width:100%;border-collapse:collapse;margin:10px 0;font-size:10pt}
  th{background:#f0f0f0;padding:7px 10px;border:1px solid #ddd;text-align:left;font-weight:bold}
  .meta{font-size:9pt;color:#777}
  .disclaimer{background:#fff8e1;border:1px solid #f59e0b;padding:10px 14px;border-radius:4px;font-size:9.5pt;color:#7a5f00;margin-bottom:16px}
  .risk-box{display:inline-block;padding:4px 12px;border-radius:4px;font-weight:bold;font-size:10pt;margin:0 4px}
  .risk-alto{background:#fee2e2;color:#dc2626}
  .risk-medio{background:#fef9c3;color:#ca8a04}
  .risk-bajo{background:#d1fae5;color:#059669}
</style></head><body>
<h1>An√°lisis Profundo de Riesgo de Compliance</h1>
<p class="meta">Organizaci√≥n: <strong>${ctx.name||'‚Äî'}</strong> | Sector: ${ctx.sector||'‚Äî'} | Fecha an√°lisis: ${date}</p>
<p class="meta">Evento: <em>${hit.title||''}</em> | Fuente: ${hit.source||''} | Fecha evento: ${fmtDate(hit.raw_date||hit.fetched_at||'')}</p>
<br>
<p>
  <span class="risk-box risk-${hit.inherent_level||'bajo'}">INHERENTE: ${levelLabel(hit.inherent_level||'')}</span>
  ‚Üí 
  <span class="risk-box risk-${hit.residual_level||'bajo'}">RESIDUAL: ${levelLabel(hit.residual_level||'')}</span>
</p>
<br>
<div class="disclaimer">‚ö† Este documento ha sido generado con asistencia de Inteligencia Artificial (Mistral AI). Los datos, precedentes e implicaciones legales deben ser validados por un profesional del derecho o compliance antes de tomar decisiones.</div>

<h2>1. Exposici√≥n Inherente</h2>
<p>${dd.inherent_analysis||'‚Äî'}</p>

${dd.worst_case?`<h3>Escenario Adverso</h3><p>${dd.worst_case}</p>`:''}

${(dd.precedents||[]).length?`
<h2>2. Precedentes Relevantes</h2>
<table><tr><th>Caso</th><th>Resultado</th><th>Fuente</th></tr>${precedentsRows}</table>`:''}

<h2>3. Cobertura del Digital Twin</h2>
${ctrlRows?`<table><tr><th>Control/Elemento</th><th>Descripci√≥n</th><th>Cobertura</th></tr>${ctrlRows}</table>`:'<p>No se identificaron controles espec√≠ficos en el Twin para este riesgo.</p>'}
${dd.maturity_comment?`<p><em>${dd.maturity_comment}</em></p>`:''}

${(dd.gaps||[]).length?`<h2>4. Gaps Identificados</h2><ul>${gapsList}</ul>`:''}

${dd.recommended_action?`<h2>5. Acci√≥n Recomendada</h2><p>${dd.recommended_action}</p>`:''}

<br><br>
<p class="meta">Generado por Digital Twin Compliance ¬∑ ${date} ¬∑ An√°lisis IA (Mistral + RAG Twin)</p>
</body></html>`;
}

function buildDeepDiveMarkdown(hit, dd){
  return `# An√°lisis Profundo: ${hit.title}\n\n${dd.inherent_analysis||''}\n\n## Acci√≥n\n${dd.recommended_action||''}`;
}

</script>
</body>
</html>
