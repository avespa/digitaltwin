<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDT â€” Compliance Digital Twin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #070b0f;
  --surface: #0c1117;
  --surface2: #111820;
  --border: #1a2530;
  --border2: #243040;
  --accent: #00e5a0;
  --accent2: #0066ff;
  --warn: #f59e0b;
  --danger: #ef4444;
  --text: #dce8f0;
  --text-muted: #3d5468;
  --text-dim: #7a96aa;
  --font-ui: 'Syne', sans-serif;
  --font-mono: 'DM Mono', monospace;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:var(--font-mono);min-height:100vh;overflow-x:hidden}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,229,160,.008) 3px,rgba(0,229,160,.008) 4px);pointer-events:none;z-index:9999}

/* LAYOUT */
.app{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{width:210px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100}
.logo{padding:24px 18px 18px;border-bottom:1px solid var(--border)}
.logo-name{font-family:var(--font-ui);font-weight:800;font-size:17px;color:var(--accent);display:flex;align-items:center;gap:8px}
.logo-dot{width:7px;height:7px;background:var(--accent);border-radius:50%;box-shadow:0 0 10px var(--accent);animation:glow 2s infinite}
@keyframes glow{0%,100%{box-shadow:0 0 6px var(--accent)}50%{box-shadow:0 0 18px var(--accent),0 0 30px rgba(0,229,160,.3)}}
.logo-sub{font-size:9px;color:var(--text-muted);letter-spacing:2.5px;text-transform:uppercase;margin-top:3px}
.nav{padding:12px 0;flex:1}
.nav-sec{padding:10px 18px 3px;font-size:8.5px;letter-spacing:2.5px;text-transform:uppercase;color:var(--text-muted)}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 18px;cursor:pointer;font-size:11.5px;color:var(--text-dim);transition:all .15s;border-left:2px solid transparent;user-select:none}
.nav-item:hover{color:var(--text);background:rgba(0,229,160,.03)}
.nav-item.active{color:var(--accent);border-left-color:var(--accent);background:rgba(0,229,160,.05)}
.nav-icon{width:14px;text-align:center;font-size:13px}
.nav-badge{margin-left:auto;background:var(--danger);color:#fff;font-size:9px;padding:1px 5px;border-radius:8px;min-width:16px;text-align:center}
.sidebar-foot{padding:14px 18px;border-top:1px solid var(--border);font-size:10px;color:var(--text-muted);display:flex;align-items:center;gap:6px}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--accent);animation:glow 2s infinite;flex-shrink:0}

/* MAIN */
.main{margin-left:210px;flex:1;display:flex;flex-direction:column}
.topbar{height:54px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:12px;position:sticky;top:0;z-index:50}
.topbar-title{font-family:var(--font-ui);font-weight:700;font-size:14px;flex:1}
.topbar-sync{font-size:10px;color:var(--text-muted)}
.content{padding:24px;flex:1}

/* VIEWS */
.view{display:none}.view.active{display:block}

/* BTN */
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:4px;font-family:var(--font-mono);font-size:11px;cursor:pointer;border:1px solid transparent;transition:all .15s;text-decoration:none;white-space:nowrap}
.btn-primary{background:var(--accent);color:#000;font-weight:500}.btn-primary:hover{background:#00ffb3;box-shadow:0 0 18px rgba(0,229,160,.35)}
.btn-ghost{background:transparent;color:var(--text-dim);border-color:var(--border)}.btn-ghost:hover{color:var(--text);border-color:var(--border2)}
.btn-danger{background:transparent;color:var(--danger);border-color:var(--danger)}.btn-danger:hover{background:rgba(239,68,68,.08)}
.btn-sm{padding:4px 10px;font-size:10px}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:18px}
.card-title{font-family:var(--font-ui);font-size:12px;font-weight:700;letter-spacing:.3px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:18px}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px 18px;position:relative;overflow:hidden}
.stat::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--c,var(--accent))}
.stat-label{font-size:8.5px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);margin-bottom:7px}
.stat-value{font-family:var(--font-ui);font-size:26px;font-weight:800;color:var(--c,var(--accent));line-height:1}
.stat-sub{font-size:9.5px;color:var(--text-muted);margin-top:5px}

/* GRID */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}

/* HITS */
.hit{border-left:3px solid var(--border);padding:11px 14px;margin-bottom:7px;background:var(--surface);border-radius:0 4px 4px 0;transition:border-color .15s}
.hit:hover{border-left-color:var(--text-muted)}
.hit.critical{border-left-color:var(--danger)}
.hit.warning{border-left-color:var(--warn)}
.hit.info{border-left-color:var(--accent2)}
.hit-head{display:flex;align-items:center;gap:7px;margin-bottom:5px}
.level-tag{font-size:8.5px;letter-spacing:1px;text-transform:uppercase;padding:2px 6px;border-radius:3px;font-weight:600}
.level-tag.critical{background:rgba(239,68,68,.15);color:var(--danger)}
.level-tag.warning{background:rgba(245,158,11,.15);color:var(--warn)}
.level-tag.info{background:rgba(0,102,255,.15);color:var(--accent2)}
.hit-source{font-size:9.5px;color:var(--text-muted)}
.hit-date{font-size:9.5px;color:var(--text-muted);margin-left:auto}
.hit-title{font-size:11.5px;font-weight:500;margin-bottom:3px;line-height:1.4}
.hit-summary{font-size:10.5px;color:var(--text-dim);line-height:1.5}
.hit-detail{margin-top:8px;display:none}
.hit-detail.open{display:block}
.hit-detail-item{font-size:10px;color:var(--text-dim);margin-bottom:5px;line-height:1.5}
.hit-detail-label{font-size:8.5px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:2px}
.score-bar{height:3px;background:var(--border2);border-radius:2px;margin-top:4px}
.score-fill{height:100%;border-radius:2px;background:var(--accent);transition:width .5s}

/* FORM */
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:9px;letter-spacing:1.8px;text-transform:uppercase;color:var(--text-muted);margin-bottom:5px}
.form-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:9px 11px;color:var(--text);font-family:var(--font-mono);font-size:11.5px;transition:border-color .15s;outline:none}
.form-input:focus{border-color:var(--accent)}
.form-input::placeholder{color:var(--text-muted)}
select.form-input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%233d5468'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;cursor:pointer}
textarea.form-input{resize:vertical;line-height:1.6;min-height:70px}
.form-hint{font-size:9.5px;color:var(--text-muted);margin-top:3px}
input[type="password"].form-input{letter-spacing:3px}

/* API KEY FIELD */
.key-wrap{position:relative}
.key-wrap .form-input{padding-right:36px}
.key-eye{position:absolute;right:9px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:13px;padding:2px}
.key-eye:hover{color:var(--text)}
.api-badge{display:inline-flex;align-items:center;gap:4px;font-size:9px;padding:2px 7px;border-radius:8px;margin-left:8px}
.api-badge.ok{background:rgba(0,229,160,.1);color:var(--accent)}
.api-badge.err{background:rgba(239,68,68,.1);color:var(--danger)}
.api-badge.pend{background:rgba(245,158,11,.1);color:var(--warn)}

/* CONFIG SECTIONS */
.config-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* QUERY LIST */
.query-item{display:flex;align-items:flex-start;gap:8px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;margin-bottom:6px;font-size:10.5px;line-height:1.5;color:var(--text-dim)}
.query-num{color:var(--accent);font-weight:600;flex-shrink:0;font-size:10px;margin-top:1px}
.query-text{flex:1;word-break:break-word}
.query-del{flex-shrink:0;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;padding:0 2px;line-height:1}
.query-del:hover{color:var(--danger)}

/* KEYWORD TAGS */
.kw-wrap{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}
.kw-tag{display:inline-flex;align-items:center;gap:4px;font-size:10px;padding:3px 8px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim)}
.kw-tag button{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px;padding:0;line-height:1}.kw-tag button:hover{color:var(--danger)}
.kw-add-row{display:flex;gap:6px}

/* RSS SOURCE LIST */
.rss-item{display:flex;align-items:center;gap:9px;padding:8px 0;border-bottom:1px solid var(--border);font-size:11px}
.rss-item:last-child{border-bottom:none}
.rss-toggle{width:32px;height:18px;background:var(--border2);border-radius:9px;cursor:pointer;position:relative;transition:background .2s;border:none;flex-shrink:0}
.rss-toggle.on{background:var(--accent)}
.rss-toggle::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:#fff;border-radius:50%;transition:left .2s}
.rss-toggle.on::after{left:16px}
.rss-name{flex:1;color:var(--text-dim)}
.rss-name.on{color:var(--text)}

/* SECTION HEADER */
.sec-head{margin-bottom:20px}
.sec-title{font-family:var(--font-ui);font-size:17px;font-weight:800;margin-bottom:3px}
.sec-sub{font-size:11px;color:var(--text-muted)}

/* TABLE */
.tbl{width:100%;border-collapse:collapse;font-size:11px}
.tbl th{text-align:left;padding:7px 11px;font-size:8.5px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);border-bottom:1px solid var(--border)}
.tbl td{padding:11px;border-bottom:1px solid rgba(26,37,48,.6)}
.tbl tr:hover td{background:rgba(0,229,160,.015)}

/* RISK BADGE */
.risk{font-size:10px;font-weight:600;padding:2px 8px;border-radius:3px}
.risk.alto{background:rgba(239,68,68,.15);color:var(--danger)}
.risk.medio{background:rgba(245,158,11,.15);color:var(--warn)}
.risk.bajo{background:rgba(0,229,160,.15);color:var(--accent)}

/* EMPTY */
.empty{text-align:center;padding:40px 20px;color:var(--text-muted)}
.empty-icon{font-size:28px;margin-bottom:10px}
.empty-title{font-family:var(--font-ui);font-size:13px;color:var(--text-dim);margin-bottom:5px}
.empty-desc{font-size:10.5px}

/* ALERT */
.alert{padding:9px 13px;border-radius:4px;font-size:11px;margin-bottom:14px;display:flex;align-items:center;gap:7px}
.alert.ok{background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.2);color:var(--accent)}
.alert.err{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:var(--danger)}
.alert.warn{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);color:var(--warn)}

/* DIVIDER */
hr.div{border:none;border-top:1px solid var(--border);margin:18px 0}

/* SPINNER */
.spin{width:14px;height:14px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:rotate .6s linear infinite;display:inline-block}
@keyframes rotate{to{transform:rotate(360deg)}}

/* MODAL */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(3px);z-index:1000;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:24px;width:580px;max-height:88vh;overflow-y:auto;position:relative}
.modal-title{font-family:var(--font-ui);font-size:15px;font-weight:700;margin-bottom:18px;padding-right:24px}
.modal-x{position:absolute;top:18px;right:18px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:17px}.modal-x:hover{color:var(--text)}

/* MONITOR */
.monitor{position:fixed;inset:0;background:var(--bg);z-index:2000;display:none;flex-direction:column;padding:28px}
.monitor.on{display:flex}
.monitor-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
.monitor-logo{font-family:var(--font-ui);font-weight:800;font-size:20px;color:var(--accent);display:flex;align-items:center;gap:10px}
.monitor-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;flex:1}
.monitor-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:22px;display:flex;flex-direction:column}
.monitor-label{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:14px}
.monitor-big{font-family:var(--font-ui);font-size:66px;font-weight:800;line-height:1}
.ticker-item{padding:9px 0;border-bottom:1px solid var(--border);animation:fadein .3s}
@keyframes fadein{from{opacity:0;transform:translateY(-3px)}to{opacity:1;transform:none}}

/* SCROLLBAR */
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* UTILS */
.flex{display:flex}.items-center{align-items:center}.justify-between{justify-content:space-between}.gap-8{gap:8px}.gap-12{gap:12px}.mt-8{margin-top:8px}.mt-14{margin-top:14px}.mt-18{margin-top:18px}.mb-14{margin-bottom:14px}.text-muted{color:var(--text-muted);font-size:10.5px}.text-accent{color:var(--accent)}
</style>
</head>
<body>
<div class="app">

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="logo">
    <div class="logo-name"><span class="logo-dot"></span>CDT</div>
    <div class="logo-sub">Compliance Digital Twin</div>
  </div>
  <div class="nav">
    <div class="nav-sec">Principal</div>
    <div class="nav-item active" onclick="go('dashboard')"><span class="nav-icon">â—ˆ</span>Dashboard</div>
    <div class="nav-item" onclick="go('clientes')"><span class="nav-icon">â—</span>Clientes</div>
    <div class="nav-sec" style="margin-top:10px">Monitor</div>
    <div class="nav-item" onclick="go('hits')"><span class="nav-icon">âŸ</span>Hits Detectados<span class="nav-badge" id="badge-hits">0</span></div>
    <div class="nav-item" onclick="go('analisis')"><span class="nav-icon">â—‰</span>AnÃ¡lisis IA</div>
    <div class="nav-sec" style="margin-top:10px">Sistema</div>
    <div class="nav-item" onclick="go('fuentes')"><span class="nav-icon">ğŸ“¡</span>Fuentes & BÃºsquedas</div>
    <div class="nav-item" onclick="go('config')"><span class="nav-icon">âš™</span>ConfiguraciÃ³n APIs</div>
    <div class="nav-item" onclick="toggleMonitor()"><span class="nav-icon">â–£</span>Modo Pantalla</div>
  </div>
  <div class="sidebar-foot"><span class="status-dot"></span><span id="foot-status">Cargando...</span></div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbar-title">Dashboard</div>
    <div class="topbar-sync" id="topbar-sync"></div>
    <button class="btn btn-ghost" onclick="syncNow()" id="sync-btn">âŸ³ Sincronizar</button>
    <button class="btn btn-primary" onclick="go('analisis')">+ AnÃ¡lisis manual</button>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div class="view active" id="view-dashboard">
      <div class="stats-grid">
        <div class="stat" style="--c:var(--accent)"><div class="stat-label">Clientes activos</div><div class="stat-value" id="s-clientes">0</div><div class="stat-sub">en seguimiento</div></div>
        <div class="stat" style="--c:var(--warn)"><div class="stat-label">Hits totales</div><div class="stat-value" id="s-hits">0</div><div class="stat-sub">eventos analizados</div></div>
        <div class="stat" style="--c:var(--danger)"><div class="stat-label">CrÃ­ticos</div><div class="stat-value" id="s-criticos">0</div><div class="stat-sub">alertas activas</div></div>
        <div class="stat" style="--c:var(--accent2)"><div class="stat-label">Ãšltima sync</div><div class="stat-value" style="font-size:14px;margin-top:4px" id="s-sync">â€”</div><div class="stat-sub">actualizaciÃ³n</div></div>
      </div>

      <div class="grid-2" style="gap:18px;margin-bottom:18px">
        <div class="card">
          <div class="card-title">Ãšltimos Hits <span class="text-muted" id="dash-hits-count"></span></div>
          <div id="dash-hits-list"></div>
        </div>
        <div class="card">
          <div class="card-title">Estado por cliente</div>
          <table class="tbl" id="dash-clients-tbl">
            <thead><tr><th>Cliente</th><th>Sector</th><th>Hits</th><th>Riesgo</th></tr></thead>
            <tbody id="dash-clients-body"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Fuentes activas <span class="text-muted" id="dash-sources-count"></span></div>
        <div id="dash-sources-list" style="display:flex;flex-wrap:wrap;gap:6px"></div>
      </div>
    </div>

    <!-- CLIENTES -->
    <div class="view" id="view-clientes">
      <div class="flex items-center justify-between mb-14">
        <div class="sec-head" style="margin-bottom:0"><div class="sec-title">Clientes</div><div class="sec-sub">Perfiles empresariales en seguimiento</div></div>
        <button class="btn btn-primary" onclick="openClientModal()">+ Nuevo cliente</button>
      </div>
      <div id="clients-list"></div>
    </div>

    <!-- HITS -->
    <div class="view" id="view-hits">
      <div class="flex items-center justify-between mb-14">
        <div class="sec-head" style="margin-bottom:0"><div class="sec-title">Hits Detectados</div><div class="sec-sub">Eventos relevantes analizados por IA</div></div>
        <div class="flex gap-8">
          <select class="form-input" style="width:160px" id="filter-level" onchange="renderHits()">
            <option value="">Todos los niveles</option>
            <option value="critical">CrÃ­tico</option>
            <option value="warning">Alerta</option>
            <option value="info">Info</option>
          </select>
          <select class="form-input" style="width:180px" id="filter-source" onchange="renderHits()">
            <option value="">Todas las fuentes</option>
          </select>
        </div>
      </div>
      <div id="hits-list"></div>
    </div>

    <!-- ANÃLISIS MANUAL -->
    <div class="view" id="view-analisis">
      <div class="sec-head"><div class="sec-title">AnÃ¡lisis IA Manual</div><div class="sec-sub">Analiza cualquier noticia o sentencia con el motor de IA</div></div>
      <div class="grid-2" style="align-items:start;gap:18px">
        <div class="card">
          <div class="card-title">Consulta</div>
          <div class="form-group">
            <label class="form-label">Cliente (contexto)</label>
            <select class="form-input" id="an-client"><option value="">AnÃ¡lisis genÃ©rico (sin cliente)</option></select>
          </div>
          <div class="form-group">
            <label class="form-label">Noticia / sentencia / evento</label>
            <textarea class="form-input" id="an-text" rows="6" placeholder="Pega aquÃ­ el texto de la noticia, sentencia o evento a analizar..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Tipo de anÃ¡lisis</label>
            <select class="form-input" id="an-type">
              <option value="full">AnÃ¡lisis completo</option>
              <option value="vulnerability">Vulnerabilidad vs. controles</option>
              <option value="financial">Impacto financiero</option>
              <option value="recommendation">Recomendaciones de mejora</option>
            </select>
          </div>
          <button class="btn btn-primary" style="width:100%" onclick="runManual()" id="an-btn">Analizar con Mistral â†’</button>
        </div>
        <div class="card">
          <div class="card-title">Resultado</div>
          <div id="an-result"><div class="empty"><div class="empty-icon">â—‰</div><div class="empty-title">Esperando anÃ¡lisis</div><div class="empty-desc">El resultado aparecerÃ¡ aquÃ­</div></div></div>
        </div>
      </div>
    </div>

    <!-- FUENTES & BÃšSQUEDAS -->
    <div class="view" id="view-fuentes">
      <div class="sec-head"><div class="sec-title">Fuentes & BÃºsquedas</div><div class="sec-sub">Configura quÃ© monitoriza el sistema cada 3 horas</div></div>
      <div id="fuentes-alert"></div>

      <div class="grid-2" style="align-items:start;gap:16px">

        <!-- QUERIES NEWSAPI -->
        <div class="card">
          <div class="card-title">Queries NewsAPI <span class="text-muted" id="queries-count"></span></div>
          <div class="form-hint" style="margin-bottom:12px">Cada query se lanza como bÃºsqueda independiente. Usa OR, AND y comillas para frases exactas.</div>
          <div id="queries-list"></div>
          <div style="margin-top:10px">
            <textarea class="form-input" id="new-query" rows="2" placeholder='Ej: ("fraude fiscal" OR "evasiÃ³n") AND EspaÃ±a'></textarea>
            <button class="btn btn-ghost btn-sm" style="margin-top:6px;width:100%" onclick="addQuery()">+ AÃ±adir query</button>
          </div>

          <hr class="div">

          <div class="form-group">
            <label class="form-label">Medios especÃ­ficos (opcional)</label>
            <input type="text" class="form-input" id="newsapi-sources" placeholder="el-mundo,expansion,cincodias (vacÃ­o = todos)">
            <div class="form-hint">Nombres de fuentes NewsAPI separados por comas. VacÃ­o = todos los medios en espaÃ±ol.</div>
          </div>
        </div>

        <!-- RSS + KEYWORDS -->
        <div>
          <div class="card" style="margin-bottom:16px">
            <div class="card-title">Fuentes RSS activas</div>
            <div id="rss-list"></div>
          </div>

          <div class="card">
            <div class="card-title">Keywords adicionales</div>
            <div class="form-hint" style="margin-bottom:10px">Palabras clave para el filtro previo de artÃ­culos del BOE y otras fuentes RSS.</div>
            <div class="kw-wrap" id="kw-list"></div>
            <div class="kw-add-row">
              <input type="text" class="form-input" id="new-kw" placeholder="Nueva keyword..." onkeydown="if(event.key==='Enter')addKw()">
              <button class="btn btn-ghost btn-sm" onclick="addKw()">+ AÃ±adir</button>
            </div>
          </div>
        </div>
      </div>

      <div class="flex gap-8 mt-18" style="justify-content:flex-end">
        <button class="btn btn-ghost" onclick="loadFuentesFromConfig()">Descartar cambios</button>
        <button class="btn btn-primary" onclick="saveFuentes()" id="fuentes-save-btn">Guardar configuraciÃ³n</button>
      </div>

      <div class="card mt-18">
        <div class="card-title">â„¹ï¸ CÃ³mo aplicar los cambios</div>
        <div style="font-size:11px;color:var(--text-dim);line-height:1.8">
          1. Guarda la configuraciÃ³n aquÃ­ â†’ se actualiza <code style="color:var(--accent)">data/config.json</code> en tu repositorio GitHub.<br>
          2. Ve a GitHub â†’ Actions â†’ <strong>CDT â€” Fetch & Analyze</strong> â†’ <strong>Run workflow</strong> para aplicarlo inmediatamente.<br>
          3. O espera hasta la prÃ³xima ejecuciÃ³n automÃ¡tica (cada 3 horas).
        </div>
      </div>
    </div>

    <!-- CONFIG APIs -->
    <div class="view" id="view-config">
      <div class="sec-head"><div class="sec-title">ConfiguraciÃ³n APIs</div><div class="sec-sub">Claves de acceso a los servicios externos</div></div>
      <div id="config-alert"></div>
      <div class="config-grid">
        <div class="card">
          <div class="card-title">ğŸ¤– Mistral AI</div>
          <div class="form-group">
            <label class="form-label">API Key <span class="api-badge pend" id="badge-mistral">â— sin verificar</span></label>
            <div class="key-wrap"><input type="password" class="form-input" id="mistral-key" placeholder="sk-..." oninput="markDirty('config')"><button class="key-eye" onclick="toggleEye('mistral-key')">ğŸ‘</button></div>
            <div class="form-hint"><a href="https://console.mistral.ai" target="_blank" style="color:var(--accent)">console.mistral.ai</a></div>
          </div>
          <div class="form-group">
            <label class="form-label">Modelo</label>
            <select class="form-input" id="mistral-model" oninput="markDirty('config')">
              <option value="mistral-small-latest">mistral-small (gratuito, rÃ¡pido)</option>
              <option value="mistral-medium-latest">mistral-medium</option>
              <option value="mistral-large-latest">mistral-large (mÃ¡s preciso)</option>
            </select>
          </div>
          <button class="btn btn-ghost" style="width:100%" onclick="testMistral()">Verificar conexiÃ³n</button>
        </div>

        <div class="card">
          <div class="card-title">ğŸ“° NewsAPI</div>
          <div class="form-group">
            <label class="form-label">API Key <span class="api-badge pend" id="badge-newsapi">â— sin verificar</span></label>
            <div class="key-wrap"><input type="password" class="form-input" id="newsapi-key" placeholder="..." oninput="markDirty('config')"><button class="key-eye" onclick="toggleEye('newsapi-key')">ğŸ‘</button></div>
            <div class="form-hint">Tier gratuito: 100 req/dÃ­a â€” <a href="https://newsapi.org" target="_blank" style="color:var(--accent)">newsapi.org</a></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">ğŸ—ƒ Pinecone</div>
          <div class="form-group">
            <label class="form-label">API Key</label>
            <div class="key-wrap"><input type="password" class="form-input" id="pinecone-key" placeholder="..." oninput="markDirty('config')"><button class="key-eye" onclick="toggleEye('pinecone-key')">ğŸ‘</button></div>
          </div>
          <div class="form-group">
            <label class="form-label">Nombre del Ã­ndice</label>
            <input type="text" class="form-input" id="pinecone-index" placeholder="digitaltwin" oninput="markDirty('config')">
          </div>
          <div class="form-group">
            <label class="form-label">Region</label>
            <input type="text" class="form-input" id="pinecone-env" placeholder="us-east-1" oninput="markDirty('config')">
          </div>
        </div>

        <div class="card">
          <div class="card-title">ğŸ”¥ Firebase</div>
          <div class="form-group">
            <label class="form-label">Project ID</label>
            <input type="text" class="form-input" id="fb-project" placeholder="digitaltwin-21a64" oninput="markDirty('config')">
          </div>
          <div class="form-group">
            <label class="form-label">API Key</label>
            <div class="key-wrap"><input type="password" class="form-input" id="fb-key" placeholder="AIza..." oninput="markDirty('config')"><button class="key-eye" onclick="toggleEye('fb-key')">ğŸ‘</button></div>
          </div>
          <div class="form-group">
            <label class="form-label">Auth Domain</label>
            <input type="text" class="form-input" id="fb-domain" placeholder="proyecto.firebaseapp.com" oninput="markDirty('config')">
          </div>
        </div>
      </div>

      <hr class="div">
      <div class="card">
        <div class="card-title">âš™ ParÃ¡metros del sistema</div>
        <div class="grid-3">
          <div class="form-group">
            <label class="form-label">Umbral de relevancia (0-100)</label>
            <input type="number" class="form-input" id="threshold" value="60" min="0" max="100" oninput="markDirty('config')">
            <div class="form-hint">MÃ­nimo score IA para publicar un hit</div>
          </div>
          <div class="form-group">
            <label class="form-label">Modelo Mistral por defecto</label>
            <select class="form-input" id="mistral-model2" oninput="markDirty('config')">
              <option value="mistral-small-latest">mistral-small</option>
              <option value="mistral-large-latest">mistral-large</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Repo GitHub</label>
            <input type="text" class="form-input" id="gh-repo" placeholder="avespa/digitaltwin" oninput="markDirty('config');updateRepoUrl()">
            <div class="form-hint">usuario/repositorio</div>
          </div>
        </div>
      </div>

      <div class="flex gap-8 mt-18" style="justify-content:flex-end">
        <button class="btn btn-ghost" onclick="loadConfig()">Descartar</button>
        <button class="btn btn-primary" onclick="saveConfig()" id="config-save-btn">Guardar configuraciÃ³n</button>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /app -->

<!-- MODAL CLIENTE -->
<div class="modal-bg" id="modal-client">
  <div class="modal">
    <div class="modal-title" id="modal-client-title">Nuevo cliente</div>
    <button class="modal-x" onclick="closeModal('modal-client')">âœ•</button>
    <div class="grid-2">
      <div class="form-group">
        <label class="form-label">Nombre *</label>
        <input type="text" class="form-input" id="cl-name" placeholder="Empresa S.A.">
      </div>
      <div class="form-group">
        <label class="form-label">Sector *</label>
        <select class="form-input" id="cl-sector">
          <option value="">Selecciona...</option>
          <option value="financiero">Financiero / Banca</option>
          <option value="seguros">Seguros</option>
          <option value="tecnologia">TecnologÃ­a / Digital</option>
          <option value="salud">Salud / Farmacia</option>
          <option value="construccion">ConstrucciÃ³n / Inmobiliaria</option>
          <option value="energia">EnergÃ­a / Utilities</option>
          <option value="alimentacion">AlimentaciÃ³n / FMCG</option>
          <option value="transporte">Transporte / LogÃ­stica</option>
          <option value="manufactura">Manufactura / Industrial</option>
          <option value="servicios">Servicios Profesionales</option>
          <option value="retail">Retail</option>
          <option value="otro">Otro</option>
        </select>
      </div>
    </div>
    <div class="grid-2">
      <div class="form-group">
        <label class="form-label">PaÃ­s / GeografÃ­a</label>
        <select class="form-input" id="cl-country">
          <option value="ES">EspaÃ±a</option>
          <option value="ES,PT">EspaÃ±a + Portugal</option>
          <option value="ES,LATAM">EspaÃ±a + LATAM</option>
          <option value="EU">UniÃ³n Europea</option>
          <option value="GLOBAL">Global</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">FacturaciÃ³n anual</label>
        <select class="form-input" id="cl-revenue">
          <option value="<5M">Menos de 5M â‚¬</option>
          <option value="5-50M">5M â€“ 50M â‚¬</option>
          <option value="50-250M">50M â€“ 250M â‚¬</option>
          <option value=">250M">MÃ¡s de 250M â‚¬</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Normas aplicables</label>
      <div style="display:flex;flex-wrap:wrap;gap:10px">
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer"><input type="checkbox" class="cl-norm" value="ISO37301" checked> ISO 37301</label>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer"><input type="checkbox" class="cl-norm" value="UNE19601"> UNE 19601</label>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer"><input type="checkbox" class="cl-norm" value="ISO37001"> ISO 37001</label>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer"><input type="checkbox" class="cl-norm" value="RGPD"> RGPD</label>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer"><input type="checkbox" class="cl-norm" value="PBC"> PBC/AML</label>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer"><input type="checkbox" class="cl-norm" value="DORA"> DORA</label>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">DescripciÃ³n del modelo de compliance</label>
      <textarea class="form-input" id="cl-compliance" rows="3" placeholder="Controles existentes, certificaciones, Ã¡reas de riesgo conocidas..."></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Ãreas de riesgo prioritarias</label>
      <textarea class="form-input" id="cl-risks" rows="2" placeholder="Ej: soborno en licitaciones, conflictos de interÃ©s..."></textarea>
    </div>
    <div class="flex gap-8" style="justify-content:flex-end;margin-top:6px">
      <button class="btn btn-ghost" onclick="closeModal('modal-client')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveClient()">Guardar cliente</button>
    </div>
  </div>
</div>

<!-- MONITOR -->
<div class="monitor" id="monitor">
  <div class="monitor-head">
    <div class="monitor-logo"><span class="logo-dot"></span>CDT â€” COMPLIANCE DIGITAL TWIN</div>
    <div id="monitor-clock" style="font-size:12px;color:var(--text-muted);font-family:var(--font-mono)"></div>
    <button class="btn btn-ghost" onclick="toggleMonitor()">âœ• Salir</button>
  </div>
  <div class="monitor-grid">
    <div class="monitor-card">
      <div class="monitor-label">âš¡ Nivel de riesgo global</div>
      <div class="monitor-big text-accent" id="mon-risk">â€”</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:6px" id="mon-risk-label">calculando...</div>
      <div style="height:3px;background:var(--border2);border-radius:2px;margin-top:14px"><div id="mon-risk-bar" style="height:100%;border-radius:2px;background:var(--accent);width:0;transition:width .8s"></div></div>
    </div>
    <div class="monitor-card">
      <div class="monitor-label">âŸ Ãšltimos hits</div>
      <div id="mon-hits" style="flex:1;overflow:hidden"></div>
    </div>
    <div class="monitor-card">
      <div class="monitor-label">â— Clientes en seguimiento</div>
      <div id="mon-clients" style="flex:1"></div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GITHUB_REPO    = 'avespa/digitaltwin';
const RAW_BASE       = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/data`;
const GITHUB_API     = `https://api.github.com/repos/${GITHUB_REPO}/contents/data`;

let S = {
  clients: [],
  hits:    [],
  stats:   {},
  lastSync: null,
  cfg: {
    mistralKey:   '',
    mistralModel: 'mistral-small-latest',
    newsapiKey:   '',
    pineconeKey:  '',
    pineconeIndex:'digitaltwin',
    pineconeEnv:  'us-east-1',
    fbProject:    'digitaltwin-21a64',
    fbKey:        '',
    fbDomain:     'digitaltwin-21a64.firebaseapp.com',
    threshold:    60,
    ghRepo:       GITHUB_REPO,
  },
  remoteCfg: {
    newsapi_queries: [],
    newsapi_sources: '',
    custom_keywords: [],
    rss_enabled:     {},
  }
};

const RSS_LABELS = {
  BOE_disposiciones:           'BOE - Disposiciones generales',
  BOE_justicia:                'BOE - AdministraciÃ³n de Justicia',
  BOE_anuncios:                'BOE - Anuncios oficiales',
  BOE_derecho_penal:           'BOE - Derecho Penal',
  BOE_derecho_mercantil:       'BOE - Derecho Mercantil',
  BOE_sistema_financiero:      'BOE - Sistema Financiero',
  BOE_tribunal_constitucional: 'BOE - Tribunal Constitucional',
  BORME_general:               'BORME - Registro Mercantil',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function persist() { localStorage.setItem('cdt_v2', JSON.stringify(S)); }

function restore() {
  try {
    const d = localStorage.getItem('cdt_v2');
    if (d) S = {...S, ...JSON.parse(d)};
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  const titles = {dashboard:'Dashboard',clientes:'Clientes',hits:'Hits Detectados',analisis:'AnÃ¡lisis IA Manual',fuentes:'Fuentes & BÃºsquedas',config:'ConfiguraciÃ³n APIs'};
  document.getElementById('topbar-title').textContent = titles[name] || name;
  document.querySelectorAll('.nav-item').forEach(el => {
    if(el.textContent.trim().toLowerCase().replace(/\s+/g,'').includes(name.replace(/\s+/g,'').toLowerCase().slice(0,5)))
      el.classList.add('active');
  });
  if(name==='config') loadConfig();
  if(name==='fuentes') loadFuentesFromConfig();
  if(name==='hits') renderHits();
  if(name==='analisis') populateAnClients();
  if(name==='clientes') renderClients();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC FROM GITHUB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncNow() {
  const btn = document.getElementById('sync-btn');
  btn.innerHTML = '<span class="spin"></span> Sincronizando...';
  btn.disabled = true;
  document.getElementById('foot-status').textContent = 'Sincronizando...';

  try {
    // Fetch hits.json
    const r1 = await fetch(`${RAW_BASE}/hits.json?t=${Date.now()}`);
    if (r1.ok) {
      const data = await r1.json();
      S.hits  = data.hits  || [];
      S.stats = data.stats || {};
      S.lastSync = data.last_updated || new Date().toISOString();
    }

    // Fetch config.json
    const r2 = await fetch(`${RAW_BASE}/config.json?t=${Date.now()}`);
    if (r2.ok) {
      S.remoteCfg = await r2.json();
    }

    persist();
    renderAll();
    document.getElementById('foot-status').textContent = 'Sincronizado âœ“';
    document.getElementById('topbar-sync').textContent = 'Sync: ' + fmtDate(S.lastSync);
  } catch(e) {
    document.getElementById('foot-status').textContent = 'Error de sync';
    console.error(e);
  }

  btn.innerHTML = 'âŸ³ Sincronizar';
  btn.disabled  = false;
}

function updateRepoUrl() {
  const repo = document.getElementById('gh-repo')?.value?.trim();
  if (repo) {
    window.GITHUB_REPO_OVERRIDE = repo;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() {
  renderDashboard();
  renderClients();
  renderHits();
  renderMonitor();
  // Update badge
  const crits = S.hits.filter(h => h.level==='critical').length;
  document.getElementById('badge-hits').textContent = crits;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  document.getElementById('s-clientes').textContent = S.clients.length;
  document.getElementById('s-hits').textContent     = S.hits.length;
  document.getElementById('s-criticos').textContent = S.hits.filter(h=>h.level==='critical').length;
  document.getElementById('s-sync').textContent     = S.lastSync ? fmtDate(S.lastSync) : 'â€”';

  // Recent hits
  const hl = document.getElementById('dash-hits-list');
  const recent = S.hits.slice(0,5);
  document.getElementById('dash-hits-count').textContent = S.hits.length + ' totales';
  hl.innerHTML = recent.length ? recent.map(h => hitCard(h, false)).join('') :
    `<div class="empty"><div class="empty-icon">âŸ</div><div class="empty-title">Sin hits aÃºn</div><div class="empty-desc">Haz clic en Sincronizar o ejecuta el workflow en GitHub</div></div>`;

  // Clients table
  const tb = document.getElementById('dash-clients-body');
  tb.innerHTML = S.clients.length ? S.clients.map(c => `
    <tr>
      <td><strong>${c.name}</strong></td>
      <td style="color:var(--text-dim)">${sectorLabel(c.sector)}</td>
      <td>${c.hits||0}</td>
      <td><span class="risk ${c.riskLevel||'medio'}">${(c.riskLevel||'medio').toUpperCase()}</span></td>
    </tr>`).join('') :
    `<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:24px">Sin clientes â€” aÃ±ade uno en la secciÃ³n Clientes</td></tr>`;

  // Active sources
  const sl = document.getElementById('dash-sources-list');
  const rss = S.remoteCfg.rss_enabled || {};
  const activeSources = Object.entries(RSS_LABELS).filter(([k]) => rss[k] !== false).map(([,v]) => v);
  const qCount = (S.remoteCfg.newsapi_queries||[]).length;
  document.getElementById('dash-sources-count').textContent = `${activeSources.length} RSS + ${qCount} queries NewsAPI`;
  sl.innerHTML = activeSources.map(s =>
    `<span style="font-size:10px;padding:3px 9px;background:var(--surface2);border:1px solid var(--border);border-radius:3px;color:var(--text-dim)">${s}</span>`
  ).join('') + (qCount ? `<span style="font-size:10px;padding:3px 9px;background:rgba(0,102,255,.1);border:1px solid rgba(0,102,255,.2);border-radius:3px;color:var(--accent2)">${qCount} queries NewsAPI</span>` : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HITS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hitCard(h, expanded=false) {
  const score = h.relevance_score || 0;
  const hasDetail = h.summary || h.vulnerability || h.financial_impact || h.recommended_action;
  return `
    <div class="hit ${h.level||'info'}" id="hit-${h.id}">
      <div class="hit-head">
        <span class="level-tag ${h.level||'info'}">${levelLabel(h.level)}</span>
        <span class="hit-source">${(h.source||'').split('Â·')[0].trim()}</span>
        <span class="hit-date">${fmtDate(h.fetched_at||h.raw_date)}</span>
      </div>
      <div class="hit-title">${esc(h.title)}</div>
      ${h.summary ? `<div class="hit-summary">${esc(h.summary)}</div>` : ''}
      <div class="score-bar"><div class="score-fill" style="width:${score}%;background:${score>70?'var(--danger)':score>40?'var(--warn)':'var(--accent)'}"></div></div>
      ${hasDetail ? `
        <div style="margin-top:7px">
          <button class="btn btn-ghost btn-sm" onclick="toggleHitDetail('${h.id}')">Ver anÃ¡lisis completo â†“</button>
          ${h.link ? `<a href="${h.link}" target="_blank" class="btn btn-ghost btn-sm" style="margin-left:4px">Fuente â†—</a>` : ''}
        </div>
        <div class="hit-detail" id="hd-${h.id}">
          ${h.risks?.length ? `<div class="hit-detail-item"><div class="hit-detail-label">Riesgos</div>${h.risks.join(' Â· ')}</div>` : ''}
          ${h.norms_affected?.length ? `<div class="hit-detail-item"><div class="hit-detail-label">Normas afectadas</div>${h.norms_affected.join(' Â· ')}</div>` : ''}
          ${h.vulnerability ? `<div class="hit-detail-item"><div class="hit-detail-label">Vulnerabilidad / Control</div>${esc(h.vulnerability)}</div>` : ''}
          ${h.financial_impact ? `<div class="hit-detail-item"><div class="hit-detail-label">Impacto financiero estimado</div>${esc(h.financial_impact)}</div>` : ''}
          ${h.recommended_action ? `<div class="hit-detail-item"><div class="hit-detail-label">AcciÃ³n recomendada</div>${esc(h.recommended_action)}</div>` : ''}
        </div>` : (h.link ? `<div style="margin-top:7px"><a href="${h.link}" target="_blank" class="btn btn-ghost btn-sm">Fuente â†—</a></div>` : '')}
    </div>`;
}

function toggleHitDetail(id) {
  const el = document.getElementById('hd-'+id);
  if(el) el.classList.toggle('open');
}

function renderHits() {
  const lv  = document.getElementById('filter-level')?.value || '';
  const src = document.getElementById('filter-source')?.value || '';
  let hits  = [...S.hits];
  if(lv)  hits = hits.filter(h => h.level === lv);
  if(src) hits = hits.filter(h => (h.source||'').includes(src));

  const container = document.getElementById('hits-list');
  container.innerHTML = hits.length ? hits.map(h => hitCard(h)).join('') :
    `<div class="empty"><div class="empty-icon">âŸ</div><div class="empty-title">Sin hits</div><div class="empty-desc">Sincroniza o ejecuta el workflow en GitHub Actions</div></div>`;

  // Populate source filter
  const srcSel = document.getElementById('filter-source');
  if(srcSel) {
    const sources = [...new Set(S.hits.map(h => (h.source||'').split('Â·')[0].trim()).filter(Boolean))];
    const cur = srcSel.value;
    srcSel.innerHTML = `<option value="">Todas las fuentes</option>` + sources.map(s => `<option value="${s}">${s}</option>`).join('');
    srcSel.value = cur;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingClient = null;

function renderClients() {
  const c = document.getElementById('clients-list');
  if(!S.clients.length) {
    c.innerHTML = `<div class="empty"><div class="empty-icon">â—</div><div class="empty-title">Sin clientes aÃºn</div><div class="empty-desc">Crea el primer perfil empresarial</div></div>`;
    return;
  }
  c.innerHTML = S.clients.map(cl => `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:14px 18px;display:flex;align-items:center;gap:14px;margin-bottom:8px;cursor:pointer;transition:border-color .15s" onmouseenter="this.style.borderColor='var(--border2)'" onmouseleave="this.style.borderColor='var(--border)'" onclick="openClientModal('${cl.id}')">
      <div style="width:38px;height:38px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;display:flex;align-items:center;justify-content:center;font-family:var(--font-ui);font-weight:800;font-size:13px;color:var(--accent);flex-shrink:0">${cl.name.slice(0,2).toUpperCase()}</div>
      <div style="flex:1">
        <div style="font-family:var(--font-ui);font-weight:700;font-size:13px;margin-bottom:2px">${cl.name}</div>
        <div style="font-size:10px;color:var(--text-muted)">${sectorLabel(cl.sector)} Â· ${cl.country} Â· ${(cl.norms||[]).join(', ')}</div>
      </div>
      <span class="risk ${cl.riskLevel||'medio'}">${(cl.riskLevel||'medio').toUpperCase()}</span>
      <div onclick="event.stopPropagation()" style="display:flex;gap:6px">
        <button class="btn btn-ghost btn-sm" onclick="openClientModal('${cl.id}')">Editar</button>
        <button class="btn btn-danger btn-sm" onclick="deleteClient('${cl.id}')">âœ•</button>
      </div>
    </div>`).join('');
}

function openClientModal(id=null) {
  editingClient = id;
  const cl = id ? S.clients.find(c=>c.id===id) : null;
  document.getElementById('modal-client-title').textContent = id ? 'Editar cliente' : 'Nuevo cliente';
  document.getElementById('cl-name').value      = cl?.name || '';
  document.getElementById('cl-sector').value    = cl?.sector || '';
  document.getElementById('cl-country').value   = cl?.country || 'ES';
  document.getElementById('cl-revenue').value   = cl?.revenue || '5-50M';
  document.getElementById('cl-compliance').value= cl?.complianceDesc || '';
  document.getElementById('cl-risks').value     = cl?.risks || '';
  document.querySelectorAll('.cl-norm').forEach(cb => {
    cb.checked = cl ? (cl.norms||[]).includes(cb.value) : cb.value==='ISO37301';
  });
  document.getElementById('modal-client').classList.add('open');
}

function saveClient() {
  const name   = document.getElementById('cl-name').value.trim();
  const sector = document.getElementById('cl-sector').value;
  if(!name||!sector) { alert('Nombre y sector obligatorios'); return; }
  const norms = [...document.querySelectorAll('.cl-norm:checked')].map(c=>c.value);
  const cl = {
    id:            editingClient || 'c'+Date.now(),
    name, sector,
    country:       document.getElementById('cl-country').value,
    revenue:       document.getElementById('cl-revenue').value,
    norms,
    complianceDesc:document.getElementById('cl-compliance').value.trim(),
    risks:         document.getElementById('cl-risks').value.trim(),
    riskLevel:     'medio',
    hits:          0,
    createdAt:     new Date().toISOString(),
  };
  if(editingClient) {
    const i = S.clients.findIndex(c=>c.id===editingClient);
    S.clients[i] = {...S.clients[i], ...cl};
  } else {
    S.clients.push(cl);
  }
  persist();
  closeModal('modal-client');
  renderClients();
  renderDashboard();
}

function deleteClient(id) {
  if(!confirm('Â¿Eliminar este cliente?')) return;
  S.clients = S.clients.filter(c=>c.id!==id);
  persist(); renderClients(); renderDashboard();
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUENTES & BÃšSQUEDAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadFuentesFromConfig() {
  const rc = S.remoteCfg;

  // Queries
  renderQueryList(rc.newsapi_queries || []);
  document.getElementById('newsapi-sources').value = rc.newsapi_sources || '';
  document.getElementById('queries-count').textContent = (rc.newsapi_queries||[]).length + ' activas';

  // RSS toggles
  renderRssList(rc.rss_enabled || {});

  // Keywords
  renderKwList(rc.custom_keywords || []);
}

function renderQueryList(queries) {
  document.getElementById('queries-list').innerHTML = queries.map((q,i) => `
    <div class="query-item">
      <span class="query-num">${i+1}</span>
      <span class="query-text">${esc(q)}</span>
      <button class="query-del" onclick="removeQuery(${i})" title="Eliminar">Ã—</button>
    </div>`).join('');
  document.getElementById('queries-count').textContent = queries.length + ' activas';
}

function addQuery() {
  const val = document.getElementById('new-query').value.trim();
  if(!val) return;
  const queries = [...(S.remoteCfg.newsapi_queries||[]), val];
  S.remoteCfg.newsapi_queries = queries;
  document.getElementById('new-query').value = '';
  renderQueryList(queries);
  markDirty('fuentes');
}

function removeQuery(i) {
  S.remoteCfg.newsapi_queries.splice(i,1);
  renderQueryList(S.remoteCfg.newsapi_queries);
  markDirty('fuentes');
}

function renderRssList(enabled) {
  document.getElementById('rss-list').innerHTML = Object.entries(RSS_LABELS).map(([k,label]) => {
    const on = enabled[k] !== false;
    return `
      <div class="rss-item">
        <button class="rss-toggle ${on?'on':''}" id="rss-${k}" onclick="toggleRss('${k}')"></button>
        <span class="rss-name ${on?'on':''}" id="rss-label-${k}">${label}</span>
      </div>`;
  }).join('');
}

function toggleRss(key) {
  const btn = document.getElementById('rss-'+key);
  const lbl = document.getElementById('rss-label-'+key);
  const isOn = btn.classList.toggle('on');
  lbl.classList.toggle('on', isOn);
  if(!S.remoteCfg.rss_enabled) S.remoteCfg.rss_enabled = {};
  S.remoteCfg.rss_enabled[key] = isOn;
  markDirty('fuentes');
}

function renderKwList(keywords) {
  document.getElementById('kw-list').innerHTML = keywords.map((kw,i) => `
    <span class="kw-tag">${esc(kw)}<button onclick="removeKw(${i})" title="Eliminar">Ã—</button></span>`
  ).join('');
}

function addKw() {
  const val = document.getElementById('new-kw').value.trim();
  if(!val) return;
  if(!(S.remoteCfg.custom_keywords||[]).includes(val)) {
    S.remoteCfg.custom_keywords = [...(S.remoteCfg.custom_keywords||[]), val];
    renderKwList(S.remoteCfg.custom_keywords);
    markDirty('fuentes');
  }
  document.getElementById('new-kw').value = '';
}

function removeKw(i) {
  S.remoteCfg.custom_keywords.splice(i,1);
  renderKwList(S.remoteCfg.custom_keywords);
  markDirty('fuentes');
}

async function saveFuentes() {
  // Recoger sources input
  S.remoteCfg.newsapi_sources = document.getElementById('newsapi-sources').value.trim();
  persist();

  // Intentar guardar en GitHub via API (requiere token)
  // Sin token, mostramos instrucciones para hacerlo manualmente
  showAlert('fuentes-alert',
    'âœ“ ConfiguraciÃ³n guardada localmente. Para aplicarla: edita <code>data/config.json</code> en GitHub con este contenido y ejecuta el workflow.',
    'ok');

  // Mostrar el JSON para copiar
  console.log('config.json actualizado:', JSON.stringify(S.remoteCfg, null, 2));

  document.getElementById('fuentes-save-btn').textContent = 'Guardado âœ“';
  setTimeout(()=>{ document.getElementById('fuentes-save-btn').textContent = 'Guardar configuraciÃ³n'; }, 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG APIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadConfig() {
  const c = S.cfg;
  document.getElementById('mistral-key').value   = c.mistralKey   || '';
  document.getElementById('mistral-model').value = c.mistralModel || 'mistral-small-latest';
  document.getElementById('newsapi-key').value   = c.newsapiKey   || '';
  document.getElementById('pinecone-key').value  = c.pineconeKey  || '';
  document.getElementById('pinecone-index').value= c.pineconeIndex|| 'digitaltwin';
  document.getElementById('pinecone-env').value  = c.pineconeEnv  || 'us-east-1';
  document.getElementById('fb-project').value    = c.fbProject    || '';
  document.getElementById('fb-key').value        = c.fbKey        || '';
  document.getElementById('fb-domain').value     = c.fbDomain     || '';
  document.getElementById('threshold').value     = c.threshold    || 60;
  document.getElementById('gh-repo').value       = c.ghRepo       || GITHUB_REPO;
}

function saveConfig() {
  S.cfg = {
    mistralKey:   document.getElementById('mistral-key').value.trim(),
    mistralModel: document.getElementById('mistral-model').value,
    newsapiKey:   document.getElementById('newsapi-key').value.trim(),
    pineconeKey:  document.getElementById('pinecone-key').value.trim(),
    pineconeIndex:document.getElementById('pinecone-index').value.trim(),
    pineconeEnv:  document.getElementById('pinecone-env').value.trim(),
    fbProject:    document.getElementById('fb-project').value.trim(),
    fbKey:        document.getElementById('fb-key').value.trim(),
    fbDomain:     document.getElementById('fb-domain').value.trim(),
    threshold:    parseInt(document.getElementById('threshold').value),
    ghRepo:       document.getElementById('gh-repo').value.trim(),
  };
  persist();
  showAlert('config-alert', 'âœ“ ConfiguraciÃ³n guardada', 'ok');
  document.getElementById('config-save-btn').textContent = 'Guardado âœ“';
  setTimeout(()=>{ document.getElementById('config-save-btn').textContent = 'Guardar configuraciÃ³n'; }, 2000);
}

async function testMistral() {
  const key = document.getElementById('mistral-key').value.trim();
  if(!key) { showAlert('config-alert','Introduce la API key de Mistral primero','err'); return; }
  const badge = document.getElementById('badge-mistral');
  badge.className = 'api-badge pend'; badge.textContent = 'â— probando...';
  try {
    const r = await fetch('https://api.mistral.ai/v1/models', { headers:{'Authorization':'Bearer '+key} });
    if(r.ok) { badge.className='api-badge ok'; badge.textContent='â— conectado'; showAlert('config-alert','âœ“ Mistral AI conectado correctamente','ok'); }
    else      { badge.className='api-badge err'; badge.textContent='â— error'; showAlert('config-alert','âœ— API Key invÃ¡lida','err'); }
  } catch(e) { badge.className='api-badge err'; badge.textContent='â— sin conexiÃ³n'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANÃLISIS MANUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateAnClients() {
  const sel = document.getElementById('an-client');
  sel.innerHTML = `<option value="">Sin cliente (anÃ¡lisis genÃ©rico)</option>` +
    S.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

async function runManual() {
  const key  = S.cfg.mistralKey;
  if(!key) { showAlert('','',''); go('config'); return; }
  const text = document.getElementById('an-text').value.trim();
  if(!text) { alert('Introduce texto para analizar'); return; }

  const clientId = document.getElementById('an-client').value;
  const type     = document.getElementById('an-type').value;
  const client   = S.clients.find(c=>c.id===clientId);
  const btn      = document.getElementById('an-btn');
  const result   = document.getElementById('an-result');

  result.innerHTML = `<div style="display:flex;align-items:center;gap:10px;color:var(--text-muted);padding:20px 0"><span class="spin"></span> Analizando con Mistral AI...</div>`;
  btn.disabled = true;

  const sys = buildPrompt(client, type);
  try {
    const r = await fetch('https://api.mistral.ai/v1/chat/completions', {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body: JSON.stringify({
        model: S.cfg.mistralModel || 'mistral-small-latest',
        messages:[{role:'system',content:sys},{role:'user',content:'Analiza:\n\n'+text}],
        temperature:0.2, max_tokens:1200
      })
    });
    if(!r.ok) throw new Error((await r.json()).message||'Error API');
    const data  = await r.json();
    const reply = data.choices[0].message.content;
    result.innerHTML = `<div style="font-size:11.5px;line-height:1.8;white-space:pre-wrap;color:var(--text-dim)">${esc(reply)}</div>`;
  } catch(e) {
    result.innerHTML = `<div style="color:var(--danger);font-size:11px">Error: ${esc(e.message)}</div>`;
  }
  btn.disabled = false;
}

function buildPrompt(client, type) {
  const ctx = client
    ? `Empresa: "${client.name}" | Sector: ${sectorLabel(client.sector)} | PaÃ­s: ${client.country} | Normas: ${(client.norms||[]).join(', ')}\nCompliance: ${client.complianceDesc||'No especificado'}\nRiesgos conocidos: ${client.risks||'No especificados'}`
    : `AnÃ¡lisis genÃ©rico de compliance corporativo espaÃ±ol (ISO 37301, UNE 19601, ISO 37001).`;

  const types = {
    full:           'AnÃ¡lisis completo: relevancia, riesgos, vulnerabilidad vs. controles, impacto financiero y recomendaciones.',
    vulnerability:  'Analiza la vulnerabilidad: Â¿tiene la empresa controles para este riesgo? Â¿Son suficientes? Â¿HabrÃ­a parado este evento?',
    financial:      'Calcula el impacto financiero: multas potenciales segÃºn normativa espaÃ±ola, daÃ±o reputacional y coste de remediaciÃ³n.',
    recommendation: 'Dame recomendaciones concretas: gaps identificados, controles a implantar, prioridad y documentaciÃ³n necesaria.',
  };

  return `${ctx}\n\n${types[type]||types.full}\n\nResponde en espaÃ±ol, de forma estructurada y concisa.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let monClock;
function toggleMonitor() {
  const m = document.getElementById('monitor');
  m.classList.toggle('on');
  if(m.classList.contains('on')) {
    renderMonitor();
    monClock = setInterval(()=>{ document.getElementById('monitor-clock').textContent = new Date().toLocaleString('es-ES'); }, 1000);
  } else {
    clearInterval(monClock);
  }
}

function renderMonitor() {
  const crits = S.hits.filter(h=>h.level==='critical').length;
  const warns = S.hits.filter(h=>h.level==='warning').length;
  const risk  = Math.min(100, 20 + crits*15 + warns*5);
  document.getElementById('mon-risk').textContent      = risk;
  document.getElementById('mon-risk-label').textContent= risk>70?'ALTO':risk>40?'MEDIO':'BAJO';
  document.getElementById('mon-risk-bar').style.width  = risk+'%';
  document.getElementById('mon-risk-bar').style.background = risk>70?'var(--danger)':risk>40?'var(--warn)':'var(--accent)';
  document.getElementById('mon-risk').style.color      = risk>70?'var(--danger)':risk>40?'var(--warn)':'var(--accent)';

  const mh = document.getElementById('mon-hits');
  mh.innerHTML = S.hits.slice(0,7).map(h=>`
    <div class="ticker-item">
      <div style="display:flex;gap:7px;align-items:center;margin-bottom:3px">
        <span class="level-tag ${h.level||'info'}" style="font-size:8px">${levelLabel(h.level)}</span>
        <span style="font-size:9.5px;color:var(--text-muted)">${fmtDate(h.fetched_at)}</span>
      </div>
      <div style="font-size:11.5px">${esc(h.title.slice(0,90))}${h.title.length>90?'...':''}</div>
    </div>`).join('') || `<div class="empty" style="padding:16px 0"><div class="empty-desc">Sin hits</div></div>`;

  const mc = document.getElementById('mon-clients');
  mc.innerHTML = S.clients.map(c=>`
    <div style="display:flex;align-items:center;gap:9px;padding:8px 0;border-bottom:1px solid var(--border)">
      <div style="width:28px;height:28px;background:var(--surface2);border-radius:4px;display:flex;align-items:center;justify-content:center;font-family:var(--font-ui);font-weight:800;font-size:10px;color:var(--accent)">${c.name.slice(0,2).toUpperCase()}</div>
      <div style="flex:1"><div style="font-size:11.5px;font-weight:500">${c.name}</div><div style="font-size:9.5px;color:var(--text-muted)">${sectorLabel(c.sector)}</div></div>
      <span class="risk ${c.riskLevel||'medio'}" style="font-size:9.5px">${(c.riskLevel||'medio').toUpperCase()}</span>
    </div>`).join('') || `<div class="empty" style="padding:16px 0"><div class="empty-desc">Sin clientes</div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function levelLabel(l) { return {critical:'CRÃTICO',warning:'ALERTA',info:'INFO'}[l]||l||'?'; }
function sectorLabel(s) {
  return {financiero:'Financiero',seguros:'Seguros',tecnologia:'TecnologÃ­a',salud:'Salud',
    construccion:'ConstrucciÃ³n',energia:'EnergÃ­a',alimentacion:'AlimentaciÃ³n',
    transporte:'Transporte',manufactura:'Manufactura',servicios:'Servicios',retail:'Retail',otro:'Otro'}[s]||s||'â€”';
}
function fmtDate(iso) {
  if(!iso) return 'â€”';
  const d = new Date(iso);
  return d.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'}) + ' ' + d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
}
function esc(s='') { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toggleEye(id) { const e=document.getElementById(id); e.type=e.type==='password'?'text':'password'; }
function markDirty(section) {
  const btn = document.getElementById(section+'-save-btn');
  if(btn && !btn.textContent.includes('*')) btn.textContent += ' *';
}
function showAlert(containerId, msg, type) {
  const map = {ok:'ok',err:'err',warn:'warn'};
  const html = `<div class="alert ${map[type]||'ok'}">${msg}</div>`;
  if(containerId) {
    const el = document.getElementById(containerId);
    if(el) { el.innerHTML=html; setTimeout(()=>{ el.innerHTML=''; },4000); }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
restore();
renderAll();
loadConfig();

// Auto-sync al arrancar
syncNow();

// Auto-sync cada 30 minutos
setInterval(syncNow, 30 * 60 * 1000);
</script>
</body>
</html>
